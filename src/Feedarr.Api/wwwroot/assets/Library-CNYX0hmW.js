import{r as a,j as e}from"./vendor-react-B6j9w5IJ.js";import{a as Te,b as tt,g as Es,A as se,r as at,u as nt,c as ve,t as ys}from"./index-CDoNWBDE.js";import{L as lt}from"./Loader-WjrgZmWo.js";import{P as it,u as ot,a as ct,e as lr,o as dt,R as ut}from"./PosterCard-2jCfGzrB.js";import{b as _r,g as mt}from"./sourceColors-KACkINRj.js";import{n as Rs,g as pt}from"./appTypes-BSxyKsC5.js";import{n as Ts}from"./categoryGroups.constants-TqNJ0nIh.js";import{f as Us,a as bt,g as ft,b as yt,c as gs,d as hs}from"./formatters-CeDqR87H.js";import{a as gt}from"./vendor-router-DbNMZja2.js";import{J as Ps,I as ht,C as xs,L as vs}from"./vendor-icons-CUZlM7O3.js";import{S as Ne}from"./SubAction-CMUbNneY.js";import{M as Fs}from"./Modal-nSKvSdtX.js";function Cr(t){const s=Ts(t?.mediaType||t?.unifiedCategoryKey);return s==="series"||s==="anime"||s==="emissions"}function jr(t){const s=String(t||"").toLowerCase();return s?s.includes("2160")||s.includes("4k")?4:s.includes("1080")?3:s.includes("720")?2:s.includes("480")?1:0:0}function xt(t){const s=Number(t?.season),i=Number(t?.episode),d=Number.isFinite(s)&&s>0?s:0,v=Number.isFinite(i)&&i>0?i:0;return d*1e3+v}function vt(t){if(!t)return"";const s=String(t),i=s.match(/\/t\/p\/([^/]+)/i);if(i?.[1])return i[1];const d=s.toLowerCase();return d.includes("cover_big")?"cover_big":d.includes("t_cover")?"cover":""}function Ss(t){const s=String(t||"").toLowerCase().trim();if(!s)return 0;if(s==="original")return 1e5;const i=s.match(/^w(\d+)$/);if(i?.[1])return Number(i[1]);const d=s.match(/^(\d+)\s*x\s*(\d+)$/);return d?Number(d[1])*Number(d[2]):s.includes("cover_big")?350:s.includes("cover")?250:0}function Nr(t){return t?.posterSize||vt(t?.posterUrl)}function St(t){const s=[...t];return s.sort((i,d)=>{const v=Ss(Nr(i)),k=Ss(Nr(d));return v!==k?k-v:String(i?.title||"").localeCompare(String(d?.title||""))}),s}function js(t){return String(t||"").toLowerCase()==="games"}function jt(t){return String(t||"").toLowerCase()==="game"}function Cs(t){return String(t||"").trim().toLowerCase()}function Ns(t,s){if(!t)return"";const i=Number(s||0);return i>0?`/api/posters/release/${t}?v=${i}`:`/api/posters/release/${t}`}function _s(t,s){const i={...t};return s.entityId!=null&&(i.entityId=s.entityId),s.posterFile!==void 0&&(i.posterFile=s.posterFile),s.posterUpdatedAtTs!==void 0&&(i.posterUpdatedAtTs=s.posterUpdatedAtTs),s.posterLastAttemptTs!==void 0&&(i.posterLastAttemptTs=s.posterLastAttemptTs),s.posterLastError!==void 0&&(i.posterLastError=s.posterLastError),s.posterUrl!==void 0&&(i.posterUrl=s.posterUrl),i}function Ct(t){return String(t||"").toUpperCase().replace(/[^A-Z0-9]/g,"")}function $s(t){const s=Ct(t);return s==="YGEGE"?"banner-pill--indexer-ygege":s==="C411"?"banner-pill--indexer-c411":s==="TOS"?"banner-pill--indexer-tos":s==="LACALE"?"banner-pill--indexer-lacale":""}function Nt(t){return!!(t?.overview||t?.releaseDate||t?.rating||t?.ratingVotes||t?.genres)}function _t(t){const s=String(t||"").toLowerCase();return s.includes("2160")||s.includes("4k")?"banner-pill--4k":s.includes("1080")?"banner-pill--1080":s.includes("720")?"banner-pill--720":""}const ws=[{key:"animation",label:"Animation"},{key:"anime",label:"Anime"},{key:"audio",label:"Audio"},{key:"comics",label:"Comics"},{key:"emissions",label:"Emissions"},{key:"films",label:"Films"},{key:"games",label:"Jeux"},{key:"books",label:"Livres"},{key:"series",label:"Series TV"},{key:"spectacle",label:"Spectacle"}],Is=600*1e3,ks=50,As=new Set(["","1","2","3","7","15","30"]),Ls=new Set(["","1","0"]),Ms=new Set(["","__hide_apps__"]);function le(t){try{return window.localStorage.getItem(t)}catch{return null}}function Se(t,s){try{window.localStorage.setItem(t,s)}catch{}}function wt(t,s){const[i]=gt(),[d,v]=a.useState(""),[k,P]=a.useState(""),[o,_]=a.useState(()=>le("feedarr.library.filter.categoryId")||""),[N,y]=a.useState("date"),[u,M]=a.useState(()=>{const x=le("feedarr.library.filter.maxAgeDays");return As.has(x??"")?x??"":""}),[c,I]=a.useState("grid"),[A,F]=a.useState("date"),[H,E]=a.useState("desc"),[q,m]=a.useState(()=>{const x=le("feedarr.library.filter.seen");return Ls.has(x??"")?x??"":""}),[$,S]=a.useState(()=>{const x=le("feedarr.library.filter.applicationId")||"";return Ms.has(x)||/^-?\d+$/.test(x)?x:""}),[f,R]=a.useState(()=>le("feedarr.library.filter.quality")||""),[V,X]=a.useState(()=>le("feedarr.library.filterbar.open")==="1"),[U,D]=a.useState(null),[Z,g]=a.useState(!1),[G,Q]=a.useState(()=>{const x=le("feedarr.library.limit");if(x==="all")return"all";const B=Number(x);return Number.isFinite(B)&&B>0?B:100}),Y=a.useMemo(()=>{const x=[{value:"grid",label:"Cartes"},{value:"poster",label:"Poster"},{value:"banner",label:"Banner"},{value:"list",label:"Liste"}];return U?.enableMissingPosterView&&x.push({value:"missing",label:"Sans poster"}),x},[U?.enableMissingPosterView]),_e=a.useMemo(()=>{const x=Number(d);if(!Number.isFinite(x)||x<=0)return"Bibliotheque";const B=s.find(J=>Number(J.id??J.sourceId)===x);return B?.name??B?.title??`Source ${x}`},[d,s]);a.useEffect(()=>{if(!U||!t||t.length===0)return;const x=le("feedarr.library.sourceId"),B=x??"",J=String(U?.defaultFilterSourceId??"").trim(),ae=W=>s.some(w=>String(w.id??w.sourceId)===String(W));v(W=>{if(W&&ae(W))return W;if(B&&ae(B))return B;if(x==null&&J&&ae(J))return J;if(!W&&B==="")return"";const w=s[0]?.id??s[0]?.sourceId;return w!=null?String(w):""}),g(!0)},[t,s,U]),a.useEffect(()=>{Z&&Se("feedarr.library.sourceId",String(d||""))},[d,Z]),a.useEffect(()=>{Se("feedarr.library.filter.categoryId",String(o||""))},[o]),a.useEffect(()=>{Se("feedarr.library.filter.maxAgeDays",String(u||""))},[u]),a.useEffect(()=>{Se("feedarr.library.filter.seen",String(q||""))},[q]),a.useEffect(()=>{Se("feedarr.library.filter.applicationId",String($||""))},[$]),a.useEffect(()=>{Se("feedarr.library.filter.quality",String(f||""))},[f]),a.useEffect(()=>{Se("feedarr.library.filterbar.open",V?"1":"0")},[V]),a.useEffect(()=>{Se("feedarr.library.limit",String(G||100))},[G]),a.useEffect(()=>{Te("/api/settings/ui").then(x=>{const B=String(x?.defaultView||"grid").toLowerCase(),J=B==="cards"?"grid":B;["grid","list","banner","poster"].includes(J)&&I(J);const ae=String(x?.defaultSort||"date").toLowerCase();["date","seeders","downloads"].includes(ae)&&y(ae);const W=String(x?.defaultMaxAgeDays??"");le("feedarr.library.filter.maxAgeDays")==null&&As.has(W)&&M(W);const ke=le("feedarr.library.filter.seen"),Oe=String(x?.defaultFilterSeen??"");ke==null&&Ls.has(Oe)&&m(Oe);const oe=le("feedarr.library.filter.applicationId"),ne=String(x?.defaultFilterApplication??"");if(oe==null&&(Ms.has(ne)||/^-?\d+$/.test(ne))&&S(ne),le("feedarr.library.filter.categoryId")==null&&_(String(x?.defaultFilterCategoryId??"")),le("feedarr.library.filter.quality")==null&&R(String(x?.defaultFilterQuality??"")),!le("feedarr.library.limit")){const ze=Number(x?.defaultLimit??100);ze===0?Q("all"):[50,100,200,500].includes(ze)&&Q(ze)}D(x||null)}).catch(x=>{console.error("Failed to load UI settings for library filters",x)})},[]),a.useEffect(()=>{if(U?.enableMissingPosterView!==!1||c!=="missing")return;const x=String(U?.defaultView||"grid").toLowerCase(),B=x==="cards"?"grid":x;I(["grid","list","banner","poster"].includes(B)?B:"grid")},[U?.enableMissingPosterView,U?.defaultView,c]),a.useEffect(()=>{const x=(i.get("q")||"").trim();P(B=>B===x?B:x)},[i]),a.useEffect(()=>{c!=="list"&&c!=="banner"||N&&(F(N),E("desc"))},[N,c]);const Ue=a.useCallback(x=>{E(B=>A===x&&B==="asc"?"desc":"asc"),F(x)},[A]),we=a.useCallback(async x=>{const B=String(x||"grid").toLowerCase(),J=B==="cards"?"grid":B;if(J==="missing"){I("missing");return}if(["grid","list","banner","poster"].includes(J)){I(J);try{let ae=U;ae||(ae=await Te("/api/settings/ui"));const W={...ae||{},defaultView:J},w=await tt("/api/settings/ui",W);D(w||W)}catch(ae){console.error("Failed to persist library default view",ae)}}},[U]),Pe=U?.defaultSort||"date",Ie=U?.defaultMaxAgeDays??"",Fe=U?.defaultLimit===0?"all":U?.defaultLimit||100,h=U?.defaultFilterSeen??"",te=U?.defaultFilterApplication??"",je=U?.defaultFilterCategoryId??"",$e=U?.defaultFilterQuality??"";return{sourceId:d,setSourceId:v,q:k,setQ:P,categoryId:o,setCategoryId:_,sortBy:N,setSortBy:y,maxAgeDays:u,setMaxAgeDays:M,viewMode:c,setViewMode:we,listSortBy:A,listSortDir:H,toggleListSort:Ue,seen:q,setSeen:m,applicationId:$,setApplicationId:S,quality:f,setQuality:R,filtersOpen:V,setFiltersOpen:X,limit:G,setLimit:Q,uiSettings:U,viewOptions:Y,selectedSourceName:_e,sourceReady:Z,defaultSort:Pe,defaultMaxAgeDays:Ie,defaultLimit:Fe,defaultSeen:h,defaultApplication:te,defaultCategoryId:je,defaultQuality:$e}}function It(){const[t,s]=a.useState(!1),[i,d]=a.useState(()=>new Set);a.useEffect(()=>(document.body.classList.toggle("library-select-mode",t),()=>document.body.classList.remove("library-select-mode")),[t]);const v=a.useCallback(()=>{s(N=>{const y=!N;return y||d(new Set),y})},[]),k=a.useCallback(N=>{N?.id&&d(y=>{const u=new Set(y);return u.has(N.id)?u.delete(N.id):u.add(N.id),u})},[]),P=a.useCallback(()=>{d(new Set)},[]),o=a.useCallback(N=>{const y=(N||[]).map(u=>u.id).filter(Boolean);d(new Set(y))},[]),_=a.useCallback(()=>{s(!1),d(new Set)},[]);return{selectionMode:t,selectedIds:i,toggleSelectionMode:v,toggleSelect:k,clearSelection:P,selectAllVisible:o,exitSelectionMode:_}}function Je(t){return String(t||"").trim().toLowerCase()}function kt(t,s,i){const d=Je(i);if(!d)return!0;const v=!!(s?.inSonarr||s?.inRadarr||s?.inOverseerr||s?.inJellyseerr||s?.inSeer)||!!(t?.isInSonarr||t?.isInRadarr);return d==="__hide_apps__"?!v:d==="sonarr"?!!(s?.inSonarr||t?.isInSonarr):d==="radarr"?!!(s?.inRadarr||t?.isInRadarr):d==="overseerr"?!!s?.inOverseerr:d==="jellyseerr"?!!s?.inJellyseerr:d==="seer"?!!s?.inSeer:!0}function At({items:t,sourceNameById:s,filterCategoryId:i,filterApplicationType:d,filterQuality:v,filterSeen:k,filterSortBy:P,filterMaxAgeDays:o,filterQ:_,filterViewMode:N,filterListSortBy:y,filterListSortDir:u,filterLimit:M,arrStatusById:c}){const I=a.useMemo(()=>{let m=t||[];if(m=m.filter(S=>S.unifiedCategoryKey),d&&(m=m.filter(S=>kt(S,c?.[S.id],d))),k){const S=k==="1"?1:k==="0"?0:null;S!==null&&(m=m.filter(f=>Number(f.seen)===S))}if(o){const S=Number(o);if(Number.isFinite(S)&&S>0){const f=Date.now()/1e3,R=S*24*60*60;m=m.filter(V=>{const X=Number(V.publishedAt||0);return!Number.isFinite(X)||X<=0?!1:f-X<=R})}}const $=String(_||"").trim().toLowerCase();return $&&(m=m.filter(S=>String(S.title||"").toLowerCase().includes($))),m},[t,d,c,k,o,_]),A=a.useMemo(()=>i?I.filter(m=>m.unifiedCategoryKey===i):I,[I,i]),F=a.useMemo(()=>{const m=new Map;(A||[]).forEach(f=>{const R=String(f?.resolution||"").trim(),V=Je(R);V&&(m.has(V)||m.set(V,R))});const $=Array.from(m.entries()).sort((f,R)=>{const V=jr(R[1])-jr(f[1]);return V!==0?V:f[1].localeCompare(R[1],Es(),{sensitivity:"base"})}).map(([,f])=>f),S=Je(v);return S&&!m.has(S)?[v,...$]:$},[A,v]),H=a.useMemo(()=>{let m=A;if(v){const S=Je(v);m=m.filter(f=>Je(f?.resolution)===S)}N==="missing"&&(m=m.filter(S=>!S.posterUrl));const $=[...m];if(N==="list"||N==="banner"){const S=u==="asc"?1:-1,f=g=>String(g.titleClean||g.title||"").toLowerCase(),R=g=>String(s.get(Number(g.sourceId))||"").toLowerCase(),V=g=>String(g.unifiedCategoryLabel||"").toLowerCase(),X=g=>xt(g),U=g=>jr(g?.resolution),D=g=>String(g.codec||"").toLowerCase(),Z=g=>Number(g.sizeBytes||g.size_bytes||0);$.sort((g,G)=>{let Q,Y;return y==="title"?(Q=f(g),Y=f(G)):y==="source"?(Q=R(g),Y=R(G)):y==="category"?(Q=V(g),Y=V(G)):y==="episode"?(Q=X(g),Y=X(G)):y==="quality"?(Q=U(g),Y=U(G)):y==="codec"?(Q=D(g),Y=D(G)):y==="size"?(Q=Z(g),Y=Z(G)):y==="seeders"?(Q=Number(g.seeders||0),Y=Number(G.seeders||0)):y==="downloads"?(Q=Number(g.grabs||0),Y=Number(G.grabs||0)):(Q=Number(g.publishedAt||0),Y=Number(G.publishedAt||0)),Q<Y?-1*S:Q>Y?1*S:0})}else P==="seeders"?$.sort((S,f)=>Number(f.seeders||0)-Number(S.seeders||0)):P==="downloads"?$.sort((S,f)=>Number(f.grabs||0)-Number(S.grabs||0)):$.sort((S,f)=>Number(f.publishedAt||0)-Number(S.publishedAt||0));return $},[A,v,N,y,u,P,s]),E=a.useMemo(()=>{if(M==="all")return H||[];const m=Math.max(1,Number(M)||100);return(H||[]).slice(0,m)},[H,M]),q=a.useMemo(()=>{const m=new Map;(I||[]).forEach(f=>{const R=f.unifiedCategoryKey;R&&(m.has(R)||m.set(R,f.unifiedCategoryLabel||R))}),i&&!m.has(i)&&m.set(i,i);const $=ws.filter(f=>m.has(f.key)).map(f=>({key:f.key,label:m.get(f.key)||f.label})),S=Array.from(m.keys()).filter(f=>!ws.some(R=>R.key===f)).map(f=>({key:f,label:m.get(f)||f}));return $.concat(S)},[I,i]);return{filtered:H,qualityOptions:F,visibleItems:E,categoriesForDropdown:q}}function Lt({items:t,onDownload:s,onOpen:i,selectionMode:d,selectedIds:v,onToggleSelect:k,onRename:P,sortBy:o,sourceNameById:_,sourceColorById:N,sourceId:y,arrStatusMap:u,integrationMode:M,cardSize:c}){const I=c?{gridTemplateColumns:`repeat(auto-fill, minmax(${Math.round(c)}px, 1fr))`,"--card-scale":c/190}:void 0;return e.jsx("div",{className:"grid",style:I,children:t.map(A=>e.jsx(it,{item:A,onDownload:s,onOpen:i,selectionMode:d,selected:v.has(A.id),onToggleSelect:k,onRename:P,sortBy:o,indexerLabel:_.get(Number(A.sourceId))||"",indexerColor:N.get(Number(A.sourceId))||null,showIndexerPill:!y,indexerPillPosition:"left",integrationMode:M,arrStatus:u[A.id]},A.id))})}function Mt({items:t,selectionMode:s,selectedIds:i,onToggleSelect:d,onOpen:v,onRename:k,listSortBy:P,listSortDir:o,onToggleSort:_,sourceNameById:N,sourceColorById:y,getUnifiedLabel:u}){const M=c=>`library-sort ${P===c?"is-active":""}${P===c&&o==="desc"?" is-desc":""}`;return e.jsxs("div",{className:"library-table",children:[e.jsxs("div",{className:"library-thead",children:[e.jsx("div",{className:"library-cell library-cell--select"}),e.jsxs("button",{type:"button",className:M("title"),onClick:()=>_("title"),children:[e.jsx("span",{className:"library-sort__label",children:"Titre"}),e.jsx(se,{name:o==="desc"?"arrow_downward":"arrow_upward",className:"library-sort__icon"})]}),e.jsxs("button",{type:"button",className:M("category"),onClick:()=>_("category"),children:[e.jsx("span",{className:"library-sort__label",children:"Catégorie"}),e.jsx(se,{name:o==="desc"?"arrow_downward":"arrow_upward",className:"library-sort__icon"})]}),e.jsxs("button",{type:"button",className:M("episode"),onClick:()=>_("episode"),children:[e.jsx("span",{className:"library-sort__label",children:"Episode"}),e.jsx(se,{name:o==="desc"?"arrow_downward":"arrow_upward",className:"library-sort__icon"})]}),e.jsxs("button",{type:"button",className:M("quality"),onClick:()=>_("quality"),children:[e.jsx("span",{className:"library-sort__label",children:"Qualité"}),e.jsx(se,{name:o==="desc"?"arrow_downward":"arrow_upward",className:"library-sort__icon"})]}),e.jsxs("button",{type:"button",className:M("codec"),onClick:()=>_("codec"),children:[e.jsx("span",{className:"library-sort__label",children:"Codec"}),e.jsx(se,{name:o==="desc"?"arrow_downward":"arrow_upward",className:"library-sort__icon"})]}),e.jsxs("button",{type:"button",className:M("size"),onClick:()=>_("size"),children:[e.jsx("span",{className:"library-sort__label",children:"Taille"}),e.jsx(se,{name:o==="desc"?"arrow_downward":"arrow_upward",className:"library-sort__icon"})]}),e.jsxs("button",{type:"button",className:M("date"),onClick:()=>_("date"),children:[e.jsx("span",{className:"library-sort__label",children:"Date d'ajout"}),e.jsx(se,{name:o==="desc"?"arrow_downward":"arrow_upward",className:"library-sort__icon"})]}),e.jsxs("button",{type:"button",className:M("seeders"),onClick:()=>_("seeders"),children:[e.jsx("span",{className:"library-sort__label",children:"Seeders"}),e.jsx(se,{name:o==="desc"?"arrow_downward":"arrow_upward",className:"library-sort__icon"})]}),e.jsxs("button",{type:"button",className:M("downloads"),onClick:()=>_("downloads"),children:[e.jsx("span",{className:"library-sort__label",children:"Téléchargé"}),e.jsx(se,{name:o==="desc"?"arrow_downward":"arrow_upward",className:"library-sort__icon"})]}),e.jsxs("button",{type:"button",className:M("source"),onClick:()=>_("source"),children:[e.jsx("span",{className:"library-sort__label",children:"Indexeur"}),e.jsx(se,{name:o==="desc"?"arrow_downward":"arrow_upward",className:"library-sort__icon"})]}),e.jsx("div",{className:"library-cell library-cell--edit"})]}),t.map(c=>e.jsxs("div",{className:`library-trow${i.has(c.id)?" is-selected":""}`,onClick:()=>{s?d(c):v(c)},children:[e.jsx("div",{className:"library-cell library-cell--select",children:s&&e.jsx("button",{type:"button",className:`list-select${i.has(c.id)?" is-on":""}`,onClick:I=>{I.stopPropagation(),d(c)},title:i.has(c.id)?"Retirer":"Selectionner",children:e.jsx(se,{name:i.has(c.id)?"check_box":"check_box_outline_blank"})})}),e.jsx("div",{className:"library-cell",children:c.titleClean||c.title||"-"}),e.jsx("div",{className:"library-cell",children:(()=>{const I=u(c);if(!I)return"-";const A=c?.unifiedCategoryKey||"unknown";return e.jsx("span",{className:`cat-bubble cat-bubble--${A}`,children:I})})()}),e.jsx("div",{className:"library-cell",children:Cr(c)&&Us(c)||"-"}),e.jsx("div",{className:"library-cell",children:c.resolution?e.jsx("div",{className:"library-quality",children:e.jsx("span",{className:`banner-pill ${_t(c.resolution)}`,children:c.resolution})}):"-"}),e.jsx("div",{className:"library-cell",children:c.codec?e.jsx("div",{className:"library-quality",children:e.jsx("span",{className:"banner-pill",children:c.codec})}):"-"}),e.jsx("div",{className:"library-cell",children:bt(c.sizeBytes||c.size_bytes||0)||"-"}),e.jsx("div",{className:"library-cell",children:c.date||"-"}),e.jsx("div",{className:"library-cell",children:c.seeders??"-"}),e.jsx("div",{className:"library-cell",children:c.grabs??"-"}),e.jsx("div",{className:"library-cell",children:(()=>{const I=N.get(Number(c.sourceId))||"";if(!I)return"-";const A=$s(I),F=_r(y?.get(Number(c.sourceId))||null);return e.jsx("span",{className:`banner-pill banner-pill--indexer${A?` ${A}`:""}`,style:F||void 0,children:I})})()}),e.jsx("div",{className:"library-cell library-cell--edit",children:!s&&e.jsx("button",{type:"button",className:"list-edit",title:"Renommer",onClick:I=>{I.stopPropagation(),k(c)},children:e.jsx(se,{name:"edit"})})})]},c.id))]})}function Et({items:t,selectionMode:s,selectedIds:i,onToggleSelect:d,onOpen:v,sourceNameById:k,sourceColorById:P}){return e.jsx("div",{className:"library-banner",children:t.map(o=>{const _=Us(o),N=o.resolution||"",y=[_,o.year?String(o.year):""].filter(Boolean),u=[N,o.source||"",o.codec||"",o.releaseGroup||""].filter(Boolean),M=N?`banner-pill banner-pill--${String(N).toLowerCase().includes("2160")||String(N).toLowerCase().includes("4k")?"4k":String(N).toLowerCase().includes("1080")?"1080":String(N).toLowerCase().includes("720")?"720":"default"}`:"banner-pill",c=ft(o),I=[c?{label:"Taille",value:c}:null,o.date?{label:"Date",value:o.date}:null,o.seeders!=null?{label:"Seeders",value:String(o.seeders)}:null,o.grabs!=null?{label:"Telecharg",value:String(o.grabs)}:null].filter(Boolean),A=k.get(Number(o.sourceId))||"",F=$s(A),H=_r(P?.get(Number(o.sourceId))||null),E=String(o?.overview||o?.synopsis||o?.description||o?.plot||o?.summary||"").trim(),q=yt(o);return e.jsxs("div",{className:`banner-row${i.has(o.id)?" is-selected":""}`,onClick:()=>{s?d(o):v(o)},children:[e.jsx("div",{className:"banner-poster",children:o.posterUrl?e.jsx("img",{src:at(`/api/posters/banner/${o.id}`),alt:o.title||"",loading:"lazy"}):e.jsx("div",{className:"banner-fallback",children:"??"})}),e.jsxs("div",{className:"banner-meta",children:[e.jsxs("div",{className:"banner-head",children:[e.jsx("div",{className:"banner-title",children:o.titleClean||o.title||"-"}),q?e.jsx("div",{className:"banner-type",children:q}):null]}),y.length>0||u.length>0||E?e.jsxs("div",{className:`banner-content${E?" has-overview":""}`,children:[e.jsxs("div",{className:"banner-details",children:[y.length>0?e.jsx("div",{className:"banner-sub",children:y.map((m,$)=>e.jsx("span",{className:m===_?"banner-pill banner-pill--episode":void 0,children:m},`${m}-${$}`))}):null,u.length>0?e.jsx("div",{className:"banner-sub",children:u.map((m,$)=>e.jsx("span",{className:m===N?M:"banner-pill",children:m},`${m}-${$}`))}):null]}),E?e.jsxs("div",{className:"banner-overview",title:E,children:[e.jsx("div",{className:"banner-overview__title",children:"Synopsis"}),e.jsx("div",{className:"banner-overview__text",children:E})]}):null]}):null,I.length>0||A?e.jsxs("div",{className:"banner-bottom",children:[I.length>0?e.jsx("div",{className:"banner-foot",children:I.map(m=>e.jsxs("span",{children:[m.label,": ",e.jsx("strong",{children:m.value})]},`${m.label}-${m.value}`))}):null,A?e.jsx("div",{className:"banner-indexer",children:e.jsx("span",{className:`banner-pill banner-pill--indexer${F?` ${F}`:""}`,style:H||void 0,children:A})}):null]}):null]})]},o.id)})})}function Rt({item:t,onOpen:s,selectionMode:i,selected:d,onToggleSelect:v,onRename:k,indexerLabel:P,indexerColor:o,showIndexerPill:_,integrationMode:N,arrStatus:y}){const u=Rs(N),M=a.useMemo(()=>t.titleClean?.trim()?t.titleClean:t.title,[t.titleClean,t.title]),c=t.posterUrl||(t.id?`/api/posters/release/${t.id}`:""),{posterSrc:I,imgError:A,handleImageError:F,handleImageLoad:H}=ot(t.id,c),E=String(P||"").trim(),q=_&&E,m=Ut(E),$=a.useMemo(()=>_r(o),[o]),S=String(t?.posterLastError||"").toLowerCase(),f=!!S&&S!=="pending",R=!!t?.posterUrl&&!!I&&!A,V=!R&&S==="pending",X=!R&&f,U=!R&&!V&&!X;let D=null,Z=null;if(!i&&y){if(u==="overseerr"&&y.inOverseerr)D="overseerr",Z=y.overseerrUrl||null;else if(u==="jellyseerr"&&y.inJellyseerr)D="jellyseerr",Z=y.jellyseerrUrl||null;else if(u==="seer"&&y.inSeer)D="seer",Z=y.seerUrl||null;else if(u==="arr"&&(y.inSonarr||y.inRadarr)){const g=!!y.inSonarr;D=g?"sonarr":"radarr",Z=g?y.sonarrUrl||null:y.radarrUrl||null}}return e.jsxs("div",{className:"posterViewCard"+(d?" posterViewCard--selected":""),onClick:()=>{i?v?.(t):s?.(t)},style:i||s?{cursor:"pointer"}:void 0,title:i?"Cliquer pour sélectionner":M||"",children:[R?e.jsx("img",{src:I,alt:M||"",loading:"lazy",onError:F,onLoad:H}):e.jsx("div",{className:"posterFallback",children:V?e.jsx("div",{className:"posterLoader"}):X?e.jsx(Ps,{className:"posterFallback__icon"}):U?e.jsx(ht,{className:"posterFallback__icon"}):null}),q?e.jsx("div",{className:"posterIndexerPill posterIndexerPill--left",children:e.jsx("span",{className:`banner-pill banner-pill--indexer${m?` ${m}`:""}`,style:$||void 0,children:E})}):null,D?(()=>{const g=pt(D),G=`posterArrBadge posterArrBadge--${D}`+(Z?" posterArrBadge--link":"");return Z?e.jsxs("a",{href:Z,target:"_blank",rel:"noopener noreferrer",className:G,onClick:Q=>Q.stopPropagation(),title:`Ouvrir dans ${g}`,children:[e.jsx(xs,{className:"posterArrBadge__icon"}),e.jsx("span",{className:"posterArrBadge__label",children:g})]}):e.jsxs("div",{className:G,children:[e.jsx(xs,{className:"posterArrBadge__icon"}),e.jsx("span",{className:"posterArrBadge__label",children:g})]})})():null,!i&&k&&e.jsx("button",{type:"button",className:"posterRenameBtn",title:"Renommer",onClick:g=>{g.stopPropagation(),k?.(t)},children:e.jsx(se,{name:"edit"})}),i&&e.jsx("div",{className:"selectBadge"+(d?" on":""),children:d?e.jsx(se,{name:"check"}):""}),e.jsxs("div",{className:`posterViewOverlay${D?" posterViewOverlay--has-badge":""}`,children:[e.jsx("div",{className:"posterViewOverlay__title",children:M}),e.jsx("div",{className:"posterViewOverlay__meta",children:e.jsx("span",{children:t.date||"-"})}),e.jsx("div",{className:"posterViewOverlay__meta",children:e.jsxs("span",{children:["Download: ",t.grabs??0]})})]})]})}function Tt(t){return String(t||"").toUpperCase().replace(/[^A-Z0-9]/g,"")}function Ut(t){const s=Tt(t);return s==="YGEGE"?"banner-pill--indexer-ygege":s==="C411"?"banner-pill--indexer-c411":s==="TOS"?"banner-pill--indexer-tos":s==="LACALE"?"banner-pill--indexer-lacale":""}function Pt({items:t,onOpen:s,selectionMode:i,selectedIds:d,onToggleSelect:v,onRename:k,sourceNameById:P,sourceColorById:o,sourceId:_,arrStatusMap:N,integrationMode:y,cardSize:u}){const M=u?{gridTemplateColumns:`repeat(auto-fill, minmax(${Math.round(u)}px, 1fr))`,"--card-scale":u/180}:void 0;return e.jsx("div",{className:"grid grid--poster",style:M,children:t.map(c=>e.jsx(Rt,{item:c,onOpen:s,selectionMode:i,selected:d.has(c.id),onToggleSelect:v,onRename:k,indexerLabel:P.get(Number(c.sourceId))||"",indexerColor:o.get(Number(c.sourceId))||null,showIndexerPill:!_,integrationMode:y,arrStatus:N[c.id]},c.id))})}function ge({icon:t,label:s,value:i,onChange:d,children:v,title:k,active:P,className:o=""}){return e.jsxs("div",{className:`subdropdown${P?" is-active":""}${o?` ${o}`:""}`,title:k||s,children:[t?e.jsx(se,{name:t,className:"subdropdown__icon"}):null,e.jsx("span",{className:"subdropdown__label",children:s}),e.jsx("span",{className:"subdropdown__caret",children:"▾"}),e.jsx("select",{className:"subdropdown__select",value:i,onChange:d,"aria-label":s,children:v})]})}function Ft({selectionMode:t,selectedIds:s,onToggleSelectionMode:i,onSelectAll:d,posterAutoLoading:v,onBulkFetchPosters:k,onOpenManualPoster:P,onBulkSetSeen:o,sortBy:_,maxAgeDays:N,setMaxAgeDays:y,seen:u,setSeen:M,applicationId:c,setApplicationId:I,quality:A,setQuality:F,qualityOptions:H,filtersOpen:E,setFiltersOpen:q,installedApps:m,sources:$,enabledSources:S,sourceId:f,setSourceId:R,uiSettings:V,categoryId:X,setCategoryId:U,categoriesForDropdown:D,setSortBy:Z,viewMode:g,setViewMode:G,viewOptions:Q,limit:Y,setLimit:_e,defaultSort:Ue="date",defaultMaxAgeDays:we="",defaultLimit:Pe=100}){const Ie=(m||[]).length>0,Fe=!t&&E;return e.jsxs("div",{className:"library-subbar-stack",children:[e.jsxs("div",{className:"library-subbar-main",children:[e.jsx(Ne,{icon:t?"close":"check_circle",label:t?"Cancel":"Select",active:t,className:"subaction--select",onClick:i}),!t&&e.jsx("div",{className:"subdivider library-subbar__select-mobile-sep"}),t&&s.size>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"subaction-group subaction-group--select",children:[e.jsx(Ne,{icon:v?"progress_activity":"image",label:"Poster Auto",onClick:k,className:"subaction--select",disabled:v}),e.jsx(Ne,{icon:"search",label:"Poster Manuel",onClick:P,className:"subaction--select",disabled:s.size!==1,title:s.size!==1?"Sélectionner une seule carte":"Poster manuel"})]}),e.jsxs("div",{className:"subaction-group subaction-group--select",children:[e.jsx(Ne,{icon:"visibility",label:"Seen",onClick:()=>o(!0),className:"subaction--select"}),e.jsx(Ne,{icon:"visibility_off",label:"Unseen",onClick:()=>o(!1),className:"subaction--select"})]}),e.jsx("div",{className:"subdivider library-subbar__selection-sep"})]}),t&&e.jsx(Ne,{icon:"select_all",label:"Select all",onClick:d,className:"subaction--select"}),e.jsx("div",{className:"subspacer"}),!t&&e.jsx(Ne,{icon:"filter_list",label:"Filtre",active:E,onClick:()=>q(h=>!h)}),e.jsxs(ge,{icon:"sort",label:"Tri",value:_,active:_!==Ue,onChange:h=>Z(h.target.value),title:"Tri",children:[e.jsx("option",{value:"date",children:"Date"}),e.jsx("option",{value:"seeders",children:"Seeders"}),e.jsx("option",{value:"downloads",children:"Téléchargé"})]}),e.jsx(ge,{icon:"view_module",label:"Vue",value:g,onChange:h=>G(h.target.value),title:"Vue",children:Q.map(h=>e.jsx("option",{value:h.value,children:h.label},h.value))}),e.jsxs(ge,{icon:"format_list_numbered",label:"Limit",value:Y,active:String(Y)!==String(Pe),onChange:h=>{const te=h.target.value;_e(te==="all"?"all":Number(te))},title:"Limit",children:[e.jsx("option",{value:50,children:"50"}),e.jsx("option",{value:100,children:"100"}),e.jsx("option",{value:200,children:"200"}),e.jsx("option",{value:500,children:"500"}),e.jsx("option",{value:"all",children:"Tous"})]})]}),Fe&&e.jsxs("div",{className:"library-filterbar",children:[e.jsxs(ge,{icon:"event",label:"Date",value:N,active:String(N||"")!==String(we??""),onChange:h=>y(h.target.value),title:"Date",children:[e.jsx("option",{value:"",children:"Tous"}),e.jsx("option",{value:"1",children:"1 jour"}),e.jsx("option",{value:"2",children:"2 jours"}),e.jsx("option",{value:"3",children:"3 jours"}),e.jsx("option",{value:"7",children:"7 jours"}),e.jsx("option",{value:"15",children:"15 jours"}),e.jsx("option",{value:"30",children:"30 jours"})]}),e.jsx("div",{className:"subspacer"}),$.length>0?e.jsxs(ge,{icon:"storage",label:"Source",value:f,active:!!f,onChange:h=>R(h.target.value),children:[e.jsx("option",{value:"",children:"Toutes sources"}),S.map(h=>{const te=h.id??h.sourceId,je=h.name??h.title??`Source ${te}`;return e.jsx("option",{value:String(te),children:je},te)})]}):e.jsxs("div",{className:"subsearch",children:[e.jsx("span",{style:{opacity:.75},children:"#"}),e.jsx("input",{value:f,onChange:h=>R(h.target.value),placeholder:"SourceId","aria-label":"Filtrer par identifiant de source",style:{width:110}})]}),V?.showCategories!==!1&&e.jsxs(ge,{icon:"category",label:"Catégorie",value:X,active:!!X,onChange:h=>U(h.target.value),children:[e.jsx("option",{value:"",children:"Toutes catégories"}),D.map(h=>e.jsx("option",{value:h.key,children:h.label},h.key))]}),Ie&&e.jsxs(ge,{icon:"video_library",label:"Application",value:c,active:!!c,className:"subdropdown--wide",onChange:h=>I(h.target.value),children:[e.jsx("option",{value:"",children:"Toutes apps"}),e.jsx("option",{value:"__hide_apps__",children:"Masquer apps"}),(m||[]).map(h=>{const te=h.id??h.appId,je=String(h.type||"app").toLowerCase(),$e=h.name||h.title||`${je} ${te}`;return e.jsx("option",{value:String(te),children:$e},String(te))})]}),e.jsxs(ge,{icon:"visibility",label:"Vu",value:u,active:!!u,onChange:h=>M(h.target.value),children:[e.jsx("option",{value:"",children:"Tous"}),e.jsx("option",{value:"1",children:"Vu"}),e.jsx("option",{value:"0",children:"Pas vu"})]}),e.jsxs(ge,{icon:"military_tech",label:"Qualité",value:A,active:!!A,onChange:h=>F(h.target.value),children:[e.jsx("option",{value:"",children:"Toutes qualités"}),(H||[]).map(h=>e.jsx("option",{value:h,children:h},h))]})]})]})}function $t({open:t,onClose:s,renameValue:i,setRenameValue:d,renameOriginal:v,onSave:k}){const P="rename-release-input";return e.jsx(Fs,{open:t,title:"Renommer",onClose:s,width:520,children:e.jsxs("form",{onSubmit:k,style:{padding:12},children:[e.jsxs("div",{className:"field",style:{marginBottom:12},children:[e.jsx("label",{className:"muted",children:"Titre original"}),e.jsx("div",{className:"rename-original",style:{padding:"4px 0"},children:v||"—"})]}),e.jsxs("div",{className:"field",style:{marginBottom:12},children:[e.jsx("label",{className:"muted",htmlFor:P,children:"Nouveau titre"}),e.jsx("input",{id:P,value:i,onChange:o=>d(o.target.value),placeholder:"Titre","aria-label":"Nouveau titre",autoFocus:!0})]}),e.jsxs("div",{className:"formactions",children:[e.jsx("button",{className:"btn",type:"submit",children:"Enregistrer"}),e.jsx("button",{className:"btn",type:"button",onClick:s,children:"Annuler"})]})]})})}function Ot({open:t,onClose:s,query:i,setQuery:d,results:v,loading:k,error:P,onSearch:o,onApply:_,mediaType:N}){const y=u=>{u.preventDefault(),o(i,N)};return e.jsx(Fs,{open:t,title:"Poster manuel",onClose:s,width:820,children:e.jsxs("div",{style:{padding:12},children:[e.jsxs("form",{onSubmit:y,className:"posterManualSearch",children:[e.jsx("input",{value:i,onChange:u=>d(u.target.value),placeholder:"Rechercher un titre...","aria-label":"Titre à rechercher pour le poster",autoFocus:!0}),e.jsx("button",{className:"btn",type:"submit",disabled:k,children:k?"Recherche…":"Rechercher"})]}),P&&e.jsx("div",{className:"errorbox",style:{marginTop:10},children:P}),e.jsxs("div",{className:"posterManualResults",children:[v.map((u,M)=>{const c=String(u?.provider||"tmdb").toUpperCase(),I=String(u?.posterLang||u?.lang||"").toUpperCase(),A=Nr(u),F=!u?.posterPath&&!u?.posterUrl,H=[c?{key:"provider",label:c}:null,I?{key:"lang",label:I}:null,A?{key:"size",label:A}:null].filter(Boolean);return e.jsxs("button",{type:"button",className:`posterManualResult${F?" posterManualResult--disabled":""}`,onClick:()=>{F||_(u)},"aria-label":F?`Poster indisponible pour ${u.title||"ce titre"}`:`Appliquer le poster ${u.title||""}`.trim(),title:F?`Aucun poster disponible sur ${c}`:"Appliquer ce poster",disabled:F,children:[u.posterUrl?e.jsx("img",{src:u.posterUrl,alt:u.title||"",loading:"lazy"}):e.jsx("div",{className:"posterManualFallback",children:e.jsx(Ps,{className:"posterManualFallback__icon"})}),e.jsxs("div",{className:"posterManualMeta",children:[e.jsx("div",{className:"posterManualTitle",children:u.title||"—"}),H.length>0?e.jsx("div",{className:"posterManualBadges",children:H.map(E=>e.jsx("span",{className:`posterBadge posterBadge--${E.key}`,children:E.label},`${E.key}-${E.label}`))}):null,e.jsxs("div",{className:"posterManualSub",children:[u.year?e.jsx("span",{children:u.year}):null,u.mediaType?e.jsx("span",{children:u.mediaType}):null]})]})]},`${u.provider||"tmdb"}-${u.igdbId??u.tmdbId??"0"}-${u.posterPath||u.posterUrl||"noposter"}-${M}`)}),!k&&v.length===0&&e.jsx("div",{className:"muted",style:{padding:12},children:"Aucun résultat."})]})]})})}const zt={loading:!0,err:"",selectedItem:null,posterAutoLoading:!1,renameOpen:!1,renameValue:"",renameTarget:null,renameOriginal:"",manualOpen:!1,manualQuery:"",manualMediaType:"",manualResults:[],manualLoading:!1,manualErr:"",manualTarget:null};function Bt(t,s){switch(s.type){case"set_loading":return{...t,loading:!!s.payload};case"set_err":return{...t,err:s.payload||""};case"set_selected_item":return{...t,selectedItem:typeof s.payload=="function"?s.payload(t.selectedItem):s.payload};case"set_poster_auto_loading":return{...t,posterAutoLoading:!!s.payload};case"set_rename_open":return{...t,renameOpen:!!s.payload};case"set_rename_value":return{...t,renameValue:s.payload||""};case"set_rename_target":return{...t,renameTarget:s.payload||null};case"set_rename_original":return{...t,renameOriginal:s.payload||""};case"set_manual_open":return{...t,manualOpen:!!s.payload};case"set_manual_query":return{...t,manualQuery:s.payload||""};case"set_manual_media_type":return{...t,manualMediaType:s.payload||""};case"set_manual_results":return{...t,manualResults:Array.isArray(s.payload)?s.payload:[]};case"set_manual_loading":return{...t,manualLoading:!!s.payload};case"set_manual_err":return{...t,manualErr:s.payload||""};case"set_manual_target":return{...t,manualTarget:s.payload||null};default:return t}}function ea(){const[t,s]=a.useReducer(Bt,zt),i=t.loading,d=t.err,v=t.selectedItem,k=t.posterAutoLoading,P=t.renameOpen,o=t.renameValue,_=t.renameTarget,N=t.renameOriginal,y=t.manualOpen,u=t.manualQuery,M=t.manualMediaType,c=t.manualResults,I=t.manualLoading,A=t.manualErr,F=t.manualTarget,H=a.useCallback(r=>{s({type:"set_loading",payload:r})},[]),E=a.useCallback(r=>{s({type:"set_err",payload:r})},[]),q=a.useCallback(r=>{s({type:"set_selected_item",payload:r})},[]),m=a.useCallback(r=>{s({type:"set_poster_auto_loading",payload:r})},[]),$=a.useCallback(r=>{s({type:"set_rename_open",payload:r})},[]),S=a.useCallback(r=>{s({type:"set_rename_value",payload:r})},[]),f=a.useCallback(r=>{s({type:"set_rename_target",payload:r})},[]),R=a.useCallback(r=>{s({type:"set_rename_original",payload:r})},[]),V=a.useCallback(r=>{s({type:"set_manual_open",payload:r})},[]),X=a.useCallback(r=>{s({type:"set_manual_query",payload:r})},[]),U=a.useCallback(r=>{s({type:"set_manual_media_type",payload:r})},[]),D=a.useCallback(r=>{s({type:"set_manual_results",payload:r})},[]),Z=a.useCallback(r=>{s({type:"set_manual_loading",payload:r})},[]),g=a.useCallback(r=>{s({type:"set_manual_err",payload:r})},[]),G=a.useCallback(r=>{s({type:"set_manual_target",payload:r})},[]),Q=nt(),Y=20,_e=95,Ue=285,we=90,Pe=270,[Ie,Fe]=a.useState(()=>{const r=Number(localStorage.getItem("feedarr.library.cardSize.grid"));return Number.isFinite(r)&&r>=Y&&r<=100?r:50}),[h,te]=a.useState(()=>{const r=Number(localStorage.getItem("feedarr.library.cardSize.poster"));return Number.isFinite(r)&&r>=Y&&r<=100?r:50}),je=_e+Ie/100*(Ue-_e),$e=we+h/100*(Pe-we),x=a.useCallback(r=>{const l=Number(r.target.value);Fe(l),localStorage.setItem("feedarr.library.cardSize.grid",String(l))},[]),B=a.useCallback(r=>{const l=Number(r.target.value);te(l),localStorage.setItem("feedarr.library.cardSize.poster",String(l))},[]),[J,ae]=a.useState([]),W=a.useMemo(()=>(J||[]).filter(r=>Number(r.enabled??1)===1),[J]),w=wt(J,W),ke=It(),{apps:Oe,hasSonarr:oe,hasRadarr:ne,hasOverseerr:de,hasJellyseerr:ue,hasSeer:me,integrationMode:ze}=ct({pollMs:12e4}),ir=Rs(ze),Ae=a.useMemo(()=>(Oe||[]).filter(r=>r&&r.id!=null&&r.isEnabled!==!1&&r.hasApiKey!==!1).sort((r,l)=>String(r.name||r.title||"").localeCompare(String(l.name||l.title||""),Es(),{sensitivity:"base"})),[Oe]),[Le,Be]=a.useState({}),or=a.useRef(new Map),qe=a.useRef(null),Ke=a.useRef(0),Ve=a.useRef(null),cr=a.useRef(0),[pe,fe]=a.useState([]),De=a.useRef({attempts:0,timer:null}),Ge=a.useRef({inFlight:!1,lastFingerprint:""}),Ye=a.useRef(new Set),wr=a.useRef([]),Me=a.useMemo(()=>{const r=new Map;return(J||[]).forEach(l=>{const n=Number(l.id??l.sourceId);Number.isFinite(n)&&r.set(n,l.name??l.title??`Source ${n}`)}),r},[J]),Qe=a.useMemo(()=>{const r=new Map;return(J||[]).forEach(l=>{const n=Number(l.id??l.sourceId);Number.isFinite(n)&&r.set(n,mt(n,l.color))}),r},[J]);a.useEffect(()=>{const r=or.current,l=Ye.current,n=De.current;return()=>{r.clear(),l.clear(),Ve.current&&Ve.current.abort(),n.timer&&clearTimeout(n.timer)}},[]),a.useEffect(()=>{(async()=>{const r=await lr(()=>Te("/api/sources"),{context:"Failed to load sources for library page"});Array.isArray(r)&&ae(r)})()},[]);const Ir=a.useCallback((r,l)=>{if(!oe&&!ne&&!de&&!ue&&!me)return{};const n={};return(r||[]).forEach(b=>{const j=l?.[b.id],C=oe&&(j?.inSonarr||b?.isInSonarr),T=ne&&(j?.inRadarr||b?.isInRadarr),L=de&&!!j?.inOverseerr,K=ue&&!!j?.inJellyseerr,O=me&&!!j?.inSeer;!C&&!T&&!L&&!K&&!O||(n[b.id]={inSonarr:C,inRadarr:T,inOverseerr:L,inJellyseerr:K,inSeer:O,sonarrUrl:C&&(j?.sonarrUrl||b?.sonarrUrl)||null,radarrUrl:T&&(j?.radarrUrl||b?.radarrUrl)||null,overseerrUrl:L&&j?.overseerrUrl||null,jellyseerrUrl:K&&j?.jellyseerrUrl||null,seerUrl:O&&j?.seerUrl||null})}),n},[oe,ne,de,ue,me]),Xe=a.useCallback(async()=>{Ve.current&&Ve.current.abort();const r=new AbortController;Ve.current=r;const l=++cr.current,n=()=>cr.current===l&&!r.signal.aborted;De.current.timer&&(clearTimeout(De.current.timer),De.current.timer=null),E("");const b=w.limit==="all"?500:Math.max(1,Number(w.limit)||100),j=w.limit==="all"?1500:Math.min(b*3,1500),C=Number(w.sourceId);H(!0);try{if(!Number.isFinite(C)||C<=0){if(W.length===0){n()&&fe([]);return}const T=new URLSearchParams;T.set("limit",String(j)),w.seen&&T.set("seen",w.seen);const L=await Promise.allSettled(W.map(async O=>{const z=O.id??O.sourceId;if(!z)return[];const ie=await Te(`/api/feed/${z}?${T.toString()}`,{signal:r.signal});return Array.isArray(ie)?ie.map(p=>({...p,sourceId:p.sourceId??z})):[]}));if(!n())return;const K=L.filter(O=>O.status==="fulfilled").flatMap(O=>O.value).map(O=>({...O,size:hs(O.sizeBytes),date:gs(O.publishedAt)}));K.sort((O,z)=>Number(z.publishedAt||0)-Number(O.publishedAt||0)),n()&&fe(K)}else{const T=new URLSearchParams;T.set("limit",String(j)),w.q.trim()&&T.set("q",w.q.trim()),w.seen&&T.set("seen",w.seen);const L=await Te(`/api/feed/${C}?${T.toString()}`,{signal:r.signal});if(!n())return;const K=(Array.isArray(L)?L:[]).map(O=>({...O,sourceId:O.sourceId??C,size:hs(O.sizeBytes),date:gs(O.publishedAt)}));n()&&fe(K)}}catch(T){if(T?.name==="AbortError"||!n())return;E(T?.message||"Erreur chargement feed"),fe([])}finally{cr.current===l&&H(!1)}},[w.sourceId,W,w.limit,w.q,w.seen,E,H]);a.useEffect(()=>{De.current.attempts=0,Xe()},[Xe]),a.useEffect(()=>{if(!pe||pe.length===0){Be({});return}Be(r=>Ir(pe,r))},[pe,oe,ne,de,ue,me,Ir]);const kr=a.useCallback(async r=>{if(!(oe||ne)&&!de&&!ue&&!me||!r||r.length===0)return;const C=Date.now(),T=r.filter(z=>{const ie=z.tmdbId||z.tvdbId,p=z.titleClean?.trim()||z.title?.trim();if(!ie&&!p)return!1;const ee=Number(z.arrCheckedAtTs||0);if(!(!Number.isFinite(ee)||ee<=0||C-ee*1e3>=Is))return!1;const nr=or.current.get(z.id);return!(nr&&C-nr<Is)});if(T.length===0)return;qe.current&&qe.current.abort();const L=new AbortController;qe.current=L;const K=++Ke.current,O=[];for(let z=0;z<T.length;z+=ks)O.push(T.slice(z,z+ks));await lr(async()=>{const z={};for(const ie of O){if(L.signal.aborted||Ke.current!==K)return;const p=ie.map(be=>({releaseId:be.id,tvdbId:be.tvdbId||null,tmdbId:be.tmdbId||null,mediaType:Cr(be)?"series":"movie",title:be.titleClean?.trim()||be.title?.trim()||null})),ee=await ve("/api/arr/status",{items:p},{signal:L.signal});if(Ke.current!==K)return;if(ee?.results&&Array.isArray(ee.results)){const be=Date.now();ie.forEach(re=>or.current.set(re.id,be));const nr=new Map(ie.map(re=>[re.id,re]));ee.results.forEach(re=>{const yr=Number(re?.releaseId||0);if(!Number.isFinite(yr)||yr<=0)return;const fs=nr.get(yr);if(!fs)return;const gr=oe&&!!re.inSonarr,hr=ne&&!!re.inRadarr,xr=de&&!!re.inOverseerr,vr=ue&&!!re.inJellyseerr,Sr=me&&!!re.inSeer;(re.exists||gr||hr||xr||vr||Sr)&&(z[fs.id]={inSonarr:gr,inRadarr:hr,inOverseerr:xr,inJellyseerr:vr,inSeer:Sr,sonarrUrl:gr&&re.sonarrUrl||null,radarrUrl:hr&&re.radarrUrl||null,overseerrUrl:xr&&re.overseerrUrl||null,jellyseerrUrl:vr&&re.jellyseerrUrl||null,seerUrl:Sr&&re.seerUrl||null})})}}Ke.current===K&&Object.keys(z).length>0&&Be(ie=>({...ie,...z}))},{context:"Failed to refresh Arr status batch in library",ignoreAbort:!0})},[oe,ne,de,ue,me]);a.useEffect(()=>{if(!(i||!(oe||ne)&&!de&&!ue&&!me))return kr(pe||[]),()=>{qe.current&&qe.current.abort()}},[pe,i,oe,ne,de,ue,me,kr]);const Os=a.useCallback(async(r,l,n)=>{const b=l==="overseerr"||l==="jellyseerr"||l==="seer",j=Le[r];if(Be(K=>({...K,[r]:{...K[r],...n}})),b)return;const C=(pe||[]).find(K=>K.id===r);if(!C)return;const T=C.tmdbId||C.tvdbId,L=C.titleClean?.trim()||C.title?.trim();if(!(!T&&!L))try{await ve("/api/arr/status",{items:[{releaseId:C.id,tvdbId:C.tvdbId||null,tmdbId:C.tmdbId||null,mediaType:Cr(C)?"series":"movie",title:C.titleClean?.trim()||C.title?.trim()||null}]})}catch(K){console.error("Failed to sync Arr status change",{itemId:r,arrType:l,error:K}),E("Impossible de synchroniser le statut Arr."),Be(O=>{const z={...O};return j==null?delete z[r]:z[r]=j,z})}},[pe,Le,E]),zs=a.useCallback(r=>r?.unifiedCategoryLabel||"",[]),Ee=w.categoryId,he=w.applicationId,Ze=w.quality,Bs=w.seen,qs=w.sortBy,Vs=w.maxAgeDays,Ds=w.q,Gs=w.viewMode,Qs=w.listSortBy,Js=w.listSortDir,Ks=w.limit,Ys=a.useMemo(()=>{if(!he)return"";if(he==="__hide_apps__")return"__hide_apps__";const r=Ae.find(l=>String(l.id)===String(he));return r?.type?String(r.type).toLowerCase():""},[he,Ae]),{visibleItems:ye,categoriesForDropdown:He,qualityOptions:We}=At({items:pe,sourceNameById:Me,filterCategoryId:Ee,filterApplicationType:Ys,filterQuality:Ze,filterSeen:Bs,filterSortBy:qs,filterMaxAgeDays:Vs,filterQ:Ds,filterViewMode:Gs,filterListSortBy:Qs,filterListSortDir:Js,filterLimit:Ks,arrStatusById:Le}),er=w.setCategoryId,Ar=w.setApplicationId,Lr=w.setQuality;a.useEffect(()=>{if(!Ee)return;(He||[]).some(l=>l.key===Ee)||er("")},[Ee,He,er]),a.useEffect(()=>{if(!he||he==="__hide_apps__")return;(Ae||[]).some(l=>String(l.id)===String(he))||Ar("")},[he,Ae,Ar]),a.useEffect(()=>{if(!Ze)return;const r=String(Ze).trim().toLowerCase();(We||[]).some(n=>String(n).trim().toLowerCase()===r)||Lr("")},[Ze,We,Lr]);const Mr=w.uiSettings?.showCategories;a.useEffect(()=>{Mr===!1&&Ee&&er("")},[Mr,Ee,er]);const Er=a.useCallback(r=>{if(!Array.isArray(r)||r.length===0)return;const l=new Map(r.map(n=>[Number(n.id),n]));l.size!==0&&(fe(n=>n.map(b=>{const j=l.get(b.id);return j?_s(b,j):b})),q(n=>{if(!n)return n;const b=l.get(n.id);return b?_s(n,b):n}))},[q]),Rr=a.useCallback(async(r,l)=>{if(Ge.current.inFlight)return;const n=wr.current;n.length!==0&&(l&&Ge.current.lastFingerprint===l||(l&&(Ge.current.lastFingerprint=l),Ge.current.inFlight=!0,await lr(async()=>{const b=await ve("/api/posters/releases/state",{ids:n}),j=Array.isArray(b?.items)?b.items:Array.isArray(b)?b:[];Er(j)},{context:"Failed to refresh visible poster states in library",onFinally:()=>{Ge.current.inFlight=!1}})))},[Er]);a.useEffect(()=>{wr.current=(ye||[]).map(r=>r.id).filter(Boolean)},[ye]),a.useEffect(()=>{if(typeof window>"u")return;const r=l=>{const n=l?.detail||{};n.fingerprintChanged&&Rr(n.reason,n.fingerprint)};return window.addEventListener("posters:polling:tick",r),()=>window.removeEventListener("posters:polling:tick",r)},[Rr]);const Tr=a.useCallback(r=>{const l=r.downloadPath||(r.id?`/api/releases/${r.id}/download`:"");l&&dt(l,{onError:E})},[E]),Ur=a.useCallback(async r=>{r?.id&&(Ye.current.has(r.id)||(Ye.current.add(r.id),await lr(async()=>{const n=(await ve(`/api/releases/${r.id}/details/igdb`))?.details;n&&(fe(b=>b.map(j=>j.id===r.id?{...j,...n}:j)),q(b=>b?.id===r.id?{...b,...n}:b))},{context:"Failed to fetch IGDB details in library",onFinally:()=>{Ye.current.delete(r.id)}})))},[q]),rr=a.useCallback(r=>{if(!r)return;q(r),(js(r.unifiedCategoryKey)||jt(r.mediaType))&&!Nt(r)&&Ur(r)},[Ur,q]),Xs=a.useCallback(()=>q(null),[q]),dr=a.useCallback(r=>{if(!r)return;const l=r.titleClean?.trim()?r.titleClean:r.title;f(r),S(l||""),R(r.title||""),$(!0)},[$,R,f,S]),ur=a.useCallback(()=>{$(!1),f(null),S(""),R("")},[$,R,f,S]),Zs=a.useCallback(async r=>{if(r?.preventDefault?.(),!_)return;const l=o.trim();if(l)try{E("");const n=await ve(`/api/releases/${_.id}/rename`,{title:l}),b=n?.entityId??_.entityId??null,j=n?.posterUrl??null,C=n?.posterUpdatedAtTs??null;fe(T=>T.map(L=>L.id===_.id||b&&L.entityId===b?{...L,...L.id===_.id?{title:n?.title??l,titleClean:n?.titleClean??L.titleClean,year:n?.year??L.year,season:n?.season??L.season,episode:n?.episode??L.episode,resolution:n?.resolution??L.resolution,source:n?.source??L.source,codec:n?.codec??L.codec,releaseGroup:n?.releaseGroup??L.releaseGroup,mediaType:n?.mediaType??L.mediaType,unifiedCategory:n?.unifiedCategory??L.unifiedCategory,entityId:b??L.entityId}:{},posterUrl:j,posterUpdatedAtTs:C??L.posterUpdatedAtTs}:L)),q(T=>T?.id===_.id||b&&T?.entityId===b?{...T,posterUrl:j,posterUpdatedAtTs:C??T?.posterUpdatedAtTs}:T),ur()}catch(n){E(n?.message||"Erreur renommage")}},[_,o,ur,E,q]),xe=ke.selectedIds,sr=ke.exitSelectionMode,Pr=ke.clearSelection,Fr=a.useCallback(async()=>{const r=Array.from(xe);if(r.length!==0){m(!0);try{await ve("/api/posters/releases/fetch",{ids:r}),ys("bulk-fetch"),await Xe(),sr()}finally{m(!1)}}},[xe,sr,Xe,m]),$r=a.useCallback(async r=>{const l=Array.from(xe);l.length!==0&&(await ve("/api/releases/seen",{ids:l,seen:r}),fe(n=>n.map(b=>xe.has(b.id)?{...b,seen:r?1:0}:b)),sr())},[xe,sr]),Or=a.useRef(null),mr=a.useCallback((r,l)=>{const n=(r||"").trim();if(!n){D([]);return}clearTimeout(Or.current),Or.current=setTimeout(async()=>{Z(!0),g("");try{const b=(l||"").trim(),j=await Te(`/api/posters/search?q=${encodeURIComponent(n)}&mediaType=${encodeURIComponent(b)}`),C=Array.isArray(j?.results)?j.results:[];D(St(C))}catch(b){g(b?.message||"Erreur recherche posters")}finally{Z(!1)}},350)},[g,Z,D]),zr=a.useCallback(()=>{if(xe.size!==1)return;const r=Array.from(xe)[0],l=(pe||[]).find(T=>T.id===r);if(!l)return;const n=l.titleClean?.trim()?l.titleClean:l.title,b=String(l.mediaType||"").trim().toLowerCase(),j=Ts(l.unifiedCategoryKey);let C=b;(!C||C==="unknown")&&(js(j)?C="game":j==="audio"?C="audio":j==="books"||j==="book"?C="book":j==="comics"||j==="comic"?C="comic":j==="anime"?C="anime":j==="series"||j==="emissions"?C="series":C="movie"),G(l),X(n||""),D([]),g(""),U(C),V(!0),n&&mr(n,C)},[xe,pe,mr,g,U,V,X,D,G]),pr=a.useCallback(()=>{V(!1),X(""),D([]),g(""),G(null),U("")},[g,U,V,X,D,G]),Hs=a.useCallback(async r=>{if(!(!F||!r))try{const l=String(r.provider||"tmdb").toLowerCase();let n=null;if(l==="igdb"){const p=r.posterPath||r.posterUrl;if(!p)return;n={provider:"igdb",igdbId:r.igdbId,posterPath:p}}else if(l==="theaudiodb"){const p=r.posterPath||r.posterUrl;if(!p)return;n={provider:"theaudiodb",providerId:r.providerId||null,posterPath:p}}else if(l==="googlebooks"){const p=r.posterPath||r.posterUrl;if(!p)return;n={provider:"googlebooks",providerId:r.providerId||null,posterPath:p}}else if(l==="comicvine"){const p=r.posterPath||r.posterUrl;if(!p)return;n={provider:"comicvine",providerId:r.providerId||null,posterPath:p}}else if(l==="musicbrainz"){const p=r.posterPath||r.posterUrl;if(!p)return;n={provider:"musicbrainz",providerId:r.providerId||null,posterPath:p}}else if(l==="openlibrary"){const p=r.posterPath||r.posterUrl;if(!p)return;n={provider:"openlibrary",providerId:r.providerId||null,posterPath:p}}else if(l==="rawg"){const p=r.posterPath||r.posterUrl;if(!p)return;n={provider:"rawg",providerId:r.providerId||null,posterPath:p}}else{if(!r.posterPath)return;n={provider:"tmdb",tmdbId:r.tmdbId,posterPath:r.posterPath}}const b=await ve(`/api/posters/release/${F.id}/manual`,n),j=Number(b?.entityId||F.entityId||0)||null,C=Number(b?.posterUpdatedAtTs||0)||null,T=b?.posterFile||null,L=Cs(F.titleClean||F.title),K=F.year!=null?Number(F.year):null,O=p=>{const ee=Cs(p.titleClean||p.title);return!(!ee||ee!==L||K!=null&&p.year!=null&&Number(p.year)!==K)},z=p=>j&&p.entityId?Number(p.entityId)===j:p.entityId?p.id===F.id:O(p),ie=p=>{const ee=C||p.posterUpdatedAtTs,be=ee?Ns(p.id,ee):p.id===F.id&&b?.posterUrl?b.posterUrl:Ns(p.id,ee);return{...p,entityId:j||p.entityId,posterFile:T||p.posterFile,posterUpdatedAtTs:ee,posterUrl:be,posterLastError:null}};fe(p=>p.map(ee=>z(ee)?ie(ee):ee)),q(p=>p&&z(p)?ie(p):p),ys("manual-set"),pr(),Pr()}catch(l){g(l?.message||"Erreur poster manuel")}},[F,pr,Pr,g,q]),{selectionMode:Ce,selectedIds:Re,toggleSelectionMode:Br,selectAllVisible:qr,toggleSelect:tr}=ke,{sortBy:br,maxAgeDays:Vr,setMaxAgeDays:Dr,seen:Gr,setSeen:Qr,applicationId:Jr,setApplicationId:Kr,quality:Yr,setQuality:Xr,filtersOpen:fr,setFiltersOpen:Zr,sourceId:ar,setSourceId:Hr,uiSettings:Wr,categoryId:es,setCategoryId:rs,setSortBy:ss,viewMode:ce,setViewMode:ts,viewOptions:as,limit:ns,setLimit:ls,listSortBy:Ws,listSortDir:et,toggleListSort:rt,selectedSourceName:st,defaultSort:is,defaultMaxAgeDays:os,defaultLimit:cs}=w,ds=a.useCallback(()=>{qr(ye)},[qr,ye]),us=a.useCallback(()=>{Fr()},[Fr]),ms=a.useCallback(()=>{zr()},[zr]),ps=a.useCallback(r=>{$r(r)},[$r]),bs=a.useMemo(()=>({subbarClassName:`subbar--library${fr&&!Ce?" subbar--library-filter-open":""}`,selectionMode:Ce,selectedIds:Re,onToggleSelectionMode:Br,onSelectAll:ds,posterAutoLoading:k,onBulkFetchPosters:us,onOpenManualPoster:ms,onBulkSetSeen:ps,sortBy:br,maxAgeDays:Vr,setMaxAgeDays:Dr,seen:Gr,setSeen:Qr,applicationId:Jr,setApplicationId:Kr,quality:Yr,setQuality:Xr,qualityOptions:We,filtersOpen:fr,setFiltersOpen:Zr,installedApps:Ae,sources:J,enabledSources:W,sourceId:ar,setSourceId:Hr,uiSettings:Wr,categoryId:es,setCategoryId:rs,categoriesForDropdown:He,setSortBy:ss,viewMode:ce,setViewMode:ts,viewOptions:as,limit:ns,setLimit:ls,defaultSort:is,defaultMaxAgeDays:os,defaultLimit:cs}),[fr,Ce,Re,Br,ds,k,us,ms,ps,br,Vr,Dr,J,Gr,Qr,Jr,Kr,Yr,Xr,We,Zr,Ae,W,ar,Hr,Wr,es,rs,He,ss,ce,ts,as,ns,ls,is,os,cs]);return a.useEffect(()=>(Q(e.jsx(Ft,{...bs})),()=>Q(null)),[Q,bs]),e.jsxs("div",{className:"page page--library",children:[e.jsxs("div",{className:"pagehead",children:[e.jsxs("div",{children:[e.jsx("h1",{children:st}),e.jsx("div",{className:"muted",children:d?"—":`Résultats: ${ye.length}`})]}),(ce==="grid"||ce==="missing"||ce==="poster")&&e.jsxs("div",{className:"library-size-slider",children:[e.jsx(vs,{className:"library-size-slider__icon"}),e.jsx("input",{type:"range",min:Y,max:100,value:ce==="poster"?h:Ie,onChange:ce==="poster"?B:x}),e.jsx(vs,{className:"library-size-slider__icon library-size-slider__icon--lg"})]})]}),i&&e.jsx(lt,{label:"Chargement du feed…"}),!i&&d&&e.jsxs("div",{className:"errorbox",children:[e.jsx("div",{className:"errorbox__title",children:"Erreur"}),e.jsx("div",{className:"muted",children:d})]}),!i&&!d&&(ce==="grid"||ce==="missing")&&e.jsx(Lt,{items:ye,onDownload:Tr,onOpen:rr,selectionMode:Ce,selectedIds:Re,onToggleSelect:tr,onRename:dr,sortBy:br,sourceNameById:Me,sourceColorById:Qe,sourceId:ar,arrStatusMap:Le,integrationMode:ir,cardSize:je}),!i&&!d&&ce==="poster"&&e.jsx(Pt,{items:ye,onOpen:rr,selectionMode:Ce,selectedIds:Re,onToggleSelect:tr,onRename:dr,sourceNameById:Me,sourceColorById:Qe,sourceId:ar,arrStatusMap:Le,integrationMode:ir,cardSize:$e}),!i&&!d&&ce==="list"&&e.jsx(Mt,{items:ye,selectionMode:Ce,selectedIds:Re,onToggleSelect:tr,onOpen:rr,onRename:dr,listSortBy:Ws,listSortDir:et,onToggleSort:rt,sourceNameById:Me,sourceColorById:Qe,getUnifiedLabel:zs}),!i&&!d&&ce==="banner"&&e.jsx(Et,{items:ye,selectionMode:Ce,selectedIds:Re,onToggleSelect:tr,onOpen:rr,sourceNameById:Me,sourceColorById:Qe}),e.jsx(ut,{open:!!v,item:v,onClose:Xs,onDownload:Tr,categoryLabel:v?.categoryName||v?.unifiedCategoryLabel||"",indexerLabel:Me.get(Number(v?.sourceId))||"",indexerColor:Qe.get(Number(v?.sourceId))||null,hasSonarr:oe,hasRadarr:ne,hasOverseerr:de,hasJellyseerr:ue,hasSeer:me,integrationMode:ir,arrStatus:v?Le[v.id]:null,onArrStatusChange:Os}),e.jsx($t,{open:P,onClose:ur,renameValue:o,setRenameValue:S,renameOriginal:N,onSave:Zs}),e.jsx(Ot,{open:y,onClose:pr,query:u,setQuery:X,results:c,loading:I,error:A,onSearch:mr,onApply:Hs,mediaType:M})]})}export{ea as default};
