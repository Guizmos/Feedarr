import{r as t,j as e}from"./vendor-react-B6j9w5IJ.js";import{d as je,e as Ne,a as Z,b as X,c as ce,t as os,u as Bs,A as Fs,f as cs,h as qs}from"./index-CFeG2zFp.js";import{L as bs}from"./Loader-WjrgZmWo.js";import{S as ve}from"./SubAction-Chy9oen0.js";import{M as Ke}from"./Modal-CuzTGtmL.js";import{T as Ws,C as Xs,I as Js}from"./ItemRow-CmVCROir.js";import{t as le}from"./uiText-P7c8BdcQ.js";import{S as Q,n as xe,g as Ys}from"./sourceColors-KACkINRj.js";import{d as Vs,C as Hs,a as Qs,m as Zs,b as et,c as ds,e as st}from"./CategoryMappingBoard-CN2-9G7j.js";import{C as us,n as oe}from"./categoryGroups.constants-TqNJ0nIh.js";import{M as ms}from"./categoryPriority.constants-BnKBS6eK.js";import"./vendor-router-DbNMZja2.js";import"./vendor-icons-BuPyRjLk.js";import"./formatters-_WhZHARF.js";const xs="test-indexer-";function tt(o,m){je({key:`${xs}${o}`,label:`Test: ${m}`,meta:"Test en cours...",ttlMs:1e3*60*2})}function ps(o){Ne(`${xs}${o}`)}function nt(){je({key:"test-new-indexer",label:"Test nouvel indexer",meta:"Validation en cours...",ttlMs:1e3*60*2})}function at(){Ne("test-new-indexer")}const ys="refresh-caps-";function rt(o,m){je({key:`${ys}${o}`,label:`Refresh caps: ${m}`,meta:"Récupération...",ttlMs:1e3*60*3})}function it(o){Ne(`${ys}${o}`)}const Se={syncIntervalMinutes:"60",rssLimitPerCategory:"50",rssLimitGlobalPerSource:"250",autoSyncEnabled:!0},z=(o,m)=>{const b=String(o??"").trim();if(!b)return m;const M=Number(b);return Number.isFinite(M)?Math.trunc(M):m};function lt({onStateChange:o,showSaveButton:m=!1}){const[b,M]=t.useState(!0),[p,j]=t.useState(""),[f,N]=t.useState("idle"),[d,E]=t.useState(Se),[I,_]=t.useState(Se),[y,D]=t.useState(()=>new Set),[T,B]=t.useState("ok"),A=t.useRef(null),n=t.useRef(null),h=t.useRef(null),g=t.useRef(null),w=t.useCallback(async()=>{M(!0),j("");try{const c=await Z("/api/settings/general"),u=z(c?.rssLimitPerCategory??c?.rssLimit,50),R=z(c?.rssLimitGlobalPerSource,250),L={syncIntervalMinutes:String(z(c?.syncIntervalMinutes,60)),rssLimitPerCategory:String(u),rssLimitGlobalPerSource:String(R),autoSyncEnabled:c?.autoSyncEnabled!==!1};E(L),_(L)}catch(c){j(c?.message||"Erreur chargement paramètres"),E(Se),_(Se)}finally{M(!1)}},[]);t.useEffect(()=>(w(),()=>{A.current&&clearTimeout(A.current)}),[w]);const k=t.useMemo(()=>!!d.autoSyncEnabled!==I.autoSyncEnabled||String(d.syncIntervalMinutes)!==I.syncIntervalMinutes||String(d.rssLimitPerCategory)!==I.rssLimitPerCategory||String(d.rssLimitGlobalPerSource)!==I.rssLimitGlobalPerSource,[d,I]),x=t.useCallback(c=>y.has(c)?T==="err"?" pulse-err":" pulse-ok":"",[y,T]),P=t.useCallback(async()=>{if(f==="loading")return;j("");const c=n.current?.value??d.syncIntervalMinutes,u=h.current?.value??d.rssLimitPerCategory,R=g.current?.value??d.rssLimitGlobalPerSource,L=new Set;!!d.autoSyncEnabled!==I.autoSyncEnabled&&L.add("general.autoSync"),String(c)!==I.syncIntervalMinutes&&L.add("general.sync"),String(u)!==I.rssLimitPerCategory&&L.add("general.rssPerCat"),String(R)!==I.rssLimitGlobalPerSource&&L.add("general.rssGlobal");const J=Date.now();let F=!1;N("loading");try{const O=await Z("/api/settings/general");await X("/api/settings/general",{...O,syncIntervalMinutes:z(c,60),rssLimit:z(u,50),rssLimitPerCategory:z(u,50),rssLimitGlobalPerSource:z(R,250),autoSyncEnabled:!!d.autoSyncEnabled}),_({syncIntervalMinutes:String(z(c,60)),rssLimitPerCategory:String(z(u,50)),rssLimitGlobalPerSource:String(z(R,250)),autoSyncEnabled:!!d.autoSyncEnabled}),E(ee=>({...ee,syncIntervalMinutes:String(c??""),rssLimitPerCategory:String(u??""),rssLimitGlobalPerSource:String(R??"")})),F=!0}catch(O){j(O?.message||"Erreur sauvegarde paramètres")}finally{const O=Date.now()-J;O<800&&await new Promise(ee=>setTimeout(ee,800-O)),N(F?"success":"error"),L.size>0&&(A.current&&clearTimeout(A.current),B(F?"ok":"err"),D(new Set(L)),A.current=setTimeout(()=>{D(new Set)},1200)),setTimeout(()=>N("idle"),1e3)}},[d,I,f]);return t.useEffect(()=>{o&&o({isDirty:k,saveState:f,onSave:P})},[o,k,f,P]),e.jsxs("div",{className:"settings-card",id:"indexers-sync",children:[e.jsx("div",{className:"settings-card__head",children:e.jsx("div",{className:"settings-card__title",children:"Synchronisation"})}),p&&e.jsxs("div",{className:"errorbox",style:{marginBottom:12},children:[e.jsx("div",{className:"errorbox__title",children:"Erreur"}),e.jsx("div",{className:"muted",children:p})]}),b?e.jsx(bs,{label:"Chargement des paramètres..."}):e.jsxs("div",{className:"indexer-list",children:[e.jsx("div",{className:`indexer-card${x("general.autoSync")}`,children:e.jsxs("div",{className:"indexer-row indexer-row--settings",children:[e.jsx("span",{className:"indexer-title",children:"Synchronisation auto"}),e.jsxs("div",{className:"indexer-actions",children:[e.jsx("span",{className:"indexer-status",children:d.autoSyncEnabled?"Actif":"Desactive"}),e.jsx(Ws,{checked:d.autoSyncEnabled,onIonChange:c=>E(u=>({...u,autoSyncEnabled:c.detail.checked})),className:"settings-toggle",title:d.autoSyncEnabled?"Désactiver":"Activer"})]})]})}),e.jsx("div",{className:`indexer-card${x("general.sync")}${d.autoSyncEnabled?"":" is-disabled"}`,children:e.jsxs("div",{className:"indexer-row indexer-row--settings",children:[e.jsx("span",{className:"indexer-title",children:"Intervalle Sync RSS (minutes)"}),e.jsx("div",{className:"indexer-actions",children:e.jsx("input",{type:"number",min:1,max:1440,value:d.syncIntervalMinutes,disabled:!d.autoSyncEnabled,ref:n,onChange:c=>{E(u=>({...u,syncIntervalMinutes:c.target.value}))}})})]})}),e.jsxs("div",{className:`indexer-card${x("general.rssPerCat")}`,children:[e.jsxs("div",{className:"indexer-row indexer-row--settings",children:[e.jsx("span",{className:"indexer-title",title:"Remplissage progressif par catégorie, purge des plus anciens.",children:"Limite RSS par catégorie"}),e.jsx("div",{className:"indexer-actions",children:e.jsx("input",{type:"number",min:1,max:200,value:d.rssLimitPerCategory,ref:h,onChange:c=>{E(u=>({...u,rssLimitPerCategory:c.target.value}))}})})]}),e.jsx("div",{className:"settings-help",children:"Remplissage progressif par catégorie, purge des plus anciens."})]}),e.jsxs("div",{className:`indexer-card${x("general.rssGlobal")}`,children:[e.jsxs("div",{className:"indexer-row indexer-row--settings",children:[e.jsx("span",{className:"indexer-title",title:"Plafond global par source, purge des plus anciens.",children:"Limite RSS globale (par source)"}),e.jsx("div",{className:"indexer-actions",children:e.jsx("input",{type:"number",min:1,max:2e3,value:d.rssLimitGlobalPerSource,ref:g,onChange:c=>{E(u=>({...u,rssLimitGlobalPerSource:c.target.value}))}})})]}),e.jsx("div",{className:"settings-help",children:"Plafond global par source, purge des plus anciens."})]})]}),m&&!b&&k&&e.jsx("div",{className:"formactions",style:{marginTop:16},children:e.jsx("button",{className:`btn ${f==="success"?"btn-hover-ok":f==="error"?"btn-fixed-danger btn-nohover":"btn-hover-ok"}`,type:"button",onClick:P,disabled:!k||f==="loading",children:f==="loading"?"Enregistrement...":f==="success"?"Enregistré":f==="error"?"Erreur":"Enregistrer"})})]})}function ot({onPrepareAdd:o,onPrepareEdit:m,onAfterClose:b}={}){const[M,p]=t.useState(!1),[j,f]=t.useState(null),[N,d]=t.useState(!1),[E,I]=t.useState(null),[_,y]=t.useState(1),D=t.useCallback(()=>{f(null),y(1),o?.(),p(!0)},[o]),T=t.useCallback(h=>{f(h),y(1),m?.(h),p(!0)},[m]),B=t.useCallback(()=>{p(!1),b?.()},[b]),A=t.useCallback(h=>{I(h),d(!0)},[]),n=t.useCallback(()=>{d(!1),I(null)},[]);return{modalOpen:M,editing:j,confirmOpen:N,confirmTarget:E,modalStep:_,setModalStep:y,openAdd:D,openEdit:T,closeModal:B,openDeleteConfirm:A,closeDeleteConfirm:n}}const hs="rss-sync-";function ct(o,m){je({key:`${hs}${o}`,label:`Sync: ${m}`,meta:"En cours...",ttlMs:1e3*60*5})}function fs(o){Ne(`${hs}${o}`)}function Ce(o,m,b=1600){setTimeout(()=>{o(M=>{const p={...M};return delete p[m],p})},b)}function dt({items:o,load:m,setErr:b}){const[M,p]=t.useState(null),[j,f]=t.useState({}),[N,d]=t.useState(!1),[E,I]=t.useState(null),[_,y]=t.useState({}),D=t.useMemo(()=>Object.values(j||{}).some(n=>n==="pending"),[j]),T=t.useCallback(async()=>{const n=(o||[]).filter(g=>g?.id&&g?.enabled);if(n.length===0)return;b("");const h=Date.now();d(!0),f(g=>{const w={...g||{}};return n.forEach(k=>{w[k.id]="pending"}),w});try{const g=await Promise.allSettled(n.map(x=>ce(`/api/sources/${x.id}/sync`)));await m(),os("sync-all");const w=Date.now()-h,k=Math.max(2e3-w,0);setTimeout(()=>{f(x=>{const P={...x||{}};return n.forEach((c,u)=>{const R=g[u],L=R.status==="fulfilled"?!!R.value?.ok:!1;P[c.id]=L?"ok":"error"}),P}),setTimeout(()=>{f(x=>{const P={...x||{}};return n.forEach(c=>{delete P[c.id]}),P})},1600),d(!1)},k)}catch(g){b(g?.message||"Erreur sync");const w=Date.now()-h,k=Math.max(2e3-w,0);setTimeout(()=>{f(x=>{const P={...x||{}};return n.forEach(c=>{P[c.id]="error"}),P}),setTimeout(()=>{f(x=>{const P={...x||{}};return n.forEach(c=>{delete P[c.id]}),P})},1600),d(!1)},k)}},[o,m,b]),B=t.useCallback(async n=>{if(!n?.id||!n.enabled||E===n.id||N||j[n.id]==="pending")return;b("");const h=Date.now();p(n.id),f(g=>({...g,[n.id]:"pending"})),ct(n.id,n.name||`Source #${n.id}`);try{const g=await ce(`/api/sources/${n.id}/sync`);await m(),os("sync");const w=Date.now()-h,k=Math.max(2e3-w,0);setTimeout(()=>{f(x=>({...x,[n.id]:g?.ok?"ok":"error"})),Ce(f,n.id),p(null),fs(n.id)},k)}catch(g){b(g?.message||"Erreur sync");const w=Date.now()-h,k=Math.max(2e3-w,0);setTimeout(()=>{f(x=>({...x,[n.id]:"error"})),Ce(f,n.id),p(null),fs(n.id)},k)}},[m,b,N,j,E]),A=t.useCallback(async n=>{if(!n?.id||!n.enabled||M===n.id||j[n.id]==="pending")return;b("");const h=Date.now();I(n.id),y(g=>({...g,[n.id]:"pending"})),tt(n.id,n.name||`Source #${n.id}`);try{const g=await ce(`/api/sources/${n.id}/test`,{rssLimit:50}),w=Date.now()-h,k=Math.max(2e3-w,0);setTimeout(()=>{y(x=>({...x,[n.id]:g?.ok?"ok":"error"})),Ce(y,n.id),I(null),ps(n.id)},k)}catch(g){b(g?.message||"Erreur test");const w=Date.now()-h,k=Math.max(2e3-w,0);setTimeout(()=>{y(x=>({...x,[n.id]:"error"})),Ce(y,n.id),I(null),ps(n.id)},k)}},[b,M,j]);return{syncingId:M,syncStatusById:j,syncAllRunning:N,testingId:E,testStatusById:_,hasPendingSync:D,syncAll:T,syncSource:B,testSource:A}}const Be="__manual__";function gs(o){return(o||"").trim().toLowerCase().replace(/\/+$/,"")}function ut(o,m){if(o===m)return!0;if(!(o instanceof Map)||!(m instanceof Map)||o.size!==m.size)return!1;for(const[b,M]of o.entries())if(m.get(b)!==M)return!1;return!0}function It(){const o=Bs(),[m,b]=t.useState(!0),[M,p]=t.useState(""),[j,f]=t.useState([]),[N,d]=t.useState(!1),[E,I]=t.useState(!1),[_,y]=t.useState(""),[D,T]=t.useState(""),[B,A]=t.useState([]),[n,h]=t.useState(()=>new Map),[g,w]=t.useState([]),[k,x]=t.useState(!1),[P,c]=t.useState(""),[u,R]=t.useState(""),[L,J]=t.useState([]),[F,O]=t.useState(!1),[ee,de]=t.useState(""),[Fe,se]=t.useState(""),[q,ue]=t.useState(""),me=t.useRef(0),[qe,we]=t.useState(Q[0]),[Ie,Y]=t.useState(!1),ke=t.useRef(null),[Ee,Me]=t.useState(!1),[We,V]=t.useState(!1),[vs,te]=t.useState(null),[Ss,Xe]=t.useState(!1),Pe=t.useRef(null),pe=t.useRef(null),[Le,Je]=t.useState(!1),[ne,ae]=t.useState(""),[W,H]=t.useState(""),[re,ye]=t.useState(""),[Te,Ye]=t.useState(!0),fe=t.useMemo(()=>(j||[]).some(s=>!!s?.enabled),[j]),[Ae,Cs]=t.useState({}),U=t.useCallback(async()=>{p(""),b(!0);try{const s=await Z("/api/sources"),a=Array.isArray(s)?s:[];f(a);const r={};await Promise.all(a.map(async i=>{if(i?.id)try{const S=await Z(`/api/sources/${i.id}/category-mappings`);r[i.id]=(Array.isArray(S)?S:[]).map(l=>({id:Number(l?.catId),unifiedKey:oe(l?.groupKey||l?.unifiedKey),unifiedLabel:l?.groupLabel||l?.unifiedLabel||us[oe(l?.groupKey||l?.unifiedKey)]||"",name:l?.groupLabel||l?.unifiedLabel||us[oe(l?.groupKey||l?.unifiedKey)]||""}))}catch(S){console.error(`[Indexers] Impossible de charger les catégories pour la source #${i.id}.`,S),r[i.id]=[]}})),Cs(r)}catch(s){p(s?.message||"Erreur chargement sources")}finally{b(!1)}},[]);t.useEffect(()=>{U()},[U]);const{syncingId:js,syncStatusById:Re,syncAllRunning:ge,testingId:Ns,testStatusById:Ve,hasPendingSync:He,syncAll:Qe,syncSource:ws,testSource:Is}=dt({items:j,load:U,setErr:p}),Ze=t.useCallback(async()=>{w([]),c(""),x(!0);try{const s=await Z("/api/providers"),r=(Array.isArray(s)?s:[]).filter(i=>!!i?.enabled);w(r),r.length===0&&c("Aucun fournisseur configuré.")}catch(s){c(s?.message||"Impossible de charger les fournisseurs.")}finally{x(!1)}},[]),$e=t.useCallback(async s=>{if(!s)return;const a=++me.current;J([]),de(""),se(""),O(!0);try{const r=await Z(`/api/providers/${s}/indexers`);if(a!==me.current)return;const i=Array.isArray(r)?r:r?.indexers,S=(Array.isArray(i)?i:[]).filter(l=>l?.name&&l?.torznabUrl).sort((l,C)=>String(l.name).localeCompare(String(C.name)));J(S),S.length===0&&de("Aucun indexeur disponible (fournisseur non configuré ?)")}catch(r){if(a!==me.current)return;se(r?.message||"Impossible de charger les indexeurs.")}finally{a===me.current&&O(!1)}},[]);t.useEffect(()=>{if(!u){me.current++,J([]),de(""),se(""),O(!1);return}$e(u)},[u,$e]),t.useEffect(()=>{if(!Ie)return;const s=r=>{ke.current&&(ke.current.contains(r.target)||Y(!1))},a=r=>{r.key==="Escape"&&Y(!1)};return document.addEventListener("mousedown",s),document.addEventListener("keydown",a),()=>{document.removeEventListener("mousedown",s),document.removeEventListener("keydown",a)}},[Ie]);const ks=t.useCallback(()=>{ae(""),H(""),ye(""),Ye(!0),we(Q[0]),Y(!1),Me(!1),V(!1),te(null),y(""),T(""),A([]),h(new Map),w([]),c(""),R(""),J([]),de(""),se(""),ue(""),Pe.current=null,pe.current=null,Ze()},[Ze]),Es=t.useCallback(s=>{const a=xe(s?.color)||Ys(s?.id,s?.color)||Q[0];Pe.current={name:(s?.name??"").trim(),torznabUrl:(s?.torznabUrl??"").trim(),color:xe(a)||Q[0]};const r=(Ae[s?.id]||[]).map(i=>[Number(i?.id),oe(i?.unifiedKey)]).filter(([i,S])=>Number.isFinite(i)&&i>0&&!!S);pe.current=new Map(r),ae(s.name??""),H(s.torznabUrl??""),ye(""),Ye(!!s.enabled),we(a),Y(!1),Me(!1),V(!1),te(null),y(""),T(""),A([]),h(new Map),R(""),ue("")},[Ae]),Ms=t.useCallback(()=>{y(""),T(""),A([]),h(new Map),R(""),ue(""),se(""),Y(!1)},[]),{modalOpen:Ps,editing:v,confirmOpen:Ls,confirmTarget:he,modalStep:$,setModalStep:_e,openAdd:es,openEdit:Ts,closeModal:ie,openDeleteConfirm:As,closeDeleteConfirm:Oe}=ot({onPrepareAdd:ks,onPrepareEdit:Es,onAfterClose:Ms}),Rs=t.useCallback(()=>{Me(s=>!s)},[]);async function ss(){y(""),T(""),p("");const s={torznabUrl:W.trim(),apiKey:re.trim(),authMode:"query",indexerName:ne.trim()};if(!s.torznabUrl){y("URL requise pour tester.");return}if(!v?.id&&!u){y("Choisis un fournisseur avant de tester.");return}I(!0),v?.id?rt(v.id,v.name||`Source #${v.id}`):nt();try{const a=v?.id?await Z(`/api/categories/caps?sourceId=${v.id}&includeStandardCatalog=true&includeSpecific=true`):await ce("/api/categories/caps/provider",{providerId:Number(u),torznabUrl:s.torznabUrl,indexerName:s.indexerName,indexerId:De?null:q||null,includeStandardCatalog:!0,includeSpecific:!0}),r=Array.isArray(a?.categories)?a.categories:[],i=Qs(r),S=Array.isArray(a?.warnings)?a.warnings:[];S.length>0&&T(S.join(" ")),A(i);const l=Zs(i);h(l),i.length===0&&S.length===0&&T("Aucune catégorie disponible."),v?.id?(pe.current=new Map(l),_e(2)):(h(new Map),a?.sourceId&&te(a.sourceId),V(!0))}catch(a){y(a?.message||"Erreur test indexeur")}finally{I(!1),v?.id?it(v.id):at()}}async function ze(s){if(s?.preventDefault&&s.preventDefault(),s?.stopPropagation&&s.stopPropagation(),N)return;if(p(""),y(""),d(!0),K&&!u){y("Choisis un fournisseur avant d’enregistrer."),d(!1);return}const a=xe(qe)||Q[0],r={name:ne.trim(),torznabUrl:W.trim(),authMode:"query",apiKey:re.trim()||null,providerId:u?Number(u):null,color:a};try{const i=new Map([...n.entries()].map(([l,C])=>[Number(l),oe(C)]).filter(([l,C])=>Number.isFinite(l)&&l>0&&!!C)),S=[...i.keys()].map(l=>Number(l)).filter(l=>Number.isFinite(l)&&l>0).sort((l,C)=>l-C);if(v?.id)if($===2){await X(`/api/sources/${v.id}`,r),await X(`/api/sources/${v.id}/enabled`,{enabled:Te});const l=et(pe.current,i);await cs(`/api/sources/${v.id}/category-mappings`,ds({mappings:l,selectedCategoryIds:S}))}else await X(`/api/sources/${v.id}`,r),await X(`/api/sources/${v.id}/enabled`,{enabled:Te});else{if($!==2)return;const l=st(i);let C=vs;if(C)await X(`/api/sources/${C}`,r),await X(`/api/sources/${C}/enabled`,{enabled:Te});else{const Ge=await ce("/api/sources",{...r});C=Number(Ge?.id)||null}C&&await cs(`/api/sources/${C}/category-mappings`,ds({mappings:l,selectedCategoryIds:S}))}await U(),typeof window<"u"&&window.dispatchEvent(new Event("onboarding:refresh")),ie()}catch(i){p(i?.message||"Erreur sauvegarde")}finally{d(!1)}}async function $s(s){if(s?.id){p("");try{await X(`/api/sources/${s.id}/enabled`,{enabled:!s.enabled}),await U()}catch(a){p(a?.message||"Erreur enable/disable")}}}async function _s(){if(!(!v?.id||Le||!(typeof window>"u"||window.confirm("Reclasser l'existant pour cette source ? Cette action peut prendre quelques instants.")))){p(""),y(""),Je(!0);try{await ce(`/api/sources/${v.id}/reclassify`),await U(),T("Reclassement lancé avec succès pour cette source.")}catch(a){p(a?.message||"Erreur reclassification")}finally{Je(!1)}}}t.useEffect(()=>(o(e.jsxs("div",{className:"indexers-subbar-content",subbarClassName:"subbar--indexers-sync",children:[e.jsx(ve,{icon:"refresh",label:"Refresh",onClick:U}),e.jsx(ve,{icon:"add_circle",label:"Ajouter",onClick:es}),e.jsx(ve,{icon:"settings",label:"Options",onClick:()=>Xe(!0),title:"Options de synchronisation"}),fe&&e.jsx("div",{className:"subspacer"}),fe&&e.jsx(ve,{icon:ge?"progress_activity":"sync",label:"Sync all",onClick:Qe,disabled:!fe||ge||He,title:fe?"Sync all":"Aucun indexer actif",className:ge?"is-loading":void 0})]})),()=>o(null)),[o,U,es,Qe,ge,fe,He]);async function Os(s){if(s?.id){p("");try{await qs(`/api/sources/${s.id}`),await U()}catch(a){p(a?.message||"Erreur suppression")}}}const zs=t.useMemo(()=>(j||[]).map(s=>({...s,_name:s.name??`Source ${s.id}`,_url:s.torznabUrl??""})).sort((s,a)=>(Number(s.id)||0)-(Number(a.id)||0)),[j]),G=!!v,K=!v,be=xe(qe)||Q[0],ts=G&&$===2,De=K&&q===Be,ns=K?u&&W.trim():W.trim(),Ds=t.useMemo(()=>{if(!G)return!1;const s=Pe.current;if(!s)return!1;const a=ne.trim()!==s.name,r=W.trim()!==s.torznabUrl,i=be!==s.color,S=!!re.trim();return a||r||i||S},[G,ne,W,be,re]),Us=t.useMemo(()=>{if(!G||$!==2)return!1;const s=pe.current;return s?!ut(n,s):!1},[G,$,n]),as=G&&(Ds||Us),Gs=n.size,Ks=B.length,rs=t.useMemo(()=>new Set((j||[]).map(s=>gs(s.torznabUrl)).filter(Boolean)),[j]),Ue=t.useMemo(()=>{const s=(L||[]).filter(a=>!rs.has(gs(a.torznabUrl)));if(q&&!s.some(r=>String(r.id)===String(q))){const r=(L||[]).find(i=>String(i.id)===String(q));if(r)return[...s,r]}return s},[L,rs,q]);return e.jsxs("div",{className:"page page--indexers",children:[e.jsx("div",{className:"pagehead",children:e.jsxs("div",{children:[e.jsx("h1",{children:"Indexeurs"}),e.jsx("div",{className:"muted",children:"Sources Torznab / Jackett / Prowlarr"})]})}),e.jsx("div",{className:"pagehead__divider"}),M&&e.jsxs("div",{className:"errorbox",children:[e.jsx("div",{className:"errorbox__title",children:"Erreur"}),e.jsx("div",{className:"muted",children:M})]}),m?e.jsx(bs,{label:"Chargement des sources…"}):e.jsx("div",{className:"indexer-list itemrow-grid",children:zs.map(s=>{const a=js===s.id||Re[s.id]==="pending",r=Ns===s.id,i=a||r||ge,S=[Ve[s.id]==="ok"&&"test-ok",Ve[s.id]==="error"&&"test-err",Re[s.id]==="ok"&&"sync-ok",Re[s.id]==="error"&&"sync-err"].filter(Boolean).join(" "),l=Vs((Ae[s.id]||[]).slice().sort((C,Ge)=>{const is=ms.indexOf(C.unifiedKey),ls=ms.indexOf(Ge.unifiedKey);return(is===-1?999:is)-(ls===-1?999:ls)})).map(C=>e.jsx(Xs,{unifiedKey:C.unifiedKey,label:C.unifiedLabel||C.name,title:`${C.name} (${C.id})`},C.unifiedKey||C.id));return e.jsx(Js,{id:s.id,title:s._name,meta:s._url,enabled:s.enabled,badges:l,statusClass:S,actions:[{icon:"sync",title:a?"Sync en cours...":"Sync",onClick:()=>ws(s),disabled:i||!s.enabled,spinning:a},{icon:"science",title:r?"Test en cours...":"Test",onClick:()=>Is(s),disabled:r||a||!s.enabled,spinning:r},{icon:"edit",title:"Modifier",onClick:()=>Ts(s),disabled:i||!s.enabled},{icon:"delete",title:"Supprimer",onClick:()=>As(s),disabled:i||!s.enabled,className:"iconbtn--danger"}],showToggle:!0,onToggle:()=>$s(s),toggleDisabled:a||r},s.id)})}),e.jsx(Ke,{open:Ss,title:"Options de synchronisation",onClose:()=>Xe(!1),width:560,children:e.jsx("div",{style:{padding:12},children:e.jsx(lt,{showSaveButton:!0})})}),e.jsx(Ke,{open:Ls,title:he?`Supprimer : ${he?.name??he?.id}`:"Supprimer",onClose:Oe,width:520,children:e.jsxs("div",{style:{padding:12},children:[e.jsx("div",{style:{fontWeight:700,marginBottom:8},children:"Confirmer la suppression ?"}),e.jsx("div",{className:"muted",children:"Cette action est irréversible."}),e.jsxs("div",{className:"formactions",style:{marginTop:16},children:[e.jsx("button",{className:"btn btn-danger",type:"button",onClick:async()=>{const s=he;Oe(),s&&await Os(s)},children:"Supprimer"}),e.jsx("button",{className:"btn",type:"button",onClick:Oe,children:"Annuler"})]})]})}),e.jsx(Ke,{open:Ps,title:v?`Modifier : ${v?.name??v?.id}`:"Ajouter une source",onClose:ie,width:780,children:e.jsxs("form",{onSubmit:s=>s.preventDefault(),className:"formgrid formgrid--edit",children:[$===1&&e.jsxs(e.Fragment,{children:[K&&e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"muted",children:"Fournisseur"}),e.jsxs("select",{value:u,onChange:s=>{const a=s.target.value;R(a),ue(""),J([]),de(""),se(""),ae(""),H(""),y(""),T(""),A([]),h(new Map),V(!1),te(null)},disabled:k||g.length===0,children:[e.jsx("option",{value:"",disabled:!0,children:"Choisir un fournisseur..."}),g.map(s=>e.jsx("option",{value:s.id,children:s.name||(String(s.type||"").toLowerCase()==="prowlarr"?"Prowlarr":"Jackett")},s.id))]}),P&&e.jsx("div",{className:"muted",style:{marginTop:6},children:P})]}),K&&e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"muted",children:"Indexeur"}),e.jsxs("select",{value:q,onChange:s=>{const a=s.target.value;if(ue(a),a===Be){ae(""),H(""),V(!1),te(null);return}const r=Ue.find(i=>String(i?.id)===String(a));r&&(ae(r.name||""),H(r.torznabUrl||"")),V(!1),te(null)},disabled:!u||F,children:[e.jsx("option",{value:"",disabled:!0,children:"Choisir un indexeur..."}),Ue.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id)),e.jsx("option",{value:Be,children:"Ajouter manuellement..."})]}),ee&&e.jsx("div",{className:"muted",style:{marginTop:6},children:ee}),!F&&L.length>0&&Ue.length===0&&e.jsx("div",{className:"muted",style:{marginTop:6},children:"Tous les indexeurs sont déjà ajoutés."}),F&&e.jsx("div",{className:"muted",style:{marginTop:6},children:"Chargement des indexeurs..."}),Fe&&e.jsxs("div",{className:"errorbox",style:{marginTop:8},children:[e.jsx("div",{className:"errorbox__title",children:"Erreur"}),e.jsx("div",{className:"muted",style:{marginBottom:6},children:Fe}),e.jsx("button",{className:"btn",type:"button",onClick:()=>$e(u),disabled:!u||F,children:"Retry"})]})]}),K&&De&&e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"muted",children:"Torznab URL"}),e.jsx("input",{value:W,onChange:s=>H(s.target.value),placeholder:"Colle l'URL Copy Torznab Feed"}),e.jsx("span",{className:"field-hint",children:`Depuis Jackett/Prowlarr, utilise "Copy Torznab Feed", puis colle l'URL complète.`})]}),K&&De&&e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"muted",children:"Clé API (optionnel)"}),e.jsx("input",{value:re,onChange:s=>ye(s.target.value),placeholder:"Laisse vide pour utiliser la clé du fournisseur"})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"muted",children:le("Nom","Name")}),e.jsx("input",{value:ne,onChange:s=>ae(s.target.value),placeholder:le("Nom de l'indexeur","Indexer name"),disabled:K&&!q})]}),e.jsxs("div",{className:"field",style:{gridColumn:"1 / -1"},children:[e.jsx("label",{className:"muted",children:le("Couleur","Color")}),e.jsxs("div",{className:`color-slider${Ie?" is-open":""}`,ref:ke,children:[e.jsx("button",{className:"color-dot color-dot--main",type:"button",onClick:()=>!ts&&Y(s=>!s),disabled:ts,style:{background:be},"aria-label":le("Choisir une couleur","Choose a color"),title:le("Choisir une couleur","Choose a color")}),e.jsx("div",{className:"color-slider__track",children:Q.map(s=>{const r=xe(s)===be;return e.jsx("button",{type:"button",className:`color-swatch${r?" is-active":""}`,style:{background:s},onClick:()=>{we(s),Y(!1)},"aria-label":`${le("Couleur","Color")} ${s}`,title:s},s)})})]})]})]}),K&&$===2&&e.jsx("div",{className:"field",style:{gridColumn:"1 / -1",marginBottom:8},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[e.jsx("span",{className:"color-dot",style:{background:be,width:16,height:16,borderRadius:"50%",flexShrink:0}}),e.jsx("span",{style:{fontWeight:600},children:ne||"Nouvel indexeur"}),e.jsx("button",{type:"button",className:"btn btn-sm",onClick:()=>{_e(1),V(!1)},style:{marginLeft:"auto"},children:"Modifier"})]})}),G&&Ee&&$===1&&e.jsx("div",{className:"field",style:{gridColumn:"1 / -1"},children:e.jsxs("div",{className:"advanced-fields",children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"muted",children:"Torznab URL"}),e.jsx("input",{value:W,onChange:s=>H(s.target.value),placeholder:"http://ip:port/api...",disabled:$===2})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"muted",children:"Clé API"}),e.jsx("input",{value:re,onChange:s=>ye(s.target.value),placeholder:"Laisse vide pour ne pas changer",disabled:$===2})]})]})}),$===2&&e.jsxs("div",{className:"field",style:{gridColumn:"1 / -1"},children:[e.jsxs("label",{className:"muted",children:["Catégories assignées (",Gs,"/",Ks,")"]}),e.jsx("div",{style:{marginTop:8},children:e.jsx(Hs,{categories:B,mappings:n,sourceId:v?.id,onChangeMapping:(s,a)=>{const r=oe(a);h(i=>{const S=new Map(i);return r?S.set(s,r):S.delete(s),S})}})})]}),_&&e.jsxs("div",{className:"errorbox",style:{gridColumn:"1 / -1"},children:[e.jsx("div",{className:"errorbox__title",children:"Erreur"}),e.jsx("div",{className:"muted",children:_})]}),D&&e.jsxs("div",{className:"errorbox",style:{gridColumn:"1 / -1"},children:[e.jsx("div",{className:"errorbox__title",children:"Info"}),e.jsx("div",{className:"muted",children:D})]}),e.jsx("div",{className:"formactions",children:G&&$===1?e.jsxs("div",{className:"formactions-row",children:[e.jsx("div",{className:"formactions-left",children:Ee&&e.jsx("button",{className:"btn btn-fixed-info btn-nohover",type:"button",onClick:ss,disabled:!ns||E||N,children:E?"Test...":"Tester categories"})}),e.jsxs("div",{className:"formactions-right",children:[e.jsx("button",{type:"button",className:"btn btn-sm",onClick:Rs,children:Ee?"Masquer options avancées":"Options avancées"}),as&&e.jsx("button",{className:"btn btn-hover-ok",type:"button",onClick:ze,disabled:N,children:"Enregistrer"}),e.jsx("button",{className:"btn btn-fixed-danger btn-nohover",type:"button",onClick:ie,disabled:N,children:"Annuler"})]})]}):G&&$===2?e.jsxs("div",{className:"formactions-row",children:[e.jsx("div",{className:"formactions-left",children:e.jsx("button",{className:"btn btn-hover-info",type:"button",onClick:_s,disabled:N||Le,children:Le?"Reclassement...":"Reclasser l'existant"})}),e.jsxs("div",{className:"formactions-right",children:[as&&e.jsx("button",{className:"btn btn-hover-ok",type:"button",onClick:ze,disabled:N,children:"Enregistrer"}),e.jsx("button",{className:"btn btn-fixed-danger btn-nohover",type:"button",onClick:ie,disabled:N,children:"Annuler"})]})]}):$===1?e.jsxs("div",{className:"formactions-row",children:[e.jsx("div",{className:"formactions-left",children:We&&e.jsxs("span",{className:"muted",style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx(Fs,{name:"check_circle",style:{color:"var(--ok)",fontSize:18}}),"Test réussi"]})}),e.jsxs("div",{className:"formactions-right",children:[We?e.jsx("button",{className:"btn btn-hover-ok",type:"button",onClick:()=>_e(2),children:"Suivant"}):ns?e.jsx("button",{className:"btn btn-fixed-info btn-nohover",type:"button",onClick:ss,disabled:E||N,children:E?"Test...":"Tester"}):null,e.jsx("button",{className:"btn btn-fixed-danger btn-nohover",type:"button",onClick:ie,disabled:E||N,children:"Annuler"})]})]}):e.jsxs("div",{className:"formactions-row",children:[e.jsx("div",{className:"formactions-left"}),e.jsxs("div",{className:"formactions-right",children:[e.jsx("button",{className:"btn btn-hover-ok",type:"button",onClick:ze,disabled:N,children:"Enregistrer"}),e.jsx("button",{className:"btn btn-fixed-danger btn-nohover",type:"button",onClick:ie,disabled:N,children:"Annuler"})]})]})})]})})]})}export{It as default};
