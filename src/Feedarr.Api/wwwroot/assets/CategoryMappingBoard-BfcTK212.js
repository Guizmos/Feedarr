import{n as v,C as z,a as I}from"./categoryGroups.constants-TqNJ0nIh.js";import{r as p,j as e,a as ne}from"./vendor-react-B6j9w5IJ.js";import{t as m}from"./uiText-Dk9tUI9L.js";import{a as te,c as se,A as re}from"./index-DavgMby8.js";import{M as ae}from"./Modal-ulxqKDui.js";import{L as ie}from"./Loader-WjrgZmWo.js";import{c as oe,d as ce}from"./formatters-cn7FiX46.js";function B(i){const r=Number(i);return Number.isFinite(r)&&r>0?r:null}function R(i){const r=i instanceof Map?i:new Map,n=new Map;for(const[t,a]of r.entries()){const c=B(t);if(!c)continue;const u=v(a);u&&n.set(c,u)}return n}function je(i){const r=new Map;for(const n of Array.isArray(i)?i:[]){const t=B(n?.id);if(!t)continue;const a=[n?.assignedGroupKey,n?.groupKey,n?.unifiedKey];for(const u of a)u==null||String(u).trim();const c=v(n?.assignedGroupKey)||v(n?.groupKey)||v(n?.unifiedKey)||v(n?.assignedGroupLabel)||v(n?.groupLabel)||v(n?.unifiedLabel);c&&n?.isAssigned!==!1&&r.set(t,c)}return r}function Ne(i){const r=R(i),n=[];for(const[t,a]of r.entries()){const c=z[a]||a;n.push({categoryId:t,unifiedKey:a,unifiedLabel:c,catId:t,groupKey:a,groupLabel:c})}return n}function we(i,r){const n=R(i),t=R(r),a=new Set([...n.keys(),...t.keys()]),c=[];for(const u of a){const h=n.get(u)||null,d=t.get(u)||null;h!==d&&c.push({categoryId:u,unifiedKey:d,unifiedLabel:d?z[d]||d:null,catId:u,groupKey:d,groupLabel:d?z[d]||d:null})}return c}function Ce({selectedCategoryIds:i,...r}={}){const n=Array.isArray(i)?i.map(a=>Number(a)).filter(a=>Number.isInteger(a)&&a>0):[],t=Array.from(new Set(n)).sort((a,c)=>a-c);return{...r,selectedCategoryIds:t}}function Ae(i){if(!Array.isArray(i))return[];const r=new Map,n=t=>{let a=0;return v(t?.unifiedKey||t?.groupKey||t?.assignedGroupKey)&&(a+=4),(t?.unifiedLabel||t?.groupLabel||t?.assignedGroupLabel)&&(a+=2),t?.parentId&&(a+=1),t?.isSub&&(a+=1),a};for(const t of i){const a=B(t?.id);if(!a)continue;const c={...t,id:a},u=r.get(a);(!u||n(c)>n(u))&&r.set(a,c)}return Array.from(r.values())}function ke(i){const r=new Set,n=[];for(const t of Array.isArray(i)?i:[]){const a=v(t?.unifiedKey||t?.key),c=String(t?.unifiedLabel||t?.label||t?.name||"").trim().toLowerCase(),u=a||c;!u||r.has(u)||(r.add(u),n.push(t))}return n}function le({sourceId:i,previewCredentials:r,catId:n,catName:t,categoryNameMap:a=null,onClose:c}){const[u,h]=p.useState(!0),[d,b]=p.useState(null),[j,g]=p.useState([]),[w,C]=p.useState(!1),N=p.useCallback(o=>{if(n)if(h(!0),b(null),g([]),C(!1),i){const f=`/api/sources/${i}/category-preview-live?catId=${n}&limit=20`;te(f,{signal:o}).then(l=>{const k=Array.isArray(l)?l:[];g(k),C(!0),h(!1)}).catch(l=>{l?.name!=="AbortError"&&(b(l?.message||m("Erreur inconnue","Unknown error")),h(!1))})}else if(r?.torznabUrl){const f={providerId:r.providerId??null,torznabUrl:r.torznabUrl,indexerId:r.indexerId??null,authMode:r.authMode??"query",apiKey:r.apiKey??"",sourceName:r.sourceName??"",catId:n,limit:20};se("/api/sources/category-preview-live-temp",f,{signal:o}).then(l=>{const k=Array.isArray(l)?l:[];g(k),C(k.length>0),h(!1)}).catch(l=>{l?.name!=="AbortError"&&(b(l?.message||m("Erreur inconnue","Unknown error")),h(!1))})}else h(!1)},[i,r,n]);p.useEffect(()=>{const o=new AbortController;return N(o.signal),()=>o.abort()},[N]);const A=p.useMemo(()=>{const o={};for(const f of j){const l=f.categoryId;l&&(o[l]={count:(o[l]?.count||0)+1,name:o[l]?.name||f.resultCategoryName||null})}return Object.entries(o).sort((f,l)=>l[1].count-f[1].count)},[j]),M=m("Aucun résultat retourné par l'indexeur pour cette catégorie.","No results returned by the indexer for this category.");function L(o){if(o?.resultCategoryName)return o.resultCategoryName;const f=Number(o?.categoryId);return!Number.isFinite(f)||!a?null:a[f]||null}const S=e.jsxs("span",{children:[m(`Aperçu : ${t} (id ${n})`,`Preview: ${t} (id ${n})`),w&&e.jsx("span",{className:"preview-live-badge",children:m("LIVE","LIVE")})]});return e.jsxs(ae,{open:!0,title:S,onClose:c,width:"75vw",modalClassName:"category-preview-modal",children:[e.jsxs("div",{className:"category-preview-modal__body",children:[u&&e.jsx("div",{className:"category-preview-modal__loader",children:e.jsx(ie,{})}),!u&&d&&e.jsxs("div",{className:"category-preview-modal__error",children:[e.jsx("span",{children:d}),e.jsx("button",{type:"button",className:"btn btn--sm",onClick:()=>{const o=new AbortController;N(o.signal)},children:m("Réessayer","Retry")})]}),!u&&!d&&j.length===0&&e.jsx("div",{className:"category-preview-modal__empty",children:M}),!u&&!d&&A.length>0&&e.jsx("div",{className:"preview-cat-summary",children:A.map(([o,{count:f,name:l}])=>e.jsxs("span",{className:"preview-cat-summary__chip",children:[o,l?` • ${l}`:"",e.jsxs("span",{className:"preview-cat-summary__count",children:["×",f]})]},o))}),!u&&!d&&j.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"category-preview-modal__note",children:m("Catégorie item: valeur brute remontée par l'indexeur pour chaque release. Aucune catégorie Feedarr n'est réappliquée ici.","Item category: raw value returned by the indexer for each release. No Feedarr mapping is reapplied here.")}),e.jsxs("table",{className:"preview-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:m("Publié","Published")}),e.jsx("th",{children:m("Tracker","Tracker")}),e.jsx("th",{children:m("Nom","Name")}),e.jsx("th",{children:m("Taille","Size")}),e.jsx("th",{children:m("Catégorie","Category")})]})}),e.jsx("tbody",{children:j.map((o,f)=>{const l=L(o);return e.jsxs("tr",{children:[e.jsx("td",{className:"preview-table__col-date",children:oe(o.publishedAtTs)}),e.jsx("td",{className:"preview-table__col-tracker",children:o.sourceName||"—"}),e.jsx("td",{className:"preview-table__col-name",title:o.title,children:o.title}),e.jsx("td",{className:"preview-table__col-size",children:ce(o.sizeBytes)||"—"}),e.jsx("td",{className:"preview-table__col-cat",children:e.jsx("span",{className:"preview-table__cat-label",children:o.categoryId?`${o.categoryId}${l?` • ${l}`:""}`:o.unifiedCategory||"—"})})]},f)})})]})]})]}),e.jsx("div",{className:"category-preview-modal__footer",children:e.jsx("button",{type:"button",className:"btn",onClick:c,children:m("Fermer","Close")})})]})}const ue={films:"Movies",series:"TV Series",animation:"Animation",anime:"Anime",games:"Video Games",comics:"Comics",books:"Books",audio:"Audio",spectacle:"Live Shows",emissions:"Shows"};function de(i){const r=new Map;for(const n of Array.isArray(i)?i:[]){const t=Number(n?.id);!Number.isFinite(t)||t<=0||r.has(t)||n?.isSupported!==!1&&r.set(t,{id:t,name:String(n?.name||`Cat ${t}`),isStandard:n?.isStandard===!0||t>=1e3&&t<=8999,isSupported:n?.isSupported!==!1})}return[...r.values()].sort((n,t)=>n.id-t.id)}function pe(i,r,n,t){const a=v(t.get(i.id));return n==="assigned"&&!a||n==="unassigned"&&a?!1:r?`${i.id} ${i.name}`.toLowerCase().includes(r.toLowerCase()):!0}function Me({categories:i,mappings:r,onChangeMapping:n,variant:t="default",sourceId:a,previewCredentials:c,infoNote:u=null}){const[h,d]=p.useState(""),[b,j]=p.useState("all"),[g,w]=p.useState(null),[C,N]=p.useState(null),[A,M]=p.useState(null),L=p.useRef(null),S=p.useRef(new Map),o=r instanceof Map?r:new Map,f=p.useMemo(()=>de(i),[i]),l=Object.fromEntries(I.map(s=>[s.key,m(s.label,ue[s.key]||s.label)])),k=p.useMemo(()=>Object.fromEntries(f.map(s=>[s.id,s.name])),[f]),G=[...I].map(s=>({...s,label:l[s.key]||s.label})).sort((s,y)=>s.label.localeCompare(y.label,"en",{sensitivity:"base"})),_=p.useCallback(()=>{w(null),N(null)},[]),O=p.useCallback((s,y)=>{y?S.current.set(s,y):S.current.delete(s)},[]),K=p.useCallback(s=>{const y=S.current.get(s);if(!y)return null;const x=y.getBoundingClientRect(),U=180,X=I.length*34+44,$=8,F=6;let E=x.right-U;E=Math.max($,E),E=Math.min(E,window.innerWidth-U-$);const Z=x.top-$,q=window.innerHeight-x.bottom-$,D=q<X&&Z>q,ee=D?"top":"bottom";return{top:D?x.top-F:x.bottom+F,left:E,placement:ee}},[]),T=p.useCallback(s=>{if(g===s){_();return}const y=K(s);if(!y){_();return}w(s),N(y)},[_,g,K]);p.useEffect(()=>{const s=y=>{L.current&&(y.target?.closest?.("[data-mapping-menu-root='true']")||L.current.contains(y.target)||_())};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[_]),p.useEffect(()=>{if(!g)return;const s=()=>{const x=K(g);if(!x){_();return}N(x)},y=x=>{x.key==="Escape"&&_()};return window.addEventListener("resize",s),window.addEventListener("scroll",s,!0),window.addEventListener("keydown",y),()=>{window.removeEventListener("resize",s),window.removeEventListener("scroll",s,!0),window.removeEventListener("keydown",y)}},[_,g,K]);const Y=p.useMemo(()=>{const s=Object.fromEntries(I.map(y=>[y.key,0]));for(const y of f){const x=v(o.get(y.id));x&&(s[x]+=1)}return s},[o,f]),P=p.useMemo(()=>f.filter(s=>pe(s,h,b,o)),[f,h,b,o]);p.useEffect(()=>{g&&(P.some(s=>s.id===g)||_())},[_,P,g]);const H=P.filter(s=>s.isStandard),W=P.filter(s=>!s.isStandard),Q=`category-mapping-board${t==="wizard"?" category-mapping-board--wizard":""}`,J=g?v(o.get(g)):null;return e.jsxs("div",{className:Q,ref:L,children:[e.jsxs("div",{className:"category-mapping-board__top",children:[e.jsx("input",{className:"category-mapping-board__search",value:h,onChange:s=>d(s.target.value),placeholder:m("Rechercher par id ou nom...","Search by id or name...")}),e.jsxs("div",{className:"category-mapping-board__filters",children:[e.jsx("button",{type:"button",className:`type-chip${b==="all"?" type-chip--active":""}`,onClick:()=>j("all"),children:m("Tout","All")}),e.jsx("button",{type:"button",className:`type-chip${b==="assigned"?" type-chip--active":""}`,onClick:()=>j("assigned"),children:m("Assignées","Assigned")}),e.jsx("button",{type:"button",className:`type-chip${b==="unassigned"?" type-chip--active":""}`,onClick:()=>j("unassigned"),children:m("Non assignées","Unassigned")})]})]}),e.jsx("div",{className:"category-mapping-board__groups",children:G.map(s=>e.jsxs("div",{className:`category-group-card cat-bubble--${s.key}`,children:[e.jsx("div",{className:"category-group-card__label",children:s.label}),e.jsx("div",{className:"category-group-card__count",children:Y[s.key]||0})]},s.key))}),u,e.jsxs("div",{className:"category-mapping-board__columns",children:[e.jsx(V,{title:m("Standard","Standard"),categories:H,mappings:o,groupLabels:l,openMenuId:g,onToggleMenu:T,registerAssignButton:O,onPreview:a||c?M:null}),e.jsx(V,{title:m("Spécifiques","Specific"),categories:W,mappings:o,groupLabels:l,openMenuId:g,onToggleMenu:T,registerAssignButton:O,onPreview:a||c?M:null})]}),g&&C&&e.jsx(me,{groups:G,position:C,assignedKey:J,onAssign:s=>{n?.(g,s),_()},onClear:()=>{n?.(g,null),_()}}),A&&(a||c)&&e.jsx(le,{sourceId:a??null,previewCredentials:a?null:c,catId:A.id,catName:A.name,categoryNameMap:k,onClose:()=>M(null)})]})}function V({title:i,categories:r,mappings:n,groupLabels:t,openMenuId:a,onToggleMenu:c,registerAssignButton:u,onPreview:h}){return e.jsxs("div",{className:"category-mapping-board__column",children:[e.jsx("div",{className:"category-mapping-board__column-title",children:i}),e.jsxs("div",{className:"category-mapping-board__chips",children:[r.length===0&&e.jsx("div",{className:"muted",children:m("Aucune catégorie.","No category.")}),r.map(d=>{const b=v(n.get(d.id)),j=b?t[b]:"—",g=a===d.id;return e.jsx("div",{className:`mapping-chip${b?` mapping-chip--assigned mapping-chip--${b}`:""}`,children:e.jsxs("div",{className:"mapping-chip__header",children:[e.jsxs("div",{className:"mapping-chip__identity",children:[e.jsx("span",{className:"mapping-chip__id",children:d.id}),e.jsx("span",{className:"mapping-chip__name",children:d.name})]}),e.jsxs("div",{className:"mapping-chip__actions",children:[e.jsx("button",{type:"button",className:"mapping-chip__assign",ref:w=>u(d.id,w),onClick:()=>c(d.id),"aria-haspopup":"menu","aria-expanded":g?"true":"false",children:j}),h&&e.jsx("button",{type:"button",className:"iconbtn mapping-chip__preview",title:m("Aperçu des 20 derniers résultats","Preview last 20 results"),"aria-label":m("Aperçu des 20 derniers résultats","Preview last 20 results"),onClick:()=>h({id:d.id,name:d.name}),children:e.jsx(re,{name:"search"})})]})]})},d.id)})]})]})}function me({groups:i,position:r,assignedKey:n,onAssign:t,onClear:a}){return typeof document>"u"?null:ne.createPortal(e.jsxs("div",{className:`mapping-chip__menu mapping-chip__menu--portal${r.placement==="top"?" mapping-chip__menu--top":""}`,"data-mapping-menu-root":"true",style:{top:`${r.top}px`,left:`${r.left}px`},role:"menu",children:[i.map(c=>e.jsx("button",{type:"button",className:`mapping-chip__menu-item${n===c.key?" is-active":""}`,onClick:()=>t(c.key),children:c.label},c.key)),e.jsx("button",{type:"button",className:"mapping-chip__menu-item",onClick:a,children:m("Retirer","Remove")})]}),document.body)}export{Me as C,Ae as a,we as b,Ce as c,ke as d,Ne as e,je as m};
