import{n as v,C as B,a as z}from"./categoryGroups.constants-TqNJ0nIh.js";import{r as u,j as e,a as ne}from"./vendor-react-B6j9w5IJ.js";import{t as p}from"./uiText-CQKjwCG_.js";import{a as te,c as se,A as re}from"./index-BxnTI6ZJ.js";import{M as ae}from"./Modal-DE4x6WoZ.js";import{L as ie}from"./Loader-WjrgZmWo.js";import{c as oe,d as ce}from"./formatters-zH9BatN7.js";function G(o){const r=Number(o);return Number.isFinite(r)&&r>0?r:null}function F(o){const r=o instanceof Map?o:new Map,t=new Map;for(const[n,i]of r.entries()){const c=G(n);if(!c)continue;const d=v(i);d&&t.set(c,d)}return t}function we(o){const r=new Map;for(const t of Array.isArray(o)?o:[]){const n=G(t?.id);if(!n)continue;const i=[t?.assignedGroupKey,t?.groupKey,t?.unifiedKey];for(const d of i)d==null||String(d).trim();const c=v(t?.assignedGroupKey)||v(t?.groupKey)||v(t?.unifiedKey)||v(t?.assignedGroupLabel)||v(t?.groupLabel)||v(t?.unifiedLabel);c&&t?.isAssigned!==!1&&r.set(n,c)}return r}function je(o){const r=F(o),t=[];for(const[n,i]of r.entries()){const c=B[i]||i;t.push({categoryId:n,unifiedKey:i,unifiedLabel:c,catId:n,groupKey:i,groupLabel:c})}return t}function Ne(o,r){const t=F(o),n=F(r),i=new Set([...t.keys(),...n.keys()]),c=[];for(const d of i){const h=t.get(d)||null,m=n.get(d)||null;h!==m&&c.push({categoryId:d,unifiedKey:m,unifiedLabel:m?B[m]||m:null,catId:d,groupKey:m,groupLabel:m?B[m]||m:null})}return c}function Ce({selectedCategoryIds:o,...r}={}){const t=Array.isArray(o)?o.map(i=>Number(i)).filter(i=>Number.isInteger(i)&&i>0):[],n=Array.from(new Set(t)).sort((i,c)=>i-c);return{...r,selectedCategoryIds:n}}function Ae(o){if(!Array.isArray(o))return[];const r=new Map,t=n=>{let i=0;return v(n?.unifiedKey||n?.groupKey||n?.assignedGroupKey)&&(i+=4),(n?.unifiedLabel||n?.groupLabel||n?.assignedGroupLabel)&&(i+=2),n?.parentId&&(i+=1),n?.isSub&&(i+=1),i};for(const n of o){const i=G(n?.id);if(!i)continue;const c={...n,id:i},d=r.get(i);(!d||t(c)>t(d))&&r.set(i,c)}return Array.from(r.values())}function Me(o){const r=new Set,t=[];for(const n of Array.isArray(o)?o:[]){const i=v(n?.unifiedKey||n?.key),c=String(n?.unifiedLabel||n?.label||n?.name||"").trim().toLowerCase(),d=i||c;!d||r.has(d)||(r.add(d),t.push(n))}return t}function le({sourceId:o,previewCredentials:r,catId:t,catName:n,categoryNameMap:i=null,onClose:c}){const[d,h]=u.useState(!0),[m,b]=u.useState(null),[_,f]=u.useState([]),[L,S]=u.useState(!1),w=Number(t),j=u.useRef(null),M=u.useCallback(a=>{if(t)if(h(!0),b(null),f([]),S(!1),o){const y=`/api/sources/${o}/category-preview-live?catId=${t}&limit=20`;te(y,{signal:a}).then(l=>{const k=Array.isArray(l)?l:[];f(k),S(!0),h(!1)}).catch(l=>{l?.name!=="AbortError"&&(b(l?.message||p("Erreur inconnue","Unknown error")),h(!1))})}else if(r?.torznabUrl){const y={providerId:r.providerId??null,torznabUrl:r.torznabUrl,indexerId:r.indexerId??null,authMode:r.authMode??"query",apiKey:r.apiKey??"",sourceName:r.sourceName??"",catId:t,limit:20};se("/api/sources/category-preview-live-temp",y,{signal:a}).then(l=>{const k=Array.isArray(l)?l:[];f(k),S(k.length>0),h(!1)}).catch(l=>{l?.name!=="AbortError"&&(b(l?.message||p("Erreur inconnue","Unknown error")),h(!1))})}else h(!1)},[o,r,t]);u.useEffect(()=>{const a=new AbortController;return j.current=a,M(a.signal),()=>{j.current?.abort(),j.current=null}},[M]);const A=u.useMemo(()=>{const a={};for(const y of _){const l=y.categoryId;l&&(a[l]={count:(a[l]?.count||0)+1,name:a[l]?.name||y.resultCategoryName||null})}return Object.entries(a).sort((y,l)=>l[1].count-y[1].count)},[_]),E=u.useMemo(()=>A.map(([a])=>Number(a)).filter(a=>Number.isFinite(a)&&a>0),[A]),N=Number.isFinite(w)&&E.includes(w),C=E.length>0&&!N,$=p("Aucun résultat retourné par l'indexeur pour cette catégorie.","No results returned by the indexer for this category.");function T(a){if(a?.resultCategoryName)return a.resultCategoryName;const y=Number(a?.categoryId);return!Number.isFinite(y)||!i?null:i[y]||null}const K=e.jsxs("span",{children:[p(`Aperçu : ${n} (id ${t})`,`Preview: ${n} (id ${t})`),L&&e.jsx("span",{className:"preview-live-badge",children:p("LIVE","LIVE")})]});return e.jsxs(ae,{open:!0,title:K,onClose:c,width:"75vw",modalClassName:"category-preview-modal",children:[e.jsxs("div",{className:"category-preview-modal__body",children:[d&&e.jsx("div",{className:"category-preview-modal__loader",children:e.jsx(ie,{})}),!d&&m&&e.jsxs("div",{className:"category-preview-modal__error",children:[e.jsx("span",{children:m}),e.jsx("button",{type:"button",className:"btn btn--sm",onClick:()=>{j.current?.abort();const a=new AbortController;j.current=a,M(a.signal)},children:p("Réessayer","Retry")})]}),!d&&!m&&_.length===0&&e.jsx("div",{className:"category-preview-modal__empty",children:$}),!d&&!m&&(A.length>0||Number.isFinite(w))&&e.jsxs("div",{className:"preview-cat-summary",children:[Number.isFinite(w)&&e.jsxs("span",{className:"preview-cat-summary__chip preview-cat-summary__chip--requested",children:[p("Demandée","Requested"),": ",w,n?` • ${n}`:""]}),A.map(([a,{count:y,name:l}])=>e.jsxs("span",{className:`preview-cat-summary__chip${C?" preview-cat-summary__chip--returned":""}`,children:[a,l?` • ${l}`:"",e.jsxs("span",{className:"preview-cat-summary__count",children:["×",y]})]},a))]}),!d&&!m&&_.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"category-preview-modal__note",children:C?p(`La requête a bien été lancée sur ${w}${n?` • ${n}`:""}, mais l'indexeur classe les items retournés dans d'autres catégories. La colonne "Catégorie item" affiche toujours la valeur brute remontée par l'indexeur.`,`The request was sent for ${w}${n?` • ${n}`:""}, but the indexer classifies returned items in different categories. The "Item category" column always shows the raw value returned by the indexer.`):p("Catégorie item: valeur brute remontée par l'indexeur pour chaque release. Aucune catégorie Feedarr n'est réappliquée ici.","Item category: raw value returned by the indexer for each release. No Feedarr mapping is reapplied here.")}),e.jsxs("table",{className:"preview-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:p("Publié","Published")}),e.jsx("th",{children:p("Tracker","Tracker")}),e.jsx("th",{children:p("Nom","Name")}),e.jsx("th",{children:p("Taille","Size")}),e.jsx("th",{children:p("Catégorie item","Item category")})]})}),e.jsx("tbody",{children:_.map((a,y)=>{const l=T(a);return e.jsxs("tr",{children:[e.jsx("td",{className:"preview-table__col-date",children:oe(a.publishedAtTs)}),e.jsx("td",{className:"preview-table__col-tracker",children:a.sourceName||"—"}),e.jsx("td",{className:"preview-table__col-name",title:a.title,children:a.title}),e.jsx("td",{className:"preview-table__col-size",children:ce(a.sizeBytes)||"—"}),e.jsx("td",{className:"preview-table__col-cat",children:e.jsx("span",{className:"preview-table__cat-label",children:a.categoryId?`${a.categoryId}${l?` • ${l}`:""}`:a.unifiedCategory||"—"})})]},y)})})]})]})]}),e.jsx("div",{className:"category-preview-modal__footer",children:e.jsx("button",{type:"button",className:"btn",onClick:c,children:p("Fermer","Close")})})]})}const ue={films:"Movies",series:"TV Series",animation:"Animation",anime:"Anime",games:"Video Games",comics:"Comics",books:"Books",audio:"Audio",spectacle:"Live Shows",emissions:"Shows"};function de(o){const r=new Map;for(const t of Array.isArray(o)?o:[]){const n=Number(t?.id);!Number.isFinite(n)||n<=0||r.has(n)||t?.isSupported!==!1&&r.set(n,{id:n,name:String(t?.name||`Cat ${n}`),isStandard:t?.isStandard===!0||n>=1e3&&n<=8999,isSupported:t?.isSupported!==!1})}return[...r.values()].sort((t,n)=>t.id-n.id)}function me(o,r,t,n){const i=v(n.get(o.id));return t==="assigned"&&!i||t==="unassigned"&&i?!1:r?`${o.id} ${o.name}`.toLowerCase().includes(r.toLowerCase()):!0}function ke({categories:o,mappings:r,onChangeMapping:t,variant:n="default",sourceId:i,previewCredentials:c,infoNote:d=null}){const[h,m]=u.useState(""),[b,_]=u.useState("all"),[f,L]=u.useState(null),[S,w]=u.useState(null),[j,M]=u.useState(null),A=u.useRef(null),E=u.useRef(new Map),N=u.useMemo(()=>r instanceof Map?r:new Map,[r]),C=u.useMemo(()=>de(o),[o]),$=Object.fromEntries(z.map(s=>[s.key,p(s.label,ue[s.key]||s.label)])),T=u.useMemo(()=>Object.fromEntries(C.map(s=>[s.id,s.name])),[C]),K=[...z].map(s=>({...s,label:$[s.key]||s.label})).sort((s,g)=>s.label.localeCompare(g.label,"en",{sensitivity:"base"})),a=u.useCallback(()=>{L(null),w(null)},[]),y=u.useCallback((s,g)=>{g?E.current.set(s,g):E.current.delete(s)},[]),l=u.useCallback(s=>{const g=E.current.get(s);if(!g)return null;const x=g.getBoundingClientRect(),O=180,X=z.length*34+44,R=8,q=6;let I=x.right-O;I=Math.max(R,I),I=Math.min(I,window.innerWidth-O-R);const Z=x.top-R,U=window.innerHeight-x.bottom-R,D=U<X&&Z>U,ee=D?"top":"bottom";return{top:D?x.top-q:x.bottom+q,left:I,placement:ee}},[]),k=u.useCallback(s=>{if(f===s){a();return}const g=l(s);if(!g){a();return}L(s),w(g)},[a,f,l]);u.useEffect(()=>{const s=g=>{A.current&&(g.target?.closest?.("[data-mapping-menu-root='true']")||A.current.contains(g.target)||a())};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[a]),u.useEffect(()=>{if(!f)return;const s=()=>{const x=l(f);if(!x){a();return}w(x)},g=x=>{x.key==="Escape"&&a()};return window.addEventListener("resize",s),window.addEventListener("scroll",s,!0),window.addEventListener("keydown",g),()=>{window.removeEventListener("resize",s),window.removeEventListener("scroll",s,!0),window.removeEventListener("keydown",g)}},[a,f,l]);const Y=u.useMemo(()=>{const s=Object.fromEntries(z.map(g=>[g.key,0]));for(const g of C){const x=v(N.get(g.id));x&&(s[x]+=1)}return s},[N,C]),P=u.useMemo(()=>C.filter(s=>me(s,h,b,N)),[C,h,b,N]);u.useEffect(()=>{f&&(P.some(s=>s.id===f)||a())},[a,P,f]);const H=P.filter(s=>s.isStandard),W=P.filter(s=>!s.isStandard),Q=`category-mapping-board${n==="wizard"?" category-mapping-board--wizard":""}`,J=f?v(N.get(f)):null;return e.jsxs("div",{className:Q,ref:A,children:[e.jsxs("div",{className:"category-mapping-board__top",children:[e.jsx("input",{className:"category-mapping-board__search",value:h,onChange:s=>m(s.target.value),placeholder:p("Rechercher par id ou nom...","Search by id or name...")}),e.jsxs("div",{className:"category-mapping-board__filters",children:[e.jsx("button",{type:"button",className:`type-chip${b==="all"?" type-chip--active":""}`,onClick:()=>_("all"),children:p("Tout","All")}),e.jsx("button",{type:"button",className:`type-chip${b==="assigned"?" type-chip--active":""}`,onClick:()=>_("assigned"),children:p("Assignées","Assigned")}),e.jsx("button",{type:"button",className:`type-chip${b==="unassigned"?" type-chip--active":""}`,onClick:()=>_("unassigned"),children:p("Non assignées","Unassigned")})]})]}),e.jsx("div",{className:"category-mapping-board__groups",children:K.map(s=>e.jsxs("div",{className:`category-group-card cat-bubble--${s.key}`,children:[e.jsx("div",{className:"category-group-card__label",children:s.label}),e.jsx("div",{className:"category-group-card__count",children:Y[s.key]||0})]},s.key))}),d,e.jsxs("div",{className:"category-mapping-board__columns",children:[e.jsx(V,{title:p("Standard","Standard"),categories:H,mappings:N,groupLabels:$,openMenuId:f,onToggleMenu:k,registerAssignButton:y,onPreview:i||c?M:null}),e.jsx(V,{title:p("Spécifiques","Specific"),categories:W,mappings:N,groupLabels:$,openMenuId:f,onToggleMenu:k,registerAssignButton:y,onPreview:i||c?M:null})]}),f&&S&&e.jsx(pe,{groups:K,position:S,assignedKey:J,onAssign:s=>{t?.(f,s),a()},onClear:()=>{t?.(f,null),a()}}),j&&(i||c)&&e.jsx(le,{sourceId:i??null,previewCredentials:i?null:c,catId:j.id,catName:j.name,categoryNameMap:T,onClose:()=>M(null)})]})}function V({title:o,categories:r,mappings:t,groupLabels:n,openMenuId:i,onToggleMenu:c,registerAssignButton:d,onPreview:h}){return e.jsxs("div",{className:"category-mapping-board__column",children:[e.jsx("div",{className:"category-mapping-board__column-title",children:o}),e.jsxs("div",{className:"category-mapping-board__chips",children:[r.length===0&&e.jsx("div",{className:"muted",children:p("Aucune catégorie.","No category.")}),r.map(m=>{const b=v(t.get(m.id)),_=b?n[b]:"—",f=i===m.id;return e.jsx("div",{className:`mapping-chip${b?` mapping-chip--assigned mapping-chip--${b}`:""}`,children:e.jsxs("div",{className:"mapping-chip__header",children:[e.jsxs("div",{className:"mapping-chip__identity",children:[e.jsx("span",{className:"mapping-chip__id",children:m.id}),e.jsx("span",{className:"mapping-chip__name",children:m.name})]}),e.jsxs("div",{className:"mapping-chip__actions",children:[e.jsx("button",{type:"button",className:"mapping-chip__assign",ref:L=>d(m.id,L),onClick:()=>c(m.id),"aria-haspopup":"menu","aria-expanded":f?"true":"false",children:_}),h&&e.jsx("button",{type:"button",className:"iconbtn mapping-chip__preview",title:p("Aperçu des 20 derniers résultats","Preview last 20 results"),"aria-label":p("Aperçu des 20 derniers résultats","Preview last 20 results"),onClick:()=>h({id:m.id,name:m.name}),children:e.jsx(re,{name:"search"})})]})]})},m.id)})]})]})}function pe({groups:o,position:r,assignedKey:t,onAssign:n,onClear:i}){return typeof document>"u"?null:ne.createPortal(e.jsxs("div",{className:`mapping-chip__menu mapping-chip__menu--portal${r.placement==="top"?" mapping-chip__menu--top":""}`,"data-mapping-menu-root":"true",style:{top:`${r.top}px`,left:`${r.left}px`},role:"menu",children:[o.map(c=>e.jsx("button",{type:"button",className:`mapping-chip__menu-item${t===c.key?" is-active":""}`,onClick:()=>n(c.key),children:c.label},c.key)),e.jsx("button",{type:"button",className:"mapping-chip__menu-item",onClick:i,children:p("Retirer","Remove")})]}),document.body)}export{ke as C,Ae as a,Ne as b,Ce as c,Me as d,je as e,we as m};
