import{r as t,j as e}from"./vendor-react-B6j9w5IJ.js";import{d as Ne,e as we,a as se,b as Y,c as ce,t as os,u as qs,A as Ws,f as cs,h as Xs}from"./index-w1EqWPJX.js";import{L as bs}from"./Loader-WjrgZmWo.js";import{S as Se}from"./SubAction-DElFiSm2.js";import{M as Ke}from"./Modal-D9seooTq.js";import{T as Js,C as Ys,I as Vs}from"./ItemRow-Dnar6FKB.js";import{t as le}from"./uiText-BZ3z2hUD.js";import{S as ee,n as ye,g as Hs}from"./sourceColors-KACkINRj.js";import{d as Qs,C as Zs,a as et,m as st,b as tt,c as ds,e as nt}from"./CategoryMappingBoard-Bg5E-jwv.js";import{C as us,n as oe}from"./categoryGroups.constants-TqNJ0nIh.js";import{M as ms}from"./categoryPriority.constants-BnKBS6eK.js";import"./vendor-router-DbNMZja2.js";import"./vendor-icons-BuPyRjLk.js";import"./formatters-D7ST7XGG.js";const xs="test-indexer-";function rt(o,m){Ne({key:`${xs}${o}`,label:`Test: ${m}`,meta:"Test en cours...",ttlMs:1e3*60*2})}function ps(o){we(`${xs}${o}`)}function at(){Ne({key:"test-new-indexer",label:"Test nouvel indexer",meta:"Validation en cours...",ttlMs:1e3*60*2})}function it(){we("test-new-indexer")}const ys="refresh-caps-";function lt(o,m){Ne({key:`${ys}${o}`,label:`Refresh caps: ${m}`,meta:"Récupération...",ttlMs:1e3*60*3})}function ot(o){we(`${ys}${o}`)}const Ce={syncIntervalMinutes:"60",rssLimitPerCategory:"50",rssLimitGlobalPerSource:"250",autoSyncEnabled:!0},G=(o,m)=>{const b=String(o??"").trim();if(!b)return m;const M=Number(b);return Number.isFinite(M)?Math.trunc(M):m};function ct({onStateChange:o,showSaveButton:m=!1}){const[b,M]=t.useState(!0),[p,j]=t.useState(""),[f,N]=t.useState("idle"),[u,E]=t.useState(Ce),[I,O]=t.useState(Ce),[y,K]=t.useState(()=>new Set),[T,q]=t.useState("ok"),A=t.useRef(null),n=t.useRef(null),h=t.useRef(null),g=t.useRef(null),w=t.useCallback(async()=>{M(!0),j("");try{const c=await se("/api/settings/general"),d=G(c?.rssLimitPerCategory??c?.rssLimit,50),$=G(c?.rssLimitGlobalPerSource,250),L={syncIntervalMinutes:String(G(c?.syncIntervalMinutes,60)),rssLimitPerCategory:String(d),rssLimitGlobalPerSource:String($),autoSyncEnabled:c?.autoSyncEnabled!==!1};E(L),O(L)}catch(c){j(c?.message||"Erreur chargement paramètres"),E(Ce),O(Ce)}finally{M(!1)}},[]);t.useEffect(()=>(w(),()=>{A.current&&clearTimeout(A.current)}),[w]);const k=t.useMemo(()=>!!u.autoSyncEnabled!==I.autoSyncEnabled||String(u.syncIntervalMinutes)!==I.syncIntervalMinutes||String(u.rssLimitPerCategory)!==I.rssLimitPerCategory||String(u.rssLimitGlobalPerSource)!==I.rssLimitGlobalPerSource,[u,I]),x=t.useCallback(c=>y.has(c)?T==="err"?" pulse-err":" pulse-ok":"",[y,T]),P=t.useCallback(async()=>{if(f==="loading")return;j("");const c=n.current?.value??u.syncIntervalMinutes,d=h.current?.value??u.rssLimitPerCategory,$=g.current?.value??u.rssLimitGlobalPerSource,L=new Set;!!u.autoSyncEnabled!==I.autoSyncEnabled&&L.add("general.autoSync"),String(c)!==I.syncIntervalMinutes&&L.add("general.sync"),String(d)!==I.rssLimitPerCategory&&L.add("general.rssPerCat"),String($)!==I.rssLimitGlobalPerSource&&L.add("general.rssGlobal");const V=Date.now();let W=!1;N("loading");try{const z=await se("/api/settings/general");await Y("/api/settings/general",{...z,syncIntervalMinutes:G(c,60),rssLimit:G(d,50),rssLimitPerCategory:G(d,50),rssLimitGlobalPerSource:G($,250),autoSyncEnabled:!!u.autoSyncEnabled}),O({syncIntervalMinutes:String(G(c,60)),rssLimitPerCategory:String(G(d,50)),rssLimitGlobalPerSource:String(G($,250)),autoSyncEnabled:!!u.autoSyncEnabled}),E(te=>({...te,syncIntervalMinutes:String(c??""),rssLimitPerCategory:String(d??""),rssLimitGlobalPerSource:String($??"")})),W=!0}catch(z){j(z?.message||"Erreur sauvegarde paramètres")}finally{const z=Date.now()-V;z<800&&await new Promise(te=>setTimeout(te,800-z)),N(W?"success":"error"),L.size>0&&(A.current&&clearTimeout(A.current),q(W?"ok":"err"),K(new Set(L)),A.current=setTimeout(()=>{K(new Set)},1200)),setTimeout(()=>N("idle"),1e3)}},[u,I,f]);return t.useEffect(()=>{o&&o({isDirty:k,saveState:f,onSave:P})},[o,k,f,P]),e.jsxs("div",{className:"settings-card",id:"indexers-sync",children:[e.jsx("div",{className:"settings-card__head",children:e.jsx("div",{className:"settings-card__title",children:"Synchronisation"})}),p&&e.jsxs("div",{className:"errorbox",style:{marginBottom:12},children:[e.jsx("div",{className:"errorbox__title",children:"Erreur"}),e.jsx("div",{className:"muted",children:p})]}),b?e.jsx(bs,{label:"Chargement des paramètres..."}):e.jsxs("div",{className:"indexer-list",children:[e.jsx("div",{className:`indexer-card${x("general.autoSync")}`,children:e.jsxs("div",{className:"indexer-row indexer-row--settings",children:[e.jsx("span",{className:"indexer-title",children:"Synchronisation auto"}),e.jsxs("div",{className:"indexer-actions",children:[e.jsx("span",{className:"indexer-status",children:u.autoSyncEnabled?"Actif":"Desactive"}),e.jsx(Js,{checked:u.autoSyncEnabled,onIonChange:c=>E(d=>({...d,autoSyncEnabled:c.detail.checked})),className:"settings-toggle",title:u.autoSyncEnabled?"Désactiver":"Activer"})]})]})}),e.jsx("div",{className:`indexer-card${x("general.sync")}${u.autoSyncEnabled?"":" is-disabled"}`,children:e.jsxs("div",{className:"indexer-row indexer-row--settings",children:[e.jsx("span",{className:"indexer-title",children:"Intervalle Sync RSS (minutes)"}),e.jsx("div",{className:"indexer-actions",children:e.jsx("input",{type:"number",min:1,max:1440,value:u.syncIntervalMinutes,disabled:!u.autoSyncEnabled,ref:n,onChange:c=>{E(d=>({...d,syncIntervalMinutes:c.target.value}))}})})]})}),e.jsxs("div",{className:`indexer-card${x("general.rssPerCat")}`,children:[e.jsxs("div",{className:"indexer-row indexer-row--settings",children:[e.jsx("span",{className:"indexer-title",title:"Remplissage progressif par catégorie, purge des plus anciens.",children:"Limite RSS par catégorie"}),e.jsx("div",{className:"indexer-actions",children:e.jsx("input",{type:"number",min:1,max:200,value:u.rssLimitPerCategory,ref:h,onChange:c=>{E(d=>({...d,rssLimitPerCategory:c.target.value}))}})})]}),e.jsx("div",{className:"settings-help",children:"Remplissage progressif par catégorie, purge des plus anciens."})]}),e.jsxs("div",{className:`indexer-card${x("general.rssGlobal")}`,children:[e.jsxs("div",{className:"indexer-row indexer-row--settings",children:[e.jsx("span",{className:"indexer-title",title:"Plafond global par source, purge des plus anciens.",children:"Limite RSS globale (par source)"}),e.jsx("div",{className:"indexer-actions",children:e.jsx("input",{type:"number",min:1,max:2e3,value:u.rssLimitGlobalPerSource,ref:g,onChange:c=>{E(d=>({...d,rssLimitGlobalPerSource:c.target.value}))}})})]}),e.jsx("div",{className:"settings-help",children:"Plafond global par source, purge des plus anciens."})]})]}),m&&!b&&k&&e.jsx("div",{className:"formactions",style:{marginTop:16},children:e.jsx("button",{className:`btn ${f==="success"?"btn-hover-ok":f==="error"?"btn-fixed-danger btn-nohover":"btn-hover-ok"}`,type:"button",onClick:P,disabled:!k||f==="loading",children:f==="loading"?"Enregistrement...":f==="success"?"Enregistré":f==="error"?"Erreur":"Enregistrer"})})]})}function dt({onPrepareAdd:o,onPrepareEdit:m,onAfterClose:b}={}){const[M,p]=t.useState(!1),[j,f]=t.useState(null),[N,u]=t.useState(!1),[E,I]=t.useState(null),[O,y]=t.useState(1),K=t.useCallback(()=>{f(null),y(1),o?.(),p(!0)},[o]),T=t.useCallback(h=>{f(h),y(1),m?.(h),p(!0)},[m]),q=t.useCallback(()=>{p(!1),b?.()},[b]),A=t.useCallback(h=>{I(h),u(!0)},[]),n=t.useCallback(()=>{u(!1),I(null)},[]);return{modalOpen:M,editing:j,confirmOpen:N,confirmTarget:E,modalStep:O,setModalStep:y,openAdd:K,openEdit:T,closeModal:q,openDeleteConfirm:A,closeDeleteConfirm:n}}const hs="rss-sync-";function ut(o,m){Ne({key:`${hs}${o}`,label:`Sync: ${m}`,meta:"En cours...",ttlMs:1e3*60*5})}function fs(o){we(`${hs}${o}`)}function je(o,m,b=1600){setTimeout(()=>{o(M=>{const p={...M};return delete p[m],p})},b)}function mt({items:o,load:m,setErr:b}){const[M,p]=t.useState(null),[j,f]=t.useState({}),[N,u]=t.useState(!1),[E,I]=t.useState(null),[O,y]=t.useState({}),K=t.useMemo(()=>Object.values(j||{}).some(n=>n==="pending"),[j]),T=t.useCallback(async()=>{const n=(o||[]).filter(g=>g?.id&&g?.enabled);if(n.length===0)return;b("");const h=Date.now();u(!0),f(g=>{const w={...g||{}};return n.forEach(k=>{w[k.id]="pending"}),w});try{const g=await Promise.allSettled(n.map(x=>ce(`/api/sources/${x.id}/sync`)));await m(),os("sync-all");const w=Date.now()-h,k=Math.max(2e3-w,0);setTimeout(()=>{f(x=>{const P={...x||{}};return n.forEach((c,d)=>{const $=g[d],L=$.status==="fulfilled"?!!$.value?.ok:!1;P[c.id]=L?"ok":"error"}),P}),setTimeout(()=>{f(x=>{const P={...x||{}};return n.forEach(c=>{delete P[c.id]}),P})},1600),u(!1)},k)}catch(g){b(g?.message||"Erreur sync");const w=Date.now()-h,k=Math.max(2e3-w,0);setTimeout(()=>{f(x=>{const P={...x||{}};return n.forEach(c=>{P[c.id]="error"}),P}),setTimeout(()=>{f(x=>{const P={...x||{}};return n.forEach(c=>{delete P[c.id]}),P})},1600),u(!1)},k)}},[o,m,b]),q=t.useCallback(async n=>{if(!n?.id||!n.enabled||E===n.id||N||j[n.id]==="pending")return;b("");const h=Date.now();p(n.id),f(g=>({...g,[n.id]:"pending"})),ut(n.id,n.name||`Source #${n.id}`);try{const g=await ce(`/api/sources/${n.id}/sync`);await m(),os("sync");const w=Date.now()-h,k=Math.max(2e3-w,0);setTimeout(()=>{f(x=>({...x,[n.id]:g?.ok?"ok":"error"})),je(f,n.id),p(null),fs(n.id)},k)}catch(g){b(g?.message||"Erreur sync");const w=Date.now()-h,k=Math.max(2e3-w,0);setTimeout(()=>{f(x=>({...x,[n.id]:"error"})),je(f,n.id),p(null),fs(n.id)},k)}},[m,b,N,j,E]),A=t.useCallback(async n=>{if(!n?.id||!n.enabled||M===n.id||j[n.id]==="pending")return;b("");const h=Date.now();I(n.id),y(g=>({...g,[n.id]:"pending"})),rt(n.id,n.name||`Source #${n.id}`);try{const g=await ce(`/api/sources/${n.id}/test`,{rssLimit:50}),w=Date.now()-h,k=Math.max(2e3-w,0);setTimeout(()=>{y(x=>({...x,[n.id]:g?.ok?"ok":"error"})),je(y,n.id),I(null),ps(n.id)},k)}catch(g){b(g?.message||"Erreur test");const w=Date.now()-h,k=Math.max(2e3-w,0);setTimeout(()=>{y(x=>({...x,[n.id]:"error"})),je(y,n.id),I(null),ps(n.id)},k)}},[b,M,j]);return{syncingId:M,syncStatusById:j,syncAllRunning:N,testingId:E,testStatusById:O,hasPendingSync:K,syncAll:T,syncSource:q,testSource:A}}const Be="__manual__";function gs(o){return(o||"").trim().toLowerCase().replace(/\/+$/,"")}function pt(o,m){if(o===m)return!0;if(!(o instanceof Map)||!(m instanceof Map)||o.size!==m.size)return!1;for(const[b,M]of o.entries())if(m.get(b)!==M)return!1;return!0}function Et(){const o=qs(),[m,b]=t.useState(!0),[M,p]=t.useState(""),[j,f]=t.useState([]),[N,u]=t.useState(!1),[E,I]=t.useState(!1),[O,y]=t.useState(""),[K,T]=t.useState(""),[q,A]=t.useState([]),[n,h]=t.useState(()=>new Map),[g,w]=t.useState([]),[k,x]=t.useState(!1),[P,c]=t.useState(""),[d,$]=t.useState(""),[L,V]=t.useState([]),[W,z]=t.useState(!1),[te,de]=t.useState(""),[Fe,ne]=t.useState(""),[D,ue]=t.useState(""),me=t.useRef(0),[qe,Ie]=t.useState(ee[0]),[ke,H]=t.useState(!1),Ee=t.useRef(null),[Me,Pe]=t.useState(!1),[We,Q]=t.useState(!1),[vs,re]=t.useState(null),[Ss,Xe]=t.useState(!1),Le=t.useRef(null),pe=t.useRef(null),[Te,Je]=t.useState(!1),[X,ae]=t.useState(""),[U,Z]=t.useState(""),[J,he]=t.useState(""),[Ae,Ye]=t.useState(!0),fe=t.useMemo(()=>(j||[]).some(s=>!!s?.enabled),[j]),[Re,Cs]=t.useState({}),B=t.useCallback(async()=>{p(""),b(!0);try{const s=await se("/api/sources"),r=Array.isArray(s)?s:[];f(r);const a={};await Promise.all(r.map(async i=>{if(i?.id)try{const S=await se(`/api/sources/${i.id}/category-mappings`);a[i.id]=(Array.isArray(S)?S:[]).map(l=>({id:Number(l?.catId),unifiedKey:oe(l?.groupKey||l?.unifiedKey),unifiedLabel:l?.groupLabel||l?.unifiedLabel||us[oe(l?.groupKey||l?.unifiedKey)]||"",name:l?.groupLabel||l?.unifiedLabel||us[oe(l?.groupKey||l?.unifiedKey)]||""}))}catch(S){console.error(`[Indexers] Impossible de charger les catégories pour la source #${i.id}.`,S),a[i.id]=[]}})),Cs(a)}catch(s){p(s?.message||"Erreur chargement sources")}finally{b(!1)}},[]);t.useEffect(()=>{B()},[B]);const{syncingId:js,syncStatusById:$e,syncAllRunning:ge,testingId:Ns,testStatusById:Ve,hasPendingSync:He,syncAll:Qe,syncSource:ws,testSource:Is}=mt({items:j,load:B,setErr:p}),Ze=t.useCallback(async()=>{w([]),c(""),x(!0);try{const s=await se("/api/providers"),a=(Array.isArray(s)?s:[]).filter(i=>!!i?.enabled);w(a),a.length===0&&c("Aucun fournisseur configuré.")}catch(s){c(s?.message||"Impossible de charger les fournisseurs.")}finally{x(!1)}},[]),_e=t.useCallback(async s=>{if(!s)return;const r=++me.current;V([]),de(""),ne(""),z(!0);try{const a=await se(`/api/providers/${s}/indexers`);if(r!==me.current)return;const i=Array.isArray(a)?a:a?.indexers,S=(Array.isArray(i)?i:[]).filter(l=>l?.name&&l?.torznabUrl).sort((l,C)=>String(l.name).localeCompare(String(C.name)));V(S),S.length===0&&de("Aucun indexeur disponible (fournisseur non configuré ?)")}catch(a){if(r!==me.current)return;ne(a?.message||"Impossible de charger les indexeurs.")}finally{r===me.current&&z(!1)}},[]);t.useEffect(()=>{if(!d){me.current++,V([]),de(""),ne(""),z(!1);return}_e(d)},[d,_e]),t.useEffect(()=>{if(!ke)return;const s=a=>{Ee.current&&(Ee.current.contains(a.target)||H(!1))},r=a=>{a.key==="Escape"&&H(!1)};return document.addEventListener("mousedown",s),document.addEventListener("keydown",r),()=>{document.removeEventListener("mousedown",s),document.removeEventListener("keydown",r)}},[ke]);const ks=t.useCallback(()=>{ae(""),Z(""),he(""),Ye(!0),Ie(ee[0]),H(!1),Pe(!1),Q(!1),re(null),y(""),T(""),A([]),h(new Map),w([]),c(""),$(""),V([]),de(""),ne(""),ue(""),Le.current=null,pe.current=null,Ze()},[Ze]),Es=t.useCallback(s=>{const r=ye(s?.color)||Hs(s?.id,s?.color)||ee[0];Le.current={name:(s?.name??"").trim(),torznabUrl:(s?.torznabUrl??"").trim(),color:ye(r)||ee[0]};const a=(Re[s?.id]||[]).map(i=>[Number(i?.id),oe(i?.unifiedKey)]).filter(([i,S])=>Number.isFinite(i)&&i>0&&!!S);pe.current=new Map(a),ae(s.name??""),Z(s.torznabUrl??""),he(""),Ye(!!s.enabled),Ie(r),H(!1),Pe(!1),Q(!1),re(null),y(""),T(""),A([]),h(new Map),$(""),ue("")},[Re]),Ms=t.useCallback(()=>{y(""),T(""),A([]),h(new Map),$(""),ue(""),ne(""),H(!1)},[]),{modalOpen:Ps,editing:v,confirmOpen:Ls,confirmTarget:ve,modalStep:R,setModalStep:Oe,openAdd:es,openEdit:Ts,closeModal:ie,openDeleteConfirm:As,closeDeleteConfirm:ze}=dt({onPrepareAdd:ks,onPrepareEdit:Es,onAfterClose:Ms}),Rs=t.useCallback(()=>{Pe(s=>!s)},[]);async function ss(){y(""),T(""),p("");const s={torznabUrl:U.trim(),apiKey:J.trim(),authMode:"query",indexerName:X.trim()};if(!s.torznabUrl){y("URL requise pour tester.");return}if(!v?.id&&!d){y("Choisis un fournisseur avant de tester.");return}I(!0),v?.id?lt(v.id,v.name||`Source #${v.id}`):at();try{const r=v?.id?await se(`/api/categories/caps?sourceId=${v.id}&includeStandardCatalog=true&includeSpecific=true`):await ce("/api/categories/caps/provider",{providerId:Number(d),torznabUrl:s.torznabUrl,indexerName:s.indexerName,indexerId:xe?null:D||null,includeStandardCatalog:!0,includeSpecific:!0}),a=Array.isArray(r?.categories)?r.categories:[],i=et(a),S=Array.isArray(r?.warnings)?r.warnings:[];S.length>0&&T(S.join(" ")),A(i);const l=st(i);h(l),i.length===0&&S.length===0&&T("Aucune catégorie disponible."),v?.id?(pe.current=new Map(l),Oe(2)):(h(new Map),r?.sourceId&&re(r.sourceId),Q(!0))}catch(r){y(r?.message||"Erreur test indexeur")}finally{I(!1),v?.id?ot(v.id):it()}}async function De(s){if(s?.preventDefault&&s.preventDefault(),s?.stopPropagation&&s.stopPropagation(),N)return;if(p(""),y(""),u(!0),F&&!d){y("Choisis un fournisseur avant d’enregistrer."),u(!1);return}const r=ye(qe)||ee[0],a={name:X.trim(),torznabUrl:U.trim(),authMode:"query",apiKey:J.trim()||null,providerId:d?Number(d):null,color:r};try{const i=new Map([...n.entries()].map(([l,C])=>[Number(l),oe(C)]).filter(([l,C])=>Number.isFinite(l)&&l>0&&!!C)),S=[...i.keys()].map(l=>Number(l)).filter(l=>Number.isFinite(l)&&l>0).sort((l,C)=>l-C);if(v?.id)if(R===2){await Y(`/api/sources/${v.id}`,a),await Y(`/api/sources/${v.id}/enabled`,{enabled:Ae});const l=tt(pe.current,i);await cs(`/api/sources/${v.id}/category-mappings`,ds({mappings:l,selectedCategoryIds:S}))}else await Y(`/api/sources/${v.id}`,a),await Y(`/api/sources/${v.id}/enabled`,{enabled:Ae});else{if(R!==2)return;const l=nt(i);let C=vs;if(C)await Y(`/api/sources/${C}`,a),await Y(`/api/sources/${C}/enabled`,{enabled:Ae});else{const Ge=await ce("/api/sources",{...a});C=Number(Ge?.id)||null}C&&await cs(`/api/sources/${C}/category-mappings`,ds({mappings:l,selectedCategoryIds:S}))}await B(),typeof window<"u"&&window.dispatchEvent(new Event("onboarding:refresh")),ie()}catch(i){p(i?.message||"Erreur sauvegarde")}finally{u(!1)}}async function $s(s){if(s?.id){p("");try{await Y(`/api/sources/${s.id}/enabled`,{enabled:!s.enabled}),await B()}catch(r){p(r?.message||"Erreur enable/disable")}}}async function _s(){if(!(!v?.id||Te||!(typeof window>"u"||window.confirm("Reclasser l'existant pour cette source ? Cette action peut prendre quelques instants.")))){p(""),y(""),Je(!0);try{await ce(`/api/sources/${v.id}/reclassify`),await B(),T("Reclassement lancé avec succès pour cette source.")}catch(r){p(r?.message||"Erreur reclassification")}finally{Je(!1)}}}t.useEffect(()=>(o(e.jsxs("div",{className:"indexers-subbar-content",subbarClassName:"subbar--indexers-sync",children:[e.jsx(Se,{icon:"refresh",label:"Refresh",onClick:B}),e.jsx(Se,{icon:"add_circle",label:"Ajouter",onClick:es}),e.jsx(Se,{icon:"settings",label:"Options",onClick:()=>Xe(!0),title:"Options de synchronisation"}),fe&&e.jsx("div",{className:"subspacer"}),fe&&e.jsx(Se,{icon:ge?"progress_activity":"sync",label:"Sync all",onClick:Qe,disabled:!fe||ge||He,title:fe?"Sync all":"Aucun indexer actif",className:ge?"is-loading":void 0})]})),()=>o(null)),[o,B,es,Qe,ge,fe,He]);async function Os(s){if(s?.id){p("");try{await Xs(`/api/sources/${s.id}`),await B()}catch(r){p(r?.message||"Erreur suppression")}}}const zs=t.useMemo(()=>(j||[]).map(s=>({...s,_name:s.name??`Source ${s.id}`,_url:s.torznabUrl??""})).sort((s,r)=>(Number(s.id)||0)-(Number(r.id)||0)),[j]),_=!!v,F=!v,be=ye(qe)||ee[0],ts=_&&R===2,xe=F&&D===Be,ns=F?d&&U.trim():U.trim(),Ds=t.useMemo(()=>{if(!_)return!1;const s=Le.current;if(!s)return!1;const r=X.trim()!==s.name,a=U.trim()!==s.torznabUrl,i=be!==s.color,S=!!J.trim();return r||a||i||S},[_,X,U,be,J]),Us=t.useMemo(()=>{if(!_||R!==2)return!1;const s=pe.current;return s?!pt(n,s):!1},[_,R,n]),rs=_&&(Ds||Us),Gs=n.size,Ks=q.length,Bs=R===2?"75vw":560,as=t.useMemo(()=>new Set((j||[]).map(s=>gs(s.torznabUrl)).filter(Boolean)),[j]),Ue=t.useMemo(()=>{const s=(L||[]).filter(r=>!as.has(gs(r.torznabUrl)));if(D&&!s.some(a=>String(a.id)===String(D))){const a=(L||[]).find(i=>String(i.id)===String(D));if(a)return[...s,a]}return s},[L,as,D]),Fs=t.useMemo(()=>{if(_)return null;const s=U.trim();return s?{providerId:d?Number(d):null,torznabUrl:s,indexerId:xe?null:D||null,authMode:"query",apiKey:J.trim(),sourceName:X.trim()}:null},[_,U,d,xe,D,J,X]);return e.jsxs("div",{className:"page page--indexers",children:[e.jsx("div",{className:"pagehead",children:e.jsxs("div",{children:[e.jsx("h1",{children:"Indexeurs"}),e.jsx("div",{className:"muted",children:"Sources Torznab / Jackett / Prowlarr"})]})}),e.jsx("div",{className:"pagehead__divider"}),M&&e.jsxs("div",{className:"errorbox",children:[e.jsx("div",{className:"errorbox__title",children:"Erreur"}),e.jsx("div",{className:"muted",children:M})]}),m?e.jsx(bs,{label:"Chargement des sources…"}):e.jsx("div",{className:"indexer-list itemrow-grid",children:zs.map(s=>{const r=js===s.id||$e[s.id]==="pending",a=Ns===s.id,i=r||a||ge,S=[Ve[s.id]==="ok"&&"test-ok",Ve[s.id]==="error"&&"test-err",$e[s.id]==="ok"&&"sync-ok",$e[s.id]==="error"&&"sync-err"].filter(Boolean).join(" "),l=Qs((Re[s.id]||[]).slice().sort((C,Ge)=>{const is=ms.indexOf(C.unifiedKey),ls=ms.indexOf(Ge.unifiedKey);return(is===-1?999:is)-(ls===-1?999:ls)})).map(C=>e.jsx(Ys,{unifiedKey:C.unifiedKey,label:C.unifiedLabel||C.name,title:`${C.name} (${C.id})`},C.unifiedKey||C.id));return e.jsx(Vs,{id:s.id,title:s._name,meta:s._url,enabled:s.enabled,badges:l,statusClass:S,actions:[{icon:"sync",title:r?"Sync en cours...":"Sync",onClick:()=>ws(s),disabled:i||!s.enabled,spinning:r},{icon:"science",title:a?"Test en cours...":"Test",onClick:()=>Is(s),disabled:a||r||!s.enabled,spinning:a},{icon:"edit",title:"Modifier",onClick:()=>Ts(s),disabled:i||!s.enabled},{icon:"delete",title:"Supprimer",onClick:()=>As(s),disabled:i||!s.enabled,className:"iconbtn--danger"}],showToggle:!0,onToggle:()=>$s(s),toggleDisabled:r||a},s.id)})}),e.jsx(Ke,{open:Ss,title:"Options de synchronisation",onClose:()=>Xe(!1),width:560,children:e.jsx("div",{style:{padding:12},children:e.jsx(ct,{showSaveButton:!0})})}),e.jsx(Ke,{open:Ls,title:ve?`Supprimer : ${ve?.name??ve?.id}`:"Supprimer",onClose:ze,width:520,children:e.jsxs("div",{style:{padding:12},children:[e.jsx("div",{style:{fontWeight:700,marginBottom:8},children:"Confirmer la suppression ?"}),e.jsx("div",{className:"muted",children:"Cette action est irréversible."}),e.jsxs("div",{className:"formactions",style:{marginTop:16},children:[e.jsx("button",{className:"btn btn-danger",type:"button",onClick:async()=>{const s=ve;ze(),s&&await Os(s)},children:"Supprimer"}),e.jsx("button",{className:"btn",type:"button",onClick:ze,children:"Annuler"})]})]})}),e.jsx(Ke,{open:Ps,title:v?`Modifier : ${v?.name??v?.id}`:"Ajouter une source",onClose:ie,width:Bs,children:e.jsxs("form",{onSubmit:s=>s.preventDefault(),className:"formgrid formgrid--edit",children:[R===1&&e.jsxs(e.Fragment,{children:[F&&e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"muted",children:"Fournisseur"}),e.jsxs("select",{value:d,onChange:s=>{const r=s.target.value;$(r),ue(""),V([]),de(""),ne(""),ae(""),Z(""),y(""),T(""),A([]),h(new Map),Q(!1),re(null)},disabled:k||g.length===0,children:[e.jsx("option",{value:"",disabled:!0,children:"Choisir un fournisseur..."}),g.map(s=>e.jsx("option",{value:s.id,children:s.name||(String(s.type||"").toLowerCase()==="prowlarr"?"Prowlarr":"Jackett")},s.id))]}),P&&e.jsx("div",{className:"muted",style:{marginTop:6},children:P})]}),F&&e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"muted",children:"Indexeur"}),e.jsxs("select",{value:D,onChange:s=>{const r=s.target.value;if(ue(r),r===Be){ae(""),Z(""),Q(!1),re(null);return}const a=Ue.find(i=>String(i?.id)===String(r));a&&(ae(a.name||""),Z(a.torznabUrl||"")),Q(!1),re(null)},disabled:!d||W,children:[e.jsx("option",{value:"",disabled:!0,children:"Choisir un indexeur..."}),Ue.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id)),e.jsx("option",{value:Be,children:"Ajouter manuellement..."})]}),te&&e.jsx("div",{className:"muted",style:{marginTop:6},children:te}),!W&&L.length>0&&Ue.length===0&&e.jsx("div",{className:"muted",style:{marginTop:6},children:"Tous les indexeurs sont déjà ajoutés."}),W&&e.jsx("div",{className:"muted",style:{marginTop:6},children:"Chargement des indexeurs..."}),Fe&&e.jsxs("div",{className:"errorbox",style:{marginTop:8},children:[e.jsx("div",{className:"errorbox__title",children:"Erreur"}),e.jsx("div",{className:"muted",style:{marginBottom:6},children:Fe}),e.jsx("button",{className:"btn",type:"button",onClick:()=>_e(d),disabled:!d||W,children:"Retry"})]})]}),F&&xe&&e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"muted",children:"Torznab URL"}),e.jsx("input",{value:U,onChange:s=>Z(s.target.value),placeholder:"Colle l'URL Copy Torznab Feed"}),e.jsx("span",{className:"field-hint",children:`Depuis Jackett/Prowlarr, utilise "Copy Torznab Feed", puis colle l'URL complète.`})]}),F&&xe&&e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"muted",children:"Clé API (optionnel)"}),e.jsx("input",{value:J,onChange:s=>he(s.target.value),placeholder:"Laisse vide pour utiliser la clé du fournisseur"})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"muted",children:le("Nom","Name")}),e.jsx("input",{value:X,onChange:s=>ae(s.target.value),placeholder:le("Nom de l'indexeur","Indexer name"),disabled:F&&!D})]}),e.jsxs("div",{className:"field",style:{gridColumn:"1 / -1"},children:[e.jsx("label",{className:"muted",children:le("Couleur","Color")}),e.jsxs("div",{className:`color-slider${ke?" is-open":""}`,ref:Ee,children:[e.jsx("button",{className:"color-dot color-dot--main",type:"button",onClick:()=>!ts&&H(s=>!s),disabled:ts,style:{background:be},"aria-label":le("Choisir une couleur","Choose a color"),title:le("Choisir une couleur","Choose a color")}),e.jsx("div",{className:"color-slider__track",children:ee.map(s=>{const a=ye(s)===be;return e.jsx("button",{type:"button",className:`color-swatch${a?" is-active":""}`,style:{background:s},onClick:()=>{Ie(s),H(!1)},"aria-label":`${le("Couleur","Color")} ${s}`,title:s},s)})})]})]})]}),F&&R===2&&e.jsx("div",{className:"field",style:{gridColumn:"1 / -1",marginBottom:8},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[e.jsx("span",{className:"color-dot",style:{background:be,width:16,height:16,borderRadius:"50%",flexShrink:0}}),e.jsx("span",{style:{fontWeight:600},children:X||"Nouvel indexeur"}),e.jsx("button",{type:"button",className:"btn btn-sm",onClick:()=>{Oe(1),Q(!1)},style:{marginLeft:"auto"},children:"Modifier"})]})}),_&&Me&&R===1&&e.jsx("div",{className:"field",style:{gridColumn:"1 / -1"},children:e.jsxs("div",{className:"advanced-fields",children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"muted",children:"Torznab URL"}),e.jsx("input",{value:U,onChange:s=>Z(s.target.value),placeholder:"http://ip:port/api...",disabled:R===2})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"muted",children:"Clé API"}),e.jsx("input",{value:J,onChange:s=>he(s.target.value),placeholder:"Laisse vide pour ne pas changer",disabled:R===2})]})]})}),R===2&&e.jsxs("div",{className:"field",style:{gridColumn:"1 / -1"},children:[e.jsxs("label",{className:"muted",children:["Catégories assignées (",Gs,"/",Ks,")"]}),e.jsx("div",{style:{marginTop:8},children:e.jsx(Zs,{categories:q,mappings:n,sourceId:v?.id,previewCredentials:Fs,onChangeMapping:(s,r)=>{const a=oe(r);h(i=>{const S=new Map(i);return a?S.set(s,a):S.delete(s),S})}})})]}),O&&e.jsxs("div",{className:"errorbox",style:{gridColumn:"1 / -1"},children:[e.jsx("div",{className:"errorbox__title",children:"Erreur"}),e.jsx("div",{className:"muted",children:O})]}),K&&e.jsxs("div",{className:"errorbox",style:{gridColumn:"1 / -1"},children:[e.jsx("div",{className:"errorbox__title",children:"Info"}),e.jsx("div",{className:"muted",children:K})]}),e.jsx("div",{className:"formactions",children:_&&R===1?e.jsxs("div",{className:"formactions-row",children:[e.jsx("div",{className:"formactions-left",children:Me&&e.jsx("button",{className:"btn btn-fixed-info btn-nohover",type:"button",onClick:ss,disabled:!ns||E||N,children:E?"Test...":"Tester categories"})}),e.jsxs("div",{className:"formactions-right",children:[e.jsx("button",{type:"button",className:"btn btn-sm",onClick:Rs,children:Me?"Masquer options avancées":"Options avancées"}),rs&&e.jsx("button",{className:"btn btn-hover-ok",type:"button",onClick:De,disabled:N,children:"Enregistrer"}),e.jsx("button",{className:"btn btn-fixed-danger btn-nohover",type:"button",onClick:ie,disabled:N,children:"Annuler"})]})]}):_&&R===2?e.jsxs("div",{className:"formactions-row",children:[e.jsx("div",{className:"formactions-left",children:e.jsx("button",{className:"btn btn-hover-info",type:"button",onClick:_s,disabled:N||Te,children:Te?"Reclassement...":"Reclasser l'existant"})}),e.jsxs("div",{className:"formactions-right",children:[rs&&e.jsx("button",{className:"btn btn-hover-ok",type:"button",onClick:De,disabled:N,children:"Enregistrer"}),e.jsx("button",{className:"btn btn-fixed-danger btn-nohover",type:"button",onClick:ie,disabled:N,children:"Annuler"})]})]}):R===1?e.jsxs("div",{className:"formactions-row",children:[e.jsx("div",{className:"formactions-left",children:We&&e.jsxs("span",{className:"muted",style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx(Ws,{name:"check_circle",style:{color:"var(--ok)",fontSize:18}}),"Test réussi"]})}),e.jsxs("div",{className:"formactions-right",children:[We?e.jsx("button",{className:"btn btn-hover-ok",type:"button",onClick:()=>Oe(2),children:"Suivant"}):ns?e.jsx("button",{className:"btn btn-fixed-info btn-nohover",type:"button",onClick:ss,disabled:E||N,children:E?"Test...":"Tester"}):null,e.jsx("button",{className:"btn btn-fixed-danger btn-nohover",type:"button",onClick:ie,disabled:E||N,children:"Annuler"})]})]}):e.jsxs("div",{className:"formactions-row",children:[e.jsx("div",{className:"formactions-left"}),e.jsxs("div",{className:"formactions-right",children:[e.jsx("button",{className:"btn btn-hover-ok",type:"button",onClick:De,disabled:N,children:"Enregistrer"}),e.jsx("button",{className:"btn btn-fixed-danger btn-nohover",type:"button",onClick:ie,disabled:N,children:"Annuler"})]})]})})]})})]})}export{Et as default};
