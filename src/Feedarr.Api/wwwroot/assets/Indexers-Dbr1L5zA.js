import{r as t,j as e}from"./vendor-react-B6j9w5IJ.js";import{d as Ce,e as Ne,a as Z,b as X,c as ce,t as ls,u as Ks,A as Bs,f as os,h as Fs}from"./index-C6BMTWfr.js";import{L as fs}from"./Loader-WjrgZmWo.js";import{S as ve}from"./SubAction-DECBSCTd.js";import{M as Ge}from"./Modal-LPROLsOK.js";import{T as qs,C as Ws,I as Xs}from"./ItemRow-CH6u-Ybt.js";import{t as le}from"./uiText-BIKCb3Eq.js";import{S as Q,n as xe,g as Js}from"./sourceColors-KACkINRj.js";import{d as Ys,C as Vs,a as Hs,m as Qs,b as Zs,c as et}from"./CategoryMappingBoard-DJH_lAZi.js";import{C as cs,n as oe}from"./categoryGroups.constants-TqNJ0nIh.js";import{M as ds}from"./categoryPriority.constants-BnKBS6eK.js";import"./vendor-router-DbNMZja2.js";import"./vendor-icons-CUZlM7O3.js";const gs="test-indexer-";function st(l,p){Ce({key:`${gs}${l}`,label:`Test: ${p}`,meta:"Test en cours...",ttlMs:1e3*60*2})}function us(l){Ne(`${gs}${l}`)}function tt(){Ce({key:"test-new-indexer",label:"Test nouvel indexer",meta:"Validation en cours...",ttlMs:1e3*60*2})}function nt(){Ne("test-new-indexer")}const bs="refresh-caps-";function at(l,p){Ce({key:`${bs}${l}`,label:`Refresh caps: ${p}`,meta:"Récupération...",ttlMs:1e3*60*3})}function rt(l){Ne(`${bs}${l}`)}const Se={syncIntervalMinutes:"60",rssLimitPerCategory:"50",rssLimitGlobalPerSource:"250",autoSyncEnabled:!0},z=(l,p)=>{const x=String(l??"").trim();if(!x)return p;const E=Number(x);return Number.isFinite(E)?Math.trunc(E):p};function it({onStateChange:l,showSaveButton:p=!1}){const[x,E]=t.useState(!0),[f,j]=t.useState(""),[g,C]=t.useState("idle"),[u,k]=t.useState(Se),[w,_]=t.useState(Se),[h,D]=t.useState(()=>new Set),[L,B]=t.useState("ok"),T=t.useRef(null),n=t.useRef(null),v=t.useRef(null),b=t.useRef(null),N=t.useCallback(async()=>{E(!0),j("");try{const o=await Z("/api/settings/general"),m=z(o?.rssLimitPerCategory??o?.rssLimit,50),A=z(o?.rssLimitGlobalPerSource,250),P={syncIntervalMinutes:String(z(o?.syncIntervalMinutes,60)),rssLimitPerCategory:String(m),rssLimitGlobalPerSource:String(A),autoSyncEnabled:o?.autoSyncEnabled!==!1};k(P),_(P)}catch(o){j(o?.message||"Erreur chargement paramètres"),k(Se),_(Se)}finally{E(!1)}},[]);t.useEffect(()=>(N(),()=>{T.current&&clearTimeout(T.current)}),[N]);const I=t.useMemo(()=>!!u.autoSyncEnabled!==w.autoSyncEnabled||String(u.syncIntervalMinutes)!==w.syncIntervalMinutes||String(u.rssLimitPerCategory)!==w.rssLimitPerCategory||String(u.rssLimitGlobalPerSource)!==w.rssLimitGlobalPerSource,[u,w]),y=t.useCallback(o=>h.has(o)?L==="err"?" pulse-err":" pulse-ok":"",[h,L]),M=t.useCallback(async()=>{if(g==="loading")return;j("");const o=n.current?.value??u.syncIntervalMinutes,m=v.current?.value??u.rssLimitPerCategory,A=b.current?.value??u.rssLimitGlobalPerSource,P=new Set;!!u.autoSyncEnabled!==w.autoSyncEnabled&&P.add("general.autoSync"),String(o)!==w.syncIntervalMinutes&&P.add("general.sync"),String(m)!==w.rssLimitPerCategory&&P.add("general.rssPerCat"),String(A)!==w.rssLimitGlobalPerSource&&P.add("general.rssGlobal");const J=Date.now();let F=!1;C("loading");try{const O=await Z("/api/settings/general");await X("/api/settings/general",{...O,syncIntervalMinutes:z(o,60),rssLimit:z(m,50),rssLimitPerCategory:z(m,50),rssLimitGlobalPerSource:z(A,250),autoSyncEnabled:!!u.autoSyncEnabled}),_({syncIntervalMinutes:String(z(o,60)),rssLimitPerCategory:String(z(m,50)),rssLimitGlobalPerSource:String(z(A,250)),autoSyncEnabled:!!u.autoSyncEnabled}),k(ee=>({...ee,syncIntervalMinutes:String(o??""),rssLimitPerCategory:String(m??""),rssLimitGlobalPerSource:String(A??"")})),F=!0}catch(O){j(O?.message||"Erreur sauvegarde paramètres")}finally{const O=Date.now()-J;O<800&&await new Promise(ee=>setTimeout(ee,800-O)),C(F?"success":"error"),P.size>0&&(T.current&&clearTimeout(T.current),B(F?"ok":"err"),D(new Set(P)),T.current=setTimeout(()=>{D(new Set)},1200)),setTimeout(()=>C("idle"),1e3)}},[u,w,g]);return t.useEffect(()=>{l&&l({isDirty:I,saveState:g,onSave:M})},[l,I,g,M]),e.jsxs("div",{className:"settings-card",id:"indexers-sync",children:[e.jsx("div",{className:"settings-card__head",children:e.jsx("div",{className:"settings-card__title",children:"Synchronisation"})}),f&&e.jsxs("div",{className:"errorbox",style:{marginBottom:12},children:[e.jsx("div",{className:"errorbox__title",children:"Erreur"}),e.jsx("div",{className:"muted",children:f})]}),x?e.jsx(fs,{label:"Chargement des paramètres..."}):e.jsxs("div",{className:"indexer-list",children:[e.jsx("div",{className:`indexer-card${y("general.autoSync")}`,children:e.jsxs("div",{className:"indexer-row indexer-row--settings",children:[e.jsx("span",{className:"indexer-title",children:"Synchronisation auto"}),e.jsxs("div",{className:"indexer-actions",children:[e.jsx("span",{className:"indexer-status",children:u.autoSyncEnabled?"Actif":"Desactive"}),e.jsx(qs,{checked:u.autoSyncEnabled,onIonChange:o=>k(m=>({...m,autoSyncEnabled:o.detail.checked})),className:"settings-toggle",title:u.autoSyncEnabled?"Désactiver":"Activer"})]})]})}),e.jsx("div",{className:`indexer-card${y("general.sync")}${u.autoSyncEnabled?"":" is-disabled"}`,children:e.jsxs("div",{className:"indexer-row indexer-row--settings",children:[e.jsx("span",{className:"indexer-title",children:"Intervalle Sync RSS (minutes)"}),e.jsx("div",{className:"indexer-actions",children:e.jsx("input",{type:"number",min:1,max:1440,value:u.syncIntervalMinutes,disabled:!u.autoSyncEnabled,ref:n,onChange:o=>{k(m=>({...m,syncIntervalMinutes:o.target.value}))}})})]})}),e.jsxs("div",{className:`indexer-card${y("general.rssPerCat")}`,children:[e.jsxs("div",{className:"indexer-row indexer-row--settings",children:[e.jsx("span",{className:"indexer-title",title:"Remplissage progressif par catégorie, purge des plus anciens.",children:"Limite RSS par catégorie"}),e.jsx("div",{className:"indexer-actions",children:e.jsx("input",{type:"number",min:1,max:200,value:u.rssLimitPerCategory,ref:v,onChange:o=>{k(m=>({...m,rssLimitPerCategory:o.target.value}))}})})]}),e.jsx("div",{className:"settings-help",children:"Remplissage progressif par catégorie, purge des plus anciens."})]}),e.jsxs("div",{className:`indexer-card${y("general.rssGlobal")}`,children:[e.jsxs("div",{className:"indexer-row indexer-row--settings",children:[e.jsx("span",{className:"indexer-title",title:"Plafond global par source, purge des plus anciens.",children:"Limite RSS globale (par source)"}),e.jsx("div",{className:"indexer-actions",children:e.jsx("input",{type:"number",min:1,max:2e3,value:u.rssLimitGlobalPerSource,ref:b,onChange:o=>{k(m=>({...m,rssLimitGlobalPerSource:o.target.value}))}})})]}),e.jsx("div",{className:"settings-help",children:"Plafond global par source, purge des plus anciens."})]})]}),p&&!x&&I&&e.jsx("div",{className:"formactions",style:{marginTop:16},children:e.jsx("button",{className:`btn ${g==="success"?"btn-hover-ok":g==="error"?"btn-fixed-danger btn-nohover":"btn-hover-ok"}`,type:"button",onClick:M,disabled:!I||g==="loading",children:g==="loading"?"Enregistrement...":g==="success"?"Enregistré":g==="error"?"Erreur":"Enregistrer"})})]})}function lt({onPrepareAdd:l,onPrepareEdit:p,onAfterClose:x}={}){const[E,f]=t.useState(!1),[j,g]=t.useState(null),[C,u]=t.useState(!1),[k,w]=t.useState(null),[_,h]=t.useState(1),D=t.useCallback(()=>{g(null),h(1),l?.(),f(!0)},[l]),L=t.useCallback(v=>{g(v),h(1),p?.(v),f(!0)},[p]),B=t.useCallback(()=>{f(!1),x?.()},[x]),T=t.useCallback(v=>{w(v),u(!0)},[]),n=t.useCallback(()=>{u(!1),w(null)},[]);return{modalOpen:E,editing:j,confirmOpen:C,confirmTarget:k,modalStep:_,setModalStep:h,openAdd:D,openEdit:L,closeModal:B,openDeleteConfirm:T,closeDeleteConfirm:n}}const xs="rss-sync-";function ot(l,p){Ce({key:`${xs}${l}`,label:`Sync: ${p}`,meta:"En cours...",ttlMs:1e3*60*5})}function ms(l){Ne(`${xs}${l}`)}function je(l,p,x=1600){setTimeout(()=>{l(E=>{const f={...E};return delete f[p],f})},x)}function ct({items:l,load:p,setErr:x}){const[E,f]=t.useState(null),[j,g]=t.useState({}),[C,u]=t.useState(!1),[k,w]=t.useState(null),[_,h]=t.useState({}),D=t.useMemo(()=>Object.values(j||{}).some(n=>n==="pending"),[j]),L=t.useCallback(async()=>{const n=(l||[]).filter(b=>b?.id&&b?.enabled);if(n.length===0)return;x("");const v=Date.now();u(!0),g(b=>{const N={...b||{}};return n.forEach(I=>{N[I.id]="pending"}),N});try{const b=await Promise.allSettled(n.map(y=>ce(`/api/sources/${y.id}/sync`)));await p(),ls("sync-all");const N=Date.now()-v,I=Math.max(2e3-N,0);setTimeout(()=>{g(y=>{const M={...y||{}};return n.forEach((o,m)=>{const A=b[m],P=A.status==="fulfilled"?!!A.value?.ok:!1;M[o.id]=P?"ok":"error"}),M}),setTimeout(()=>{g(y=>{const M={...y||{}};return n.forEach(o=>{delete M[o.id]}),M})},1600),u(!1)},I)}catch(b){x(b?.message||"Erreur sync");const N=Date.now()-v,I=Math.max(2e3-N,0);setTimeout(()=>{g(y=>{const M={...y||{}};return n.forEach(o=>{M[o.id]="error"}),M}),setTimeout(()=>{g(y=>{const M={...y||{}};return n.forEach(o=>{delete M[o.id]}),M})},1600),u(!1)},I)}},[l,p,x]),B=t.useCallback(async n=>{if(!n?.id||!n.enabled||k===n.id||C||j[n.id]==="pending")return;x("");const v=Date.now();f(n.id),g(b=>({...b,[n.id]:"pending"})),ot(n.id,n.name||`Source #${n.id}`);try{const b=await ce(`/api/sources/${n.id}/sync`);await p(),ls("sync");const N=Date.now()-v,I=Math.max(2e3-N,0);setTimeout(()=>{g(y=>({...y,[n.id]:b?.ok?"ok":"error"})),je(g,n.id),f(null),ms(n.id)},I)}catch(b){x(b?.message||"Erreur sync");const N=Date.now()-v,I=Math.max(2e3-N,0);setTimeout(()=>{g(y=>({...y,[n.id]:"error"})),je(g,n.id),f(null),ms(n.id)},I)}},[p,x,C,j,k]),T=t.useCallback(async n=>{if(!n?.id||!n.enabled||E===n.id||j[n.id]==="pending")return;x("");const v=Date.now();w(n.id),h(b=>({...b,[n.id]:"pending"})),st(n.id,n.name||`Source #${n.id}`);try{const b=await ce(`/api/sources/${n.id}/test`,{rssLimit:50}),N=Date.now()-v,I=Math.max(2e3-N,0);setTimeout(()=>{h(y=>({...y,[n.id]:b?.ok?"ok":"error"})),je(h,n.id),w(null),us(n.id)},I)}catch(b){x(b?.message||"Erreur test");const N=Date.now()-v,I=Math.max(2e3-N,0);setTimeout(()=>{h(y=>({...y,[n.id]:"error"})),je(h,n.id),w(null),us(n.id)},I)}},[x,E,j]);return{syncingId:E,syncStatusById:j,syncAllRunning:C,testingId:k,testStatusById:_,hasPendingSync:D,syncAll:L,syncSource:B,testSource:T}}const Ke="__manual__";function ps(l){return(l||"").trim().toLowerCase().replace(/\/+$/,"")}function dt(l,p){if(l===p)return!0;if(!(l instanceof Map)||!(p instanceof Map)||l.size!==p.size)return!1;for(const[x,E]of l.entries())if(p.get(x)!==E)return!1;return!0}function Nt(){const l=Ks(),[p,x]=t.useState(!0),[E,f]=t.useState(""),[j,g]=t.useState([]),[C,u]=t.useState(!1),[k,w]=t.useState(!1),[_,h]=t.useState(""),[D,L]=t.useState(""),[B,T]=t.useState([]),[n,v]=t.useState(()=>new Map),[b,N]=t.useState([]),[I,y]=t.useState(!1),[M,o]=t.useState(""),[m,A]=t.useState(""),[P,J]=t.useState([]),[F,O]=t.useState(!1),[ee,de]=t.useState(""),[Be,se]=t.useState(""),[q,ue]=t.useState(""),me=t.useRef(0),[Fe,we]=t.useState(Q[0]),[Ie,Y]=t.useState(!1),ke=t.useRef(null),[Ee,Me]=t.useState(!1),[qe,V]=t.useState(!1),[ys,te]=t.useState(null),[hs,We]=t.useState(!1),Pe=t.useRef(null),pe=t.useRef(null),[Le,Xe]=t.useState(!1),[ne,ae]=t.useState(""),[W,H]=t.useState(""),[re,ye]=t.useState(""),[Te,Je]=t.useState(!0),fe=t.useMemo(()=>(j||[]).some(s=>!!s?.enabled),[j]),[Ae,vs]=t.useState({}),U=t.useCallback(async()=>{f(""),x(!0);try{const s=await Z("/api/sources"),a=Array.isArray(s)?s:[];g(a);const r={};await Promise.all(a.map(async i=>{if(i?.id)try{const c=await Z(`/api/sources/${i.id}/category-mappings`);r[i.id]=(Array.isArray(c)?c:[]).map(d=>({id:Number(d?.catId),unifiedKey:oe(d?.groupKey||d?.unifiedKey),unifiedLabel:d?.groupLabel||d?.unifiedLabel||cs[oe(d?.groupKey||d?.unifiedKey)]||"",name:d?.groupLabel||d?.unifiedLabel||cs[oe(d?.groupKey||d?.unifiedKey)]||""}))}catch(c){console.error(`[Indexers] Impossible de charger les catégories pour la source #${i.id}.`,c),r[i.id]=[]}})),vs(r)}catch(s){f(s?.message||"Erreur chargement sources")}finally{x(!1)}},[]);t.useEffect(()=>{U()},[U]);const{syncingId:Ss,syncStatusById:Re,syncAllRunning:ge,testingId:js,testStatusById:Ye,hasPendingSync:Ve,syncAll:He,syncSource:Cs,testSource:Ns}=ct({items:j,load:U,setErr:f}),Qe=t.useCallback(async()=>{N([]),o(""),y(!0);try{const s=await Z("/api/providers"),r=(Array.isArray(s)?s:[]).filter(i=>!!i?.enabled);N(r),r.length===0&&o("Aucun fournisseur configuré.")}catch(s){o(s?.message||"Impossible de charger les fournisseurs.")}finally{y(!1)}},[]),$e=t.useCallback(async s=>{if(!s)return;const a=++me.current;J([]),de(""),se(""),O(!0);try{const r=await Z(`/api/providers/${s}/indexers`);if(a!==me.current)return;const i=Array.isArray(r)?r:r?.indexers,c=(Array.isArray(i)?i:[]).filter(d=>d?.name&&d?.torznabUrl).sort((d,$)=>String(d.name).localeCompare(String($.name)));J(c),c.length===0&&de("Aucun indexeur disponible (fournisseur non configuré ?)")}catch(r){if(a!==me.current)return;se(r?.message||"Impossible de charger les indexeurs.")}finally{a===me.current&&O(!1)}},[]);t.useEffect(()=>{if(!m){me.current++,J([]),de(""),se(""),O(!1);return}$e(m)},[m,$e]),t.useEffect(()=>{if(!Ie)return;const s=r=>{ke.current&&(ke.current.contains(r.target)||Y(!1))},a=r=>{r.key==="Escape"&&Y(!1)};return document.addEventListener("mousedown",s),document.addEventListener("keydown",a),()=>{document.removeEventListener("mousedown",s),document.removeEventListener("keydown",a)}},[Ie]);const ws=t.useCallback(()=>{ae(""),H(""),ye(""),Je(!0),we(Q[0]),Y(!1),Me(!1),V(!1),te(null),h(""),L(""),T([]),v(new Map),N([]),o(""),A(""),J([]),de(""),se(""),ue(""),Pe.current=null,pe.current=null,Qe()},[Qe]),Is=t.useCallback(s=>{const a=xe(s?.color)||Js(s?.id,s?.color)||Q[0];Pe.current={name:(s?.name??"").trim(),torznabUrl:(s?.torznabUrl??"").trim(),color:xe(a)||Q[0]};const r=(Ae[s?.id]||[]).map(i=>[Number(i?.id),oe(i?.unifiedKey)]).filter(([i,c])=>Number.isFinite(i)&&i>0&&!!c);pe.current=new Map(r),ae(s.name??""),H(s.torznabUrl??""),ye(""),Je(!!s.enabled),we(a),Y(!1),Me(!1),V(!1),te(null),h(""),L(""),T([]),v(new Map),A(""),ue("")},[Ae]),ks=t.useCallback(()=>{h(""),L(""),T([]),v(new Map),A(""),ue(""),se(""),Y(!1)},[]),{modalOpen:Es,editing:S,confirmOpen:Ms,confirmTarget:he,modalStep:R,setModalStep:_e,openAdd:Ze,openEdit:Ps,closeModal:ie,openDeleteConfirm:Ls,closeDeleteConfirm:Oe}=lt({onPrepareAdd:ws,onPrepareEdit:Is,onAfterClose:ks}),Ts=t.useCallback(()=>{Me(s=>!s)},[]);async function es(){h(""),L(""),f("");const s={torznabUrl:W.trim(),apiKey:re.trim(),authMode:"query",indexerName:ne.trim()};if(!s.torznabUrl){h("URL requise pour tester.");return}if(!S?.id&&!m){h("Choisis un fournisseur avant de tester.");return}w(!0),S?.id?at(S.id,S.name||`Source #${S.id}`):tt();try{const a=S?.id?await Z(`/api/categories/caps?sourceId=${S.id}&includeStandardCatalog=true&includeSpecific=true`):await ce("/api/categories/caps/provider",{providerId:Number(m),torznabUrl:s.torznabUrl,indexerName:s.indexerName,indexerId:De?null:q||null,includeStandardCatalog:!0,includeSpecific:!0}),r=Array.isArray(a?.categories)?a.categories:[],i=Hs(r),c=Array.isArray(a?.warnings)?a.warnings:[];c.length>0&&L(c.join(" ")),T(i);const d=Qs(i);v(d),i.length===0&&c.length===0&&L("Aucune catégorie disponible."),S?.id?(pe.current=new Map(d),_e(2)):(v(new Map),a?.sourceId&&te(a.sourceId),V(!0))}catch(a){h(a?.message||"Erreur test indexeur")}finally{w(!1),S?.id?rt(S.id):nt()}}async function ze(s){if(s?.preventDefault&&s.preventDefault(),s?.stopPropagation&&s.stopPropagation(),C)return;if(f(""),h(""),u(!0),K&&!m){h("Choisis un fournisseur avant d’enregistrer."),u(!1);return}const a=xe(Fe)||Q[0],r={name:ne.trim(),torznabUrl:W.trim(),authMode:"query",apiKey:re.trim()||null,providerId:m?Number(m):null,color:a};try{const i=new Map([...n.entries()].map(([c,d])=>[Number(c),oe(d)]).filter(([c,d])=>Number.isFinite(c)&&c>0&&!!d));if(S?.id)if(R===2){await X(`/api/sources/${S.id}`,r),await X(`/api/sources/${S.id}/enabled`,{enabled:Te});const c=Zs(pe.current,i);c.length>0&&await os(`/api/sources/${S.id}/category-mappings`,{mappings:c})}else await X(`/api/sources/${S.id}`,r),await X(`/api/sources/${S.id}/enabled`,{enabled:Te});else{if(R!==2)return;const c=et(i);let d=ys;if(d)await X(`/api/sources/${d}`,r),await X(`/api/sources/${d}/enabled`,{enabled:Te});else{const $=await ce("/api/sources",{...r});d=Number($?.id)||null}d&&c.length>0&&await os(`/api/sources/${d}/category-mappings`,{mappings:c})}await U(),typeof window<"u"&&window.dispatchEvent(new Event("onboarding:refresh")),ie()}catch(i){f(i?.message||"Erreur sauvegarde")}finally{u(!1)}}async function As(s){if(s?.id){f("");try{await X(`/api/sources/${s.id}/enabled`,{enabled:!s.enabled}),await U()}catch(a){f(a?.message||"Erreur enable/disable")}}}async function Rs(){if(!(!S?.id||Le||!(typeof window>"u"||window.confirm("Reclasser l'existant pour cette source ? Cette action peut prendre quelques instants.")))){f(""),h(""),Xe(!0);try{await ce(`/api/sources/${S.id}/reclassify`),await U(),L("Reclassement lancé avec succès pour cette source.")}catch(a){f(a?.message||"Erreur reclassification")}finally{Xe(!1)}}}t.useEffect(()=>(l(e.jsxs("div",{className:"indexers-subbar-content",subbarClassName:"subbar--indexers-sync",children:[e.jsx(ve,{icon:"refresh",label:"Refresh",onClick:U}),e.jsx(ve,{icon:"add_circle",label:"Ajouter",onClick:Ze}),e.jsx(ve,{icon:"settings",label:"Options",onClick:()=>We(!0),title:"Options de synchronisation"}),fe&&e.jsx("div",{className:"subspacer"}),fe&&e.jsx(ve,{icon:ge?"progress_activity":"sync",label:"Sync all",onClick:He,disabled:!fe||ge||Ve,title:fe?"Sync all":"Aucun indexer actif",className:ge?"is-loading":void 0})]})),()=>l(null)),[l,U,Ze,He,ge,fe,Ve]);async function $s(s){if(s?.id){f("");try{await Fs(`/api/sources/${s.id}`),await U()}catch(a){f(a?.message||"Erreur suppression")}}}const _s=t.useMemo(()=>(j||[]).map(s=>({...s,_name:s.name??`Source ${s.id}`,_url:s.torznabUrl??""})).sort((s,a)=>(Number(s.id)||0)-(Number(a.id)||0)),[j]),G=!!S,K=!S,be=xe(Fe)||Q[0],ss=G&&R===2,De=K&&q===Ke,ts=K?m&&W.trim():W.trim(),Os=t.useMemo(()=>{if(!G)return!1;const s=Pe.current;if(!s)return!1;const a=ne.trim()!==s.name,r=W.trim()!==s.torznabUrl,i=be!==s.color,c=!!re.trim();return a||r||i||c},[G,ne,W,be,re]),zs=t.useMemo(()=>{if(!G||R!==2)return!1;const s=pe.current;return s?!dt(n,s):!1},[G,R,n]),ns=G&&(Os||zs),Ds=n.size,Us=B.length,as=t.useMemo(()=>new Set((j||[]).map(s=>ps(s.torznabUrl)).filter(Boolean)),[j]),Ue=t.useMemo(()=>{const s=(P||[]).filter(a=>!as.has(ps(a.torznabUrl)));if(q&&!s.some(r=>String(r.id)===String(q))){const r=(P||[]).find(i=>String(i.id)===String(q));if(r)return[...s,r]}return s},[P,as,q]);return e.jsxs("div",{className:"page page--indexers",children:[e.jsx("div",{className:"pagehead",children:e.jsxs("div",{children:[e.jsx("h1",{children:"Indexeurs"}),e.jsx("div",{className:"muted",children:"Sources Torznab / Jackett / Prowlarr"})]})}),e.jsx("div",{className:"pagehead__divider"}),E&&e.jsxs("div",{className:"errorbox",children:[e.jsx("div",{className:"errorbox__title",children:"Erreur"}),e.jsx("div",{className:"muted",children:E})]}),p?e.jsx(fs,{label:"Chargement des sources…"}):e.jsx("div",{className:"indexer-list itemrow-grid",children:_s.map(s=>{const a=Ss===s.id||Re[s.id]==="pending",r=js===s.id,i=a||r||ge,c=[Ye[s.id]==="ok"&&"test-ok",Ye[s.id]==="error"&&"test-err",Re[s.id]==="ok"&&"sync-ok",Re[s.id]==="error"&&"sync-err"].filter(Boolean).join(" "),d=Ys((Ae[s.id]||[]).slice().sort(($,Gs)=>{const rs=ds.indexOf($.unifiedKey),is=ds.indexOf(Gs.unifiedKey);return(rs===-1?999:rs)-(is===-1?999:is)})).map($=>e.jsx(Ws,{unifiedKey:$.unifiedKey,label:$.unifiedLabel||$.name,title:`${$.name} (${$.id})`},$.unifiedKey||$.id));return e.jsx(Xs,{id:s.id,title:s._name,meta:s._url,enabled:s.enabled,badges:d,statusClass:c,actions:[{icon:"sync",title:a?"Sync en cours...":"Sync",onClick:()=>Cs(s),disabled:i||!s.enabled,spinning:a},{icon:"science",title:r?"Test en cours...":"Test",onClick:()=>Ns(s),disabled:r||a||!s.enabled,spinning:r},{icon:"edit",title:"Modifier",onClick:()=>Ps(s),disabled:i||!s.enabled},{icon:"delete",title:"Supprimer",onClick:()=>Ls(s),disabled:i||!s.enabled,className:"iconbtn--danger"}],showToggle:!0,onToggle:()=>As(s),toggleDisabled:a||r},s.id)})}),e.jsx(Ge,{open:hs,title:"Options de synchronisation",onClose:()=>We(!1),width:560,children:e.jsx("div",{style:{padding:12},children:e.jsx(it,{showSaveButton:!0})})}),e.jsx(Ge,{open:Ms,title:he?`Supprimer : ${he?.name??he?.id}`:"Supprimer",onClose:Oe,width:520,children:e.jsxs("div",{style:{padding:12},children:[e.jsx("div",{style:{fontWeight:700,marginBottom:8},children:"Confirmer la suppression ?"}),e.jsx("div",{className:"muted",children:"Cette action est irréversible."}),e.jsxs("div",{className:"formactions",style:{marginTop:16},children:[e.jsx("button",{className:"btn btn-danger",type:"button",onClick:async()=>{const s=he;Oe(),s&&await $s(s)},children:"Supprimer"}),e.jsx("button",{className:"btn",type:"button",onClick:Oe,children:"Annuler"})]})]})}),e.jsx(Ge,{open:Es,title:S?`Modifier : ${S?.name??S?.id}`:"Ajouter une source",onClose:ie,width:780,children:e.jsxs("form",{onSubmit:s=>s.preventDefault(),className:"formgrid formgrid--edit",children:[R===1&&e.jsxs(e.Fragment,{children:[K&&e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"muted",children:"Fournisseur"}),e.jsxs("select",{value:m,onChange:s=>{const a=s.target.value;A(a),ue(""),J([]),de(""),se(""),ae(""),H(""),h(""),L(""),T([]),v(new Map),V(!1),te(null)},disabled:I||b.length===0,children:[e.jsx("option",{value:"",disabled:!0,children:"Choisir un fournisseur..."}),b.map(s=>e.jsx("option",{value:s.id,children:s.name||(String(s.type||"").toLowerCase()==="prowlarr"?"Prowlarr":"Jackett")},s.id))]}),M&&e.jsx("div",{className:"muted",style:{marginTop:6},children:M})]}),K&&e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"muted",children:"Indexeur"}),e.jsxs("select",{value:q,onChange:s=>{const a=s.target.value;if(ue(a),a===Ke){ae(""),H(""),V(!1),te(null);return}const r=Ue.find(i=>String(i?.id)===String(a));r&&(ae(r.name||""),H(r.torznabUrl||"")),V(!1),te(null)},disabled:!m||F,children:[e.jsx("option",{value:"",disabled:!0,children:"Choisir un indexeur..."}),Ue.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id)),e.jsx("option",{value:Ke,children:"Ajouter manuellement..."})]}),ee&&e.jsx("div",{className:"muted",style:{marginTop:6},children:ee}),!F&&P.length>0&&Ue.length===0&&e.jsx("div",{className:"muted",style:{marginTop:6},children:"Tous les indexeurs sont déjà ajoutés."}),F&&e.jsx("div",{className:"muted",style:{marginTop:6},children:"Chargement des indexeurs..."}),Be&&e.jsxs("div",{className:"errorbox",style:{marginTop:8},children:[e.jsx("div",{className:"errorbox__title",children:"Erreur"}),e.jsx("div",{className:"muted",style:{marginBottom:6},children:Be}),e.jsx("button",{className:"btn",type:"button",onClick:()=>$e(m),disabled:!m||F,children:"Retry"})]})]}),K&&De&&e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"muted",children:"Torznab URL"}),e.jsx("input",{value:W,onChange:s=>H(s.target.value),placeholder:"Colle l'URL Copy Torznab Feed"}),e.jsx("span",{className:"field-hint",children:`Depuis Jackett/Prowlarr, utilise "Copy Torznab Feed", puis colle l'URL complète.`})]}),K&&De&&e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"muted",children:"Clé API (optionnel)"}),e.jsx("input",{value:re,onChange:s=>ye(s.target.value),placeholder:"Laisse vide pour utiliser la clé du fournisseur"})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"muted",children:le("Nom","Name")}),e.jsx("input",{value:ne,onChange:s=>ae(s.target.value),placeholder:le("Nom de l'indexeur","Indexer name"),disabled:K&&!q})]}),e.jsxs("div",{className:"field",style:{gridColumn:"1 / -1"},children:[e.jsx("label",{className:"muted",children:le("Couleur","Color")}),e.jsxs("div",{className:`color-slider${Ie?" is-open":""}`,ref:ke,children:[e.jsx("button",{className:"color-dot color-dot--main",type:"button",onClick:()=>!ss&&Y(s=>!s),disabled:ss,style:{background:be},"aria-label":le("Choisir une couleur","Choose a color"),title:le("Choisir une couleur","Choose a color")}),e.jsx("div",{className:"color-slider__track",children:Q.map(s=>{const r=xe(s)===be;return e.jsx("button",{type:"button",className:`color-swatch${r?" is-active":""}`,style:{background:s},onClick:()=>{we(s),Y(!1)},"aria-label":`${le("Couleur","Color")} ${s}`,title:s},s)})})]})]})]}),K&&R===2&&e.jsx("div",{className:"field",style:{gridColumn:"1 / -1",marginBottom:8},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[e.jsx("span",{className:"color-dot",style:{background:be,width:16,height:16,borderRadius:"50%",flexShrink:0}}),e.jsx("span",{style:{fontWeight:600},children:ne||"Nouvel indexeur"}),e.jsx("button",{type:"button",className:"btn btn-sm",onClick:()=>{_e(1),V(!1)},style:{marginLeft:"auto"},children:"Modifier"})]})}),G&&Ee&&R===1&&e.jsx("div",{className:"field",style:{gridColumn:"1 / -1"},children:e.jsxs("div",{className:"advanced-fields",children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"muted",children:"Torznab URL"}),e.jsx("input",{value:W,onChange:s=>H(s.target.value),placeholder:"http://ip:port/api...",disabled:R===2})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{className:"muted",children:"Clé API"}),e.jsx("input",{value:re,onChange:s=>ye(s.target.value),placeholder:"Laisse vide pour ne pas changer",disabled:R===2})]})]})}),R===2&&e.jsxs("div",{className:"field",style:{gridColumn:"1 / -1"},children:[e.jsxs("label",{className:"muted",children:["Catégories assignées (",Ds,"/",Us,")"]}),e.jsx("div",{style:{marginTop:8},children:e.jsx(Vs,{categories:B,mappings:n,onChangeMapping:(s,a)=>{const r=oe(a);v(i=>{const c=new Map(i);return r?c.set(s,r):c.delete(s),c})}})})]}),_&&e.jsxs("div",{className:"errorbox",style:{gridColumn:"1 / -1"},children:[e.jsx("div",{className:"errorbox__title",children:"Erreur"}),e.jsx("div",{className:"muted",children:_})]}),D&&e.jsxs("div",{className:"errorbox",style:{gridColumn:"1 / -1"},children:[e.jsx("div",{className:"errorbox__title",children:"Info"}),e.jsx("div",{className:"muted",children:D})]}),e.jsx("div",{className:"formactions",children:G&&R===1?e.jsxs("div",{className:"formactions-row",children:[e.jsx("div",{className:"formactions-left",children:Ee&&e.jsx("button",{className:"btn btn-fixed-info btn-nohover",type:"button",onClick:es,disabled:!ts||k||C,children:k?"Test...":"Tester categories"})}),e.jsxs("div",{className:"formactions-right",children:[e.jsx("button",{type:"button",className:"btn btn-sm",onClick:Ts,children:Ee?"Masquer options avancées":"Options avancées"}),ns&&e.jsx("button",{className:"btn btn-hover-ok",type:"button",onClick:ze,disabled:C,children:"Enregistrer"}),e.jsx("button",{className:"btn btn-fixed-danger btn-nohover",type:"button",onClick:ie,disabled:C,children:"Annuler"})]})]}):G&&R===2?e.jsxs("div",{className:"formactions-row",children:[e.jsx("div",{className:"formactions-left",children:e.jsx("button",{className:"btn btn-hover-info",type:"button",onClick:Rs,disabled:C||Le,children:Le?"Reclassement...":"Reclasser l'existant"})}),e.jsxs("div",{className:"formactions-right",children:[ns&&e.jsx("button",{className:"btn btn-hover-ok",type:"button",onClick:ze,disabled:C,children:"Enregistrer"}),e.jsx("button",{className:"btn btn-fixed-danger btn-nohover",type:"button",onClick:ie,disabled:C,children:"Annuler"})]})]}):R===1?e.jsxs("div",{className:"formactions-row",children:[e.jsx("div",{className:"formactions-left",children:qe&&e.jsxs("span",{className:"muted",style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx(Bs,{name:"check_circle",style:{color:"var(--ok)",fontSize:18}}),"Test réussi"]})}),e.jsxs("div",{className:"formactions-right",children:[qe?e.jsx("button",{className:"btn btn-hover-ok",type:"button",onClick:()=>_e(2),children:"Suivant"}):ts?e.jsx("button",{className:"btn btn-fixed-info btn-nohover",type:"button",onClick:es,disabled:k||C,children:k?"Test...":"Tester"}):null,e.jsx("button",{className:"btn btn-fixed-danger btn-nohover",type:"button",onClick:ie,disabled:k||C,children:"Annuler"})]})]}):e.jsxs("div",{className:"formactions-row",children:[e.jsx("div",{className:"formactions-left"}),e.jsxs("div",{className:"formactions-right",children:[e.jsx("button",{className:"btn btn-hover-ok",type:"button",onClick:ze,disabled:C,children:"Enregistrer"}),e.jsx("button",{className:"btn btn-fixed-danger btn-nohover",type:"button",onClick:ie,disabled:C,children:"Annuler"})]})]})})]})})]})}export{Nt as default};
