import{n as m,C as M,a as L}from"./categoryGroups.constants-TqNJ0nIh.js";import{r as d,j as r,a as W}from"./vendor-react-B6j9w5IJ.js";function S(o){const s=Number(o);return Number.isFinite(s)&&s>0?s:null}function K(o){const s=o instanceof Map?o:new Map,n=new Map;for(const[e,i]of s.entries()){const u=S(e);if(!u)continue;const a=m(i);a&&n.set(u,a)}return n}function ee(o){const s=new Map;for(const n of Array.isArray(o)?o:[]){const e=S(n?.id);if(!e)continue;const i=[n?.assignedGroupKey,n?.groupKey,n?.unifiedKey];for(const a of i)a==null||String(a).trim();const u=m(n?.assignedGroupKey)||m(n?.groupKey)||m(n?.unifiedKey)||m(n?.assignedGroupLabel)||m(n?.groupLabel)||m(n?.unifiedLabel);u&&n?.isAssigned!==!1&&s.set(e,u)}return s}function ne(o){const s=K(o),n=[];for(const[e,i]of s.entries()){const u=M[i]||i;n.push({categoryId:e,unifiedKey:i,unifiedLabel:u,catId:e,groupKey:i,groupLabel:u})}return n}function te(o,s){const n=K(o),e=K(s),i=new Set([...n.keys(),...e.keys()]),u=[];for(const a of i){const g=n.get(a)||null,c=e.get(a)||null;g!==c&&u.push({categoryId:a,unifiedKey:c,unifiedLabel:c?M[c]||c:null,catId:a,groupKey:c,groupLabel:c?M[c]||c:null})}return u}function se(o){if(!Array.isArray(o))return[];const s=new Map,n=e=>{let i=0;return m(e?.unifiedKey||e?.groupKey||e?.assignedGroupKey)&&(i+=4),(e?.unifiedLabel||e?.groupLabel||e?.assignedGroupLabel)&&(i+=2),e?.parentId&&(i+=1),e?.isSub&&(i+=1),i};for(const e of o){const i=S(e?.id);if(!i)continue;const u={...e,id:i},a=s.get(i);(!a||n(u)>n(a))&&s.set(i,u)}return Array.from(s.values())}function ie(o){const s=new Set,n=[];for(const e of Array.isArray(o)?o:[]){const i=m(e?.unifiedKey||e?.key),u=String(e?.unifiedLabel||e?.label||e?.name||"").trim().toLowerCase(),a=i||u;!a||s.has(a)||(s.add(a),n.push(e))}return n}function Y(o){const s=new Map;for(const n of Array.isArray(o)?o:[]){const e=Number(n?.id);!Number.isFinite(e)||e<=0||s.has(e)||n?.isSupported!==!1&&s.set(e,{id:e,name:String(n?.name||`Cat ${e}`),isStandard:n?.isStandard===!0||e>=1e3&&e<=8999,isSupported:n?.isSupported!==!1})}return[...s.values()].sort((n,e)=>n.id-e.id)}function Q(o,s,n,e){const i=m(e.get(o.id));return n==="assigned"&&!i||n==="unassigned"&&i?!1:s?`${o.id} ${o.name}`.toLowerCase().includes(s.toLowerCase()):!0}function oe({categories:o,mappings:s,onChangeMapping:n,variant:e="default"}){const[i,u]=d.useState(""),[a,g]=d.useState("all"),[c,h]=d.useState(null),[_,j]=d.useState(null),N=d.useRef(null),k=d.useRef(new Map),y=s instanceof Map?s:new Map,x=d.useMemo(()=>Y(o),[o]),A=d.useMemo(()=>[...L].sort((t,l)=>t.label.localeCompare(l.label,"fr",{sensitivity:"base"})),[]),f=d.useCallback(()=>{h(null),j(null)},[]),E=d.useCallback((t,l)=>{l?k.current.set(t,l):k.current.delete(t)},[]),v=d.useCallback(t=>{const l=k.current.get(t);if(!l)return null;const p=l.getBoundingClientRect(),P=180,U=L.length*34+44,C=8,R=6;let b=p.right-P;b=Math.max(C,b),b=Math.min(b,window.innerWidth-P-C);const q=p.top-C,I=window.innerHeight-p.bottom-C,z=I<U&&q>I,H=z?"top":"bottom";return{top:z?p.top-R:p.bottom+R,left:b,placement:H}},[]),$=d.useCallback(t=>{if(c===t){f();return}const l=v(t);if(!l){f();return}h(t),j(l)},[f,c,v]);d.useEffect(()=>{const t=l=>{N.current&&(l.target?.closest?.("[data-mapping-menu-root='true']")||N.current.contains(l.target)||f())};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[f]),d.useEffect(()=>{if(!c)return;const t=()=>{const p=v(c);if(!p){f();return}j(p)},l=p=>{p.key==="Escape"&&f()};return window.addEventListener("resize",t),window.addEventListener("scroll",t,!0),window.addEventListener("keydown",l),()=>{window.removeEventListener("resize",t),window.removeEventListener("scroll",t,!0),window.removeEventListener("keydown",l)}},[f,c,v]);const G=d.useMemo(()=>{const t=Object.fromEntries(L.map(l=>[l.key,0]));for(const l of x){const p=m(y.get(l.id));p&&(t[p]+=1)}return t},[y,x]),w=d.useMemo(()=>x.filter(t=>Q(t,i,a,y)),[x,i,a,y]);d.useEffect(()=>{c&&(w.some(t=>t.id===c)||f())},[f,w,c]);const O=w.filter(t=>t.isStandard),T=w.filter(t=>!t.isStandard),D=`category-mapping-board${e==="wizard"?" category-mapping-board--wizard":""}`,F=c?m(y.get(c)):null;return r.jsxs("div",{className:D,ref:N,children:[r.jsxs("div",{className:"category-mapping-board__top",children:[r.jsx("input",{className:"category-mapping-board__search",value:i,onChange:t=>u(t.target.value),placeholder:"Rechercher par id ou nom..."}),r.jsxs("div",{className:"category-mapping-board__filters",children:[r.jsx("button",{type:"button",className:`type-chip${a==="all"?" type-chip--active":""}`,onClick:()=>g("all"),children:"Tout"}),r.jsx("button",{type:"button",className:`type-chip${a==="assigned"?" type-chip--active":""}`,onClick:()=>g("assigned"),children:"Assignées"}),r.jsx("button",{type:"button",className:`type-chip${a==="unassigned"?" type-chip--active":""}`,onClick:()=>g("unassigned"),children:"Non assignées"})]})]}),r.jsx("div",{className:"category-mapping-board__groups",children:A.map(t=>r.jsxs("div",{className:`category-group-card cat-bubble--${t.key}`,children:[r.jsx("div",{className:"category-group-card__label",children:t.label}),r.jsx("div",{className:"category-group-card__count",children:G[t.key]||0})]},t.key))}),r.jsxs("div",{className:"category-mapping-board__columns",children:[r.jsx(B,{title:"Standard",categories:O,mappings:y,openMenuId:c,onToggleMenu:$,registerAssignButton:E}),r.jsx(B,{title:"Spécifiques",categories:T,mappings:y,openMenuId:c,onToggleMenu:$,registerAssignButton:E})]}),c&&_&&r.jsx(V,{groups:A,position:_,assignedKey:F,onAssign:t=>{n?.(c,t),f()},onClear:()=>{n?.(c,null),f()}})]})}function B({title:o,categories:s,mappings:n,openMenuId:e,onToggleMenu:i,registerAssignButton:u}){return r.jsxs("div",{className:"category-mapping-board__column",children:[r.jsx("div",{className:"category-mapping-board__column-title",children:o}),r.jsxs("div",{className:"category-mapping-board__chips",children:[s.length===0&&r.jsx("div",{className:"muted",children:"Aucune catégorie."}),s.map(a=>{const g=m(n.get(a.id)),c=g?M[g]:"—",h=e===a.id;return r.jsxs("div",{className:`mapping-chip${g?` mapping-chip--assigned mapping-chip--${g}`:""}`,children:[r.jsxs("div",{className:"mapping-chip__line",children:[r.jsx("span",{className:"mapping-chip__id",children:a.id}),r.jsx("span",{className:"mapping-chip__name",children:a.name})]}),r.jsx("div",{className:"mapping-chip__line",children:r.jsx("button",{type:"button",className:"mapping-chip__assign",ref:_=>u(a.id,_),onClick:()=>i(a.id),"aria-haspopup":"menu","aria-expanded":h?"true":"false",children:c})})]},a.id)})]})]})}function V({groups:o,position:s,assignedKey:n,onAssign:e,onClear:i}){return typeof document>"u"?null:W.createPortal(r.jsxs("div",{className:`mapping-chip__menu mapping-chip__menu--portal${s.placement==="top"?" mapping-chip__menu--top":""}`,"data-mapping-menu-root":"true",style:{top:`${s.top}px`,left:`${s.left}px`},role:"menu",children:[o.map(u=>r.jsx("button",{type:"button",className:`mapping-chip__menu-item${n===u.key?" is-active":""}`,onClick:()=>e(u.key),children:u.label},u.key)),r.jsx("button",{type:"button",className:"mapping-chip__menu-item",onClick:i,children:"Retirer"})]}),document.body)}export{oe as C,se as a,te as b,ne as c,ie as d,ee as m};
