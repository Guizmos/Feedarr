import{r,j as t}from"./vendor-react-B6j9w5IJ.js";import{g as Pe,u as $e,a as De,c as L,b as X,h as _e}from"./index-CFeG2zFp.js";import{L as Me}from"./Loader-WjrgZmWo.js";import{S as be}from"./SubAction-Chy9oen0.js";import{M as ge}from"./Modal-CuzTGtmL.js";import{I as Ue,T as Ie}from"./ItemRow-CmVCROir.js";import"./vendor-router-DbNMZja2.js";import"./vendor-icons-BuPyRjLk.js";function N(n){return String(n||"").toLowerCase()==="prowlarr"?"Prowlarr":"Jackett"}function R(n){return String(n||"").trim().replace(/\/+$/,"")}function Le(n){if(!n)return"—";try{const a=new URL(n),S=a.host;return`${a.protocol}//${S}/•••`}catch{return n.length<=8?"•••":`${n.slice(0,8)}•••`}}function Re(n){const a=Number(n);return!Number.isFinite(a)||a<=0?"":new Date(a*1e3).toLocaleString(Pe(),{dateStyle:"short",timeStyle:"short"})}function Be(n){return(n||[]).map(a=>({...a,_name:a.name||N(a.type),_url:Le(a.baseUrl),_typeLabel:N(a.type),_lastTest:a.lastTestOkAt?Re(a.lastTestOkAt):""})).sort((a,S)=>(Number(a.id)||0)-(Number(S.id)||0))}const Oe=["jackett","prowlarr"];function Z(n){const a=String(n?.message||"");return/invalid start of a value|unexpected token\s*</i.test(a)}function Ye(){const n=$e(),[a,S]=r.useState(!0),[ee,f]=r.useState(""),[te,y]=r.useState(""),[C,se]=r.useState([]),[re,B]=r.useState(null),[ae,A]=r.useState({}),[pe,O]=r.useState(!1),[l,ne]=r.useState(null),[u,ie]=r.useState(null),[xe,oe]=r.useState(!1),[v,le]=r.useState(null),[E,K]=r.useState(!1),[c,g]=r.useState("idle"),[de,p]=r.useState(""),[o,F]=r.useState("jackett"),[P,q]=r.useState(""),[z,J]=r.useState(""),[x,G]=r.useState(""),[ce,V]=r.useState(!1),[j,W]=r.useState(!0),w=r.useCallback(async()=>{f(""),S(!0);try{const e=await De("/api/providers");se(Array.isArray(e)?e:[])}catch(e){f(e?.message||"Erreur chargement fournisseurs")}finally{S(!1)}},[]),Y=r.useCallback(e=>{const s=Math.floor(Date.now()/1e3);se(i=>(Array.isArray(i)?i:[]).map(d=>d.id===e?{...d,lastTestOkAt:s}:d))},[]);r.useEffect(()=>{w()},[w]);const $=r.useMemo(()=>{const e=new Set((Array.isArray(C)?C:[]).map(s=>String(s?.type||"").toLowerCase()).filter(Boolean));return Oe.filter(s=>!e.has(s))},[C]),D=$.length>0,ue=r.useCallback(()=>{if(!D){y("Tous les fournisseurs disponibles sont déjà ajoutés.");return}ne(null),ie(null),F($[0]||""),q(""),J(""),G(""),V(!1),W(!0),g("idle"),p(""),O(!0)},[$,D]);function ye(e){ne(e),F(e?.type||"jackett"),q(e?.name||""),J(e?.baseUrl||""),G(""),V(!1),W(!!e?.enabled),ie({type:e?.type||"jackett",name:e?.name||"",baseUrl:e?.baseUrl||"",enabled:!!e?.enabled}),g("idle"),p(""),O(!0)}function H(){E||c==="pending"||(O(!1),g("idle"),p(""))}function ve(e){le(e),oe(!0)}function Q(){oe(!1),le(null)}async function je(){p(""),g("pending");const e=R(z);try{const s=String(o||"").toLowerCase(),i=u?R(u.baseUrl)!==e:!0;if(!l?.id||x.trim()||i||s!==String(u?.type||"").toLowerCase()){if(!e){g("error"),p("Base URL requise pour tester.");return}if(!x.trim()){g("error"),p("Renseigne la clé API pour tester les nouveaux paramètres.");return}const b=async Ae=>{try{return await L("/api/providers/test",{type:s,baseUrl:e,apiKey:x.trim()})}catch(he){if(Ae&&Z(he))return await new Promise(Ee=>setTimeout(Ee,350)),b(!1);throw he}},I=(await b(!0))?.count??0;g("ok"),p(`Connexion OK (${I} indexeur${I>1?"s":""})`),l?.id&&Y(l.id);return}const h=async b=>{try{return await L(`/api/providers/${l.id}/test`)}catch(_){if(b&&Z(_))return await new Promise(I=>setTimeout(I,350)),h(!1);throw _}},m=(await h(!0))?.count??0;g("ok"),p(`Connexion OK (${m} indexeur${m>1?"s":""})`),l?.id&&Y(l.id)}catch(s){g("error"),p(s?.message||"Erreur test fournisseur")}}async function Se(e){if(e.preventDefault(),!E){if(f(""),y(""),K(!0),M&&!me){K(!1);return}try{if(l?.id){const s={type:o,name:P.trim()||N(o),baseUrl:k,apiKey:x.trim()||null};if(await X(`/api/providers/${l.id}`,s),u&&j!==!!u.enabled){const i=await X(`/api/providers/${l.id}/enabled`,{enabled:j});i?.message&&y(i.message)}}else{const s={type:o,name:P.trim()||N(o),baseUrl:k,apiKey:x.trim()||null,enabled:j};await L("/api/providers",s)}await w(),H()}catch(s){f(s?.message||"Erreur sauvegarde")}finally{K(!1)}}}async function we(e){if(e?.id){f(""),y("");try{const s=await X(`/api/providers/${e.id}/enabled`,{enabled:!e.enabled});s?.message&&y(s.message),await w()}catch(s){f(s?.message||"Erreur enable/disable")}}}async function Ne(e){if(!e?.id||!e.enabled||re===e.id)return;f(""),y("");const s=Date.now();B(e.id),A(i=>({...i,[e.id]:"pending"}));try{const i=async m=>{try{return await L(`/api/providers/${e.id}/test`)}catch(b){if(m&&Z(b))return await new Promise(_=>setTimeout(_,350)),i(!1);throw b}},d=await i(!0);d?.ok&&Y(e.id);const h=Date.now()-s,T=Math.max(1200-h,0);setTimeout(()=>{A(m=>({...m,[e.id]:d?.ok?"ok":"error"})),setTimeout(()=>{A(m=>{const b={...m};return delete b[e.id],b})},1200),B(null)},T)}catch(i){f(i?.message||"Erreur test");const d=Date.now()-s,h=Math.max(1200-d,0);setTimeout(()=>{A(T=>({...T,[e.id]:"error"})),setTimeout(()=>{A(T=>{const m={...T};return delete m[e.id],m})},1200),B(null)},h)}}async function ke(e){if(e?.id){f(""),y("");try{const s=await _e(`/api/providers/${e.id}`);s?.disabledSources>0&&y(`${s.disabledSources} indexeur${s.disabledSources>1?"s":""} désactivé${s.disabledSources>1?"s":""}.`),await w()}catch(s){f(s?.message||"Erreur suppression")}}}const Te=r.useMemo(()=>Be(C),[C]),M=!!l,U=!l,k=R(z),me=r.useMemo(()=>{if(!M||!u)return!0;const e=String(o||"").toLowerCase()!==String(u.type||"").toLowerCase(),s=String(P||"")!==String(u.name||""),i=R(u.baseUrl)!==k,d=j!==!!u.enabled,h=!!x.trim();return e||s||i||d||h},[M,u,o,P,k,j,x]),fe=U?!!o&&!!k&&!!x.trim():!!o&&!!k&&me,Ce=r.useMemo(()=>U?$:o?[o]:[],[$,U,o]);return r.useEffect(()=>(n(t.jsxs(t.Fragment,{children:[t.jsx(be,{icon:"refresh",label:"Refresh",onClick:w}),t.jsx(be,{icon:"add_circle",label:"Ajouter",onClick:ue,disabled:!D,title:D?"Ajouter":"Tous les fournisseurs disponibles sont déjà ajoutés"})]})),()=>n(null)),[n,w,ue,D]),t.jsxs("div",{className:"page page--providers",children:[t.jsx("div",{className:"pagehead",children:t.jsxs("div",{children:[t.jsx("h1",{children:"Fournisseurs"}),t.jsx("div",{className:"muted",children:"Jackett / Prowlarr"})]})}),t.jsx("div",{className:"pagehead__divider"}),ee&&t.jsxs("div",{className:"errorbox",children:[t.jsx("div",{className:"errorbox__title",children:"Erreur"}),t.jsx("div",{className:"muted",children:ee})]}),te&&t.jsxs("div",{className:"noticebox",children:[t.jsx("div",{className:"errorbox__title",children:"Info"}),t.jsx("div",{className:"muted",children:te})]}),a?t.jsx(Me,{label:"Chargement des fournisseurs…"}):t.jsx("div",{className:"indexer-list itemrow-grid",children:Te.map(e=>{const s=re===e.id,i=[ae[e.id]==="ok"&&"test-ok",ae[e.id]==="error"&&"test-err"].filter(Boolean).join(" "),d=e._url,h=e._lastTest?`Derniere synchro: ${e._lastTest}`:"Derniere synchro...";return t.jsx(Ue,{id:e.id,title:e._name,meta:d,metaSub:h,enabled:e.enabled,statusClass:i,badges:[{label:e._typeLabel,className:"pill--accent"},e.linkedSources>0?{label:`${e.linkedSources} indexeur${e.linkedSources>1?"s":""}`}:null].filter(Boolean),actions:[{icon:"science",title:s?"Test en cours...":"Test",onClick:()=>Ne(e),disabled:s||!e.enabled,spinning:s},{icon:"edit",title:"Modifier",onClick:()=>ye(e),disabled:s||!e.enabled},{icon:"delete",title:"Supprimer",onClick:()=>ve(e),disabled:s||!e.enabled,className:"iconbtn--danger"}],showToggle:!0,onToggle:()=>we(e),toggleDisabled:s},e.id)})}),t.jsx(ge,{open:xe,title:v?`Supprimer : ${v?.name??v?.id}`:"Supprimer",onClose:Q,width:520,children:t.jsxs("div",{style:{padding:12},children:[t.jsx("div",{style:{fontWeight:700,marginBottom:8},children:"Confirmer la suppression ?"}),t.jsx("div",{className:"muted",children:"Cette action est irréversible."}),v?.linkedSources>0&&t.jsxs("div",{className:"muted",style:{marginTop:6},children:["Supprimer aussi ",v.linkedSources," indexeur",v.linkedSources>1?"s":""," lié",v.linkedSources>1?"s":""," (désactivation automatique)."]}),t.jsxs("div",{className:"formactions",style:{marginTop:16},children:[t.jsx("button",{className:"btn btn-danger",type:"button",onClick:async()=>{const e=v;Q(),e&&await ke(e)},children:"Supprimer"}),t.jsx("button",{className:"btn",type:"button",onClick:Q,children:"Annuler"})]})]})}),t.jsx(ge,{open:pe,title:l?`Modifier : ${l?.name??l?.id}`:"Ajouter un fournisseur",onClose:H,width:560,children:t.jsxs("form",{onSubmit:Se,className:"formgrid formgrid--edit",children:[t.jsxs("div",{className:"field",children:[t.jsx("label",{className:"muted",children:"Type"}),t.jsx("select",{value:o,onChange:e=>F(e.target.value),disabled:!U,children:Ce.map(e=>t.jsx("option",{value:e,children:N(e)},e))})]}),t.jsxs("div",{className:"field",children:[t.jsx("label",{className:"muted",children:"Nom"}),t.jsx("input",{value:P,onChange:e=>q(e.target.value),placeholder:N(o)})]}),t.jsxs("div",{className:"field",children:[t.jsx("label",{className:"muted",children:"Base URL"}),t.jsx("input",{value:z,onChange:e=>J(e.target.value),placeholder:o==="prowlarr"?"http://192.168.1.x:9696 ou https://domaine.tld/prowlarr":"http://192.168.1.x:9117 ou https://domaine.tld/jackett",disabled:c==="pending"}),t.jsx("span",{className:"field-hint",children:"IP, hostname ou URL reverse proxy (http/https)"})]}),t.jsxs("div",{className:"field",children:[t.jsx("label",{className:"muted",children:"Clé API"}),t.jsxs("div",{className:"setup-jackett-key",children:[t.jsx("input",{type:ce?"text":"password",value:x,onChange:e=>G(e.target.value),placeholder:M?"Laisse vide pour ne pas changer":`Clé API ${N(o)}`,disabled:c==="pending"}),t.jsx("button",{className:"btn",type:"button",onClick:()=>V(e=>!e),disabled:c==="pending",children:ce?"Masquer":"Afficher"})]})]}),c==="pending"&&t.jsxs("div",{className:"muted",style:{gridColumn:"1 / -1"},children:[t.jsx("span",{className:"spinner",style:{marginRight:8}})," Test en cours..."]}),c==="error"&&t.jsxs("div",{className:"errorbox",style:{gridColumn:"1 / -1"},children:[t.jsx("div",{className:"errorbox__title",children:"Erreur"}),t.jsx("div",{className:"muted",children:de})]}),c==="ok"&&t.jsxs("div",{className:"noticebox",style:{gridColumn:"1 / -1"},children:[t.jsx("div",{className:"errorbox__title",children:"OK"}),t.jsx("div",{className:"muted",children:de})]}),t.jsx("div",{className:"formactions",children:t.jsxs("div",{className:"formactions-row",children:[t.jsxs("div",{className:"formactions-left",children:[t.jsx(Ie,{checked:j,onIonChange:e=>W(e.detail.checked),className:"settings-toggle",disabled:c==="pending",title:j?"Désactiver":"Activer"}),t.jsx("span",{className:"muted",children:j?"Actif":"Inactif"})]}),t.jsxs("div",{className:"formactions-right",children:[fe&&c!=="ok"&&t.jsx("button",{className:"btn",type:"button",onClick:je,disabled:c==="pending",children:c==="pending"?"Test...":"Tester"}),fe&&c==="ok"&&t.jsx("button",{className:"btn btn-accent",type:"submit",disabled:E,children:E?"Enregistrement...":"Enregistrer"}),t.jsx("button",{className:"btn",type:"button",onClick:H,disabled:E,children:"Annuler"})]})]})})]})})]})}export{Ye as default};
