import{n as f,C as A,a as N}from"./categoryGroups.constants-TqNJ0nIh.js";import{r as d,j as r,a as W}from"./vendor-react-B6j9w5IJ.js";import{t as y}from"./uiText-DZWurmTv.js";function K(o){const s=Number(o);return Number.isFinite(s)&&s>0?s:null}function E(o){const s=o instanceof Map?o:new Map,t=new Map;for(const[e,i]of s.entries()){const c=K(e);if(!c)continue;const l=f(i);l&&t.set(c,l)}return t}function ie(o){const s=new Map;for(const t of Array.isArray(o)?o:[]){const e=K(t?.id);if(!e)continue;const i=[t?.assignedGroupKey,t?.groupKey,t?.unifiedKey];for(const l of i)l==null||String(l).trim();const c=f(t?.assignedGroupKey)||f(t?.groupKey)||f(t?.unifiedKey)||f(t?.assignedGroupLabel)||f(t?.groupLabel)||f(t?.unifiedLabel);c&&t?.isAssigned!==!1&&s.set(e,c)}return s}function oe(o){const s=E(o),t=[];for(const[e,i]of s.entries()){const c=A[i]||i;t.push({categoryId:e,unifiedKey:i,unifiedLabel:c,catId:e,groupKey:i,groupLabel:c})}return t}function ae(o,s){const t=E(o),e=E(s),i=new Set([...t.keys(),...e.keys()]),c=[];for(const l of i){const p=t.get(l)||null,a=e.get(l)||null;p!==a&&c.push({categoryId:l,unifiedKey:a,unifiedLabel:a?A[a]||a:null,catId:l,groupKey:a,groupLabel:a?A[a]||a:null})}return c}function re(o){if(!Array.isArray(o))return[];const s=new Map,t=e=>{let i=0;return f(e?.unifiedKey||e?.groupKey||e?.assignedGroupKey)&&(i+=4),(e?.unifiedLabel||e?.groupLabel||e?.assignedGroupLabel)&&(i+=2),e?.parentId&&(i+=1),e?.isSub&&(i+=1),i};for(const e of o){const i=K(e?.id);if(!i)continue;const c={...e,id:i},l=s.get(i);(!l||t(c)>t(l))&&s.set(i,c)}return Array.from(s.values())}function ce(o){const s=new Set,t=[];for(const e of Array.isArray(o)?o:[]){const i=f(e?.unifiedKey||e?.key),c=String(e?.unifiedLabel||e?.label||e?.name||"").trim().toLowerCase(),l=i||c;!l||s.has(l)||(s.add(l),t.push(e))}return t}const Q={films:"Movies",series:"TV Series",animation:"Animation",anime:"Anime",games:"Video Games",comics:"Comics",books:"Books",audio:"Audio",spectacle:"Live Shows",emissions:"Shows"};function J(o){const s=new Map;for(const t of Array.isArray(o)?o:[]){const e=Number(t?.id);!Number.isFinite(e)||e<=0||s.has(e)||t?.isSupported!==!1&&s.set(e,{id:e,name:String(t?.name||`Cat ${e}`),isStandard:t?.isStandard===!0||e>=1e3&&e<=8999,isSupported:t?.isSupported!==!1})}return[...s.values()].sort((t,e)=>t.id-e.id)}function X(o,s,t,e){const i=f(e.get(o.id));return t==="assigned"&&!i||t==="unassigned"&&i?!1:s?`${o.id} ${o.name}`.toLowerCase().includes(s.toLowerCase()):!0}function le({categories:o,mappings:s,onChangeMapping:t,variant:e="default"}){const[i,c]=d.useState(""),[l,p]=d.useState("all"),[a,v]=d.useState(null),[x,h]=d.useState(null),j=d.useRef(null),L=d.useRef(new Map),b=s instanceof Map?s:new Map,w=d.useMemo(()=>J(o),[o]),S=Object.fromEntries(N.map(n=>[n.key,y(n.label,Q[n.key]||n.label)])),R=[...N].map(n=>({...n,label:S[n.key]||n.label})).sort((n,u)=>n.label.localeCompare(u.label,"en",{sensitivity:"base"})),g=d.useCallback(()=>{v(null),h(null)},[]),P=d.useCallback((n,u)=>{u?L.current.set(n,u):L.current.delete(n)},[]),C=d.useCallback(n=>{const u=L.current.get(n);if(!u)return null;const m=u.getBoundingClientRect(),G=180,Y=N.length*34+44,M=8,B=6;let _=m.right-G;_=Math.max(M,_),_=Math.min(_,window.innerWidth-G-M);const q=m.top-M,O=window.innerHeight-m.bottom-M,I=O<Y&&q>O,H=I?"top":"bottom";return{top:I?m.top-B:m.bottom+B,left:_,placement:H}},[]),$=d.useCallback(n=>{if(a===n){g();return}const u=C(n);if(!u){g();return}v(n),h(u)},[g,a,C]);d.useEffect(()=>{const n=u=>{j.current&&(u.target?.closest?.("[data-mapping-menu-root='true']")||j.current.contains(u.target)||g())};return document.addEventListener("mousedown",n),()=>document.removeEventListener("mousedown",n)},[g]),d.useEffect(()=>{if(!a)return;const n=()=>{const m=C(a);if(!m){g();return}h(m)},u=m=>{m.key==="Escape"&&g()};return window.addEventListener("resize",n),window.addEventListener("scroll",n,!0),window.addEventListener("keydown",u),()=>{window.removeEventListener("resize",n),window.removeEventListener("scroll",n,!0),window.removeEventListener("keydown",u)}},[g,a,C]);const T=d.useMemo(()=>{const n=Object.fromEntries(N.map(u=>[u.key,0]));for(const u of w){const m=f(b.get(u.id));m&&(n[m]+=1)}return n},[b,w]),k=d.useMemo(()=>w.filter(n=>X(n,i,l,b)),[w,i,l,b]);d.useEffect(()=>{a&&(k.some(n=>n.id===a)||g())},[g,k,a]);const U=k.filter(n=>n.isStandard),D=k.filter(n=>!n.isStandard),F=`category-mapping-board${e==="wizard"?" category-mapping-board--wizard":""}`,V=a?f(b.get(a)):null;return r.jsxs("div",{className:F,ref:j,children:[r.jsxs("div",{className:"category-mapping-board__top",children:[r.jsx("input",{className:"category-mapping-board__search",value:i,onChange:n=>c(n.target.value),placeholder:y("Rechercher par id ou nom...","Search by id or name...")}),r.jsxs("div",{className:"category-mapping-board__filters",children:[r.jsx("button",{type:"button",className:`type-chip${l==="all"?" type-chip--active":""}`,onClick:()=>p("all"),children:y("Tout","All")}),r.jsx("button",{type:"button",className:`type-chip${l==="assigned"?" type-chip--active":""}`,onClick:()=>p("assigned"),children:y("Assignées","Assigned")}),r.jsx("button",{type:"button",className:`type-chip${l==="unassigned"?" type-chip--active":""}`,onClick:()=>p("unassigned"),children:y("Non assignées","Unassigned")})]})]}),r.jsx("div",{className:"category-mapping-board__groups",children:R.map(n=>r.jsxs("div",{className:`category-group-card cat-bubble--${n.key}`,children:[r.jsx("div",{className:"category-group-card__label",children:n.label}),r.jsx("div",{className:"category-group-card__count",children:T[n.key]||0})]},n.key))}),r.jsxs("div",{className:"category-mapping-board__columns",children:[r.jsx(z,{title:y("Standard","Standard"),categories:U,mappings:b,groupLabels:S,openMenuId:a,onToggleMenu:$,registerAssignButton:P}),r.jsx(z,{title:y("Spécifiques","Specific"),categories:D,mappings:b,groupLabels:S,openMenuId:a,onToggleMenu:$,registerAssignButton:P})]}),a&&x&&r.jsx(Z,{groups:R,position:x,assignedKey:V,onAssign:n=>{t?.(a,n),g()},onClear:()=>{t?.(a,null),g()}})]})}function z({title:o,categories:s,mappings:t,groupLabels:e,openMenuId:i,onToggleMenu:c,registerAssignButton:l}){return r.jsxs("div",{className:"category-mapping-board__column",children:[r.jsx("div",{className:"category-mapping-board__column-title",children:o}),r.jsxs("div",{className:"category-mapping-board__chips",children:[s.length===0&&r.jsx("div",{className:"muted",children:y("Aucune catégorie.","No category.")}),s.map(p=>{const a=f(t.get(p.id)),v=a?e[a]:"—",x=i===p.id;return r.jsxs("div",{className:`mapping-chip${a?` mapping-chip--assigned mapping-chip--${a}`:""}`,children:[r.jsxs("div",{className:"mapping-chip__line",children:[r.jsx("span",{className:"mapping-chip__id",children:p.id}),r.jsx("span",{className:"mapping-chip__name",children:p.name})]}),r.jsx("div",{className:"mapping-chip__line",children:r.jsx("button",{type:"button",className:"mapping-chip__assign",ref:h=>l(p.id,h),onClick:()=>c(p.id),"aria-haspopup":"menu","aria-expanded":x?"true":"false",children:v})})]},p.id)})]})]})}function Z({groups:o,position:s,assignedKey:t,onAssign:e,onClear:i}){return typeof document>"u"?null:W.createPortal(r.jsxs("div",{className:`mapping-chip__menu mapping-chip__menu--portal${s.placement==="top"?" mapping-chip__menu--top":""}`,"data-mapping-menu-root":"true",style:{top:`${s.top}px`,left:`${s.left}px`},role:"menu",children:[o.map(c=>r.jsx("button",{type:"button",className:`mapping-chip__menu-item${t===c.key?" is-active":""}`,onClick:()=>e(c.key),children:c.label},c.key)),r.jsx("button",{type:"button",className:"mapping-chip__menu-item",onClick:i,children:y("Retirer","Remove")})]}),document.body)}export{le as C,re as a,ae as b,oe as c,ce as d,ie as m};
