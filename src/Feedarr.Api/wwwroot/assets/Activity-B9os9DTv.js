import{r,j as s}from"./vendor-react-B6j9w5IJ.js";import{u as W,a as A,r as $,g as q,A as B,c as H}from"./index-Dw1RV2ov.js";import{S as L}from"./SubAction-Ch7FlwVn.js";import{L as z}from"./Loader-WjrgZmWo.js";import{M as G}from"./Modal-CnEzehYC.js";import{t}from"./uiText-D9t7ygxs.js";import"./vendor-router-DbNMZja2.js";import"./vendor-icons-BuPyRjLk.js";function se(){function _(e){return e?new Date(e*1e3).toLocaleString(q()):""}const[h,j]=r.useState(!0),[f,g]=r.useState(""),[m,S]=r.useState([]),[b,E]=r.useState({}),[u,C]=r.useState(()=>new Set),[I,p]=r.useState(!1),[o,N]=r.useState(!1),[x,T]=r.useState(100),[n,D]=r.useState(""),[i,k]=r.useState(""),v=W(),c=r.useCallback(async()=>{j(!0),g("");try{const e=new URLSearchParams;e.set("limit",String(x)),n&&e.set("eventType",n),i&&e.set("level",i);const a=await A(`/api/activity?${e.toString()}`);S(Array.isArray(a)?a:[])}catch(e){g(e.message||"Erreur chargement activité"),S([])}finally{j(!1)}},[x,n,i]);r.useEffect(()=>{c()},[c]),r.useEffect(()=>{(async()=>{try{const e=await A("/api/sources");if(Array.isArray(e)){const a={};e.forEach(l=>{const d=l?.id??l?.sourceId;d&&(a[d]=l?.name||`Fournisseur ${d}`)}),E(a)}}catch{}})()},[]);function w({icon:e,label:a,value:l,onChange:d,children:M,title:O}){return s.jsxs("div",{className:"subdropdown",title:O||a,children:[s.jsx(B,{name:e,className:"subdropdown__icon"}),s.jsx("span",{className:"subdropdown__label",children:a}),s.jsx("span",{className:"subdropdown__caret",children:"▾"}),s.jsx("select",{className:"subdropdown__select",value:l,onChange:d,"aria-label":a,children:M})]})}r.useEffect(()=>(v(s.jsxs(s.Fragment,{children:[s.jsx(L,{icon:"refresh",label:t("Rafraîchir","Refresh"),onClick:c}),s.jsx(L,{icon:"delete",label:t("Effacer","Clear"),onClick:()=>p(!0),disabled:o||m.length===0}),s.jsx("span",{className:"subsep"}),s.jsx("div",{className:"subspacer"}),s.jsxs(w,{icon:"filter_list",label:t("Type","Type"),value:n,onChange:e=>D(e.target.value),title:t("Type de logs","Log type"),children:[s.jsx("option",{value:"",children:t("Tous","All")}),s.jsx("option",{value:"sync",children:"Sync"}),s.jsx("option",{value:"source",children:t("Source","Source")}),s.jsx("option",{value:"poster_fetch",children:t("Posters","Posters")})]}),s.jsxs(w,{icon:"priority_high",label:t("Niveau","Level"),value:i,onChange:e=>k(e.target.value),title:t("Niveau de log","Log level"),children:[s.jsx("option",{value:"",children:t("Tous","All")}),s.jsx("option",{value:"info",children:"Info"}),s.jsx("option",{value:"warn",children:t("Avertissement","Warning")}),s.jsx("option",{value:"error",children:t("Erreur","Error")})]})]})),()=>v(null)),[v,c,n,i,o,m.length]);const P=m.filter(e=>!(n&&String(e.eventType||"")!==n||i&&String(e.level||"")!==i));function F(e){C(a=>{const l=new Set(a);return l.has(e)?l.delete(e):l.add(e),l})}function y(e){if(!e)return null;try{return typeof e=="string"?JSON.parse(e):e}catch{return null}}function R(e){if(!e)return null;const a=y(e);return a?JSON.stringify(a,null,2):String(e)}async function U(){N(!0);try{await H("/api/activity/purge?scope=all",{}),C(new Set),p(!1),await c()}catch(e){g(e?.message||"Erreur purge logs")}finally{N(!1)}}return s.jsxs("div",{className:"page",children:[s.jsxs("div",{className:"pagehead",children:[s.jsxs("div",{children:[s.jsx("h1",{children:"Logs"}),s.jsx("div",{className:"muted",children:t("Synchronisations et événements","Synchronizations and events")})]}),s.jsx("div",{style:{display:"flex",gap:8},children:s.jsxs("select",{value:x,onChange:e=>T(e.target.value),children:[s.jsx("option",{value:50,children:"50"}),s.jsx("option",{value:100,children:"100"}),s.jsx("option",{value:200,children:"200"})]})})]}),h&&s.jsx(z,{label:t("Chargement des logs...","Loading logs...")}),!h&&f&&s.jsxs("div",{className:"errorbox",children:[s.jsx("div",{className:"errorbox__title",children:"Erreur"}),s.jsx("div",{className:"muted",children:f})]}),!h&&!f&&s.jsx("div",{style:{display:"flex",flexDirection:"column",gap:8},children:P.map((e,a)=>s.jsxs("div",{className:"activityCard"+(String(e.level||"").toLowerCase()==="warn"?" activityCard--warn":"")+(String(e.level||"").toLowerCase()==="error"?" activityCard--error":""),children:[s.jsxs("div",{style:{display:"flex",gap:12,alignItems:"center"},children:[s.jsxs("div",{style:{display:"flex",flexWrap:"wrap",gap:8,alignItems:"baseline",flex:"1 1 auto"},children:[s.jsxs("div",{style:{fontWeight:700},children:["[",e.level?.toUpperCase(),"] ",e.message]}),s.jsxs("div",{className:"muted",style:{display:"flex",gap:8,flexWrap:"wrap"},children:[s.jsxs("span",{children:[t("Source","Source")," : ",e.sourceId??"-",e.sourceId&&b[e.sourceId]?` ${b[e.sourceId]}`:""]}),s.jsxs("span",{children:[t("Type","Type")," : ",e.eventType??"-"]}),s.jsxs("span",{children:["#",e.id??"-"]})]})]}),s.jsx("div",{className:"muted",style:{marginLeft:"auto",whiteSpace:"nowrap"},children:_(e.createdAt)}),s.jsx("button",{className:"activityCard__toggle",onClick:()=>F(e.id??a),title:u.has(e.id??a)?t("Masquer détails","Hide details"):t("Afficher détails","Show details"),"aria-label":u.has(e.id??a)?t("Masquer détails","Hide details"):t("Afficher détails","Show details"),children:u.has(e.id??a)?"–":"+"})]}),u.has(e.id??a)&&s.jsxs(s.Fragment,{children:[s.jsx("pre",{className:"activityCard__details",children:R(e.dataJson)||t("Aucun détail","No details")}),y(e.dataJson)?.logFile&&s.jsx("div",{className:"activityCard__detailsActions",children:s.jsx("a",{className:"btn btn-sm",href:$(`/api/posters/retro-fetch/log/${encodeURIComponent(y(e.dataJson).logFile)}`),download:!0,children:t("Télécharger","Download")})})]})]},a))}),s.jsx(G,{open:I,title:t("Effacer les logs","Clear logs"),onClose:()=>p(!1),width:520,children:s.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[s.jsx("div",{className:"muted",children:t("Confirmer la purge des logs.","Confirm log purge.")}),s.jsx("div",{className:"muted",children:t("Cette action est définitive.","This action is permanent.")}),s.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end"},children:[s.jsx("button",{className:"btn",type:"button",onClick:()=>p(!1),disabled:o,children:t("Annuler","Cancel")}),s.jsx("button",{className:"btn btn-accent",type:"button",onClick:U,disabled:o,children:o?t("Suppression...","Deleting..."):t("Confirmer","Confirm")})]})]})})]})}export{se as default};
