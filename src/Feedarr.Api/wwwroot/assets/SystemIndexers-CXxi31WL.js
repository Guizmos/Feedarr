import{r as n,j as e}from"./vendor-react-B6j9w5IJ.js";import{u as A,a as p}from"./index-C6BMTWfr.js";import{S as M}from"./SubAction-DECBSCTd.js";import{L as E}from"./Loader-WjrgZmWo.js";import{a as y}from"./systemUtils-DnAbBuwt.js";import"./vendor-router-DbNMZja2.js";import"./vendor-icons-CUZlM7O3.js";import"./formatters--KSD9hRc.js";import"./categoryGroups.constants-TqNJ0nIh.js";function I(m){if(!Array.isArray(m))return null;for(const a of m){const c=a?.dataJson;if(!c)continue;let r=c;if(typeof c=="string")try{r=JSON.parse(c)}catch{r=null}if(!r||typeof r!="object")continue;const d=Number(r?.itemsCount??r?.items??null),i=Number(r?.upserted??null);if(Number.isFinite(d)||Number.isFinite(i)){const l=String(a?.message??"").toLowerCase(),h=l.includes("autosync")?"Automatique":l.includes("manual")||l.includes("sync ok")||l.includes("sync error")?"Manuel":null,u=Number(a?.createdAt??a?.created_at_ts??0);return{itemsCount:Number.isFinite(d)?d:null,upserted:Number.isFinite(i)?i:null,createdAt:Number.isFinite(u)&&u>0?u:null,mode:h}}}return null}function P(){const m=A(),[a,c]=n.useState(!0),[r,d]=n.useState(""),[i,l]=n.useState([]),[h,u]=n.useState({syncIntervalMinutes:60,autoSyncEnabled:!0}),[o,f]=n.useState(null),N=n.useCallback(async()=>{c(!0),d("");try{const[s,t,v]=await Promise.allSettled([p("/api/sources"),p("/api/settings/general"),p("/api/activity?limit=30&eventType=sync&level=info")]),j=[];s.status==="fulfilled"?l(Array.isArray(s.value)?s.value:[]):(l([]),j.push("Fournisseurs indisponibles")),t.status==="fulfilled"?u({syncIntervalMinutes:Number(t.value?.syncIntervalMinutes??60),autoSyncEnabled:t.value?.autoSyncEnabled!==!1}):u({syncIntervalMinutes:60,autoSyncEnabled:!0}),v.status==="fulfilled"?f(I(v.value)):f(null),j.length&&d(j.join(" - "))}catch(s){l([]),u({syncIntervalMinutes:60,autoSyncEnabled:!0}),f(null),d(s?.message||"Fournisseurs indisponibles")}finally{c(!1)}},[]);n.useEffect(()=>{N()},[N]),n.useEffect(()=>(m(e.jsx(e.Fragment,{children:e.jsx(M,{icon:"refresh",label:"Rafraîchir",onClick:N})})),()=>m(null)),[m,N]);const b=n.useMemo(()=>(i||[]).slice().sort((s,t)=>(s?.name||"").localeCompare(t?.name||"")),[i]),x=n.useMemo(()=>{const s=(i||[]).map(t=>Number(t?.lastSyncAt??0)).filter(t=>Number.isFinite(t)&&t>0);return s.length>0?Math.max(...s):null},[i]),S=n.useMemo(()=>{const s=Number(h?.syncIntervalMinutes??0);return!h?.autoSyncEnabled||!Number.isFinite(s)||s<=0||!Number.isFinite(x)||!x?null:Math.round(x+s*60)},[h,x]),g=n.useMemo(()=>o?Number.isFinite(o.upserted)?o.upserted:Number.isFinite(o.itemsCount)?o.itemsCount:null:null,[o]),C=o?.mode||"-",F=s=>{const t=Number(s);return Number.isFinite(t)?String(t):"-"};return e.jsxs("div",{className:"page page--system",children:[e.jsx("div",{className:"pagehead",children:e.jsxs("div",{children:[e.jsx("h1",{children:"Fournisseurs"}),e.jsx("div",{className:"muted",children:"Configuration de l'application"})]})}),e.jsx("div",{className:"pagehead__divider"}),a&&e.jsx(E,{label:"Chargement des fournisseurs..."}),!a&&r&&e.jsxs("div",{className:"errorbox",children:[e.jsx("div",{className:"errorbox__title",children:"Attention"}),e.jsx("div",{className:"muted",children:r})]}),!a&&e.jsxs("div",{className:"settings-grid",children:[e.jsxs("div",{className:"card-row card-row-third",style:{gridColumn:"1 / -1"},children:[e.jsxs("div",{className:"card card-third",children:[e.jsx("div",{className:"card-title",children:"Dernier sync"}),e.jsx("div",{className:"card-value",children:y(x)}),e.jsxs("div",{className:"muted",children:["Mode: ",C]})]}),e.jsxs("div",{className:"card card-third",children:[e.jsx("div",{className:"card-title",children:"Prochain sync"}),e.jsx("div",{className:"card-value",children:y(S)})]}),e.jsxs("div",{className:"card card-third",children:[e.jsx("div",{className:"card-title",children:"Items dernier sync"}),e.jsx("div",{className:"card-value",children:F(g)})]})]}),e.jsxs("div",{className:"settings-card settings-card--full",children:[e.jsx("div",{className:"settings-card__title",children:"Santé des fournisseurs"}),e.jsxs("div",{className:"health-head",children:[e.jsx("div",{children:"Nom"}),e.jsx("div",{children:"URL"}),e.jsx("div",{children:"Sync"}),e.jsx("div",{children:"Status"}),e.jsx("div",{children:"Erreur"})]}),b.length===0&&e.jsx("div",{className:"indexer-card",children:e.jsx("div",{className:"indexer-row indexer-row--settings",children:e.jsx("span",{className:"indexer-title",children:"Aucune source configurée."})})}),b.map(s=>{const t=String(s?.lastStatus||"").toLowerCase(),v=t==="ok"?"pill-ok":t?"pill-warn":"";return e.jsx("div",{className:`indexer-card${s?.enabled?"":" is-disabled"}`,children:e.jsxs("div",{className:"health-row",children:[e.jsxs("div",{className:"health-cell td-name",children:[e.jsx("span",{className:`dot ${s?.enabled?"ok":"off"}`}),e.jsx("span",{className:"name",children:s?.name||`Fournisseur ${s?.id}`})]}),e.jsx("div",{className:"health-cell td-url",children:e.jsx("span",{className:"muted",children:s?.torznabUrl||"-"})}),e.jsx("div",{className:"health-cell",children:e.jsx("span",{className:"muted",children:y(s?.lastSyncAt)})}),e.jsx("div",{className:"health-cell",children:t?e.jsx("span",{className:`pill ${v}`,children:t.toUpperCase()}):e.jsx("span",{className:"muted",children:"-"})}),e.jsx("div",{className:"health-cell",children:e.jsx("span",{className:"muted",children:s?.lastError||"-"})})]})},s.id)})]})]})]})}export{P as default};
