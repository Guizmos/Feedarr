import{r as t,j as e}from"./vendor-react-B6j9w5IJ.js";import{D as Ue,a as ie,n as ze,j as sa,b as Je,L as ya,c as Ce,f as ra,h as ma}from"./index-C6BMTWfr.js";import{t as a}from"./uiText-BIKCb3Eq.js";import{b as Re,a as xa,E as va}from"./ExternalProviderInstancesSection-CjDzFwgQ.js";import{I as aa}from"./ItemRow-CH6u-Ybt.js";import{M as ta}from"./Modal-LPROLsOK.js";import{C as ja,m as na,c as ba}from"./CategoryMappingBoard-DJH_lAZi.js";import{n as ia,C as wa}from"./categoryGroups.constants-TqNJ0nIh.js";import{i as Sa,g as Te,a as ka}from"./appTypes-BSxyKsC5.js";import{O as Aa}from"./vendor-icons-CUZlM7O3.js";import{b as Na}from"./vendor-router-DbNMZja2.js";function Ca({onStatusChange:l}){const[n,g]=t.useState(!0),[i,k]=t.useState(!1),[C,I]=t.useState(""),[T,b]=t.useState(Ue),[K,_]=t.useState(null),Z=t.useRef(0),A=t.useCallback(async()=>{g(!0),I("");try{const y=await ie("/api/settings/ui"),O=Re(y||{}),j=ze(O.uiLanguage||Ue);_(O),b(j),sa(j,!0)}catch(y){_(Re({uiLanguage:Ue,mediaInfoLanguage:Ue})),b(Ue),I(y?.message||a("Erreur chargement langue","Language loading error"))}finally{g(!1)}},[]);t.useEffect(()=>{A()},[A]);const Y=t.useCallback(async y=>{const O=K||Re({}),j=ze(y||Ue),Q=Z.current+1;Z.current=Q,k(!0),I("");try{const M=Re(O,{uiLanguage:j,mediaInfoLanguage:j}),J=await Je("/api/settings/ui",M);if(Q!==Z.current)return;const c=Re(J||M),v=ze(c.uiLanguage||j);_(c),b(v),sa(v,!0)}catch(M){if(Q!==Z.current)return;I(M?.message||a("Erreur sauvegarde langue","Language save error"))}finally{Q===Z.current&&k(!1)}},[K]);function H(y){const O=ze(y.target.value);b(O),Y(O)}const x=t.useMemo(()=>({ready:!n&&!i&&!!T&&!C,saving:i,error:C}),[C,n,i,T]);return t.useEffect(()=>{l?.(x)},[l,x]),e.jsxs("div",{className:"setup-step setup-language",children:[e.jsx("h2",{children:a("Langue","Language")}),e.jsx("p",{children:a("Choisis la langue par defaut de Feedarr.","Choose Feedarr default language.")}),e.jsxs("div",{className:"setup-providers__add settings-row settings-row--ui-select",children:[e.jsx("label",{children:a("Langue par defaut","Default language")}),e.jsx("select",{className:"settings-field",value:T,onChange:H,disabled:n||i,children:ya.map(y=>e.jsx("option",{value:y.value,children:y.label},y.value))})]}),e.jsx("div",{className:"muted",children:a("Cette etape applique la langue UI et la langue metadata par defaut.","This step sets both UI and metadata default language.")}),n&&e.jsx("div",{className:"muted",children:a("Chargement...","Loading...")}),i&&e.jsx("div",{className:"muted",children:a("Enregistrement...","Saving...")}),C&&e.jsx("div",{className:"onboarding__error",style:{marginTop:12},children:C}),C&&e.jsx("div",{className:"setup-jackett__actions",style:{marginTop:12},children:e.jsx("button",{className:"btn",type:"button",onClick:()=>A(),disabled:n||i,children:a("Reessayer","Retry")})})]})}function Ia(){return e.jsxs("div",{className:"setup-step",children:[e.jsx("h2",{children:a("Bienvenue","Welcome")}),e.jsx("p",{children:a("Configuration rapide en 7 etapes.","Quick setup in 7 steps.")}),e.jsx("p",{className:"muted",children:a("Resume : langue -> metadata -> fournisseurs RSS -> indexeurs -> applications.","Summary: language -> metadata -> RSS providers -> indexers -> applications.")})]})}const Pa={};function _a({validation:l,onValidationChange:n,onAllProvidersAddedChange:g}){const i=xa();t.useEffect(()=>{i.loadExternalProviders(),i.loadProviderStats()},[i.loadExternalProviders,i.loadProviderStats]),t.useEffect(()=>{n&&n(C=>({...C||Pa,...i.externalValidationByProvider}))},[i.externalValidationByProvider,n]),t.useEffect(()=>{g?.(i.allProvidersAdded)},[i.allProvidersAdded,g]);const k=Object.values(l||i.externalValidationByProvider||{}).some(C=>C==="ok");return e.jsxs("div",{className:"setup-step setup-providers",children:[e.jsx("h2",{children:a("Metadonnees","Metadata")}),e.jsx("p",{children:a("Ajoute au moins un provider metadata configure et actif.","Add at least one configured and enabled metadata provider.")}),!k&&e.jsx("div",{className:"onboarding__error",children:a("Configure au moins un provider metadata pour continuer.","Configure at least one metadata provider to continue.")}),e.jsx(va,{controller:i,showInlineAdd:!0})]})}const $e="feedarr:jackettProvider",Oe=[{key:"jackett",label:"Jackett",placeholder:"http://192.168.1.x:9117 ou https://domaine.tld/jackett",endpoint:"/api/jackett/indexers"},{key:"prowlarr",label:"Prowlarr",placeholder:"http://192.168.1.x:9696 ou https://domaine.tld/prowlarr",endpoint:"/api/prowlarr/indexers"}],Ne={jackett:{baseUrl:"feedarr:jackettBaseUrl",apiKey:"feedarr:jackettApiKey",indexers:"feedarr:jackettIndexersCache",configured:"feedarr:jackettConfigured",manualOnly:"feedarr:jackettManualOnly"},prowlarr:{baseUrl:"feedarr:prowlarrBaseUrl",apiKey:"feedarr:prowlarrApiKey",indexers:"feedarr:prowlarrIndexersCache",configured:"feedarr:prowlarrConfigured",manualOnly:"feedarr:prowlarrManualOnly"}},we={baseUrl:"",indexers:[],configured:!1,manualOnly:!1};function He(l){return String(l||"").trim().replace(/\/+$/,"")}function Qe(l){return Oe.find(n=>n.key===l)||Oe[0]}function oa(l){const n=Ne[l];if(!n||typeof window>"u")return{...we};const g=window.localStorage.getItem(n.baseUrl)||"",i=window.localStorage.getItem(n.configured)==="true",k=window.localStorage.getItem(n.indexers)||"",C=k?JSON.parse(k)||[]:[],I=window.localStorage.getItem(n.manualOnly)==="true";return{baseUrl:g,configured:i&&!!g,indexers:Array.isArray(C)?C:[],manualOnly:I}}function Ma({onStatusChange:l,resetToken:n,initialStatus:g}){const[i,k]=t.useState(""),[C,I]=t.useState(""),[T,b]=t.useState(""),[K,_]=t.useState(""),[Z,A]=t.useState(!1),[Y,H]=t.useState(!1),[x,y]=t.useState("idle"),[O,j]=t.useState(""),[Q,M]=t.useState(0),[J,c]=t.useState(""),[v,E]=t.useState(!1),[$,F]=t.useState([]),[U,p]=t.useState({jackett:{...we},prowlarr:{...we}}),[z,D]=t.useState(!1),P=t.useRef(!1),B=t.useRef(null);t.useEffect(()=>{if(typeof window>"u")return;Object.values(Ne).forEach(w=>{window.localStorage.removeItem(w.apiKey)});const o=window.localStorage.getItem($e)||"";if(o==="prowlarr"){const w=Ne.jackett,ue=Ne.prowlarr,W=window.localStorage.getItem(ue.configured)==="true",te=window.localStorage.getItem(w.baseUrl)||"",oe=window.localStorage.getItem(w.configured)==="true",le=window.localStorage.getItem(w.indexers)||"";!W&&(oe||te)&&(window.localStorage.setItem(ue.baseUrl,te),le&&window.localStorage.setItem(ue.indexers,le),window.localStorage.setItem(ue.configured,oe?"true":"false"),window.localStorage.removeItem(w.baseUrl),window.localStorage.removeItem(w.apiKey),window.localStorage.removeItem(w.indexers),window.localStorage.removeItem(w.configured))}const h={jackett:oa("jackett"),prowlarr:oa("prowlarr")};p(h);const N=o==="prowlarr"?"prowlarr":"jackett",L=h[N],R=Oe.find(w=>h[w.key]?.configured),ae=L?.configured?N:R?.key||"";if(ae){const w=h[ae]||{...we};P.current=!0,k(ae),I(""),b(w.baseUrl),_(""),F(Array.isArray(w.indexers)?w.indexers:[]),M(Array.isArray(w.indexers)?w.indexers.length:0),y(w.manualOnly?"manual":"ok"),j(w.manualOnly?a("Configuration enregistree. Ajoute les indexeurs manuellement a l'etape suivante.","Configuration saved. Add indexers manually at the next step."):a("Cles deja enregistrees.","Keys already saved.")),E(!0),l?.({provider:ae,ready:!0,baseUrl:w.baseUrl,indexers:Array.isArray(w.indexers)?w.indexers:[],manualOnly:!!w.manualOnly})}D(!0)},[l]),t.useEffect(()=>{if(!g?.ready)return;const o=String(g.baseUrl||"");if(!o)return;const h=g.provider||"jackett";P.current=!0,k(h),I(""),b(o),_(""),F(Array.isArray(g.indexers)?g.indexers:[]),y(g?.manualOnly?"manual":"ok"),j(g?.manualOnly?a("Configuration enregistree. Ajoute les indexeurs manuellement a l'etape suivante.","Configuration saved. Add indexers manually at the next step."):a("Cles deja enregistrees.","Keys already saved.")),M(Array.isArray(g.indexers)?g.indexers.length:0),E(!0),p(N=>({...N,[h]:{baseUrl:o,indexers:Array.isArray(g.indexers)?g.indexers:[],configured:!0,manualOnly:!!g?.manualOnly}}))},[g]),t.useEffect(()=>{n&&(typeof window<"u"&&(Object.values(Ne).forEach(o=>{window.localStorage.removeItem(o.baseUrl),window.localStorage.removeItem(o.apiKey),window.localStorage.removeItem(o.indexers),window.localStorage.removeItem(o.configured),window.localStorage.removeItem(o.manualOnly)}),window.localStorage.removeItem($e)),p({jackett:{...we},prowlarr:{...we}}),k(""),I(""),b(""),_(""),E(!1),y("idle"),j(""),M(0),c(""),F([]),l?.({provider:"",ready:!1,baseUrl:"",indexers:[],manualOnly:!1}),H(!1))},[n,l]),t.useEffect(()=>{if(z){if(P.current){P.current=!1;return}y("idle"),j(""),M(0),c(""),E(!1)}},[T,K,i,z]);const ee=t.useMemo(()=>(i==="jackett"||i==="prowlarr")&&!!T.trim()&&!!K.trim()&&x!=="testing",[i,T,K,x]),X=x==="testing",de=x==="ok"||x==="manual"?!!T.trim()&&!!K.trim()&&!X:ee,re=t.useMemo(()=>Oe.filter(o=>U[o.key]?.configured),[U]),V=t.useMemo(()=>Oe.filter(o=>!U[o.key]?.configured),[U]),ce=Qe(i||"jackett");function me(o){const h=U[o]||{...we};P.current=!0,k(o),I(""),b(h.baseUrl||""),_(""),F(Array.isArray(h.indexers)?h.indexers:[]),M(Array.isArray(h.indexers)?h.indexers.length:0),h.configured?(y(h.manualOnly?"manual":"ok"),j(h.manualOnly?a("Configuration enregistree. Ajoute les indexeurs manuellement a l'etape suivante.","Configuration saved. Add indexers manually at the next step."):a("Cles deja enregistrees.","Keys already saved.")),E(!0)):(y("idle"),j(""),E(!1)),c(""),A(!1),H(!0)}function ge(o){B.current&&clearTimeout(B.current),c(o),B.current=setTimeout(()=>{c("")},1200)}async function he(){if(!ee)return;y("testing"),j(""),M(0);const o=Date.now();let h="error",N="",L=0,R=[];const ae=Qe(i),w=ae.label;for(let W=0;W<2;W+=1)try{const te=He(T),oe=ae.endpoint,le=await Ce(oe,{baseUrl:te,apiKey:K.trim()}),fe=Array.isArray(le)?le:le?.indexers,pe=Array.isArray(fe)?fe.length:0;pe>0?(h="ok",N=a(`Connexion OK (${pe} indexeur${pe>1?"s":""})`,`Connection OK (${pe} indexer${pe>1?"s":""})`),L=pe,R=Array.isArray(fe)?fe:[]):(h="manual",N=a("Connexion OK, mais aucun indexeur recupere automatiquement. Tu pourras les ajouter manuellement a l'etape suivante (Copy Torznab Feed + cle API).","Connection OK, but no indexer was auto-fetched. You can add them manually at the next step (Copy Torznab Feed + API key)."));break}catch(te){const oe=te?.message||`Erreur de connexion ${w}.`;if(W===0&&/invalid start of a value|unexpected token\s*</i.test(oe)){await new Promise(le=>setTimeout(le,350));continue}h="manual",N=/invalid start of a value|unexpected token\s*</i.test(oe)?a(`Recuperation auto des indexeurs ${w} impossible. Enregistre la config puis ajoute les indexeurs manuellement a l'etape suivante (Copy Torznab Feed + cle API).`,`Unable to auto-fetch ${w} indexers. Save the config then add indexers manually at the next step (Copy Torznab Feed + API key).`):`${oe} ${a("Tu peux quand meme enregistrer et ajouter les indexeurs manuellement a l'etape suivante.","You can still save and add indexers manually at the next step.")}`;break}const ue=Date.now()-o;if(ue<2e3&&await new Promise(W=>setTimeout(W,2e3-ue)),y(h),j(N),M(L),h==="ok"||h==="manual"){if(F(R),typeof window<"u"){const W=Ne[i];W&&window.localStorage.setItem(W.indexers,JSON.stringify(R))}if(L>200){const W=R.slice(0,3).map(te=>({id:te?.id,name:te?.name}));console.log(`[${w}] indexers count suspicious`,{url:He(T),status:"ok",size:L,shape:Array.isArray(R)?"array":typeof R,sample:W})}}ge(h==="error"?"error":"ok")}async function ye(){if(x!=="ok"&&x!=="manual")return;const o=He(T),h=K.trim();if(!o||!h)return;const N=Ne[i];if(!(!N||typeof window>"u")){try{await Je(`/api/setup/indexer-providers/${i}`,{baseUrl:o,apiKey:h,enabled:!0}),console.info("[setup/providers] persisted",{provider:i,baseUrl:o})}catch(L){const R=Qe(i).label;y("error"),E(!1),j(L?.message||a(`Impossible d'enregistrer ${R}.`,`Unable to save ${R}.`));return}window.localStorage.setItem(N.baseUrl,o),window.localStorage.removeItem(N.apiKey),window.localStorage.setItem(N.configured,"true"),window.localStorage.setItem(N.manualOnly,x==="manual"?"true":"false"),window.localStorage.setItem($e,i),window.localStorage.setItem(N.indexers,JSON.stringify($||[])),P.current=!0,b(o),E(!0),H(!1),p(L=>({...L,[i]:{baseUrl:o,indexers:Array.isArray($)?$:[],configured:!0,manualOnly:x==="manual"}})),l?.({provider:i,ready:!0,baseUrl:o,indexers:Array.isArray($)?$:[],manualOnly:x==="manual"})}}function xe(o){const h=Ne[o];typeof window<"u"&&h&&(window.localStorage.removeItem(h.baseUrl),window.localStorage.removeItem(h.apiKey),window.localStorage.removeItem(h.indexers),window.localStorage.removeItem(h.configured),window.localStorage.removeItem(h.manualOnly));const N={...U,[o]:{...we}};p(N),o===i&&(k(""),I(""),b(""),_(""),E(!1),y("idle"),j(""),M(0),c(""),F([]),H(!1));const L=Oe.find(R=>R.key!==o&&N[R.key]?.configured);if(L){const R=N[L.key]||{...we};typeof window<"u"&&window.localStorage.setItem($e,L.key),l?.({provider:L.key,ready:R.configured,baseUrl:R.baseUrl,indexers:Array.isArray(R.indexers)?R.indexers:[],manualOnly:!!R.manualOnly})}else typeof window<"u"&&window.localStorage.removeItem($e),l?.({provider:"",ready:!1,baseUrl:"",indexers:[],manualOnly:!1})}return e.jsxs("div",{className:"setup-step setup-jackett-conn",children:[e.jsx("h2",{children:a("Fournisseurs","Providers")}),e.jsx("p",{children:a("Choisis ton fournisseur d'indexeurs.","Choose your indexer provider.")}),V.length>0&&e.jsxs("div",{className:"setup-providers__add settings-row settings-row--ui-select",children:[e.jsx("label",{children:a("Fournisseur","Provider")}),e.jsxs("select",{className:"settings-field",value:C,onChange:o=>{const h=o.target.value;I(""),h&&me(h)},children:[e.jsx("option",{value:"",disabled:!0,children:a("Selectionner...","Select...")}),V.map(o=>e.jsx("option",{value:o.key,children:o.label},o.key))]})]}),e.jsxs("div",{className:"setup-providers__list",children:[e.jsx("h4",{children:a("Fournisseurs configures","Configured providers")}),re.length===0&&e.jsx("div",{className:"muted",children:a("Aucun fournisseur configure.","No provider configured.")}),re.length>0&&e.jsx("div",{className:"indexer-list",children:re.map((o,h)=>{const N=U[o.key]?.baseUrl||"",L=[{label:a("Configure","Configured"),className:"pill-ok"}];return U[o.key]?.manualOnly&&L.push({label:a("Ajout manuel","Manual add"),className:"pill-warn"}),e.jsx(aa,{id:h+1,title:o.label,meta:N,enabled:!0,badges:L,actions:[{icon:"edit",title:a("Modifier","Edit"),onClick:()=>me(o.key),disabled:x==="testing"},{icon:"delete",title:a("Supprimer","Delete"),onClick:()=>xe(o.key),disabled:x==="testing",className:"iconbtn--danger"}],showToggle:!1},o.key)})})]}),e.jsxs(ta,{open:Y,title:`${a("Configurer","Configure")} ${ce.label}`,onClose:()=>H(!1),width:520,children:[e.jsxs("div",{className:"formgrid formgrid--edit",children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{children:a("Base URL","Base URL")}),e.jsx("input",{value:T,onChange:o=>b(o.target.value),placeholder:ce.placeholder,disabled:x==="testing"}),e.jsx("span",{className:"field-hint",children:a("IP, hostname ou URL reverse proxy (http/https)","IP, hostname or reverse proxy URL (http/https)")})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{children:a("API key","API key")}),e.jsxs("div",{className:"setup-jackett-key",children:[e.jsx("input",{type:Z?"text":"password",value:K,onChange:o=>_(o.target.value),placeholder:`${a("Cle API","API key")} ${ce.label}`,disabled:x==="testing"}),e.jsx("button",{className:"btn",type:"button",onClick:()=>A(o=>!o),disabled:x==="testing",children:Z?a("Masquer","Hide"):a("Afficher","Show")})]})]})]}),e.jsxs("div",{className:"setup-jackett-hint",children:[a("Indexeurs detectes","Detected indexers"),": ",Q||0]}),x==="error"&&e.jsx("div",{className:"onboarding__error",children:O}),x==="ok"&&e.jsxs("div",{className:"onboarding__ok",children:[O," ",v?` - ${a("enregistre","saved")}`:""]}),x==="manual"&&e.jsxs("div",{className:"onboarding__warn",children:[O," ",v?` - ${a("enregistre","saved")}`:""]}),e.jsx("div",{className:"setup-jackett-footer",children:e.jsx("button",{className:`btn btn-accent btn-test${J==="ok"?" btn-pulse-ok":""}${J==="error"?" btn-pulse-err":""}`,type:"button",onClick:x==="ok"||x==="manual"?ye:()=>he(),disabled:!de,children:X?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"btn-spinner"}),a("Test en cours...","Test in progress...")]}):J==="ok"?a("Valide","Valid"):J==="error"?a("Invalide","Invalid"):x==="ok"?a("Sauvegarder","Save"):x==="manual"?a("Sauvegarder (manuel)","Save (manual)"):a("Tester","Test")})})]})]})}const qe={jackett:{baseUrl:"feedarr:jackettBaseUrl",apiKey:"feedarr:jackettApiKey",indexers:"feedarr:jackettIndexersCache",configured:"feedarr:jackettConfigured",manualOnly:"feedarr:jackettManualOnly"},prowlarr:{baseUrl:"feedarr:prowlarrBaseUrl",apiKey:"feedarr:prowlarrApiKey",indexers:"feedarr:prowlarrIndexersCache",configured:"feedarr:prowlarrConfigured",manualOnly:"feedarr:prowlarrManualOnly"}},Ie=[{key:"jackett",label:"Jackett"},{key:"prowlarr",label:"Prowlarr"}],ea={baseUrl:"",providerId:null,indexers:[],configured:!1,manualOnly:!1},la="__manual__";function ne(l){return String(l||"").trim().replace(/\/+$/,"")}function da(l){const n=qe[l];if(!n||typeof window>"u")return{...ea};const g=window.localStorage.getItem(n.baseUrl)||"",i=window.localStorage.getItem(n.configured)==="true",k=window.localStorage.getItem(n.indexers)||"",C=k?JSON.parse(k)||[]:[],I=window.localStorage.getItem(n.manualOnly)==="true";return{baseUrl:g,providerId:null,configured:i&&!!g,indexers:Array.isArray(C)?C:[],manualOnly:I}}function Xe(l){return Ie.find(n=>n.key===l)?.label||a("Fournisseur","Provider")}function Ua({onHasSourcesChange:l,onBack:n,jackettConfig:g}){const[i,k]=t.useState({jackett:{...ea},prowlarr:{...ea}}),[C,I]=t.useState({jackett:"",prowlarr:""}),[T,b]=t.useState([]),[K,_]=t.useState({jackett:"",prowlarr:""}),[Z,A]=t.useState(!1),[Y,H]=t.useState(null),[x,y]=t.useState(""),[O,j]=t.useState(!1),[Q,M]=t.useState(""),[J,c]=t.useState(""),[v,E]=t.useState(null),[$,F]=t.useState(!1),[U,p]=t.useState(""),[z,D]=t.useState(""),[P,B]=t.useState(""),[ee,X]=t.useState([]),[de,re]=t.useState(()=>new Map),[V,ce]=t.useState(!1),[me,ge]=t.useState(!1),[he,ye]=t.useState(null),[xe,o]=t.useState(""),h=t.useCallback(async()=>{o("");const r={jackett:da("jackett"),prowlarr:da("prowlarr")},m={jackett:"",prowlarr:""};try{const u=await ie("/api/providers"),f=new Map((Array.isArray(u)?u:[]).map(d=>[String(d?.type||"").toLowerCase(),d]));for(const d of Ie){const S=f.get(d.key);if(!S)continue;const G=Number(S?.id),s=ne(S?.baseUrl),q=!!S?.enabled&&!!S?.hasApiKey&&!!s;if(r[d.key]={...r[d.key],providerId:Number.isFinite(G)&&G>0?G:null,baseUrl:s,configured:q,manualOnly:r[d.key]?.manualOnly||!1},typeof window<"u"){const se=qe[d.key];window.localStorage.setItem(se.baseUrl,s||""),window.localStorage.setItem(se.configured,q?"true":"false"),window.localStorage.removeItem(se.apiKey),q||(window.localStorage.setItem(se.indexers,JSON.stringify([])),window.localStorage.setItem(se.manualOnly,"false"))}}await Promise.all(Ie.map(async d=>{const S=r[d.key];if(!(!S?.configured||!S.providerId))try{const G=await ie(`/api/providers/${S.providerId}/indexers`),s=Array.isArray(G)?G:[];r[d.key]={...r[d.key],indexers:s,manualOnly:s.length===0},typeof window<"u"&&(window.localStorage.setItem(qe[d.key].indexers,JSON.stringify(s)),window.localStorage.setItem(qe[d.key].manualOnly,s.length===0?"true":"false")),s.length===0&&(m[d.key]=`Récupération automatique indisponible pour ${d.label}. Ajoute les indexeurs manuellement via "Copy Torznab Feed".`)}catch(G){console.error(`[Step3 Indexers] Chargement indexeurs ${d.label} échoué.`,G);const q=(Array.isArray(r[d.key]?.indexers)?r[d.key].indexers:[]).length===0||!!r[d.key]?.manualOnly;r[d.key]={...r[d.key],manualOnly:q},q&&(m[d.key]=`Impossible de récupérer la liste auto pour ${d.label}. Ajoute les indexeurs manuellement via "Copy Torznab Feed".`)}}))}catch(u){console.error("[Step3 Indexers] Impossible de charger les fournisseurs depuis l'API.",u),o("Impossible de charger les fournisseurs. La configuration locale est utilisée.")}k(r),I(m)},[]),N=t.useCallback(async()=>{try{const r=await ie("/api/sources");b(Array.isArray(r)?r:[])}catch(r){console.error("[Step3 Indexers] Impossible de charger les sources.",r),b([]),o("Erreur lors du chargement des sources.")}},[]);t.useEffect(()=>{h()},[h]),t.useEffect(()=>{g&&h()},[g,h]),t.useEffect(()=>{N()},[N]);const L=t.useMemo(()=>Ie.filter(r=>i[r.key]?.configured),[i]),R=L.length>0,ae=t.useMemo(()=>{const r=Object.fromEntries(Ie.map(u=>[u.key,[]])),m=Ie.map(u=>({key:u.key,base:ne(i[u.key]?.baseUrl)})).filter(u=>u.base);return T.forEach(u=>{const f=ne(u?.torznabUrl),d=m.find(S=>f.startsWith(S.base));d&&r[d.key]&&r[d.key].push(u)}),r},[T,i]),w=t.useMemo(()=>L.reduce((r,m)=>r+(ae[m.key]?.length||0),0),[L,ae]);t.useEffect(()=>{l?.(w>0)},[w,l]);const ue=t.useMemo(()=>{const r={};return L.forEach(m=>{const u=new Set((ae[m.key]||[]).map(S=>ne(S?.torznabUrl))),f=i[m.key]?.indexers||[],d=Array.isArray(f)?f:[];r[m.key]=d.filter(S=>!u.has(ne(S?.torznabUrl)))}),r},[L,i,ae]);function W(){p(""),D(""),B(""),X([]),re(new Map),H(null),E(null),j(!1),M(""),c("")}function te(){V||(A(!1),y(""),W())}function oe(r,m){W(),j(!1),y(r),H(m),A(!0),Pe(r,m)}function le(r){W(),j(!0),y(r),A(!0)}function fe(r){const m=ne(r?.torznabUrl),u=Ie.map(f=>({key:f.key,base:ne(i[f.key]?.baseUrl)})).find(f=>f.base&&m.startsWith(f.base));return u?.key?u.key:L[0]?.key||""}function pe(r){const m=new URLSearchParams;Object.entries(r||{}).forEach(([f,d])=>{if(d==null)return;const S=String(d).trim();S&&m.set(f,S)});const u=m.toString();return u?`/api/categories/caps?${u}`:"/api/categories/caps"}async function Pe(r,m){if(p(""),D(""),B(""),X([]),re(new Map),!m?.torznabUrl){p(a("Indexeur invalide.","Invalid indexer."));return}const u=Number(i[r]?.providerId||0);if(!u){p(a("Fournisseur non configure cote API.","Provider not configured in API."));return}F(!0);try{const f=await Ce("/api/categories/caps/provider",{providerId:u,torznabUrl:m.torznabUrl,indexerId:m?.id,indexerName:m?.name,includeStandardCatalog:!0,includeSpecific:!0}),d=Array.isArray(f?.categories)?f.categories:[],S=Array.isArray(f?.warnings)?f.warnings:[];S.length>0&&B(S.join(" ")),X(d),re(na(d)),d.length>0?D(a("Categories chargees.","Categories loaded.")):S.length===0&&B(a("Aucune categorie disponible.","No category available."))}catch(f){B(f?.message||a("Caps indisponible. Aucune categorie disponible.","Caps unavailable. No category available."))}finally{F(!1)}}async function ve(){const r=x;if(!r){p(a("Fournisseur non selectionne.","Provider not selected."));return}const m=ne(J);if(!m){p(a("URL Torznab requise.","Torznab URL required."));return}const u=Xe(r);await Pe(r,{id:"manual",name:Q.trim()||`${u} manuel`,torznabUrl:m})}async function Ee(){p(""),D("");const r=x,m=Xe(r),u=O?{id:"manual",name:Q.trim()||`${m} manuel`,torznabUrl:ne(J)}:Y;if(!u?.torznabUrl||!ne(u?.torznabUrl)){p(O?a("URL Torznab requise.","Torznab URL required."):a("Indexeur invalide.","Invalid indexer."));return}if(T.find(S=>ne(S?.torznabUrl)===ne(u.torznabUrl))){p("Cet indexeur est déjà ajouté.");return}const d=Number(i[r]?.providerId||0);if(!d){p(a("Fournisseur non configure cote API.","Provider not configured in API."));return}ce(!0);try{const S=await Ce("/api/sources",{name:u.name||m,torznabUrl:ne(u.torznabUrl),authMode:"query",providerId:d});if(S?.id){await Je(`/api/sources/${S.id}/enabled`,{enabled:!0});const G=ba(de);G.length>0&&await ra(`/api/sources/${S.id}/category-mappings`,{mappings:G})}await N(),D(a("Indexeur ajoute.","Indexer added.")),te()}catch(S){p(S?.message||"Erreur ajout indexeur")}finally{ce(!1)}}async function _e(r){const m=fe(r);y(m),E(r),j(!1),M(""),c(""),A(!0),p(""),D(""),B(""),X([]),re(new Map),F(!0);try{const u=await ie(pe({sourceId:r.id,indexerName:r?.name,includeStandardCatalog:!0,includeSpecific:!0}));let f=Array.isArray(u?.categories)?u.categories:[];const d=Array.isArray(u?.warnings)?u.warnings:[];d.length>0&&B(d.join(" ")),X(f),re(na(f)),f.length>0?D(a("Categories chargees.","Categories loaded.")):d.length===0&&B(a("Aucune categorie disponible.","No category available."))}catch(u){p(u?.message||"Erreur chargement categories")}finally{F(!1)}}async function Le(){if(!v?.id)return;const r=(ee||[]).map(m=>{const u=Number(m?.id);if(!Number.isFinite(u)||u<=0)return null;const f=ia(de.get(u))||null,d=f?wa[f]||f:null;return{categoryId:u,unifiedKey:f,unifiedLabel:d,catId:u,groupKey:f,groupLabel:d}}).filter(Boolean);if(r.length===0){p(a("Aucune categorie a mettre a jour.","No category to update."));return}ce(!0);try{await ra(`/api/sources/${v.id}/category-mappings`,{mappings:r}),await N(),D(a("Categories mises a jour.","Categories updated.")),te()}catch(m){p(m?.message||"Erreur sauvegarde categories")}finally{ce(!1)}}async function Ge(r){if(r?.id){ye(r.id);try{await ma(`/api/sources/${r.id}`),await N()}catch(m){console.error("[Step3 Indexers] Impossible de supprimer la source.",m),o("Impossible de supprimer la source.")}ye(null)}}async function Ve(){if(!(!v?.id||me||!(typeof window>"u"||window.confirm("Reclasser l'existant pour cette source ?")))){p(""),ge(!0);try{await Ce(`/api/sources/${v.id}/reclassify`),D(a("Reclassement termine.","Reclassification done.")),await N()}catch(m){p(m?.message||a("Erreur reclassification","Reclassification error"))}finally{ge(!1)}}}const Ke=t.useMemo(()=>ee||[],[ee]),ke=de.size,We=t.useMemo(()=>!(O&&!ne(J)),[O,J]),Me=!!x,Ae=Me?Xe(x):"",Ye=v?`Modifier : ${v.name}${Me?` (${Ae})`:""}`:O?`Ajouter manuellement${Me?` (${Ae})`:""}`:`Ajouter : ${Y?.name||"Indexeur"}${Me?` (${Ae})`:""}`;return e.jsxs("div",{className:"setup-step setup-jackett",children:[e.jsx("h2",{children:a("Indexeurs","Indexers")}),xe&&e.jsx("div",{className:"onboarding__error",children:xe}),!R&&e.jsxs("div",{className:"setup-jackett__guard",children:[e.jsx("div",{className:"onboarding__error",children:a("Aucun fournisseur configure, reviens a l'etape Fournisseurs.","No configured provider. Go back to Providers step.")}),e.jsx("button",{className:"btn btn-accent",type:"button",onClick:n,disabled:!n,children:a("Retour etape 3","Back to step 3")})]}),R&&e.jsx("div",{className:"setup-jackett__columns",children:L.map(r=>{const m=ue[r.key]||[],u=ae[r.key]||[];return e.jsxs("div",{className:"setup-jackett__column",children:[e.jsx("div",{className:"setup-jackett__provider-title",children:r.label}),e.jsxs("div",{className:"setup-providers__add settings-row settings-row--ui-select",children:[e.jsx("label",{children:a("Ajouter un indexeur","Add an indexer")}),e.jsxs("select",{className:"settings-field",value:K[r.key]||"",onChange:f=>{const d=f.target.value;if(_(G=>({...G,[r.key]:d})),d===la){le(r.key),_(G=>({...G,[r.key]:""}));return}const S=m.find(G=>String(G.id)===String(d));S&&oe(r.key,S),_(G=>({...G,[r.key]:""}))},children:[e.jsx("option",{value:"",disabled:!0,children:a("Selectionner...","Select...")}),m.map(f=>e.jsx("option",{value:f.id,children:f.name},f.id)),e.jsx("option",{value:la,children:a("Ajouter manuellement...","Add manually...")})]}),m.length===0&&i[r.key]?.indexers?.length>0&&e.jsx("div",{className:"muted",children:a("Tous les indexeurs detectes sont deja ajoutes.","All detected indexers are already added.")}),m.length===0&&i[r.key]?.indexers?.length===0&&e.jsx("div",{className:"onboarding__warn",children:C[r.key]||a(`Aucun indexeur detecte automatiquement pour ${r.label}.`,`No indexer auto-detected for ${r.label}.`)}),i[r.key]?.manualOnly&&e.jsx("div",{className:"muted",children:a(`Dans ${r.label}, utilise "Copy Torznab Feed" puis colle l'URL ici. La cle API du fournisseur configuree a l'etape 3 sera utilisee.`,`In ${r.label}, use "Copy Torznab Feed" and paste the URL here. The API key configured at step 3 will be used.`)})]}),e.jsxs("div",{className:"setup-jackett__list",children:[e.jsx("h4",{children:a("Indexeurs ajoutes","Added indexers")}),u.length===0?e.jsx("div",{className:"muted",children:a("Aucun indexeur ajoute.","No indexer added.")}):e.jsx("div",{className:"indexer-list",children:u.map((f,d)=>e.jsx(aa,{id:d+1,title:f.name,meta:f.torznabUrl,enabled:!!f.enabled,actions:[{icon:"edit",title:a("Modifier","Edit"),onClick:()=>_e(f),disabled:he===f.id},{icon:"delete",title:a("Supprimer","Delete"),onClick:()=>Ge(f),disabled:he===f.id,className:"iconbtn--danger"}],showToggle:!1},f.id))})]})]},r.key)})}),e.jsxs(ta,{open:Z,title:Ye,onClose:te,width:840,children:[O&&!v&&e.jsxs("div",{className:"formgrid formgrid--edit",style:{marginBottom:12},children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{children:a("Nom (optionnel)","Name (optional)")}),e.jsx("input",{value:Q,onChange:r=>M(r.target.value),placeholder:`Nom ${Ae||"indexeur"}`,disabled:V||$})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{children:a("Torznab Feed URL","Torznab Feed URL")}),e.jsx("input",{value:J,onChange:r=>{c(r.target.value),p(""),D(""),B(""),X([]),re(new Map)},placeholder:"Colle l'URL Copy Torznab Feed",disabled:V||$}),e.jsx("span",{className:"field-hint",children:a(`Depuis ${Ae||"le fournisseur"}, clique "Copy Torznab Feed", puis colle l'URL complete.`,`From ${Ae||"the provider"}, click "Copy Torznab Feed" and paste the full URL.`)})]}),e.jsx("div",{className:"setup-jackett__actions",style:{gridColumn:"1 / -1"},children:e.jsx("button",{className:"btn",type:"button",onClick:ve,disabled:V||$||!ne(J),children:$?a("Test...","Test..."):a("Tester les categories (caps)","Test categories (caps)")})})]}),U&&e.jsx("div",{className:"onboarding__error",children:U}),P&&e.jsx("div",{className:"onboarding__warn",children:P}),z&&e.jsx("div",{className:"onboarding__ok",children:z}),$&&e.jsx("div",{className:"muted",children:a("Chargement des categories...","Loading categories...")}),Ke.length>0&&e.jsxs("div",{className:"setup-jackett__categories",children:[e.jsx(ja,{variant:"wizard",categories:ee,mappings:de,onChangeMapping:(r,m)=>{const u=ia(m);re(f=>{const d=new Map(f);return u?d.set(r,u):d.delete(r),d})}}),e.jsx("div",{className:"muted",style:{marginTop:8},children:a(`${ke} categorie${ke>1?"s":""} selectionnee${ke>1?"s":""}`,`${ke} selected categor${ke>1?"ies":"y"}`)})]}),e.jsxs("div",{className:"setup-jackett__actions setup-jackett__footer",children:[e.jsxs("div",{className:"setup-jackett__footer-note",role:"note",children:[e.jsx("span",{className:"setup-jackett__footer-note-icon","aria-hidden":"true",children:"i"}),e.jsx("span",{children:'Choisissez de preference les categories specifiques, plus pertinentes. Les categories "parents" incluent souvent des sous-categories qui peuvent provoquer un mauvais tri.'})]}),v?e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx("button",{className:"btn",type:"button",onClick:Ve,disabled:V||me,children:me?a("Reclassement...","Reclassifying..."):a("Reclasser l'existant","Reclassify existing")}),e.jsx("button",{className:"btn btn-accent",type:"button",onClick:Le,disabled:V||!1,children:V?a("Enregistrement...","Saving..."):a("Mettre a jour","Update")})]}):e.jsx("button",{className:"btn btn-accent",type:"button",onClick:Ee,disabled:V||!We,children:V?a("Enregistrement...","Saving..."):O?a("Ajouter manuellement","Add manually"):a("Ajouter l'indexeur","Add indexer")})]})]})]})}const Ta=["sonarr","radarr","overseerr","jellyseerr","seer"];function Oa(){const[l,n]=t.useState([]),[g,i]=t.useState(!1),[k,C]=t.useState(""),[I,T]=t.useState(!1),[b,K]=t.useState("add"),[_,Z]=t.useState(null),[A,Y]=t.useState("sonarr"),[H,x]=t.useState(""),[y,O]=t.useState(""),[j,Q]=t.useState(""),[M,J]=t.useState(!1),[c,v]=t.useState("idle"),[E,$]=t.useState(""),[F,U]=t.useState(""),[p,z]=t.useState(!1),[D,P]=t.useState(""),B=t.useRef(null),[ee,X]=t.useState(!1),[de,re]=t.useState(!1),[V,ce]=t.useState(null),[me,ge]=t.useState(""),[he,ye]=t.useState(""),[xe,o]=t.useState([]),[h,N]=t.useState("standard"),[L,R]=t.useState(!0),[ae,w]=t.useState("all"),[ue,W]=t.useState(!0),[te,oe]=t.useState(!1),[le,fe]=t.useState("released"),[pe,Pe]=t.useState(!0),ve=t.useMemo(()=>{const s=new Set((l||[]).map(q=>String(q?.type||"").toLowerCase()));return Ta.filter(q=>!s.has(q))},[l]),Ee=ve.length===0,_e=t.useCallback(async()=>{i(!0),C("");try{const s=await ie("/api/apps");n(Array.isArray(s)?s:[])}catch(s){C(s?.message||a("Erreur chargement applications","Applications loading error")),n([])}finally{i(!1)}},[]);t.useEffect(()=>{_e()},[_e]),t.useEffect(()=>{I&&(v("idle"),$(""),U(""))},[y,j,A,I]),t.useEffect(()=>{if(!(!I||b!=="add")){if(ve.length===0){Y("");return}ve.includes(A)||Y(ve[0])}},[b,I,A,ve]);function Le(){K("add"),Z(null),Y("sonarr"),x(""),O(""),Q(""),J(!1),v("idle"),$(""),U(""),z(!1),X(!1),ce(null),re(!1),ge(""),ye(""),o([]),N("standard"),R(!0),w("all"),W(!0),oe(!1),fe("released"),Pe(!0)}function Ge(s){s&&(Le(),K("add"),Y(s),T(!0))}function Ve(s){Le(),K("edit"),Z(s),Y(s.type),x(s.name||""),O(s.baseUrl||""),Q(""),ge(s.rootFolderPath||""),ye(s.qualityProfileId?String(s.qualityProfileId):""),o(Array.isArray(s.tags)?s.tags:[]),N(s.seriesType||"standard"),R(s.seasonFolder!==!1),w(s.monitorMode||"all"),W(s.searchMissing!==!1),oe(!!s.searchCutoff),fe(s.minimumAvailability||"released"),Pe(s.searchForMovie!==!1),T(!0),s.hasApiKey&&ke(s.id)}function Ke(){T(!1),Le()}async function ke(s){re(!0);try{const q=await ie(`/api/apps/${s}/config`);ce(q)}catch{ce(null)}finally{re(!1)}}function We(s){B.current&&clearTimeout(B.current),$(s),B.current=setTimeout(()=>{$("")},1200)}async function Me(){const s=b==="edit"&&_?.id&&!j.trim();if(!y.trim()||!j.trim()&&!s)return;J(!0),U(""),v("idle"),$("");const q=Date.now();let se=!1,je="";try{let be;s?be=await Ce(`/api/apps/${_.id}/test`):be=await Ce(`/api/apps/test?type=${A}`,{baseUrl:y.trim(),apiKey:j.trim()}),se=!!be?.ok,se||(je=be?.error||a("Test echoue","Test failed"))}catch(be){je=be?.message||a("Erreur test connexion","Connection test error")}finally{const be=Date.now()-q;be<2e3&&await new Promise(ha=>setTimeout(ha,2e3-be)),J(!1),v(se?"ok":"error"),U(se?"":je||a("Test echoue","Test failed")),We(se?"ok":"error")}}async function Ae(){z(!0),U("");try{if(b==="add"&&!A)throw new Error(a("Toutes les applications sont deja ajoutees.","All applications are already added."));const s={type:A,name:H.trim()||null,baseUrl:y.trim(),rootFolderPath:me||null,qualityProfileId:he?Number(he):null,tags:xe.length>0?xe:null};j.trim()&&(s.apiKey=j.trim()),A==="sonarr"?(s.seriesType=h,s.seasonFolder=L,s.monitorMode=ae,s.searchMissing=ue,s.searchCutoff=te):A==="radarr"&&(s.minimumAvailability=le,s.searchForMovie=pe),b==="add"?await Ce("/api/apps",s):_&&await Je(`/api/apps/${_.id}`,s),Ke(),await _e()}catch(s){U(s?.message||a("Erreur sauvegarde","Save error"))}finally{z(!1)}}async function Ye(s){if(s?.id&&window.confirm(a(`Supprimer ${s.name||s.type} ?`,`Delete ${s.name||s.type}?`)))try{await ma(`/api/apps/${s.id}`),await _e()}catch(q){console.error("[Step4 ArrApps] Impossible de supprimer l'application.",q),C(q?.message||a("Impossible de supprimer l'application.","Failed to delete the application."))}}const r=t.useMemo(()=>Array.isArray(V?.tags)?V.tags:[],[V]),m=Sa(A),u=b!=="add"||!!A,f=b==="edit"&&_?.id&&!j.trim(),d=u&&!!y.trim()&&(j.trim()||f)&&!M&&!p,S=u&&!!y.trim()&&!p&&!M,G=c==="ok"?S:d;return e.jsxs("div",{className:"setup-step setup-arr",children:[e.jsxs("div",{className:"setup-arr__header",children:[e.jsxs("div",{children:[e.jsx("h2",{children:a("Applications (Sonarr / Radarr / Overseerr / Jellyseerr / Seer)","Applications (Sonarr / Radarr / Overseerr / Jellyseerr / Seer)")}),e.jsx("p",{children:a("Optionnel - configure une ou plusieurs apps.","Optional - configure one or more apps.")})]}),e.jsxs("div",{className:"setup-arr__add settings-row settings-row--ui-select",children:[e.jsx("label",{children:a("Ajouter","Add")}),e.jsxs("select",{className:"settings-field",value:D,disabled:Ee,onChange:s=>{const q=s.target.value;P(""),q&&Ge(q)},children:[e.jsx("option",{value:"",disabled:!0,children:Ee?a("Toutes les applications sont deja ajoutees","All applications are already added"):a("Selectionner...","Select...")}),ve.map(s=>e.jsx("option",{value:s,children:Te(s)},s))]})]})]}),k&&e.jsx("div",{className:"onboarding__error",children:k}),e.jsxs("div",{className:"indexer-list",children:[g&&e.jsx("div",{className:"indexer-card",children:e.jsx("div",{className:"indexer-row",children:e.jsx("span",{className:"indexer-url muted",children:a("Chargement...","Loading...")})})}),!g&&l.length===0&&e.jsx("div",{className:"indexer-card",children:e.jsx("div",{className:"indexer-row",children:e.jsx("span",{className:"indexer-url muted",children:a("Aucune application configuree","No configured application")})})}),!g&&l.map((s,q)=>{const se=Te(s.type),je=[{label:se},{label:s.hasApiKey?"API OK":"NO KEY",className:s.hasApiKey?"pill-ok":"pill-warn"}];return e.jsx(aa,{id:q+1,title:s.name||se,meta:s.baseUrl||"",enabled:s.isEnabled,badges:je,actions:[{icon:"edit",title:a("Editer","Edit"),onClick:()=>Ve(s)},{icon:"delete",title:a("Supprimer","Delete"),onClick:()=>Ye(s),className:"iconbtn--danger"}],showToggle:!1},s.id)})]}),e.jsxs(ta,{open:I,title:b==="add"?a("Ajouter une application","Add an application"):`${a("Editer","Edit")}: ${_?.name||_?.type||a("Application","Application")}`,onClose:Ke,width:620,children:[e.jsxs("div",{className:"formgrid",children:[b==="add"&&e.jsxs("div",{className:"field",children:[e.jsx("label",{children:"Type"}),e.jsxs("select",{value:A,onChange:s=>Y(s.target.value),children:[Ee&&e.jsx("option",{value:"",children:"Aucun type disponible"}),ve.map(s=>e.jsx("option",{value:s,children:Te(s)},s))]})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{children:a("Nom","Name")}),e.jsx("input",{value:H,onChange:s=>x(s.target.value),placeholder:`Mon ${Te(A)}`,disabled:p||M})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{children:"Base URL"}),e.jsx("input",{value:y,onChange:s=>O(s.target.value),placeholder:ka(A),disabled:p||M}),e.jsx("span",{className:"field-hint",children:"IP, hostname ou URL reverse proxy (http/https)"})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{children:a("Cle API","API key")}),e.jsx("input",{value:j,onChange:s=>Q(s.target.value),placeholder:b==="edit"?"••••••••••••••••":a("Entrez la cle API","Enter API key"),disabled:p||M})]})]}),e.jsx("div",{className:"setup-arr__modal-actions",children:m&&e.jsx("button",{className:"btn",type:"button",onClick:()=>X(s=>!s),children:ee?a("Masquer options avancees","Hide advanced options"):a("Options avancees","Advanced options")})}),F&&e.jsx("div",{className:"onboarding__error",children:F}),c==="ok"&&e.jsx("div",{className:"onboarding__ok",children:a("Connexion OK","Connection OK")}),ee&&m&&e.jsxs("div",{className:"setup-arr__advanced",children:[b==="edit"&&_?.hasApiKey&&e.jsx("div",{className:"setup-arr__config",children:e.jsx("button",{className:"btn",type:"button",onClick:()=>ke(_.id),disabled:de,children:de?a("Chargement...","Loading..."):a("Charger la config","Load config")})}),e.jsxs("div",{className:"formgrid",children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{children:"Root folder"}),V?.rootFolders?.length>0?e.jsxs("select",{value:me,onChange:s=>ge(s.target.value),children:[e.jsx("option",{value:"",disabled:!0,children:a("Selectionner...","Select...")}),V.rootFolders.map(s=>e.jsx("option",{value:s.path,children:s.path},s.id))]}):e.jsx("input",{value:me,onChange:s=>ge(s.target.value),placeholder:"/data/series"})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{children:"Quality profile"}),V?.qualityProfiles?.length>0?e.jsxs("select",{value:he,onChange:s=>ye(s.target.value),children:[e.jsx("option",{value:"",disabled:!0,children:a("Selectionner...","Select...")}),V.qualityProfiles.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]}):e.jsx("input",{value:he,onChange:s=>ye(s.target.value),placeholder:"1"})]})]}),r.length>0&&e.jsx("div",{className:"setup-arr__tags",children:r.map(s=>{const q=xe.includes(s.id);return e.jsxs("label",{className:"pill",children:[e.jsx("input",{type:"checkbox",checked:q,onChange:se=>{const je=new Set(xe);se.target.checked?je.add(s.id):je.delete(s.id),o(Array.from(je))}}),s.label]},s.id)})}),A==="sonarr"?e.jsxs("div",{className:"formgrid",children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{children:"Series type"}),e.jsxs("select",{value:h,onChange:s=>N(s.target.value),children:[e.jsx("option",{value:"standard",children:"Standard"}),e.jsx("option",{value:"daily",children:"Daily"}),e.jsx("option",{value:"anime",children:"Anime"})]})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{children:"Monitor mode"}),e.jsxs("select",{value:ae,onChange:s=>w(s.target.value),children:[e.jsx("option",{value:"all",children:"All"}),e.jsx("option",{value:"future",children:"Future"}),e.jsx("option",{value:"missing",children:"Missing"}),e.jsx("option",{value:"existing",children:"Existing"}),e.jsx("option",{value:"latest",children:"Latest"}),e.jsx("option",{value:"pilot",children:"Pilot"}),e.jsx("option",{value:"firstSeason",children:"First Season"})]})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{children:"Season folder"}),e.jsxs("select",{value:L?"yes":"no",onChange:s=>R(s.target.value==="yes"),children:[e.jsx("option",{value:"yes",children:a("Oui","Yes")}),e.jsx("option",{value:"no",children:a("Non","No")})]})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{children:"Search missing"}),e.jsxs("select",{value:ue?"yes":"no",onChange:s=>W(s.target.value==="yes"),children:[e.jsx("option",{value:"yes",children:a("Oui","Yes")}),e.jsx("option",{value:"no",children:a("Non","No")})]})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{children:"Search cutoff"}),e.jsxs("select",{value:te?"yes":"no",onChange:s=>oe(s.target.value==="yes"),children:[e.jsx("option",{value:"yes",children:a("Oui","Yes")}),e.jsx("option",{value:"no",children:a("Non","No")})]})]})]}):A==="radarr"?e.jsxs("div",{className:"formgrid",children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{children:"Minimum availability"}),e.jsxs("select",{value:le,onChange:s=>fe(s.target.value),children:[e.jsx("option",{value:"announced",children:"Announced"}),e.jsx("option",{value:"inCinemas",children:"In Cinemas"}),e.jsx("option",{value:"released",children:"Released"})]})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{children:"Search for movie"}),e.jsxs("select",{value:pe?"yes":"no",onChange:s=>Pe(s.target.value==="yes"),children:[e.jsx("option",{value:"yes",children:a("Oui","Yes")}),e.jsx("option",{value:"no",children:a("Non","No")})]})]})]}):null]}),ee&&!m&&e.jsx("div",{className:"setup-arr__advanced",children:e.jsxs("div",{className:"muted",children:[a("Pas d'options avancees pour","No advanced options for")," ",Te(A),"."]})}),e.jsx("div",{className:"setup-arr__footer",children:e.jsx("button",{className:`btn btn-accent btn-test${E==="ok"?" btn-pulse-ok":""}${E==="error"?" btn-pulse-err":""}`,type:"button",onClick:c==="ok"?Ae:Me,disabled:!G,children:M?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"btn-spinner"}),a("Test en cours...","Test in progress...")]}):E==="ok"?a("Valide","Valid"):E==="error"?a("Invalide","Invalid"):c==="ok"?a("Sauvegarder","Save"):a("Tester","Test")})})]})]})}const ca={jackett:"feedarr:jackettConfigured",prowlarr:"feedarr:prowlarrConfigured"};function Be({children:l}){const n=t.useRef(null),g=t.useRef(null),[i,k]=t.useState(!1),[C,I]=t.useState(0);return t.useEffect(()=>{const T=()=>{if(n.current&&g.current){const b=n.current.scrollWidth,K=g.current.clientWidth,_=b>K;k(_),_&&I(-(b-K+10))}};return T(),window.addEventListener("resize",T),()=>window.removeEventListener("resize",T)},[l]),e.jsx("div",{className:"text-scroll-wrapper",ref:g,children:e.jsx("span",{className:`text-scroll-content${i?" is-overflowing":""}`,ref:n,style:i?{"--scroll-distance":`${C}px`}:void 0,children:l})})}function Ea(l){if(!l)return"—";try{const n=new URL(l),g=n.host;return`${n.protocol}//${g}/•••`}catch{return l.length<=8?"•••":`${l.slice(0,8)}•••`}}function ua(l){return l==="prowlarr"?"Prowlarr":"Jackett"}function La(l){if(!l)return"";const n=String(l).trim();return n?`has${n.charAt(0).toUpperCase()}${n.slice(1)}`:""}function Ra(l,n){if(!n)return!1;const g=(n.fieldsSchema||[]).filter(k=>k.required);if(g.length===0)return!0;const i=l?.authFlags||{};return g.every(k=>!!i[La(k.key)])}function $a({onFinish:l,finishing:n}){const[g,i]=t.useState(!0),[k,C]=t.useState([]),[I,T]=t.useState([]),[b,K]=t.useState([]),[_,Z]=t.useState({}),[A,Y]=t.useState([]),[H,x]=t.useState(""),[y,O]=t.useState(""),j=t.useCallback(async()=>{i(!0),x("");try{const[c,v,E,$]=await Promise.all([ie("/api/providers/external"),ie("/api/providers"),ie("/api/sources"),ie("/api/apps")]),F=Array.isArray(c?.definitions)?c.definitions:[],U=new Map(F.map(P=>[String(P?.providerKey||"").toLowerCase(),P])),p=(Array.isArray(c?.instances)?c.instances:[]).map(P=>{const B=String(P?.providerKey||"").toLowerCase(),ee=U.get(B),X=Ra(P,ee);return{key:String(P?.instanceId||B),label:P?.displayName||ee?.displayName||B||a("Provider","Provider"),configured:X,enabled:P?.enabled!==!1}});C(p),T(Array.isArray(v)?v:[]);const z=Array.isArray(E)?E:[];K(z);const D={};await Promise.all(z.map(async P=>{if(P?.id)try{const B=await ie(`/api/categories/${P.id}`);D[P.id]=Array.isArray(B)?B:[]}catch{D[P.id]=[]}})),Z(D),Y(Array.isArray($)?$:[])}catch(c){x(c?.message||a("Erreur chargement resume","Summary loading error"))}finally{i(!1)}},[]);t.useEffect(()=>{j()},[j]);const Q=t.useMemo(()=>{const c=new Map((Array.isArray(I)?I:[]).map(v=>[String(v?.type||"").toLowerCase(),v]));return["jackett","prowlarr"].map(v=>{const E=c.get(v),$=!!E?.hasApiKey,F=!!String(E?.baseUrl||"").trim(),U=!!E?.enabled;return{type:v,configured:$&&F&&U,maskedUrl:Ea(E?.baseUrl||"")}})},[I]),M=t.useMemo(()=>Q.filter(c=>c.configured),[Q]),J=t.useCallback(async()=>{if(n)return;O("");const c=[];if(typeof window<"u"&&(window.localStorage.getItem(ca.jackett)==="true"&&c.push("jackett"),window.localStorage.getItem(ca.prowlarr)==="true"&&c.push("prowlarr")),c.length>0)try{const v=await ie("/api/providers"),E=new Set((Array.isArray(v)?v:[]).map(F=>String(F?.type||"").toLowerCase())),$=c.filter(F=>!E.has(F));if($.length>0){const F=$.map(U=>ua(U)).join(", ");O(a(`Verification echouee: fournisseur manquant en API (${F}).`,`Verification failed: missing provider in API (${F}).`));return}}catch(v){O(v?.message||a("Impossible de verifier les fournisseurs avant lancement.","Unable to verify providers before launch."));return}l?.()},[n,l]);return e.jsxs("div",{className:"setup-step setup-summary",children:[e.jsx("div",{className:`launch-transition-overlay${n?" is-active":""}`}),e.jsx("div",{className:"setup-summary__header",children:e.jsxs("div",{children:[e.jsx("h2",{children:a("Resume","Summary")}),e.jsx("p",{children:a("Verifie la configuration puis lance Feedarr.","Check the configuration then launch Feedarr.")})]})}),H&&e.jsx("div",{className:"onboarding__error",children:H}),y&&e.jsx("div",{className:"onboarding__error",children:y}),g?e.jsx("div",{className:"muted",children:a("Chargement...","Loading...")}):e.jsxs("div",{className:"setup-summary__grid",children:[e.jsxs("div",{className:"setup-summary__card",children:[e.jsx("h3",{children:a("Metadonnees","Metadata")}),e.jsx("ul",{children:k.map(c=>e.jsxs("li",{children:[e.jsx(Be,{children:c.label||c.key||a("Provider","Provider")}),e.jsx("span",{className:`pill ${c.enabled?"pill-ok":"pill-warn"}`,children:c.enabled?a("Actif","Active"):a("Inactif","Inactive")}),e.jsx("span",{className:`pill ${c.configured?"pill-ok":"pill-warn"}`,children:c.configured?a("Auth OK","Auth OK"):a("Auth manquante","Auth missing")})]},c.key))})]}),e.jsxs("div",{className:"setup-summary__card",children:[e.jsx("h3",{children:a("Fournisseurs","Providers")}),M.length===0?e.jsx("div",{className:"muted",children:a("Aucun fournisseur configure","No configured provider")}):e.jsx("ul",{children:M.map(c=>e.jsxs("li",{children:[e.jsx(Be,{children:ua(c.type)}),e.jsx("span",{className:"pill pill-ok",children:a("Configure","Configured")})]},c.type))})]}),e.jsxs("div",{className:"setup-summary__card",children:[e.jsx("h3",{children:a("Sources","Sources")}),b.length===0?e.jsx("div",{className:"muted",children:a("Aucune source ajoutee","No source added")}):e.jsx("ul",{children:b.map(c=>{const v=_[c.id]||[];return e.jsxs("li",{children:[e.jsx(Be,{children:c.name}),e.jsxs("span",{className:"pill pill-blue",children:[v.length," ",a("categorie","category"),v.length>1?"s":""]})]},c.id)})})]}),e.jsxs("div",{className:"setup-summary__card",children:[e.jsx("h3",{children:a("Applications","Applications")}),A.length===0?e.jsx("div",{className:"muted",children:a("Aucune application","No application")}):e.jsx("ul",{children:A.map(c=>e.jsxs("li",{children:[e.jsx(Be,{children:c.name||Te(c.type)}),e.jsx("span",{className:"pill pill-ok",children:a("Configure","Configured")})]},c.id))})]})]}),e.jsx("div",{className:"setup-summary__cta",children:e.jsxs("button",{className:`btn-launch${n?" is-launching":""}`,type:"button",onClick:J,disabled:n,children:[n?a("Lancement...","Launching..."):a("Lancer Feedarr","Launch Feedarr"),e.jsx(Aa,{className:"launch-icon"})]})})]})}const Fe="feedarr:setupStep",De="feedarr:onboardingDone",pa="feedarr:setupHasJackettSource",Ze=["feedarr:jackettBaseUrl","feedarr:jackettApiKey","feedarr:jackettProvider","feedarr:jackettIndexersCache","feedarr:jackettConfigured","feedarr:jackettManualOnly","feedarr:prowlarrBaseUrl","feedarr:prowlarrApiKey","feedarr:prowlarrIndexersCache","feedarr:prowlarrConfigured","feedarr:prowlarrManualOnly"],Se=1,fa=7;function ga(l){return Number.isFinite(l)?Math.min(fa,Math.max(Se,Math.floor(l))):Se}function Fa(){if(typeof window>"u")return Se;const l=window.localStorage.getItem(Fe),n=Number(l);return ga(n||Se)}function Qa(){const l=Na(),[n,g]=t.useState(Fa),[i,k]=t.useState(n),[C,I]=t.useState(!1),[T,b]=t.useState({ready:!1,saving:!1,error:""}),[K,_]=t.useState({}),[Z,A]=t.useState(!1),[Y,H]=t.useState({provider:"",ready:!1,baseUrl:"",manualOnly:!1}),[x,y]=t.useState(!1),[O,j]=t.useState(0);t.useEffect(()=>{k(p=>Math.max(p,n)),typeof window<"u"&&window.localStorage.setItem(Fe,String(n))},[n]),t.useEffect(()=>{let p=!0;return ie("/api/system/onboarding").then(z=>{if(!p||typeof window>"u")return;const D=window.localStorage.getItem(De)==="true";if(z?.onboardingDone){window.localStorage.setItem(De,"true"),l("/library",{replace:!0});return}D&&(window.localStorage.setItem(De,"false"),window.localStorage.removeItem(Fe),Ze.forEach(P=>window.localStorage.removeItem(P)),g(Se),k(Se))}).catch(z=>{console.error("Failed to load onboarding status in setup wizard",z)}),()=>{p=!1}},[l]),t.useEffect(()=>{let p=!0;return ie("/api/setup/state").then(z=>{if(!p||typeof window>"u")return;const D=window.localStorage.getItem(pa),P=Ze.some(X=>{const de=window.localStorage.getItem(X);return de!==null&&de!==""}),ee=!(!!z?.hasJackettSource||!!z?.hasProwlarrSource)&&(D==="true"||P);window.localStorage.setItem(pa,z?.hasJackettSource?"true":"false"),ee&&(Ze.forEach(X=>window.localStorage.removeItem(X)),window.localStorage.removeItem(Fe),H({provider:"",ready:!1,baseUrl:"",manualOnly:!1}),y(!1),g(Se),k(Se),j(Date.now()))}).catch(z=>{console.error("Failed to load setup state in setup wizard",z)}),()=>{p=!1}},[]);const Q=t.useCallback(async()=>{if(!C){I(!0);try{await Ce("/api/system/onboarding/complete"),typeof window<"u"&&(window.localStorage.removeItem(Fe),window.localStorage.setItem(De,"true")),l("/library",{replace:!0})}catch(p){console.error("Failed to complete onboarding from setup wizard",p),I(!1)}}},[C,l]),M=[{id:1,title:a("Langue","Language"),content:e.jsx(Ca,{onStatusChange:b})},{id:2,title:a("Intro","Intro"),content:e.jsx(Ia,{})},{id:3,title:a("Metadonnees","Metadata"),content:e.jsx(_a,{validation:K,onValidationChange:_,onAllProvidersAddedChange:A})},{id:4,title:a("Fournisseurs RSS","RSS providers"),content:e.jsx(Ma,{onStatusChange:H,resetToken:O,initialStatus:Y})},{id:5,title:a("Indexeurs","Indexers"),content:e.jsx(Ua,{onHasSourcesChange:y,onBack:()=>g(4),jackettConfig:Y})},{id:6,title:a("Applications","Applications"),content:e.jsx(Oa,{})},{id:7,title:a("Resume","Summary"),content:e.jsx($a,{onFinish:Q,finishing:C})}],J=t.useMemo(()=>Object.values(K||{}).some(p=>p==="ok"),[K]),c=M[n-1],v=n===3||n===6,E=!!Y?.ready,$=n===3?J:!0,F=v&&!(n===3&&Z);function U(p){g(ga(p))}return e.jsxs("div",{className:"setup-container",children:[e.jsx("div",{className:"setup-stepper",children:M.map(p=>{const z=p.id===n,D=p.id<=i,P=p.id<=i;return e.jsxs("button",{type:"button",className:`setup-stepper-item${z?" is-active":""}${D?" is-done":""}`,onClick:()=>P&&U(p.id),disabled:!P,"aria-current":z?"step":void 0,children:[e.jsx("span",{className:"setup-stepper-num",children:p.id}),e.jsx("span",{className:"setup-stepper-label",children:p.title})]},p.id)})}),e.jsxs("div",{className:"setup-card setupWizardFrame",children:[e.jsx("div",{className:"setupWizardBody",children:e.jsx("div",{className:"setup-card__content",children:c?.content})}),e.jsx("div",{className:"setupWizardFooter",children:e.jsxs("div",{className:"setup-actions",children:[n>Se&&e.jsx("button",{className:"btn",type:"button",onClick:()=>U(n-1),children:a("Precedent","Previous")}),e.jsxs("div",{className:"setup-actions-right",style:{marginLeft:"auto"},children:[F&&e.jsx("button",{className:"btn",type:"button",onClick:()=>U(n+1),disabled:!$,children:a("Passer","Skip")}),n<fa&&e.jsx("button",{className:"btn btn-accent",type:"button",onClick:()=>U(n+1),disabled:n===1&&(!T.ready||T.saving)||n===3&&!J||n===4&&!E||n===5&&!x,children:a("Suivant","Next")})]})]})})]})]})}export{Qa as default};
