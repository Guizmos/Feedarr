import{n as x,C as P,a as K}from"./categoryGroups.constants-TqNJ0nIh.js";import{r as p,j as e,a as Z}from"./vendor-react-B6j9w5IJ.js";import{t as m}from"./uiText-D9t7ygxs.js";import{a as D,A as ee}from"./index-Dw1RV2ov.js";import{M as ne}from"./Modal-CnEzehYC.js";import{L as te}from"./Loader-WjrgZmWo.js";import{c as se,d as ae}from"./formatters-Bh97CVLp.js";function B(r){const i=Number(r);return Number.isFinite(i)&&i>0?i:null}function R(r){const i=r instanceof Map?r:new Map,s=new Map;for(const[n,t]of i.entries()){const o=B(n);if(!o)continue;const u=x(t);u&&s.set(o,u)}return s}function be(r){const i=new Map;for(const s of Array.isArray(r)?r:[]){const n=B(s?.id);if(!n)continue;const t=[s?.assignedGroupKey,s?.groupKey,s?.unifiedKey];for(const u of t)u==null||String(u).trim();const o=x(s?.assignedGroupKey)||x(s?.groupKey)||x(s?.unifiedKey)||x(s?.assignedGroupLabel)||x(s?.groupLabel)||x(s?.unifiedLabel);o&&s?.isAssigned!==!1&&i.set(n,o)}return i}function ve(r){const i=R(r),s=[];for(const[n,t]of i.entries()){const o=P[t]||t;s.push({categoryId:n,unifiedKey:t,unifiedLabel:o,catId:n,groupKey:t,groupLabel:o})}return s}function xe(r,i){const s=R(r),n=R(i),t=new Set([...s.keys(),...n.keys()]),o=[];for(const u of t){const b=s.get(u)||null,l=n.get(u)||null;b!==l&&o.push({categoryId:u,unifiedKey:l,unifiedLabel:l?P[l]||l:null,catId:u,groupKey:l,groupLabel:l?P[l]||l:null})}return o}function _e({selectedCategoryIds:r,...i}={}){const s=Array.isArray(r)?r.map(t=>Number(t)).filter(t=>Number.isInteger(t)&&t>0):[],n=Array.from(new Set(s)).sort((t,o)=>t-o);return{...i,selectedCategoryIds:n}}function we(r){if(!Array.isArray(r))return[];const i=new Map,s=n=>{let t=0;return x(n?.unifiedKey||n?.groupKey||n?.assignedGroupKey)&&(t+=4),(n?.unifiedLabel||n?.groupLabel||n?.assignedGroupLabel)&&(t+=2),n?.parentId&&(t+=1),n?.isSub&&(t+=1),t};for(const n of r){const t=B(n?.id);if(!t)continue;const o={...n,id:t},u=i.get(t);(!u||s(o)>s(u))&&i.set(t,o)}return Array.from(i.values())}function je(r){const i=new Set,s=[];for(const n of Array.isArray(r)?r:[]){const t=x(n?.unifiedKey||n?.key),o=String(n?.unifiedLabel||n?.label||n?.name||"").trim().toLowerCase(),u=t||o;!u||i.has(u)||(i.add(u),s.push(n))}return s}function ie({sourceId:r,catId:i,catName:s,onClose:n}){const[t,o]=p.useState(!0),[u,b]=p.useState(null),[l,d]=p.useState([]),[N,j]=p.useState(!1),w=p.useCallback(c=>{if(!r||!i)return;o(!0),b(null),d([]),j(!1);const h=`/api/sources/${r}/category-preview?catId=${i}&limit=20`,g=`/api/sources/${r}/category-preview-live?catId=${i}&limit=20`;D(h,{signal:c}).then(_=>{const k=Array.isArray(_)?_:[];if(k.length>0){d(k),j(!1),o(!1);return}return D(g,{signal:c}).then(M=>{const y=Array.isArray(M)?M:[];d(y),j(y.length>0),o(!1)})}).catch(_=>{_?.name!=="AbortError"&&(b(_?.message||m("Erreur inconnue","Unknown error")),o(!1))})},[r,i]);p.useEffect(()=>{const c=new AbortController;return w(c.signal),()=>c.abort()},[w]);const C=p.useMemo(()=>{const c={};for(const h of l){const g=h.categoryId;g&&(c[g]={count:(c[g]?.count||0)+1,name:c[g]?.name||h.resultCategoryName||null})}return Object.entries(c).sort((h,g)=>g[1].count-h[1].count)},[l]),A=e.jsxs("span",{children:[m(`Aperçu : ${s} (id ${i})`,`Preview: ${s} (id ${i})`),N&&e.jsx("span",{className:"preview-live-badge",children:m("LIVE","LIVE")})]});return e.jsxs(ne,{open:!0,title:A,onClose:n,width:1280,modalClassName:"category-preview-modal",children:[e.jsxs("div",{className:"category-preview-modal__body",children:[t&&e.jsx("div",{className:"category-preview-modal__loader",children:e.jsx(te,{})}),!t&&u&&e.jsxs("div",{className:"category-preview-modal__error",children:[e.jsx("span",{children:u}),e.jsx("button",{type:"button",className:"btn btn--sm",onClick:()=>{const c=new AbortController;w(c.signal)},children:m("Réessayer","Retry")})]}),!t&&!u&&l.length===0&&e.jsx("div",{className:"category-preview-modal__empty",children:m("Aucun résultat pour cette catégorie (DB et indexeur).","No results for this category (DB and indexer).")}),!t&&!u&&C.length>0&&e.jsx("div",{className:"preview-cat-summary",children:C.map(([c,{count:h,name:g}])=>e.jsxs("span",{className:"preview-cat-summary__chip",children:[c,g?` • ${g}`:"",e.jsxs("span",{className:"preview-cat-summary__count",children:["×",h]})]},c))}),!t&&!u&&l.length>0&&e.jsxs("table",{className:"preview-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:m("Publié","Published")}),e.jsx("th",{children:m("Tracker","Tracker")}),e.jsx("th",{children:m("Nom","Name")}),e.jsx("th",{children:m("Taille","Size")}),e.jsx("th",{children:m("Catégorie","Category")})]})}),e.jsx("tbody",{children:l.map((c,h)=>e.jsxs("tr",{children:[e.jsx("td",{className:"preview-table__col-date",children:se(c.publishedAtTs)}),e.jsx("td",{className:"preview-table__col-tracker",children:c.sourceName||"—"}),e.jsx("td",{className:"preview-table__col-name",title:c.title,children:c.title}),e.jsx("td",{className:"preview-table__col-size",children:ae(c.sizeBytes)||"—"}),e.jsx("td",{className:"preview-table__col-cat",children:e.jsx("span",{className:"preview-table__cat-label",children:c.categoryId?`${c.categoryId}${c.resultCategoryName?` • ${c.resultCategoryName}`:""}`:c.unifiedCategory||"—"})})]},h))})]})]}),e.jsx("div",{className:"category-preview-modal__footer",children:e.jsx("button",{type:"button",className:"btn",onClick:n,children:m("Fermer","Close")})})]})}const re={films:"Movies",series:"TV Series",animation:"Animation",anime:"Anime",games:"Video Games",comics:"Comics",books:"Books",audio:"Audio",spectacle:"Live Shows",emissions:"Shows"};function oe(r){const i=new Map;for(const s of Array.isArray(r)?r:[]){const n=Number(s?.id);!Number.isFinite(n)||n<=0||i.has(n)||s?.isSupported!==!1&&i.set(n,{id:n,name:String(s?.name||`Cat ${n}`),isStandard:s?.isStandard===!0||n>=1e3&&n<=8999,isSupported:s?.isSupported!==!1})}return[...i.values()].sort((s,n)=>s.id-n.id)}function ce(r,i,s,n){const t=x(n.get(r.id));return s==="assigned"&&!t||s==="unassigned"&&t?!1:i?`${r.id} ${r.name}`.toLowerCase().includes(i.toLowerCase()):!0}function Ne({categories:r,mappings:i,onChangeMapping:s,variant:n="default",sourceId:t}){const[o,u]=p.useState(""),[b,l]=p.useState("all"),[d,N]=p.useState(null),[j,w]=p.useState(null),[C,A]=p.useState(null),c=p.useRef(null),h=p.useRef(new Map),g=i instanceof Map?i:new Map,_=p.useMemo(()=>oe(r),[r]),k=Object.fromEntries(K.map(a=>[a.key,m(a.label,re[a.key]||a.label)])),M=[...K].map(a=>({...a,label:k[a.key]||a.label})).sort((a,f)=>a.label.localeCompare(f.label,"en",{sensitivity:"base"})),y=p.useCallback(()=>{N(null),w(null)},[]),z=p.useCallback((a,f)=>{f?h.current.set(a,f):h.current.delete(a)},[]),S=p.useCallback(a=>{const f=h.current.get(a);if(!f)return null;const v=f.getBoundingClientRect(),I=180,Q=K.length*34+44,$=8,O=6;let L=v.right-I;L=Math.max($,L),L=Math.min(L,window.innerWidth-I-$);const J=v.top-$,T=window.innerHeight-v.bottom-$,U=T<Q&&J>T,X=U?"top":"bottom";return{top:U?v.top-O:v.bottom+O,left:L,placement:X}},[]),G=p.useCallback(a=>{if(d===a){y();return}const f=S(a);if(!f){y();return}N(a),w(f)},[y,d,S]);p.useEffect(()=>{const a=f=>{c.current&&(f.target?.closest?.("[data-mapping-menu-root='true']")||c.current.contains(f.target)||y())};return document.addEventListener("mousedown",a),()=>document.removeEventListener("mousedown",a)},[y]),p.useEffect(()=>{if(!d)return;const a=()=>{const v=S(d);if(!v){y();return}w(v)},f=v=>{v.key==="Escape"&&y()};return window.addEventListener("resize",a),window.addEventListener("scroll",a,!0),window.addEventListener("keydown",f),()=>{window.removeEventListener("resize",a),window.removeEventListener("scroll",a,!0),window.removeEventListener("keydown",f)}},[y,d,S]);const V=p.useMemo(()=>{const a=Object.fromEntries(K.map(f=>[f.key,0]));for(const f of _){const v=x(g.get(f.id));v&&(a[v]+=1)}return a},[g,_]),E=p.useMemo(()=>_.filter(a=>ce(a,o,b,g)),[_,o,b,g]);p.useEffect(()=>{d&&(E.some(a=>a.id===d)||y())},[y,E,d]);const Y=E.filter(a=>a.isStandard),q=E.filter(a=>!a.isStandard),H=`category-mapping-board${n==="wizard"?" category-mapping-board--wizard":""}`,W=d?x(g.get(d)):null;return e.jsxs("div",{className:H,ref:c,children:[e.jsxs("div",{className:"category-mapping-board__top",children:[e.jsx("input",{className:"category-mapping-board__search",value:o,onChange:a=>u(a.target.value),placeholder:m("Rechercher par id ou nom...","Search by id or name...")}),e.jsxs("div",{className:"category-mapping-board__filters",children:[e.jsx("button",{type:"button",className:`type-chip${b==="all"?" type-chip--active":""}`,onClick:()=>l("all"),children:m("Tout","All")}),e.jsx("button",{type:"button",className:`type-chip${b==="assigned"?" type-chip--active":""}`,onClick:()=>l("assigned"),children:m("Assignées","Assigned")}),e.jsx("button",{type:"button",className:`type-chip${b==="unassigned"?" type-chip--active":""}`,onClick:()=>l("unassigned"),children:m("Non assignées","Unassigned")})]})]}),e.jsx("div",{className:"category-mapping-board__groups",children:M.map(a=>e.jsxs("div",{className:`category-group-card cat-bubble--${a.key}`,children:[e.jsx("div",{className:"category-group-card__label",children:a.label}),e.jsx("div",{className:"category-group-card__count",children:V[a.key]||0})]},a.key))}),e.jsxs("div",{className:"category-mapping-board__columns",children:[e.jsx(F,{title:m("Standard","Standard"),categories:Y,mappings:g,groupLabels:k,openMenuId:d,onToggleMenu:G,registerAssignButton:z,sourceId:t,onPreview:t?A:null}),e.jsx(F,{title:m("Spécifiques","Specific"),categories:q,mappings:g,groupLabels:k,openMenuId:d,onToggleMenu:G,registerAssignButton:z,sourceId:t,onPreview:t?A:null})]}),d&&j&&e.jsx(le,{groups:M,position:j,assignedKey:W,onAssign:a=>{s?.(d,a),y()},onClear:()=>{s?.(d,null),y()}}),C&&t&&e.jsx(ie,{sourceId:t,catId:C.id,catName:C.name,onClose:()=>A(null)})]})}function F({title:r,categories:i,mappings:s,groupLabels:n,openMenuId:t,onToggleMenu:o,registerAssignButton:u,onPreview:b}){return e.jsxs("div",{className:"category-mapping-board__column",children:[e.jsx("div",{className:"category-mapping-board__column-title",children:r}),e.jsxs("div",{className:"category-mapping-board__chips",children:[i.length===0&&e.jsx("div",{className:"muted",children:m("Aucune catégorie.","No category.")}),i.map(l=>{const d=x(s.get(l.id)),N=d?n[d]:"—",j=t===l.id;return e.jsxs("div",{className:`mapping-chip${d?` mapping-chip--assigned mapping-chip--${d}`:""}`,children:[e.jsxs("div",{className:"mapping-chip__line",children:[e.jsx("span",{className:"mapping-chip__id",children:l.id}),e.jsx("span",{className:"mapping-chip__name",children:l.name}),b&&e.jsx("button",{type:"button",className:"iconbtn mapping-chip__preview",title:m("Aperçu des 20 derniers résultats","Preview last 20 results"),onClick:()=>b({id:l.id,name:l.name}),children:e.jsx(ee,{name:"search"})})]}),e.jsx("div",{className:"mapping-chip__line",children:e.jsx("button",{type:"button",className:"mapping-chip__assign",ref:w=>u(l.id,w),onClick:()=>o(l.id),"aria-haspopup":"menu","aria-expanded":j?"true":"false",children:N})})]},l.id)})]})]})}function le({groups:r,position:i,assignedKey:s,onAssign:n,onClear:t}){return typeof document>"u"?null:Z.createPortal(e.jsxs("div",{className:`mapping-chip__menu mapping-chip__menu--portal${i.placement==="top"?" mapping-chip__menu--top":""}`,"data-mapping-menu-root":"true",style:{top:`${i.top}px`,left:`${i.left}px`},role:"menu",children:[r.map(o=>e.jsx("button",{type:"button",className:`mapping-chip__menu-item${s===o.key?" is-active":""}`,onClick:()=>n(o.key),children:o.label},o.key)),e.jsx("button",{type:"button",className:"mapping-chip__menu-item",onClick:t,children:m("Retirer","Remove")})]}),document.body)}export{Ne as C,we as a,xe as b,_e as c,je as d,ve as e,be as m};
