import{n as v,C as T,a as R}from"./categoryGroups.constants-TqNJ0nIh.js";import{r as p,j as e,a as ne}from"./vendor-react-B6j9w5IJ.js";import{t as f}from"./uiText-BZ3z2hUD.js";import{a as te,c as se,A as re}from"./index-w1EqWPJX.js";import{M as ae}from"./Modal-D9seooTq.js";import{L as ie}from"./Loader-WjrgZmWo.js";import{c as oe,d as ce}from"./formatters-D7ST7XGG.js";function F(i){const r=Number(i);return Number.isFinite(r)&&r>0?r:null}function B(i){const r=i instanceof Map?i:new Map,t=new Map;for(const[n,a]of r.entries()){const c=F(n);if(!c)continue;const u=v(a);u&&t.set(c,u)}return t}function we(i){const r=new Map;for(const t of Array.isArray(i)?i:[]){const n=F(t?.id);if(!n)continue;const a=[t?.assignedGroupKey,t?.groupKey,t?.unifiedKey];for(const u of a)u==null||String(u).trim();const c=v(t?.assignedGroupKey)||v(t?.groupKey)||v(t?.unifiedKey)||v(t?.assignedGroupLabel)||v(t?.groupLabel)||v(t?.unifiedLabel);c&&t?.isAssigned!==!1&&r.set(n,c)}return r}function je(i){const r=B(i),t=[];for(const[n,a]of r.entries()){const c=T[a]||a;t.push({categoryId:n,unifiedKey:a,unifiedLabel:c,catId:n,groupKey:a,groupLabel:c})}return t}function Ne(i,r){const t=B(i),n=B(r),a=new Set([...t.keys(),...n.keys()]),c=[];for(const u of a){const h=t.get(u)||null,d=n.get(u)||null;h!==d&&c.push({categoryId:u,unifiedKey:d,unifiedLabel:d?T[d]||d:null,catId:u,groupKey:d,groupLabel:d?T[d]||d:null})}return c}function Ce({selectedCategoryIds:i,...r}={}){const t=Array.isArray(i)?i.map(a=>Number(a)).filter(a=>Number.isInteger(a)&&a>0):[],n=Array.from(new Set(t)).sort((a,c)=>a-c);return{...r,selectedCategoryIds:n}}function Ae(i){if(!Array.isArray(i))return[];const r=new Map,t=n=>{let a=0;return v(n?.unifiedKey||n?.groupKey||n?.assignedGroupKey)&&(a+=4),(n?.unifiedLabel||n?.groupLabel||n?.assignedGroupLabel)&&(a+=2),n?.parentId&&(a+=1),n?.isSub&&(a+=1),a};for(const n of i){const a=F(n?.id);if(!a)continue;const c={...n,id:a},u=r.get(a);(!u||t(c)>t(u))&&r.set(a,c)}return Array.from(r.values())}function Me(i){const r=new Set,t=[];for(const n of Array.isArray(i)?i:[]){const a=v(n?.unifiedKey||n?.key),c=String(n?.unifiedLabel||n?.label||n?.name||"").trim().toLowerCase(),u=a||c;!u||r.has(u)||(r.add(u),t.push(n))}return t}function le({sourceId:i,previewCredentials:r,catId:t,catName:n,categoryNameMap:a=null,onClose:c}){const[u,h]=p.useState(!0),[d,b]=p.useState(null),[_,g]=p.useState([]),[k,L]=p.useState(!1),w=Number(t),M=p.useCallback(o=>{if(t)if(h(!0),b(null),g([]),L(!1),i){const l=`/api/sources/${i}/category-preview-live?catId=${t}&limit=20`;te(l,{signal:o}).then(m=>{const N=Array.isArray(m)?m:[];g(N),L(!0),h(!1)}).catch(m=>{m?.name!=="AbortError"&&(b(m?.message||f("Erreur inconnue","Unknown error")),h(!1))})}else if(r?.torznabUrl){const l={providerId:r.providerId??null,torznabUrl:r.torznabUrl,indexerId:r.indexerId??null,authMode:r.authMode??"query",apiKey:r.apiKey??"",sourceName:r.sourceName??"",catId:t,limit:20};se("/api/sources/category-preview-live-temp",l,{signal:o}).then(m=>{const N=Array.isArray(m)?m:[];g(N),L(N.length>0),h(!1)}).catch(m=>{m?.name!=="AbortError"&&(b(m?.message||f("Erreur inconnue","Unknown error")),h(!1))})}else h(!1)},[i,r,t]);p.useEffect(()=>{const o=new AbortController;return M(o.signal),()=>o.abort()},[M]);const C=p.useMemo(()=>{const o={};for(const l of _){const m=l.categoryId;m&&(o[m]={count:(o[m]?.count||0)+1,name:o[m]?.name||l.resultCategoryName||null})}return Object.entries(o).sort((l,m)=>m[1].count-l[1].count)},[_]),S=p.useMemo(()=>C.map(([o])=>Number(o)).filter(o=>Number.isFinite(o)&&o>0),[C]),E=Number.isFinite(w)&&S.includes(w),j=S.length>0&&!E,A=f("Aucun résultat retourné par l'indexeur pour cette catégorie.","No results returned by the indexer for this category.");function $(o){if(o?.resultCategoryName)return o.resultCategoryName;const l=Number(o?.categoryId);return!Number.isFinite(l)||!a?null:a[l]||null}const z=e.jsxs("span",{children:[f(`Aperçu : ${n} (id ${t})`,`Preview: ${n} (id ${t})`),k&&e.jsx("span",{className:"preview-live-badge",children:f("LIVE","LIVE")})]});return e.jsxs(ae,{open:!0,title:z,onClose:c,width:"75vw",modalClassName:"category-preview-modal",children:[e.jsxs("div",{className:"category-preview-modal__body",children:[u&&e.jsx("div",{className:"category-preview-modal__loader",children:e.jsx(ie,{})}),!u&&d&&e.jsxs("div",{className:"category-preview-modal__error",children:[e.jsx("span",{children:d}),e.jsx("button",{type:"button",className:"btn btn--sm",onClick:()=>{const o=new AbortController;M(o.signal)},children:f("Réessayer","Retry")})]}),!u&&!d&&_.length===0&&e.jsx("div",{className:"category-preview-modal__empty",children:A}),!u&&!d&&(C.length>0||Number.isFinite(w))&&e.jsxs("div",{className:"preview-cat-summary",children:[Number.isFinite(w)&&e.jsxs("span",{className:"preview-cat-summary__chip preview-cat-summary__chip--requested",children:[f("Demandée","Requested"),": ",w,n?` • ${n}`:""]}),C.map(([o,{count:l,name:m}])=>e.jsxs("span",{className:`preview-cat-summary__chip${j?" preview-cat-summary__chip--returned":""}`,children:[o,m?` • ${m}`:"",e.jsxs("span",{className:"preview-cat-summary__count",children:["×",l]})]},o))]}),!u&&!d&&_.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"category-preview-modal__note",children:j?f(`La requête a bien été lancée sur ${w}${n?` • ${n}`:""}, mais l'indexeur classe les items retournés dans d'autres catégories. La colonne "Catégorie item" affiche toujours la valeur brute remontée par l'indexeur.`,`The request was sent for ${w}${n?` • ${n}`:""}, but the indexer classifies returned items in different categories. The "Item category" column always shows the raw value returned by the indexer.`):f("Catégorie item: valeur brute remontée par l'indexeur pour chaque release. Aucune catégorie Feedarr n'est réappliquée ici.","Item category: raw value returned by the indexer for each release. No Feedarr mapping is reapplied here.")}),e.jsxs("table",{className:"preview-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:f("Publié","Published")}),e.jsx("th",{children:f("Tracker","Tracker")}),e.jsx("th",{children:f("Nom","Name")}),e.jsx("th",{children:f("Taille","Size")}),e.jsx("th",{children:f("Catégorie item","Item category")})]})}),e.jsx("tbody",{children:_.map((o,l)=>{const m=$(o);return e.jsxs("tr",{children:[e.jsx("td",{className:"preview-table__col-date",children:oe(o.publishedAtTs)}),e.jsx("td",{className:"preview-table__col-tracker",children:o.sourceName||"—"}),e.jsx("td",{className:"preview-table__col-name",title:o.title,children:o.title}),e.jsx("td",{className:"preview-table__col-size",children:ce(o.sizeBytes)||"—"}),e.jsx("td",{className:"preview-table__col-cat",children:e.jsx("span",{className:"preview-table__cat-label",children:o.categoryId?`${o.categoryId}${m?` • ${m}`:""}`:o.unifiedCategory||"—"})})]},l)})})]})]})]}),e.jsx("div",{className:"category-preview-modal__footer",children:e.jsx("button",{type:"button",className:"btn",onClick:c,children:f("Fermer","Close")})})]})}const ue={films:"Movies",series:"TV Series",animation:"Animation",anime:"Anime",games:"Video Games",comics:"Comics",books:"Books",audio:"Audio",spectacle:"Live Shows",emissions:"Shows"};function de(i){const r=new Map;for(const t of Array.isArray(i)?i:[]){const n=Number(t?.id);!Number.isFinite(n)||n<=0||r.has(n)||t?.isSupported!==!1&&r.set(n,{id:n,name:String(t?.name||`Cat ${n}`),isStandard:t?.isStandard===!0||n>=1e3&&n<=8999,isSupported:t?.isSupported!==!1})}return[...r.values()].sort((t,n)=>t.id-n.id)}function me(i,r,t,n){const a=v(n.get(i.id));return t==="assigned"&&!a||t==="unassigned"&&a?!1:r?`${i.id} ${i.name}`.toLowerCase().includes(r.toLowerCase()):!0}function ke({categories:i,mappings:r,onChangeMapping:t,variant:n="default",sourceId:a,previewCredentials:c,infoNote:u=null}){const[h,d]=p.useState(""),[b,_]=p.useState("all"),[g,k]=p.useState(null),[L,w]=p.useState(null),[M,C]=p.useState(null),S=p.useRef(null),E=p.useRef(new Map),j=p.useMemo(()=>r instanceof Map?r:new Map,[r]),A=p.useMemo(()=>de(i),[i]),$=Object.fromEntries(R.map(s=>[s.key,f(s.label,ue[s.key]||s.label)])),z=p.useMemo(()=>Object.fromEntries(A.map(s=>[s.id,s.name])),[A]),o=[...R].map(s=>({...s,label:$[s.key]||s.label})).sort((s,y)=>s.label.localeCompare(y.label,"en",{sensitivity:"base"})),l=p.useCallback(()=>{k(null),w(null)},[]),m=p.useCallback((s,y)=>{y?E.current.set(s,y):E.current.delete(s)},[]),N=p.useCallback(s=>{const y=E.current.get(s);if(!y)return null;const x=y.getBoundingClientRect(),O=180,X=R.length*34+44,P=8,q=6;let I=x.right-O;I=Math.max(P,I),I=Math.min(I,window.innerWidth-O-P);const Z=x.top-P,U=window.innerHeight-x.bottom-P,D=U<X&&Z>U,ee=D?"top":"bottom";return{top:D?x.top-q:x.bottom+q,left:I,placement:ee}},[]),G=p.useCallback(s=>{if(g===s){l();return}const y=N(s);if(!y){l();return}k(s),w(y)},[l,g,N]);p.useEffect(()=>{const s=y=>{S.current&&(y.target?.closest?.("[data-mapping-menu-root='true']")||S.current.contains(y.target)||l())};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[l]),p.useEffect(()=>{if(!g)return;const s=()=>{const x=N(g);if(!x){l();return}w(x)},y=x=>{x.key==="Escape"&&l()};return window.addEventListener("resize",s),window.addEventListener("scroll",s,!0),window.addEventListener("keydown",y),()=>{window.removeEventListener("resize",s),window.removeEventListener("scroll",s,!0),window.removeEventListener("keydown",y)}},[l,g,N]);const Y=p.useMemo(()=>{const s=Object.fromEntries(R.map(y=>[y.key,0]));for(const y of A){const x=v(j.get(y.id));x&&(s[x]+=1)}return s},[j,A]),K=p.useMemo(()=>A.filter(s=>me(s,h,b,j)),[A,h,b,j]);p.useEffect(()=>{g&&(K.some(s=>s.id===g)||l())},[l,K,g]);const H=K.filter(s=>s.isStandard),W=K.filter(s=>!s.isStandard),Q=`category-mapping-board${n==="wizard"?" category-mapping-board--wizard":""}`,J=g?v(j.get(g)):null;return e.jsxs("div",{className:Q,ref:S,children:[e.jsxs("div",{className:"category-mapping-board__top",children:[e.jsx("input",{className:"category-mapping-board__search",value:h,onChange:s=>d(s.target.value),placeholder:f("Rechercher par id ou nom...","Search by id or name...")}),e.jsxs("div",{className:"category-mapping-board__filters",children:[e.jsx("button",{type:"button",className:`type-chip${b==="all"?" type-chip--active":""}`,onClick:()=>_("all"),children:f("Tout","All")}),e.jsx("button",{type:"button",className:`type-chip${b==="assigned"?" type-chip--active":""}`,onClick:()=>_("assigned"),children:f("Assignées","Assigned")}),e.jsx("button",{type:"button",className:`type-chip${b==="unassigned"?" type-chip--active":""}`,onClick:()=>_("unassigned"),children:f("Non assignées","Unassigned")})]})]}),e.jsx("div",{className:"category-mapping-board__groups",children:o.map(s=>e.jsxs("div",{className:`category-group-card cat-bubble--${s.key}`,children:[e.jsx("div",{className:"category-group-card__label",children:s.label}),e.jsx("div",{className:"category-group-card__count",children:Y[s.key]||0})]},s.key))}),u,e.jsxs("div",{className:"category-mapping-board__columns",children:[e.jsx(V,{title:f("Standard","Standard"),categories:H,mappings:j,groupLabels:$,openMenuId:g,onToggleMenu:G,registerAssignButton:m,onPreview:a||c?C:null}),e.jsx(V,{title:f("Spécifiques","Specific"),categories:W,mappings:j,groupLabels:$,openMenuId:g,onToggleMenu:G,registerAssignButton:m,onPreview:a||c?C:null})]}),g&&L&&e.jsx(pe,{groups:o,position:L,assignedKey:J,onAssign:s=>{t?.(g,s),l()},onClear:()=>{t?.(g,null),l()}}),M&&(a||c)&&e.jsx(le,{sourceId:a??null,previewCredentials:a?null:c,catId:M.id,catName:M.name,categoryNameMap:z,onClose:()=>C(null)})]})}function V({title:i,categories:r,mappings:t,groupLabels:n,openMenuId:a,onToggleMenu:c,registerAssignButton:u,onPreview:h}){return e.jsxs("div",{className:"category-mapping-board__column",children:[e.jsx("div",{className:"category-mapping-board__column-title",children:i}),e.jsxs("div",{className:"category-mapping-board__chips",children:[r.length===0&&e.jsx("div",{className:"muted",children:f("Aucune catégorie.","No category.")}),r.map(d=>{const b=v(t.get(d.id)),_=b?n[b]:"—",g=a===d.id;return e.jsx("div",{className:`mapping-chip${b?` mapping-chip--assigned mapping-chip--${b}`:""}`,children:e.jsxs("div",{className:"mapping-chip__header",children:[e.jsxs("div",{className:"mapping-chip__identity",children:[e.jsx("span",{className:"mapping-chip__id",children:d.id}),e.jsx("span",{className:"mapping-chip__name",children:d.name})]}),e.jsxs("div",{className:"mapping-chip__actions",children:[e.jsx("button",{type:"button",className:"mapping-chip__assign",ref:k=>u(d.id,k),onClick:()=>c(d.id),"aria-haspopup":"menu","aria-expanded":g?"true":"false",children:_}),h&&e.jsx("button",{type:"button",className:"iconbtn mapping-chip__preview",title:f("Aperçu des 20 derniers résultats","Preview last 20 results"),"aria-label":f("Aperçu des 20 derniers résultats","Preview last 20 results"),onClick:()=>h({id:d.id,name:d.name}),children:e.jsx(re,{name:"search"})})]})]})},d.id)})]})]})}function pe({groups:i,position:r,assignedKey:t,onAssign:n,onClear:a}){return typeof document>"u"?null:ne.createPortal(e.jsxs("div",{className:`mapping-chip__menu mapping-chip__menu--portal${r.placement==="top"?" mapping-chip__menu--top":""}`,"data-mapping-menu-root":"true",style:{top:`${r.top}px`,left:`${r.left}px`},role:"menu",children:[i.map(c=>e.jsx("button",{type:"button",className:`mapping-chip__menu-item${t===c.key?" is-active":""}`,onClick:()=>n(c.key),children:c.label},c.key)),e.jsx("button",{type:"button",className:"mapping-chip__menu-item",onClick:a,children:f("Retirer","Remove")})]}),document.body)}export{ke as C,Ae as a,Ne as b,Ce as c,Me as d,je as e,we as m};
