import{r as f,j as e}from"./vendor-react-B6j9w5IJ.js";import{u as w,a as P,c as ee,A as R,g as Z}from"./index-BxnTI6ZJ.js";import{S as z}from"./SubAction-DoLvrlQN.js";import{L as se}from"./Loader-WjrgZmWo.js";import{M as te}from"./Modal-DE4x6WoZ.js";import{g as U,b as ie}from"./sourceColors-KACkINRj.js";import{t as a}from"./uiText-CQKjwCG_.js";import{n as ne,C as re}from"./categoryGroups.constants-TqNJ0nIh.js";import{R as J}from"./categoryPriority.constants-BnKBS6eK.js";import"./vendor-router-DbNMZja2.js";import"./vendor-icons-BuPyRjLk.js";const _=15;function ae(t){return t?new Date(t*1e3).toLocaleString(Z()):"-"}function oe(t){return String(t||"").toUpperCase().replace(/[^A-Z0-9]/g,"")}function le(t){const r=oe(t);return r==="YGEGE"?"banner-pill--indexer-ygege":r==="C411"?"banner-pill--indexer-c411":r==="TOS"?"banner-pill--indexer-tos":r==="LACALE"?"banner-pill--indexer-lacale":""}function ce(t){if(!t)return null;if(typeof t=="object")return t;if(typeof t!="string")return null;try{return JSON.parse(t)}catch{return null}}const ue=/fetched=(\d+)/i,de=/\((\d+)\s*items/i,me=/(\d+)\s*ms/i;function fe(t,r){const l=r?.itemsCount??r?.items;if(l!=null){const u=Number(l);if(Number.isFinite(u))return u}const p=String(t?.message??""),o=p.match(ue);if(o)return Number(o[1]);const c=p.match(de);return c?Number(c[1]):null}function pe(t,r){const l=r?.elapsedMs??r?.responseMs??r?.elapsed;if(l!=null){const c=Number(l);if(Number.isFinite(c))return c}const o=String(t?.message??"").match(me);return o?Number(o[1]):null}function Y(t){const l=String(t?.message??"").toLowerCase().split("cats=");if(l.length<2)return[];const p=l[1].split("missing=")[0];return p?p.split(",").map(o=>o.trim().split("=")[0]).map(o=>Number(o)).filter(o=>Number.isFinite(o)):[]}function he(t){if(!t)return null;const r=ne(t.unifiedKey||t.key)||null;return r?{key:r,label:re[r]||t.unifiedLabel||t.name||r}:t.unifiedLabel?{key:null,label:t.unifiedLabel}:t.name?{key:null,label:t.name}:null}function ge(t,r){if(!r||t.length===0)return[];const l=new Map;return t.forEach(o=>{const c=he(r[o]);if(!c||!c.label)return;const u=c.key||c.label;l.has(u)||l.set(u,c)}),Array.from(l.values()).sort((o,c)=>{const u=J.indexOf(o.key),b=J.indexOf(c.key);return u!==-1||b!==-1?(u===-1?999:u)-(b===-1?999:b):String(o.label).localeCompare(String(c.label),Z(),{sensitivity:"base"})})}function Ae(){const t=w(),[r,l]=f.useState([]),[p,o]=f.useState(1),[c,u]=f.useState(!1),[b,F]=f.useState(!1),[S,q]=f.useState(!0),[E,I]=f.useState(""),y=f.useCallback(async()=>{q(!0),I("");try{const[n,N]=await Promise.allSettled([P("/api/activity?limit=500&eventType=sync"),P("/api/sources")]),M=n.status==="fulfilled"&&Array.isArray(n.value)?n.value:[],v=N.status==="fulfilled"&&Array.isArray(N.value)?N.value:[];n.status!=="fulfilled"&&I("Historique indisponible");const D={},G={};v.forEach(i=>{const s=i?.id??i?.sourceId;s&&(D[s]=i?.name||`Fournisseur ${s}`,G[s]=U(s,i?.color))});const K={},k=new Set;if(M.forEach(i=>{const s=i?.sourceId??i?.source_id;s&&Y(i).length>0&&k.add(s)}),k.size>0){const i=Array.from(k),s=await Promise.allSettled(i.map(d=>P(`/api/categories/${d}`)));i.forEach((d,g)=>{const m=s[g];if(m.status!=="fulfilled"||!Array.isArray(m.value))return;const j={};m.value.forEach(x=>{x?.id&&(j[x.id]={name:x?.name||String(x.id),unifiedKey:x?.unifiedKey||null,unifiedLabel:x?.unifiedLabel||null})}),K[d]=j})}const L=new Map,B=[];M.forEach(i=>{const s=i?.sourceId??i?.source_id,d=Number(i?.createdAt??i?.created_at_ts??0);if(!s||!Number.isFinite(d)||d<=0)return;const g=`${s}-${d}`;let m=L.get(g);m||(m={sourceId:s,createdAt:d,itemsCount:null,responseMs:null,catIds:new Set},L.set(g,m),B.push(g));const j=ce(i?.dataJson??i?.data_json),x=fe(i,j),H=pe(i,j),W=Y(i);Number.isFinite(x)&&(m.itemsCount=x),Number.isFinite(H)&&m.responseMs==null&&(m.responseMs=H),W.forEach(X=>m.catIds.add(X))});const V=B.map(i=>{const s=L.get(i),d=K[s.sourceId],g=Array.from(s.catIds||[]),m=s.itemsCount>0?ge(g,d):[];return{id:i,sourceId:s.sourceId,createdAt:s.createdAt,indexer:D[s.sourceId]||`Fournisseur ${s.sourceId}`,indexerColor:G[s.sourceId]||U(s.sourceId,null),itemsCount:s.itemsCount,categories:m,date:ae(s.createdAt),responseMs:s.responseMs}}),A=[];V.forEach(i=>{const s=A[A.length-1];if(s&&s.sourceId===i.sourceId&&Math.abs(s.createdAt-i.createdAt)<=10){const d=Number(s.itemsCount),g=Number(i.itemsCount);(!Number.isFinite(d)||d<=0)&&(s.itemsCount=Number.isFinite(g)?g:s.itemsCount),(!s.categories||s.categories.length===0)&&i.categories.length>0&&(s.categories=i.categories),s.responseMs==null&&i.responseMs!=null&&(s.responseMs=i.responseMs);return}A.push(i)}),l(A)}catch(n){I(n?.message||"Erreur chargement historique"),l([])}finally{q(!1)}},[]),$=r.length,C=Math.max(1,Math.ceil($/_)),h=Math.min(p,C),T=f.useMemo(()=>{const n=(h-1)*_;return r.slice(n,n+_)},[r,h]),O=f.useCallback(()=>{o(1),y()},[y]),Q=f.useCallback(async()=>{F(!0);try{await ee("/api/activity/purge?scope=history",{}),u(!1),o(1),await y()}catch(n){I(n?.message||"Erreur purge historique")}finally{F(!1)}},[y]);return f.useEffect(()=>{y()},[y]),f.useEffect(()=>(t(e.jsxs(e.Fragment,{children:[e.jsx(z,{icon:"refresh",label:a("Rafraîchir","Refresh"),onClick:O}),e.jsx(z,{icon:"delete",label:a("Effacer","Clear"),onClick:()=>u(!0),disabled:b||r.length===0})]})),()=>t(null)),[t,O,b,r.length]),f.useEffect(()=>{p!==h&&o(h)},[p,h]),e.jsxs("div",{className:"page",children:[e.jsx("div",{className:"pagehead",children:e.jsxs("div",{children:[e.jsx("h1",{children:a("Historique","History")}),e.jsx("div",{className:"muted",children:a("Requêtes et synchronisations","Requests and synchronizations")})]})}),S&&e.jsx(se,{label:a("Chargement de l'historique...","Loading history...")}),!S&&E&&e.jsxs("div",{className:"errorbox",children:[e.jsx("div",{className:"errorbox__title",children:"Erreur"}),e.jsx("div",{className:"muted",children:E})]}),!S&&!E&&e.jsxs("div",{className:"history-table table",children:[e.jsxs("div",{className:"thead",children:[e.jsx("div",{className:"th",children:a("Fournisseurs","Providers")}),e.jsx("div",{className:"th",children:a("Éléments","Items")}),e.jsx("div",{className:"th",children:a("Catégories sync","Sync categories")}),e.jsx("div",{className:"th",children:a("Date","Date")}),e.jsx("div",{className:"th th-right",children:a("Temps de réponse","Response time")})]}),T.length===0?e.jsx("div",{className:"trow",children:e.jsx("div",{className:"td history-empty",children:a("Aucune entrée d'historique","No history entries")})}):T.map(n=>{const N=le(n.indexer),M=ie(n.indexerColor);return e.jsxs("div",{className:"trow",children:[e.jsx("div",{className:"td",children:e.jsx("span",{className:`banner-pill banner-pill--indexer${N?` ${N}`:""}`,style:M||void 0,children:n.indexer})}),e.jsx("div",{className:"td td-query",title:n.itemsCount!=null?`${n.itemsCount}`:"-",children:n.itemsCount!=null?n.itemsCount:"-"}),e.jsx("div",{className:"td td-categories",children:n.categories.length>0?n.categories.map(v=>e.jsx("span",{className:`cat-bubble cat-bubble--${v.key||"unknown"}`,children:v.label},`${n.id}-${v.key||v.label}`)):e.jsx("span",{className:"muted",children:"-"})}),e.jsx("div",{className:"td td-date",children:n.date}),e.jsx("div",{className:"td td-right td-response",children:Number.isFinite(n.responseMs)?`${n.responseMs}ms`:"-"})]},n.id)})]}),!S&&!E&&e.jsxs("div",{className:"history-footer",children:[e.jsxs("div",{className:"history-meta muted",children:[a("Total entrées","Total records"),": ",$]}),e.jsxs("div",{className:"history-pager",children:[e.jsx("button",{className:"iconbtn",type:"button",onClick:()=>o(1),disabled:h<=1,title:a("Première page","First page"),"aria-label":a("Première page","First page"),children:e.jsx(R,{name:"first_page"})}),e.jsx("button",{className:"iconbtn",type:"button",onClick:()=>o(n=>Math.max(1,n-1)),disabled:h<=1,title:a("Page précédente","Previous page"),"aria-label":a("Page précédente","Previous page"),children:e.jsx(R,{name:"chevron_left"})}),e.jsxs("div",{className:"history-pagecount",children:[h," / ",C]}),e.jsx("button",{className:"iconbtn",type:"button",onClick:()=>o(n=>Math.min(C,n+1)),disabled:h>=C,title:a("Page suivante","Next page"),"aria-label":a("Page suivante","Next page"),children:e.jsx(R,{name:"chevron_right"})}),e.jsx("button",{className:"iconbtn",type:"button",onClick:()=>o(C),disabled:h>=C,title:a("Dernière page","Last page"),"aria-label":a("Dernière page","Last page"),children:e.jsx(R,{name:"last_page"})})]})]}),e.jsx(te,{open:c,title:a("Effacer l'historique","Clear history"),onClose:()=>u(!1),width:520,children:e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[e.jsx("div",{className:"muted",children:a("Confirmer la suppression de l'historique.","Confirm history deletion.")}),e.jsx("div",{className:"muted",children:a("Cette action est définitive.","This action is permanent.")}),e.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end"},children:[e.jsx("button",{className:"btn",type:"button",onClick:()=>u(!1),disabled:b,children:a("Annuler","Cancel")}),e.jsx("button",{className:"btn btn-accent",type:"button",onClick:Q,disabled:b,children:b?a("Suppression...","Deleting..."):a("Confirmer","Confirm")})]})]})})]})}export{Ae as default};
