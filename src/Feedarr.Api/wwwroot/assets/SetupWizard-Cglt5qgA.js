import{r as a,j as e}from"./vendor-react-B6j9w5IJ.js";import{D as Ee,a as ce,n as qe,j as rs,b as ze,L as xs,c as Ae,f as ts,h as fs}from"./index-w1EqWPJX.js";import{t as s}from"./uiText-BZ3z2hUD.js";import{b as Re,I as vs,a as ws,E as js}from"./InlineNotice-DHWQwron.js";import{I as ss}from"./ItemRow-Dnar6FKB.js";import{M as as}from"./Modal-D9seooTq.js";import{C as bs,m as ns,e as Ss,c as is}from"./CategoryMappingBoard-Bg5E-jwv.js";import{n as os,C as ks}from"./categoryGroups.constants-TqNJ0nIh.js";import{i as Ns,g as _e,a as Cs}from"./appTypes-BSxyKsC5.js";import{W as As}from"./vendor-icons-BuPyRjLk.js";import{b as Is}from"./vendor-router-DbNMZja2.js";import"./Loader-WjrgZmWo.js";import"./formatters-D7ST7XGG.js";function Ps({onStatusChange:o}){const[i,g]=a.useState(!0),[u,E]=a.useState(!1),[S,C]=a.useState(""),[I,A]=a.useState(Ee),[k,R]=a.useState(null),X=a.useRef(0),P=a.useCallback(async()=>{g(!0),C("");try{const y=await ce("/api/settings/ui"),O=Re(y||{}),b=qe(O.uiLanguage||Ee);R(O),A(b),rs(b,!0)}catch(y){R(Re({uiLanguage:Ee,mediaInfoLanguage:Ee})),A(Ee),C(y?.message||s("Erreur chargement langue","Language loading error"))}finally{g(!1)}},[]);a.useEffect(()=>{P()},[P]);const V=a.useCallback(async y=>{const O=k||Re({}),b=qe(y||Ee),ee=X.current+1;X.current=ee,E(!0),C("");try{const T=Re(O,{uiLanguage:b,mediaInfoLanguage:b}),Y=await ze("/api/settings/ui",T);if(ee!==X.current)return;const p=Re(Y||T),w=qe(p.uiLanguage||b);R(p),A(w),rs(w,!0)}catch(T){if(ee!==X.current)return;C(T?.message||s("Erreur sauvegarde langue","Language save error"))}finally{ee===X.current&&E(!1)}},[k]);function Z(y){const O=qe(y.target.value);A(O),V(O)}const t=a.useMemo(()=>({ready:!i&&!u&&!!I&&!S,saving:u,error:S}),[S,i,u,I]);return a.useEffect(()=>{o?.(t)},[o,t]),e.jsxs("div",{className:"setup-step setup-language",children:[e.jsx("h2",{children:s("Langue","Language")}),e.jsx("p",{children:s("Choisis la langue par defaut de Feedarr.","Choose Feedarr default language.")}),e.jsxs("div",{className:"setup-providers__add settings-row settings-row--ui-select",children:[e.jsx("label",{children:s("Langue par defaut","Default language")}),e.jsx("select",{className:"settings-field",value:I,onChange:Z,disabled:i||u,children:xs.map(y=>e.jsx("option",{value:y.value,children:y.label},y.value))})]}),e.jsx("div",{className:"muted",children:s("Cette etape applique la langue UI et la langue metadata par defaut.","This step sets both UI and metadata default language.")}),i&&e.jsx("div",{className:"muted",children:s("Chargement...","Loading...")}),u&&e.jsx("div",{className:"muted",children:s("Enregistrement...","Saving...")}),S&&e.jsx("div",{className:"onboarding__error",style:{marginTop:12},children:S}),S&&e.jsx("div",{className:"setup-jackett__actions",style:{marginTop:12},children:e.jsx("button",{className:"btn",type:"button",onClick:()=>P(),disabled:i||u,children:s("Reessayer","Retry")})})]})}function Ms(){return e.jsxs("div",{className:"setup-step",children:[e.jsx("h2",{children:s("Bienvenue","Welcome")}),e.jsx("p",{children:s("Configuration rapide en 7 etapes.","Quick setup in 7 steps.")}),e.jsx("p",{className:"muted",children:s("Resume : langue -> metadata -> fournisseurs RSS -> indexeurs -> applications.","Summary: language -> metadata -> RSS providers -> indexers -> applications.")})]})}function Us({required:o=!1,onStatusChange:i,saveRef:g}){const[u,E]=a.useState(!0),[S,C]=a.useState(!1),[I,A]=a.useState(!1),[k,R]=a.useState(!1),[X,P]=a.useState(""),V=a.useRef(null),Z=a.useRef(null),[t,y]=a.useState({authMode:"smart",publicBaseUrl:"",username:"",password:"",passwordConfirmation:"",hasPassword:!1,authConfigured:!1,authRequired:o}),[O,b]=a.useState(()=>new Set),ee=a.useRef({username:"",password:"",confirm:""}),T=a.useRef(null);a.useEffect(()=>()=>{T.current&&clearTimeout(T.current)},[]);const Y=a.useCallback(async()=>{E(!0),P("");try{const c=await ce("/api/settings/security");y(N=>({...N,authMode:c?.authMode||"smart",publicBaseUrl:c?.publicBaseUrl||"",username:c?.username||"",password:"",passwordConfirmation:"",hasPassword:!!c?.hasPassword,authConfigured:!!c?.authConfigured,authRequired:!!c?.authRequired}))}catch(c){P(c?.message||s("Erreur chargement securite","Security loading error"))}finally{E(!1)}},[]);a.useEffect(()=>{Y()},[Y]);const p=t.authMode!=="open",w=!String(t.username||"").trim(),$=t.hasPassword||!!String(t.password||"").trim(),K=!!t.password||!!t.passwordConfirmation,F=K&&(!String(t.password||"").trim()||!String(t.passwordConfirmation||"").trim()||t.password!==t.passwordConfirmation),q=a.useMemo(()=>k&&p&&w?"error":w?"":"valid",[k,p,w]),M=a.useMemo(()=>k&&p&&!$||F?"error":t.hasPassword&&!K||!F&&t.password?"valid":"",[k,p,$,t.hasPassword,t.password,K,F]),te=a.useMemo(()=>F?"error":t.passwordConfirmation&&t.password===t.passwordConfirmation?"valid":"",[F,t.passwordConfirmation,t.password]);a.useEffect(()=>{const c={username:q,password:M,confirm:te},N=[];for(const B of Object.keys(c)){const _=ee.current[B],H=c[B];H&&H!==_&&N.push(B)}ee.current=c,N.length>0&&(T.current&&clearTimeout(T.current),b(new Set(N)),T.current=setTimeout(()=>{b(new Set)},850))},[q,M,te]);const W=(c,N)=>{const B=N==="error"||N==="valid"?N:"";let _="fieldWrap";return B==="error"&&(_+=" fieldWrap--error"),B==="valid"&&(_+=" fieldWrap--valid"),O.has(c)&&(_+=" fieldWrap--pulse"),_},h=a.useCallback(async()=>{R(!0);const c=t.authMode!=="open",N=!String(t.username||"").trim(),B=!(t.hasPassword||String(t.password||"").trim()),_=(!!t.password||!!t.passwordConfirmation)&&(!String(t.password||"").trim()||!String(t.passwordConfirmation||"").trim()||t.password!==t.passwordConfirmation);if(c&&N){V.current?.focus();return}if(c&&B){Z.current?.focus();return}if(_){Z.current?.focus();return}C(!0),P("");try{const H={authMode:t.authMode,publicBaseUrl:t.publicBaseUrl,username:t.username};(t.password||t.passwordConfirmation)&&(H.password=t.password,H.passwordConfirmation=t.passwordConfirmation);const Q=await ze("/api/settings/security",H);y(ie=>({...ie,authMode:Q?.authMode||ie.authMode,publicBaseUrl:Q?.publicBaseUrl||ie.publicBaseUrl,username:Q?.username||ie.username,password:"",passwordConfirmation:"",hasPassword:!!Q?.hasPassword,authConfigured:!!Q?.authConfigured,authRequired:!!Q?.authRequired})),A(!0)}catch(H){P(H?.message||s("Erreur sauvegarde securite","Security save error"))}finally{C(!1)}},[t]);a.useEffect(()=>{g&&(g.current=h)},[h,g]);const j=a.useMemo(()=>({ready:!S,saving:S,saved:I,error:X,authRequired:!!t.authRequired||!!o,authConfigured:!!t.authConfigured,authMode:t.authMode}),[t.authConfigured,t.authMode,t.authRequired,o,S,I,X]);a.useEffect(()=>{i?.(j)},[i,j]);const se=a.useMemo(()=>{const c=[],N=t.authMode!=="open",B=!String(t.username||"").trim(),_=!(t.hasPassword||String(t.password||"").trim()),H=(!!t.password||!!t.passwordConfirmation)&&(!String(t.password||"").trim()||!String(t.passwordConfirmation||"").trim()||t.password!==t.passwordConfirmation),Q=k&&N&&(B||_)||H;return k&&N&&B&&_?c.push({key:"creds",variant:"error",message:s("Username et password sont requis.","Username and password are required.")}):k&&N&&B?c.push({key:"username",variant:"error",message:s("Username requis.","Username is required.")}):k&&N&&_?c.push({key:"password",variant:"error",message:s("Password requis.","Password is required.")}):H&&c.push({key:"confirm",variant:"error",message:s("Les mots de passe ne correspondent pas ou sont incomplets.","Passwords don't match or are incomplete.")}),X&&c.push({key:"api",variant:"error",message:X}),!k&&!I&&t.authMode!=="open"&&t.hasPassword&&c.push({key:"hint",variant:"info",message:s("Identifiants déjà configurés. Laisse vide pour conserver le mot de passe actuel.","Credentials already configured. Leave blank to keep current password.")}),I&&!X&&!Q&&c.push({key:"ok",variant:"success",message:s("Paramètres de sécurité sauvegardés.","Security settings saved.")}),c},[k,t.authMode,t.username,t.hasPassword,t.password,t.passwordConfirmation,X,I]);return e.jsxs("div",{className:"setup-step setup-security",children:[e.jsx("h2",{children:s("Securite","Security")}),e.jsx("p",{children:s("Configure le mode d'acces de Feedarr.","Configure Feedarr access mode.")}),u&&e.jsx("div",{className:"muted",children:s("Chargement...","Loading...")}),!u&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"indexer-list",children:[e.jsxs("div",{className:"indexer-card",children:[e.jsxs("div",{className:"indexer-row indexer-row--settings",children:[e.jsx("span",{className:"indexer-title",children:"Auth Mode"}),e.jsx("div",{className:"indexer-actions",children:e.jsx("div",{className:"fieldWrap",children:e.jsxs("select",{value:t.authMode,onChange:c=>y(N=>({...N,authMode:c.target.value})),disabled:S,children:[e.jsx("option",{value:"smart",children:"Smart (default)"}),e.jsx("option",{value:"strict",children:"Strict"}),e.jsx("option",{value:"open",children:"Open"})]})})})]}),e.jsx("div",{className:"settings-help",children:s("Smart protege automatiquement si instance exposee.","Smart mode protects automatically if the instance is exposed.")})]}),e.jsx("div",{className:"indexer-card",children:e.jsxs("div",{className:"indexer-row indexer-row--settings",children:[e.jsx("span",{className:"indexer-title",children:"Public Base URL"}),e.jsx("div",{className:"indexer-actions",children:e.jsx("div",{className:"fieldWrap",children:e.jsx("input",{type:"text",value:t.publicBaseUrl,onChange:c=>y(N=>({...N,publicBaseUrl:c.target.value})),placeholder:"https://example.com/feedarr",disabled:S})})})]})}),t.authMode!=="open"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"indexer-card",children:e.jsxs("div",{className:"indexer-row indexer-row--settings",children:[e.jsx("span",{className:"indexer-title",children:"Username"}),e.jsx("div",{className:"indexer-actions",children:e.jsx("div",{className:W("username",q),children:e.jsx("input",{ref:V,type:"text",value:t.username,onChange:c=>y(N=>({...N,username:c.target.value})),placeholder:s("Entrez username","Enter username"),disabled:S})})})]})}),e.jsx("div",{className:"indexer-card",children:e.jsxs("div",{className:"indexer-row indexer-row--settings",children:[e.jsx("span",{className:"indexer-title",children:"Password"}),e.jsx("div",{className:"indexer-actions",children:e.jsx("div",{className:W("password",M),children:e.jsx("input",{ref:Z,type:"password",value:t.password,onChange:c=>y(N=>({...N,password:c.target.value})),placeholder:t.hasPassword?s("Laisser vide pour conserver","Leave blank to keep current"):s("Entrez password","Enter password"),disabled:S})})})]})}),e.jsx("div",{className:"indexer-card",children:e.jsxs("div",{className:"indexer-row indexer-row--settings",children:[e.jsx("span",{className:"indexer-title",children:"Password Confirmation"}),e.jsx("div",{className:"indexer-actions",children:e.jsx("div",{className:W("confirm",te),children:e.jsx("input",{type:"password",value:t.passwordConfirmation,onChange:c=>y(N=>({...N,passwordConfirmation:c.target.value})),placeholder:s("Confirmez password","Confirm password"),disabled:S})})})]})})]})]}),se.length>0&&e.jsx("div",{className:"security-notices",children:se.map(c=>e.jsx(vs,{variant:c.variant,message:c.message},c.key))})]})]})}const Es={};function _s({validation:o,onValidationChange:i,onAllProvidersAddedChange:g}){const u=ws(),{loadExternalProviders:E,loadProviderStats:S,externalValidationByProvider:C,allProvidersAdded:I}=u;a.useEffect(()=>{E(),S()},[E,S]),a.useEffect(()=>{i&&i(k=>({...k||Es,...C}))},[C,i]),a.useEffect(()=>{g?.(I)},[I,g]);const A=Object.values(o||C||{}).some(k=>k==="ok");return e.jsxs("div",{className:"setup-step setup-providers",children:[e.jsx("h2",{children:s("Metadonnees","Metadata")}),e.jsx("p",{children:s("Ajoute au moins un provider metadata configure et actif.","Add at least one configured and enabled metadata provider.")}),!A&&e.jsx("div",{className:"onboarding__error",children:s("Configure au moins un provider metadata pour continuer.","Configure at least one metadata provider to continue.")}),e.jsx(js,{controller:u,showInlineAdd:!0})]})}const $e="feedarr:jackettProvider",Te=[{key:"jackett",label:"Jackett",placeholder:"http://192.168.1.x:9117 ou https://domaine.tld/jackett",endpoint:"/api/jackett/indexers"},{key:"prowlarr",label:"Prowlarr",placeholder:"http://192.168.1.x:9696 ou https://domaine.tld/prowlarr",endpoint:"/api/prowlarr/indexers"}],Ce={jackett:{baseUrl:"feedarr:jackettBaseUrl",apiKey:"feedarr:jackettApiKey",indexers:"feedarr:jackettIndexersCache",configured:"feedarr:jackettConfigured",manualOnly:"feedarr:jackettManualOnly"},prowlarr:{baseUrl:"feedarr:prowlarrBaseUrl",apiKey:"feedarr:prowlarrApiKey",indexers:"feedarr:prowlarrIndexersCache",configured:"feedarr:prowlarrConfigured",manualOnly:"feedarr:prowlarrManualOnly"}},Se={baseUrl:"",indexers:[],configured:!1,manualOnly:!1};function He(o){return String(o||"").trim().replace(/\/+$/,"")}function Qe(o){return Te.find(i=>i.key===o)||Te[0]}function ls(o){const i=Ce[o];if(!i||typeof window>"u")return{...Se};const g=window.localStorage.getItem(i.baseUrl)||"",u=window.localStorage.getItem(i.configured)==="true",E=window.localStorage.getItem(i.indexers)||"",S=E?JSON.parse(E)||[]:[],C=window.localStorage.getItem(i.manualOnly)==="true";return{baseUrl:g,configured:u&&!!g,indexers:Array.isArray(S)?S:[],manualOnly:C}}function Ts({onStatusChange:o,resetToken:i,initialStatus:g}){const[u,E]=a.useState(""),[S,C]=a.useState(""),[I,A]=a.useState(""),[k,R]=a.useState(""),[X,P]=a.useState(!1),[V,Z]=a.useState(!1),[t,y]=a.useState("idle"),[O,b]=a.useState(""),[ee,T]=a.useState(0),[Y,p]=a.useState(""),[w,$]=a.useState(!1),[K,F]=a.useState([]),[q,M]=a.useState({jackett:{...Se},prowlarr:{...Se}}),[te,W]=a.useState(!1),h=a.useRef(!1),j=a.useRef(null);a.useEffect(()=>{if(typeof window>"u")return;Object.values(Ce).forEach(L=>{window.localStorage.removeItem(L.apiKey)});const l=window.localStorage.getItem($e)||"";if(l==="prowlarr"){const L=Ce.jackett,me=Ce.prowlarr,ae=window.localStorage.getItem(me.configured)==="true",le=window.localStorage.getItem(L.baseUrl)||"",ue=window.localStorage.getItem(L.configured)==="true",pe=window.localStorage.getItem(L.indexers)||"";!ae&&(ue||le)&&(window.localStorage.setItem(me.baseUrl,le),pe&&window.localStorage.setItem(me.indexers,pe),window.localStorage.setItem(me.configured,ue?"true":"false"),window.localStorage.removeItem(L.baseUrl),window.localStorage.removeItem(L.apiKey),window.localStorage.removeItem(L.indexers),window.localStorage.removeItem(L.configured))}const v={jackett:ls("jackett"),prowlarr:ls("prowlarr")};M(v);const z=l==="prowlarr"?"prowlarr":"jackett",J=v[z],G=Te.find(L=>v[L.key]?.configured),oe=J?.configured?z:G?.key||"";if(oe){const L=v[oe]||{...Se};h.current=!0,E(oe),C(""),A(L.baseUrl),R(""),F(Array.isArray(L.indexers)?L.indexers:[]),T(Array.isArray(L.indexers)?L.indexers.length:0),y(L.manualOnly?"manual":"ok"),b(L.manualOnly?s("Configuration enregistree. Ajoute les indexeurs manuellement a l'etape suivante.","Configuration saved. Add indexers manually at the next step."):s("Cles deja enregistrees.","Keys already saved.")),$(!0),o?.({provider:oe,ready:!0,baseUrl:L.baseUrl,indexers:Array.isArray(L.indexers)?L.indexers:[],manualOnly:!!L.manualOnly})}W(!0)},[o]),a.useEffect(()=>{if(!g?.ready)return;const l=String(g.baseUrl||"");if(!l)return;const v=g.provider||"jackett";h.current=!0,E(v),C(""),A(l),R(""),F(Array.isArray(g.indexers)?g.indexers:[]),y(g?.manualOnly?"manual":"ok"),b(g?.manualOnly?s("Configuration enregistree. Ajoute les indexeurs manuellement a l'etape suivante.","Configuration saved. Add indexers manually at the next step."):s("Cles deja enregistrees.","Keys already saved.")),T(Array.isArray(g.indexers)?g.indexers.length:0),$(!0),M(z=>({...z,[v]:{baseUrl:l,indexers:Array.isArray(g.indexers)?g.indexers:[],configured:!0,manualOnly:!!g?.manualOnly}}))},[g]),a.useEffect(()=>{i&&(typeof window<"u"&&(Object.values(Ce).forEach(l=>{window.localStorage.removeItem(l.baseUrl),window.localStorage.removeItem(l.apiKey),window.localStorage.removeItem(l.indexers),window.localStorage.removeItem(l.configured),window.localStorage.removeItem(l.manualOnly)}),window.localStorage.removeItem($e)),M({jackett:{...Se},prowlarr:{...Se}}),E(""),C(""),A(""),R(""),$(!1),y("idle"),b(""),T(0),p(""),F([]),o?.({provider:"",ready:!1,baseUrl:"",indexers:[],manualOnly:!1}),Z(!1))},[i,o]),a.useEffect(()=>{if(te){if(h.current){h.current=!1;return}y("idle"),b(""),T(0),p(""),$(!1)}},[I,k,u,te]);const se=a.useMemo(()=>(u==="jackett"||u==="prowlarr")&&!!I.trim()&&!!k.trim()&&t!=="testing",[u,I,k,t]),c=t==="testing",N=t==="ok"||t==="manual"?!!I.trim()&&!!k.trim()&&!c:se,B=a.useMemo(()=>Te.filter(l=>q[l.key]?.configured),[q]),_=a.useMemo(()=>Te.filter(l=>!q[l.key]?.configured),[q]),H=Qe(u||"jackett");function Q(l){const v=q[l]||{...Se};h.current=!0,E(l),C(""),A(v.baseUrl||""),R(""),F(Array.isArray(v.indexers)?v.indexers:[]),T(Array.isArray(v.indexers)?v.indexers.length:0),v.configured?(y(v.manualOnly?"manual":"ok"),b(v.manualOnly?s("Configuration enregistree. Ajoute les indexeurs manuellement a l'etape suivante.","Configuration saved. Add indexers manually at the next step."):s("Cles deja enregistrees.","Keys already saved.")),$(!0)):(y("idle"),b(""),$(!1)),p(""),P(!1),Z(!0)}function ie(l){j.current&&clearTimeout(j.current),p(l),j.current=setTimeout(()=>{p("")},1200)}async function he(){if(!se)return;y("testing"),b(""),T(0);const l=Date.now();let v="error",z="",J=0,G=[];const oe=Qe(u),L=oe.label;for(let ae=0;ae<2;ae+=1)try{const le=He(I),ue=oe.endpoint,pe=await Ae(ue,{baseUrl:le,apiKey:k.trim()}),ge=Array.isArray(pe)?pe:pe?.indexers,fe=Array.isArray(ge)?ge.length:0;fe>0?(v="ok",z=s(`Connexion OK (${fe} indexeur${fe>1?"s":""})`,`Connection OK (${fe} indexer${fe>1?"s":""})`),J=fe,G=Array.isArray(ge)?ge:[]):(v="manual",z=s("Connexion OK, mais aucun indexeur recupere automatiquement. Tu pourras les ajouter manuellement a l'etape suivante (Copy Torznab Feed + cle API).","Connection OK, but no indexer was auto-fetched. You can add them manually at the next step (Copy Torznab Feed + API key)."));break}catch(le){const ue=le?.message||`Erreur de connexion ${L}.`;if(ae===0&&/invalid start of a value|unexpected token\s*</i.test(ue)){await new Promise(pe=>setTimeout(pe,350));continue}v="manual",z=/invalid start of a value|unexpected token\s*</i.test(ue)?s(`Recuperation auto des indexeurs ${L} impossible. Enregistre la config puis ajoute les indexeurs manuellement a l'etape suivante (Copy Torznab Feed + cle API).`,`Unable to auto-fetch ${L} indexers. Save the config then add indexers manually at the next step (Copy Torznab Feed + API key).`):`${ue} ${s("Tu peux quand meme enregistrer et ajouter les indexeurs manuellement a l'etape suivante.","You can still save and add indexers manually at the next step.")}`;break}const me=Date.now()-l;if(me<2e3&&await new Promise(ae=>setTimeout(ae,2e3-me)),y(v),b(z),T(J),v==="ok"||v==="manual"){if(F(G),typeof window<"u"){const ae=Ce[u];ae&&window.localStorage.setItem(ae.indexers,JSON.stringify(G))}if(J>200){const ae=G.slice(0,3).map(le=>({id:le?.id,name:le?.name}));console.log(`[${L}] indexers count suspicious`,{url:He(I),status:"ok",size:J,shape:Array.isArray(G)?"array":typeof G,sample:ae})}}ie(v==="error"?"error":"ok")}async function ye(){if(t!=="ok"&&t!=="manual")return;const l=He(I),v=k.trim();if(!l||!v)return;const z=Ce[u];if(!(!z||typeof window>"u")){try{await ze(`/api/setup/indexer-providers/${u}`,{baseUrl:l,apiKey:v,enabled:!0}),console.info("[setup/providers] persisted",{provider:u,baseUrl:l})}catch(J){const G=Qe(u).label;y("error"),$(!1),b(J?.message||s(`Impossible d'enregistrer ${G}.`,`Unable to save ${G}.`));return}window.localStorage.setItem(z.baseUrl,l),window.localStorage.removeItem(z.apiKey),window.localStorage.setItem(z.configured,"true"),window.localStorage.setItem(z.manualOnly,t==="manual"?"true":"false"),window.localStorage.setItem($e,u),window.localStorage.setItem(z.indexers,JSON.stringify(K||[])),h.current=!0,A(l),$(!0),Z(!1),M(J=>({...J,[u]:{baseUrl:l,indexers:Array.isArray(K)?K:[],configured:!0,manualOnly:t==="manual"}})),o?.({provider:u,ready:!0,baseUrl:l,indexers:Array.isArray(K)?K:[],manualOnly:t==="manual"})}}function xe(l){const v=Ce[l];typeof window<"u"&&v&&(window.localStorage.removeItem(v.baseUrl),window.localStorage.removeItem(v.apiKey),window.localStorage.removeItem(v.indexers),window.localStorage.removeItem(v.configured),window.localStorage.removeItem(v.manualOnly));const z={...q,[l]:{...Se}};M(z),l===u&&(E(""),C(""),A(""),R(""),$(!1),y("idle"),b(""),T(0),p(""),F([]),Z(!1));const J=Te.find(G=>G.key!==l&&z[G.key]?.configured);if(J){const G=z[J.key]||{...Se};typeof window<"u"&&window.localStorage.setItem($e,J.key),o?.({provider:J.key,ready:G.configured,baseUrl:G.baseUrl,indexers:Array.isArray(G.indexers)?G.indexers:[],manualOnly:!!G.manualOnly})}else typeof window<"u"&&window.localStorage.removeItem($e),o?.({provider:"",ready:!1,baseUrl:"",indexers:[],manualOnly:!1})}return e.jsxs("div",{className:"setup-step setup-jackett-conn",children:[e.jsx("h2",{children:s("Fournisseurs","Providers")}),e.jsx("p",{children:s("Choisis ton fournisseur d'indexeurs.","Choose your indexer provider.")}),_.length>0&&e.jsxs("div",{className:"setup-providers__add settings-row settings-row--ui-select",children:[e.jsx("label",{children:s("Fournisseur","Provider")}),e.jsxs("select",{className:"settings-field",value:S,onChange:l=>{const v=l.target.value;C(""),v&&Q(v)},children:[e.jsx("option",{value:"",disabled:!0,children:s("Selectionner...","Select...")}),_.map(l=>e.jsx("option",{value:l.key,children:l.label},l.key))]})]}),e.jsxs("div",{className:"setup-providers__list",children:[e.jsx("h4",{children:s("Fournisseurs configures","Configured providers")}),B.length===0&&e.jsx("div",{className:"muted",children:s("Aucun fournisseur configure.","No provider configured.")}),B.length>0&&e.jsx("div",{className:"indexer-list",children:B.map((l,v)=>{const z=q[l.key]?.baseUrl||"",J=[{label:s("Configure","Configured"),className:"pill-ok"}];return q[l.key]?.manualOnly&&J.push({label:s("Ajout manuel","Manual add"),className:"pill-warn"}),e.jsx(ss,{id:v+1,title:l.label,meta:z,enabled:!0,badges:J,actions:[{icon:"edit",title:s("Modifier","Edit"),onClick:()=>Q(l.key),disabled:t==="testing"},{icon:"delete",title:s("Supprimer","Delete"),onClick:()=>xe(l.key),disabled:t==="testing",className:"iconbtn--danger"}],showToggle:!1},l.key)})})]}),e.jsxs(as,{open:V,title:`${s("Configurer","Configure")} ${H.label}`,onClose:()=>Z(!1),width:520,children:[e.jsxs("div",{className:"formgrid formgrid--edit",children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{children:s("Base URL","Base URL")}),e.jsx("input",{value:I,onChange:l=>A(l.target.value),placeholder:H.placeholder,disabled:t==="testing"}),e.jsx("span",{className:"field-hint",children:s("IP, hostname ou URL reverse proxy (http/https)","IP, hostname or reverse proxy URL (http/https)")})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{children:s("API key","API key")}),e.jsxs("div",{className:"setup-jackett-key",children:[e.jsx("input",{type:X?"text":"password",value:k,onChange:l=>R(l.target.value),placeholder:`${s("Cle API","API key")} ${H.label}`,disabled:t==="testing"}),e.jsx("button",{className:"btn",type:"button",onClick:()=>P(l=>!l),disabled:t==="testing",children:X?s("Masquer","Hide"):s("Afficher","Show")})]})]})]}),e.jsxs("div",{className:"setup-jackett-hint",children:[s("Indexeurs detectes","Detected indexers"),": ",ee||0]}),t==="error"&&e.jsx("div",{className:"onboarding__error",children:O}),t==="ok"&&e.jsxs("div",{className:"onboarding__ok",children:[O," ",w?` - ${s("enregistre","saved")}`:""]}),t==="manual"&&e.jsxs("div",{className:"onboarding__warn",children:[O," ",w?` - ${s("enregistre","saved")}`:""]}),e.jsx("div",{className:"setup-jackett-footer",children:e.jsx("button",{className:`btn btn-accent btn-test${Y==="ok"?" btn-pulse-ok":""}${Y==="error"?" btn-pulse-err":""}`,type:"button",onClick:t==="ok"||t==="manual"?ye:()=>he(),disabled:!N,children:c?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"btn-spinner"}),s("Test en cours...","Test in progress...")]}):Y==="ok"?s("Valide","Valid"):Y==="error"?s("Invalide","Invalid"):t==="ok"?s("Sauvegarder","Save"):t==="manual"?s("Sauvegarder (manuel)","Save (manual)"):s("Tester","Test")})})]})]})}const Je={jackett:{baseUrl:"feedarr:jackettBaseUrl",apiKey:"feedarr:jackettApiKey",indexers:"feedarr:jackettIndexersCache",configured:"feedarr:jackettConfigured",manualOnly:"feedarr:jackettManualOnly"},prowlarr:{baseUrl:"feedarr:prowlarrBaseUrl",apiKey:"feedarr:prowlarrApiKey",indexers:"feedarr:prowlarrIndexersCache",configured:"feedarr:prowlarrConfigured",manualOnly:"feedarr:prowlarrManualOnly"}},Ie=[{key:"jackett",label:"Jackett"},{key:"prowlarr",label:"Prowlarr"}],es={baseUrl:"",providerId:null,indexers:[],configured:!1,manualOnly:!1},ds="__manual__";function de(o){return String(o||"").trim().replace(/\/+$/,"")}function cs(o){const i=Je[o];if(!i||typeof window>"u")return{...es};const g=window.localStorage.getItem(i.baseUrl)||"",u=window.localStorage.getItem(i.configured)==="true",E=window.localStorage.getItem(i.indexers)||"",S=E?JSON.parse(E)||[]:[],C=window.localStorage.getItem(i.manualOnly)==="true";return{baseUrl:g,providerId:null,configured:u&&!!g,indexers:Array.isArray(S)?S:[],manualOnly:C}}function Xe(o){return Ie.find(i=>i.key===o)?.label||s("Fournisseur","Provider")}function Ls({onHasSourcesChange:o,onBack:i,jackettConfig:g}){const[u,E]=a.useState({jackett:{...es},prowlarr:{...es}}),[S,C]=a.useState({jackett:"",prowlarr:""}),[I,A]=a.useState([]),[k,R]=a.useState({jackett:"",prowlarr:""}),[X,P]=a.useState(!1),[V,Z]=a.useState(null),[t,y]=a.useState(""),[O,b]=a.useState(!1),[ee,T]=a.useState(""),[Y,p]=a.useState(""),[w,$]=a.useState(null),[K,F]=a.useState(!1),[q,M]=a.useState(""),[te,W]=a.useState(""),[h,j]=a.useState(""),[se,c]=a.useState([]),[N,B]=a.useState(()=>new Map),[_,H]=a.useState(!1),[Q,ie]=a.useState(!1),[he,ye]=a.useState(null),[xe,l]=a.useState(""),v=a.useCallback(async()=>{l("");const n={jackett:cs("jackett"),prowlarr:cs("prowlarr")},x={jackett:"",prowlarr:""};try{const m=await ce("/api/providers"),f=new Map((Array.isArray(m)?m:[]).map(d=>[String(d?.type||"").toLowerCase(),d]));for(const d of Ie){const U=f.get(d.key);if(!U)continue;const re=Number(U?.id),r=de(U?.baseUrl),D=!!U?.enabled&&!!U?.hasApiKey&&!!r;if(n[d.key]={...n[d.key],providerId:Number.isFinite(re)&&re>0?re:null,baseUrl:r,configured:D,manualOnly:n[d.key]?.manualOnly||!1},typeof window<"u"){const ne=Je[d.key];window.localStorage.setItem(ne.baseUrl,r||""),window.localStorage.setItem(ne.configured,D?"true":"false"),window.localStorage.removeItem(ne.apiKey),D||(window.localStorage.setItem(ne.indexers,JSON.stringify([])),window.localStorage.setItem(ne.manualOnly,"false"))}}await Promise.all(Ie.map(async d=>{const U=n[d.key];if(!(!U?.configured||!U.providerId))try{const re=await ce(`/api/providers/${U.providerId}/indexers`),r=Array.isArray(re)?re:[];n[d.key]={...n[d.key],indexers:r,manualOnly:r.length===0},typeof window<"u"&&(window.localStorage.setItem(Je[d.key].indexers,JSON.stringify(r)),window.localStorage.setItem(Je[d.key].manualOnly,r.length===0?"true":"false")),r.length===0&&(x[d.key]=`Récupération automatique indisponible pour ${d.label}. Ajoute les indexeurs manuellement via "Copy Torznab Feed".`)}catch(re){console.error(`[Step3 Indexers] Chargement indexeurs ${d.label} échoué.`,re);const D=(Array.isArray(n[d.key]?.indexers)?n[d.key].indexers:[]).length===0||!!n[d.key]?.manualOnly;n[d.key]={...n[d.key],manualOnly:D},D&&(x[d.key]=`Impossible de récupérer la liste auto pour ${d.label}. Ajoute les indexeurs manuellement via "Copy Torznab Feed".`)}}))}catch(m){console.error("[Step3 Indexers] Impossible de charger les fournisseurs depuis l'API.",m),l("Impossible de charger les fournisseurs. La configuration locale est utilisée.")}E(n),C(x)},[]),z=a.useCallback(async()=>{try{const n=await ce("/api/sources");A(Array.isArray(n)?n:[])}catch(n){console.error("[Step3 Indexers] Impossible de charger les sources.",n),A([]),l("Erreur lors du chargement des sources.")}},[]);a.useEffect(()=>{v()},[v]),a.useEffect(()=>{g&&v()},[g,v]),a.useEffect(()=>{z()},[z]);const J=a.useMemo(()=>Ie.filter(n=>u[n.key]?.configured),[u]),G=J.length>0,oe=a.useMemo(()=>{const n=Object.fromEntries(Ie.map(m=>[m.key,[]])),x=Ie.map(m=>({key:m.key,base:de(u[m.key]?.baseUrl)})).filter(m=>m.base);return I.forEach(m=>{const f=de(m?.torznabUrl),d=x.find(U=>f.startsWith(U.base));d&&n[d.key]&&n[d.key].push(m)}),n},[I,u]),L=a.useMemo(()=>J.reduce((n,x)=>n+(oe[x.key]?.length||0),0),[J,oe]);a.useEffect(()=>{o?.(L>0)},[L,o]);const me=a.useMemo(()=>{const n={};return J.forEach(x=>{const m=new Set((oe[x.key]||[]).map(U=>de(U?.torznabUrl))),f=u[x.key]?.indexers||[],d=Array.isArray(f)?f:[];n[x.key]=d.filter(U=>!m.has(de(U?.torznabUrl)))}),n},[J,u,oe]);function ae(){M(""),W(""),j(""),c([]),B(new Map),Z(null),$(null),b(!1),T(""),p("")}function le(){_||(P(!1),y(""),ae())}function ue(n,x){ae(),b(!1),y(n),Z(x),P(!0),Pe(n,x)}function pe(n){ae(),b(!0),y(n),P(!0)}function ge(n){const x=de(n?.torznabUrl),m=Ie.map(f=>({key:f.key,base:de(u[f.key]?.baseUrl)})).find(f=>f.base&&x.startsWith(f.base));return m?.key?m.key:J[0]?.key||""}function fe(n){const x=new URLSearchParams;Object.entries(n||{}).forEach(([f,d])=>{if(d==null)return;const U=String(d).trim();U&&x.set(f,U)});const m=x.toString();return m?`/api/categories/caps?${m}`:"/api/categories/caps"}async function Pe(n,x){if(M(""),W(""),j(""),c([]),B(new Map),!x?.torznabUrl){M(s("Indexeur invalide.","Invalid indexer."));return}const m=Number(u[n]?.providerId||0);if(!m){M(s("Fournisseur non configure cote API.","Provider not configured in API."));return}F(!0);try{const f=await Ae("/api/categories/caps/provider",{providerId:m,torznabUrl:x.torznabUrl,indexerId:x?.id,indexerName:x?.name,includeStandardCatalog:!0,includeSpecific:!0}),d=Array.isArray(f?.categories)?f.categories:[],U=Array.isArray(f?.warnings)?f.warnings:[];U.length>0&&j(U.join(" ")),c(d),B(ns(d)),d.length>0?W(s("Categories chargees.","Categories loaded.")):U.length===0&&j(s("Aucune categorie disponible.","No category available."))}catch(f){j(f?.message||s("Caps indisponible. Aucune categorie disponible.","Caps unavailable. No category available."))}finally{F(!1)}}async function ve(){const n=t;if(!n){M(s("Fournisseur non selectionne.","Provider not selected."));return}const x=de(Y);if(!x){M(s("URL Torznab requise.","Torznab URL required."));return}const m=Xe(n);await Pe(n,{id:"manual",name:ee.trim()||`${m} manuel`,torznabUrl:x})}async function Le(){M(""),W("");const n=t,x=Xe(n),m=O?{id:"manual",name:ee.trim()||`${x} manuel`,torznabUrl:de(Y)}:V;if(!m?.torznabUrl||!de(m?.torznabUrl)){M(O?s("URL Torznab requise.","Torznab URL required."):s("Indexeur invalide.","Invalid indexer."));return}if(I.find(U=>de(U?.torznabUrl)===de(m.torznabUrl))){M(s("Cet indexeur est déjà ajouté.","This indexer is already added."));return}const d=Number(u[n]?.providerId||0);if(!d){M(s("Fournisseur non configure cote API.","Provider not configured in API."));return}H(!0);try{const U=await Ae("/api/sources",{name:m.name||x,torznabUrl:de(m.torznabUrl),authMode:"query",providerId:d});if(U?.id){await ze(`/api/sources/${U.id}/enabled`,{enabled:!0});const re=Ss(N),r=[...N.keys()].map(D=>Number(D)).filter(D=>Number.isFinite(D)&&D>0).sort((D,ne)=>D-ne);await ts(`/api/sources/${U.id}/category-mappings`,is({mappings:re,selectedCategoryIds:r}))}await z(),W(s("Indexeur ajoute.","Indexer added.")),le()}catch(U){M(U?.message||"Erreur ajout indexeur")}finally{H(!1)}}async function Me(n){const x=ge(n);y(x),$(n),b(!1),T(""),p(""),P(!0),M(""),W(""),j(""),c([]),B(new Map),F(!0);try{const m=await ce(fe({sourceId:n.id,indexerName:n?.name,includeStandardCatalog:!0,includeSpecific:!0}));let f=Array.isArray(m?.categories)?m.categories:[];const d=Array.isArray(m?.warnings)?m.warnings:[];d.length>0&&j(d.join(" ")),c(f),B(ns(f)),f.length>0?W(s("Categories chargees.","Categories loaded.")):d.length===0&&j(s("Aucune categorie disponible.","No category available."))}catch(m){M(m?.message||"Erreur chargement categories")}finally{F(!1)}}async function Oe(){if(!w?.id)return;const n=(se||[]).map(m=>{const f=Number(m?.id);if(!Number.isFinite(f)||f<=0)return null;const d=os(N.get(f))||null,U=d?ks[d]||d:null;return{categoryId:f,unifiedKey:d,unifiedLabel:U,catId:f,groupKey:d,groupLabel:U}}).filter(Boolean),x=[...N.keys()].map(m=>Number(m)).filter(m=>Number.isFinite(m)&&m>0).sort((m,f)=>m-f);if(n.length===0){M(s("Aucune categorie a mettre a jour.","No category to update."));return}H(!0);try{await ts(`/api/sources/${w.id}/category-mappings`,is({mappings:n,selectedCategoryIds:x})),await z(),W(s("Categories mises a jour.","Categories updated.")),le()}catch(m){M(m?.message||"Erreur sauvegarde categories")}finally{H(!1)}}async function We(n){if(n?.id){ye(n.id);try{await fs(`/api/sources/${n.id}`),await z()}catch(x){console.error("[Step3 Indexers] Impossible de supprimer la source.",x),l("Impossible de supprimer la source.")}ye(null)}}async function Ge(){if(!(!w?.id||Q||!(typeof window>"u"||window.confirm("Reclasser l'existant pour cette source ?")))){M(""),ie(!0);try{await Ae(`/api/sources/${w.id}/reclassify`),W(s("Reclassement termine.","Reclassification done.")),await z()}catch(x){M(x?.message||s("Erreur reclassification","Reclassification error"))}finally{ie(!1)}}}const Ke=a.useMemo(()=>se||[],[se]),Ne=N.size,Ve=a.useMemo(()=>!(O&&!de(Y)),[O,Y]),Ue=!!t,we=Ue?Xe(t):"",Ye=w?`${s("Modifier","Edit")} : ${w.name}${Ue?` (${we})`:""}`:O?`${s("Ajouter manuellement","Add manually")}${Ue?` (${we})`:""}`:`${s("Ajouter","Add")} : ${V?.name||s("Indexeur","Indexer")}${Ue?` (${we})`:""}`;return e.jsxs("div",{className:"setup-step setup-jackett",children:[e.jsx("h2",{children:s("Indexeurs","Indexers")}),xe&&e.jsx("div",{className:"onboarding__error",children:xe}),!G&&e.jsxs("div",{className:"setup-jackett__guard",children:[e.jsx("div",{className:"onboarding__error",children:s("Aucun fournisseur configure, reviens a l'etape Fournisseurs.","No configured provider. Go back to Providers step.")}),e.jsx("button",{className:"btn btn-accent",type:"button",onClick:i,disabled:!i,children:s("Retour etape 3","Back to step 3")})]}),G&&e.jsx("div",{className:"setup-jackett__columns",children:J.map(n=>{const x=me[n.key]||[],m=oe[n.key]||[];return e.jsxs("div",{className:"setup-jackett__column",children:[e.jsx("div",{className:"setup-jackett__provider-title",children:n.label}),e.jsxs("div",{className:"setup-providers__add settings-row settings-row--ui-select",children:[e.jsx("label",{children:s("Ajouter un indexeur","Add an indexer")}),e.jsxs("select",{className:"settings-field",value:k[n.key]||"",onChange:f=>{const d=f.target.value;if(R(re=>({...re,[n.key]:d})),d===ds){pe(n.key),R(re=>({...re,[n.key]:""}));return}const U=x.find(re=>String(re.id)===String(d));U&&ue(n.key,U),R(re=>({...re,[n.key]:""}))},children:[e.jsx("option",{value:"",disabled:!0,children:s("Selectionner...","Select...")}),x.map(f=>e.jsx("option",{value:f.id,children:f.name},f.id)),e.jsx("option",{value:ds,children:s("Ajouter manuellement...","Add manually...")})]}),x.length===0&&u[n.key]?.indexers?.length>0&&e.jsx("div",{className:"muted",children:s("Tous les indexeurs detectes sont deja ajoutes.","All detected indexers are already added.")}),x.length===0&&u[n.key]?.indexers?.length===0&&e.jsx("div",{className:"onboarding__warn",children:S[n.key]||s(`Aucun indexeur detecte automatiquement pour ${n.label}.`,`No indexer auto-detected for ${n.label}.`)}),u[n.key]?.manualOnly&&e.jsx("div",{className:"muted",children:s(`Dans ${n.label}, utilise "Copy Torznab Feed" puis colle l'URL ici. La cle API du fournisseur configuree a l'etape 3 sera utilisee.`,`In ${n.label}, use "Copy Torznab Feed" and paste the URL here. The API key configured at step 3 will be used.`)})]}),e.jsxs("div",{className:"setup-jackett__list",children:[e.jsx("h4",{children:s("Indexeurs ajoutes","Added indexers")}),m.length===0?e.jsx("div",{className:"muted",children:s("Aucun indexeur ajoute.","No indexer added.")}):e.jsx("div",{className:"indexer-list",children:m.map((f,d)=>e.jsx(ss,{id:d+1,title:f.name,meta:f.torznabUrl,enabled:!!f.enabled,actions:[{icon:"edit",title:s("Modifier","Edit"),onClick:()=>Me(f),disabled:he===f.id},{icon:"delete",title:s("Supprimer","Delete"),onClick:()=>We(f),disabled:he===f.id,className:"iconbtn--danger"}],showToggle:!1},f.id))})]})]},n.key)})}),e.jsxs(as,{open:X,title:Ye,onClose:le,width:"75vw",children:[O&&!w&&e.jsxs("div",{className:"formgrid formgrid--edit",style:{marginBottom:12},children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{children:s("Nom (optionnel)","Name (optional)")}),e.jsx("input",{value:ee,onChange:n=>T(n.target.value),placeholder:s(`Nom ${we||"indexeur"}`,`Name ${we||"indexer"}`),disabled:_||K})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{children:s("Torznab Feed URL","Torznab Feed URL")}),e.jsx("input",{value:Y,onChange:n=>{p(n.target.value),M(""),W(""),j(""),c([]),B(new Map)},placeholder:s("Colle l'URL Copy Torznab Feed","Paste the Copy Torznab Feed URL"),disabled:_||K}),e.jsx("span",{className:"field-hint",children:s(`Depuis ${we||"le fournisseur"}, clique "Copy Torznab Feed", puis colle l'URL complete.`,`From ${we||"the provider"}, click "Copy Torznab Feed" and paste the full URL.`)})]}),e.jsx("div",{className:"setup-jackett__actions",style:{gridColumn:"1 / -1"},children:e.jsx("button",{className:"btn",type:"button",onClick:ve,disabled:_||K||!de(Y),children:K?s("Test...","Test..."):s("Tester les categories (caps)","Test categories (caps)")})})]}),q&&e.jsx("div",{className:"onboarding__error",children:q}),h&&e.jsx("div",{className:"onboarding__warn",children:h}),te&&e.jsx("div",{className:"onboarding__ok",children:te}),K&&e.jsx("div",{className:"muted",children:s("Chargement des categories...","Loading categories...")}),Ke.length>0&&e.jsxs("div",{className:"setup-jackett__categories",children:[e.jsx(bs,{variant:"wizard",categories:se,mappings:N,sourceId:w?.id,infoNote:e.jsxs("div",{className:"setup-jackett__info-note",role:"note",children:[e.jsx("span",{className:"setup-jackett__info-note-icon","aria-hidden":"true",children:"i"}),e.jsxs("div",{className:"setup-jackett__info-note-copy",children:[e.jsx("div",{className:"setup-jackett__info-note-title",children:s("Conseil de tri","Sorting tip")}),e.jsx("div",{children:s('Choisissez de preference les categories specifiques, plus pertinentes. Les categories "parents" incluent souvent des sous-categories qui peuvent provoquer un mauvais tri.',"Prefer specific categories when possible. Parent categories often include subcategories that can cause incorrect sorting.")})]})]}),previewCredentials:w?.id?null:{providerId:Number(u[t]?.providerId||0)||null,torznabUrl:O?de(Y):V?.torznabUrl??"",indexerId:O?null:V?.id??null,authMode:"query",sourceName:O?ee.trim()||s("Manuel","Manual"):V?.name??""},onChangeMapping:(n,x)=>{const m=os(x);B(f=>{const d=new Map(f);return m?d.set(n,m):d.delete(n),d})}}),e.jsx("div",{className:"muted",style:{marginTop:8},children:s(`${Ne} categorie${Ne>1?"s":""} selectionnee${Ne>1?"s":""}`,`${Ne} selected categor${Ne>1?"ies":"y"}`)})]}),e.jsx("div",{className:"setup-jackett__actions setup-jackett__footer",children:w?e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx("button",{className:"btn",type:"button",onClick:Ge,disabled:_||Q,children:Q?s("Reclassement...","Reclassifying..."):s("Reclasser l'existant","Reclassify existing")}),e.jsx("button",{className:"btn btn-accent",type:"button",onClick:Oe,disabled:_||!1,children:_?s("Enregistrement...","Saving..."):s("Mettre a jour","Update")})]}):e.jsx("button",{className:"btn btn-accent",type:"button",onClick:Le,disabled:_||!Ve,children:_?s("Enregistrement...","Saving..."):O?s("Ajouter manuellement","Add manually"):s("Ajouter l'indexeur","Add Indexer")})})]})]})}const Os=["sonarr","radarr","overseerr","jellyseerr","seer"];function Rs(){const[o,i]=a.useState([]),[g,u]=a.useState(!1),[E,S]=a.useState(""),[C,I]=a.useState(!1),[A,k]=a.useState("add"),[R,X]=a.useState(null),[P,V]=a.useState("sonarr"),[Z,t]=a.useState(""),[y,O]=a.useState(""),[b,ee]=a.useState(""),[T,Y]=a.useState(!1),[p,w]=a.useState("idle"),[$,K]=a.useState(""),[F,q]=a.useState(""),[M,te]=a.useState(!1),[W,h]=a.useState(""),j=a.useRef(null),[se,c]=a.useState(!1),[N,B]=a.useState(!1),[_,H]=a.useState(null),[Q,ie]=a.useState(""),[he,ye]=a.useState(""),[xe,l]=a.useState([]),[v,z]=a.useState("standard"),[J,G]=a.useState(!0),[oe,L]=a.useState("all"),[me,ae]=a.useState(!0),[le,ue]=a.useState(!1),[pe,ge]=a.useState("released"),[fe,Pe]=a.useState(!0),ve=a.useMemo(()=>{const r=new Set((o||[]).map(D=>String(D?.type||"").toLowerCase()));return Os.filter(D=>!r.has(D))},[o]),Le=ve.length===0,Me=a.useCallback(async()=>{u(!0),S("");try{const r=await ce("/api/apps");i(Array.isArray(r)?r:[])}catch(r){S(r?.message||s("Erreur chargement applications","Applications loading error")),i([])}finally{u(!1)}},[]);a.useEffect(()=>{Me()},[Me]),a.useEffect(()=>{C&&(w("idle"),K(""),q(""))},[y,b,P,C]),a.useEffect(()=>{if(!(!C||A!=="add")){if(ve.length===0){V("");return}ve.includes(P)||V(ve[0])}},[A,C,P,ve]);function Oe(){k("add"),X(null),V("sonarr"),t(""),O(""),ee(""),Y(!1),w("idle"),K(""),q(""),te(!1),c(!1),H(null),B(!1),ie(""),ye(""),l([]),z("standard"),G(!0),L("all"),ae(!0),ue(!1),ge("released"),Pe(!0)}function We(r){r&&(Oe(),k("add"),V(r),I(!0))}function Ge(r){Oe(),k("edit"),X(r),V(r.type),t(r.name||""),O(r.baseUrl||""),ee(""),ie(r.rootFolderPath||""),ye(r.qualityProfileId?String(r.qualityProfileId):""),l(Array.isArray(r.tags)?r.tags:[]),z(r.seriesType||"standard"),G(r.seasonFolder!==!1),L(r.monitorMode||"all"),ae(r.searchMissing!==!1),ue(!!r.searchCutoff),ge(r.minimumAvailability||"released"),Pe(r.searchForMovie!==!1),I(!0),r.hasApiKey&&Ne(r.id)}function Ke(){I(!1),Oe()}async function Ne(r){B(!0);try{const D=await ce(`/api/apps/${r}/config`);H(D)}catch{H(null)}finally{B(!1)}}function Ve(r){j.current&&clearTimeout(j.current),K(r),j.current=setTimeout(()=>{K("")},1200)}async function Ue(){const r=A==="edit"&&R?.id&&!b.trim();if(!y.trim()||!b.trim()&&!r)return;Y(!0),q(""),w("idle"),K("");const D=Date.now();let ne=!1,je="";try{let be;r?be=await Ae(`/api/apps/${R.id}/test`):be=await Ae(`/api/apps/test?type=${P}`,{baseUrl:y.trim(),apiKey:b.trim()}),ne=!!be?.ok,ne||(je=be?.error||s("Test echoue","Test failed"))}catch(be){je=be?.message||s("Erreur test connexion","Connection test error")}finally{const be=Date.now()-D;be<2e3&&await new Promise(ys=>setTimeout(ys,2e3-be)),Y(!1),w(ne?"ok":"error"),q(ne?"":je||s("Test echoue","Test failed")),Ve(ne?"ok":"error")}}async function we(){te(!0),q("");try{if(A==="add"&&!P)throw new Error(s("Toutes les applications sont deja ajoutees.","All applications are already added."));const r={type:P,name:Z.trim()||null,baseUrl:y.trim(),rootFolderPath:Q||null,qualityProfileId:he?Number(he):null,tags:xe.length>0?xe:null};b.trim()&&(r.apiKey=b.trim()),P==="sonarr"?(r.seriesType=v,r.seasonFolder=J,r.monitorMode=oe,r.searchMissing=me,r.searchCutoff=le):P==="radarr"&&(r.minimumAvailability=pe,r.searchForMovie=fe),A==="add"?await Ae("/api/apps",r):R&&await ze(`/api/apps/${R.id}`,r),Ke(),await Me()}catch(r){q(r?.message||s("Erreur sauvegarde","Save error"))}finally{te(!1)}}async function Ye(r){if(r?.id&&window.confirm(s(`Supprimer ${r.name||r.type} ?`,`Delete ${r.name||r.type}?`)))try{await fs(`/api/apps/${r.id}`),await Me()}catch(D){console.error("[Step4 ArrApps] Impossible de supprimer l'application.",D),S(D?.message||s("Impossible de supprimer l'application.","Failed to delete the application."))}}const n=a.useMemo(()=>Array.isArray(_?.tags)?_.tags:[],[_]),x=Ns(P),m=A!=="add"||!!P,f=A==="edit"&&R?.id&&!b.trim(),d=m&&!!y.trim()&&(b.trim()||f)&&!T&&!M,U=m&&!!y.trim()&&!M&&!T,re=p==="ok"?U:d;return e.jsxs("div",{className:"setup-step setup-arr",children:[e.jsxs("div",{className:"setup-arr__header",children:[e.jsxs("div",{children:[e.jsx("h2",{children:s("Applications (Sonarr / Radarr / Overseerr / Jellyseerr / Seer)","Applications (Sonarr / Radarr / Overseerr / Jellyseerr / Seer)")}),e.jsx("p",{children:s("Optionnel - configure une ou plusieurs apps.","Optional - configure one or more apps.")})]}),e.jsxs("div",{className:"setup-arr__add settings-row settings-row--ui-select",children:[e.jsx("label",{children:s("Ajouter","Add")}),e.jsxs("select",{className:"settings-field",value:W,disabled:Le,onChange:r=>{const D=r.target.value;h(""),D&&We(D)},children:[e.jsx("option",{value:"",disabled:!0,children:Le?s("Toutes les applications sont deja ajoutees","All applications are already added"):s("Selectionner...","Select...")}),ve.map(r=>e.jsx("option",{value:r,children:_e(r)},r))]})]})]}),E&&e.jsx("div",{className:"onboarding__error",children:E}),e.jsxs("div",{className:"indexer-list",children:[g&&e.jsx("div",{className:"indexer-card",children:e.jsx("div",{className:"indexer-row",children:e.jsx("span",{className:"indexer-url muted",children:s("Chargement...","Loading...")})})}),!g&&o.length===0&&e.jsx("div",{className:"indexer-card",children:e.jsx("div",{className:"indexer-row",children:e.jsx("span",{className:"indexer-url muted",children:s("Aucune application configuree","No configured application")})})}),!g&&o.map((r,D)=>{const ne=_e(r.type),je=[{label:ne},{label:r.hasApiKey?"API OK":"NO KEY",className:r.hasApiKey?"pill-ok":"pill-warn"}];return e.jsx(ss,{id:D+1,title:r.name||ne,meta:r.baseUrl||"",enabled:r.isEnabled,badges:je,actions:[{icon:"edit",title:s("Editer","Edit"),onClick:()=>Ge(r)},{icon:"delete",title:s("Supprimer","Delete"),onClick:()=>Ye(r),className:"iconbtn--danger"}],showToggle:!1},r.id)})]}),e.jsxs(as,{open:C,title:A==="add"?s("Ajouter une application","Add an application"):`${s("Editer","Edit")}: ${R?.name||R?.type||s("Application","Application")}`,onClose:Ke,width:620,children:[e.jsxs("div",{className:"formgrid",children:[A==="add"&&e.jsxs("div",{className:"field",children:[e.jsx("label",{children:"Type"}),e.jsxs("select",{value:P,onChange:r=>V(r.target.value),children:[Le&&e.jsx("option",{value:"",children:"Aucun type disponible"}),ve.map(r=>e.jsx("option",{value:r,children:_e(r)},r))]})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{children:s("Nom","Name")}),e.jsx("input",{value:Z,onChange:r=>t(r.target.value),placeholder:`Mon ${_e(P)}`,disabled:M||T})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{children:"Base URL"}),e.jsx("input",{value:y,onChange:r=>O(r.target.value),placeholder:Cs(P),disabled:M||T}),e.jsx("span",{className:"field-hint",children:"IP, hostname ou URL reverse proxy (http/https)"})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{children:s("Cle API","API key")}),e.jsx("input",{value:b,onChange:r=>ee(r.target.value),placeholder:A==="edit"?"••••••••••••••••":s("Entrez la cle API","Enter API key"),disabled:M||T})]})]}),e.jsx("div",{className:"setup-arr__modal-actions",children:x&&e.jsx("button",{className:"btn",type:"button",onClick:()=>c(r=>!r),children:se?s("Masquer options avancees","Hide advanced options"):s("Options avancees","Advanced options")})}),F&&e.jsx("div",{className:"onboarding__error",children:F}),p==="ok"&&e.jsx("div",{className:"onboarding__ok",children:s("Connexion OK","Connection OK")}),se&&x&&e.jsxs("div",{className:"setup-arr__advanced",children:[A==="edit"&&R?.hasApiKey&&e.jsx("div",{className:"setup-arr__config",children:e.jsx("button",{className:"btn",type:"button",onClick:()=>Ne(R.id),disabled:N,children:N?s("Chargement...","Loading..."):s("Charger la config","Load config")})}),e.jsxs("div",{className:"formgrid",children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{children:"Root folder"}),_?.rootFolders?.length>0?e.jsxs("select",{value:Q,onChange:r=>ie(r.target.value),children:[e.jsx("option",{value:"",disabled:!0,children:s("Selectionner...","Select...")}),_.rootFolders.map(r=>e.jsx("option",{value:r.path,children:r.path},r.id))]}):e.jsx("input",{value:Q,onChange:r=>ie(r.target.value),placeholder:"/data/series"})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{children:"Quality profile"}),_?.qualityProfiles?.length>0?e.jsxs("select",{value:he,onChange:r=>ye(r.target.value),children:[e.jsx("option",{value:"",disabled:!0,children:s("Selectionner...","Select...")}),_.qualityProfiles.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]}):e.jsx("input",{value:he,onChange:r=>ye(r.target.value),placeholder:"1"})]})]}),n.length>0&&e.jsx("div",{className:"setup-arr__tags",children:n.map(r=>{const D=xe.includes(r.id);return e.jsxs("label",{className:"pill",children:[e.jsx("input",{type:"checkbox",checked:D,onChange:ne=>{const je=new Set(xe);ne.target.checked?je.add(r.id):je.delete(r.id),l(Array.from(je))}}),r.label]},r.id)})}),P==="sonarr"?e.jsxs("div",{className:"formgrid",children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{children:"Series type"}),e.jsxs("select",{value:v,onChange:r=>z(r.target.value),children:[e.jsx("option",{value:"standard",children:"Standard"}),e.jsx("option",{value:"daily",children:"Daily"}),e.jsx("option",{value:"anime",children:"Anime"})]})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{children:"Monitor mode"}),e.jsxs("select",{value:oe,onChange:r=>L(r.target.value),children:[e.jsx("option",{value:"all",children:"All"}),e.jsx("option",{value:"future",children:"Future"}),e.jsx("option",{value:"missing",children:"Missing"}),e.jsx("option",{value:"existing",children:"Existing"}),e.jsx("option",{value:"latest",children:"Latest"}),e.jsx("option",{value:"pilot",children:"Pilot"}),e.jsx("option",{value:"firstSeason",children:"First Season"})]})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{children:"Season folder"}),e.jsxs("select",{value:J?"yes":"no",onChange:r=>G(r.target.value==="yes"),children:[e.jsx("option",{value:"yes",children:s("Oui","Yes")}),e.jsx("option",{value:"no",children:s("Non","No")})]})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{children:"Search missing"}),e.jsxs("select",{value:me?"yes":"no",onChange:r=>ae(r.target.value==="yes"),children:[e.jsx("option",{value:"yes",children:s("Oui","Yes")}),e.jsx("option",{value:"no",children:s("Non","No")})]})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{children:"Search cutoff"}),e.jsxs("select",{value:le?"yes":"no",onChange:r=>ue(r.target.value==="yes"),children:[e.jsx("option",{value:"yes",children:s("Oui","Yes")}),e.jsx("option",{value:"no",children:s("Non","No")})]})]})]}):P==="radarr"?e.jsxs("div",{className:"formgrid",children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{children:"Minimum availability"}),e.jsxs("select",{value:pe,onChange:r=>ge(r.target.value),children:[e.jsx("option",{value:"announced",children:"Announced"}),e.jsx("option",{value:"inCinemas",children:"In Cinemas"}),e.jsx("option",{value:"released",children:"Released"})]})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{children:"Search for movie"}),e.jsxs("select",{value:fe?"yes":"no",onChange:r=>Pe(r.target.value==="yes"),children:[e.jsx("option",{value:"yes",children:s("Oui","Yes")}),e.jsx("option",{value:"no",children:s("Non","No")})]})]})]}):null]}),se&&!x&&e.jsx("div",{className:"setup-arr__advanced",children:e.jsxs("div",{className:"muted",children:[s("Pas d'options avancees pour","No advanced options for")," ",_e(P),"."]})}),e.jsx("div",{className:"setup-arr__footer",children:e.jsx("button",{className:`btn btn-accent btn-test${$==="ok"?" btn-pulse-ok":""}${$==="error"?" btn-pulse-err":""}`,type:"button",onClick:p==="ok"?we:Ue,disabled:!re,children:T?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"btn-spinner"}),s("Test en cours...","Test in progress...")]}):$==="ok"?s("Valide","Valid"):$==="error"?s("Invalide","Invalid"):p==="ok"?s("Sauvegarder","Save"):s("Tester","Test")})})]})]})}const us={jackett:"feedarr:jackettConfigured",prowlarr:"feedarr:prowlarrConfigured"};function Be({children:o}){const i=a.useRef(null),g=a.useRef(null),[u,E]=a.useState(!1),[S,C]=a.useState(0);return a.useEffect(()=>{const I=()=>{if(i.current&&g.current){const A=i.current.scrollWidth,k=g.current.clientWidth,R=A>k;E(R),R&&C(-(A-k+10))}};return I(),window.addEventListener("resize",I),()=>window.removeEventListener("resize",I)},[o]),e.jsx("div",{className:"text-scroll-wrapper",ref:g,children:e.jsx("span",{className:`text-scroll-content${u?" is-overflowing":""}`,ref:i,style:u?{"--scroll-distance":`${S}px`}:void 0,children:o})})}function $s(o){if(!o)return"—";try{const i=new URL(o),g=i.host;return`${i.protocol}//${g}/•••`}catch{return o.length<=8?"•••":`${o.slice(0,8)}•••`}}function ps(o){return o==="prowlarr"?"Prowlarr":"Jackett"}function Fs(o){if(!o)return"";const i=String(o).trim();return i?`has${i.charAt(0).toUpperCase()}${i.slice(1)}`:""}function zs(o,i){if(!i)return!1;const g=(i.fieldsSchema||[]).filter(E=>E.required);if(g.length===0)return!0;const u=o?.authFlags||{};return g.every(E=>!!u[Fs(E.key)])}function Ks({onFinish:o,finishing:i}){const[g,u]=a.useState(!0),[E,S]=a.useState([]),[C,I]=a.useState([]),[A,k]=a.useState([]),[R,X]=a.useState({}),[P,V]=a.useState([]),[Z,t]=a.useState(""),[y,O]=a.useState(""),b=a.useCallback(async()=>{u(!0),t("");try{const[p,w,$,K]=await Promise.all([ce("/api/providers/external"),ce("/api/providers"),ce("/api/sources"),ce("/api/apps")]),F=Array.isArray(p?.definitions)?p.definitions:[],q=new Map(F.map(h=>[String(h?.providerKey||"").toLowerCase(),h])),M=(Array.isArray(p?.instances)?p.instances:[]).map(h=>{const j=String(h?.providerKey||"").toLowerCase(),se=q.get(j),c=zs(h,se);return{key:String(h?.instanceId||j),label:h?.displayName||se?.displayName||j||s("Provider","Provider"),configured:c,enabled:h?.enabled!==!1}});S(M),I(Array.isArray(w)?w:[]);const te=Array.isArray($)?$:[];k(te);const W={};await Promise.all(te.map(async h=>{if(h?.id)try{const j=await ce(`/api/categories/${h.id}`);W[h.id]=Array.isArray(j)?j:[]}catch{W[h.id]=[]}})),X(W),V(Array.isArray(K)?K:[])}catch(p){t(p?.message||s("Erreur chargement resume","Summary loading error"))}finally{u(!1)}},[]);a.useEffect(()=>{b()},[b]);const ee=a.useMemo(()=>{const p=new Map((Array.isArray(C)?C:[]).map(w=>[String(w?.type||"").toLowerCase(),w]));return["jackett","prowlarr"].map(w=>{const $=p.get(w),K=!!$?.hasApiKey,F=!!String($?.baseUrl||"").trim(),q=!!$?.enabled;return{type:w,configured:K&&F&&q,maskedUrl:$s($?.baseUrl||"")}})},[C]),T=a.useMemo(()=>ee.filter(p=>p.configured),[ee]),Y=a.useCallback(async()=>{if(i)return;O("");const p=[];if(typeof window<"u"&&(window.localStorage.getItem(us.jackett)==="true"&&p.push("jackett"),window.localStorage.getItem(us.prowlarr)==="true"&&p.push("prowlarr")),p.length>0)try{const w=await ce("/api/providers"),$=new Set((Array.isArray(w)?w:[]).map(F=>String(F?.type||"").toLowerCase())),K=p.filter(F=>!$.has(F));if(K.length>0){const F=K.map(q=>ps(q)).join(", ");O(s(`Verification echouee: fournisseur manquant en API (${F}).`,`Verification failed: missing provider in API (${F}).`));return}}catch(w){O(w?.message||s("Impossible de verifier les fournisseurs avant lancement.","Unable to verify providers before launch."));return}o?.()},[i,o]);return e.jsxs("div",{className:"setup-step setup-summary",children:[e.jsx("div",{className:`launch-transition-overlay${i?" is-active":""}`}),e.jsx("div",{className:"setup-summary__header",children:e.jsxs("div",{children:[e.jsx("h2",{children:s("Resume","Summary")}),e.jsx("p",{children:s("Verifie la configuration puis lance Feedarr.","Check the configuration then launch Feedarr.")})]})}),Z&&e.jsx("div",{className:"onboarding__error",children:Z}),y&&e.jsx("div",{className:"onboarding__error",children:y}),g?e.jsx("div",{className:"muted",children:s("Chargement...","Loading...")}):e.jsxs("div",{className:"setup-summary__grid",children:[e.jsxs("div",{className:"setup-summary__card",children:[e.jsx("h3",{children:s("Metadonnees","Metadata")}),e.jsx("ul",{children:E.map(p=>e.jsxs("li",{children:[e.jsx(Be,{children:p.label||p.key||s("Provider","Provider")}),e.jsx("span",{className:`pill ${p.enabled?"pill-ok":"pill-warn"}`,children:p.enabled?s("Actif","Active"):s("Inactif","Inactive")}),e.jsx("span",{className:`pill ${p.configured?"pill-ok":"pill-warn"}`,children:p.configured?s("Auth OK","Auth OK"):s("Auth manquante","Auth missing")})]},p.key))})]}),e.jsxs("div",{className:"setup-summary__card",children:[e.jsx("h3",{children:s("Fournisseurs","Providers")}),T.length===0?e.jsx("div",{className:"muted",children:s("Aucun fournisseur configure","No configured provider")}):e.jsx("ul",{children:T.map(p=>e.jsxs("li",{children:[e.jsx(Be,{children:ps(p.type)}),e.jsx("span",{className:"pill pill-ok",children:s("Configure","Configured")})]},p.type))})]}),e.jsxs("div",{className:"setup-summary__card",children:[e.jsx("h3",{children:s("Sources","Sources")}),A.length===0?e.jsx("div",{className:"muted",children:s("Aucune source ajoutee","No source added")}):e.jsx("ul",{children:A.map(p=>{const w=R[p.id]||[];return e.jsxs("li",{children:[e.jsx(Be,{children:p.name}),e.jsxs("span",{className:"pill pill-blue",children:[w.length," ",s("categorie","category"),w.length>1?"s":""]})]},p.id)})})]}),e.jsxs("div",{className:"setup-summary__card",children:[e.jsx("h3",{children:s("Applications","Applications")}),P.length===0?e.jsx("div",{className:"muted",children:s("Aucune application","No application")}):e.jsx("ul",{children:P.map(p=>e.jsxs("li",{children:[e.jsx(Be,{children:p.name||_e(p.type)}),e.jsx("span",{className:"pill pill-ok",children:s("Configure","Configured")})]},p.id))})]})]}),e.jsx("div",{className:"setup-summary__cta",children:e.jsxs("button",{className:`btn-launch${i?" is-launching":""}`,type:"button",onClick:Y,disabled:i,children:[i?s("Lancement...","Launching..."):s("Lancer Feedarr","Launch Feedarr"),e.jsx(As,{className:"launch-icon"})]})})]})}const Fe="feedarr:setupStep",De="feedarr:onboardingDone",ms="feedarr:setupHasJackettSource",Ze=["feedarr:jackettBaseUrl","feedarr:jackettApiKey","feedarr:jackettProvider","feedarr:jackettIndexersCache","feedarr:jackettConfigured","feedarr:jackettManualOnly","feedarr:prowlarrBaseUrl","feedarr:prowlarrApiKey","feedarr:prowlarrIndexersCache","feedarr:prowlarrConfigured","feedarr:prowlarrManualOnly"],ke=1,gs=8;function hs(o){return Number.isFinite(o)?Math.min(gs,Math.max(ke,Math.floor(o))):ke}function qs(){if(typeof window>"u")return ke;const o=window.localStorage.getItem(Fe),i=Number(o);return hs(i||ke)}function aa(){const o=Is(),[i,g]=a.useState(qs),[u,E]=a.useState(i),[S,C]=a.useState(!1),[I,A]=a.useState({ready:!1,saving:!1,error:""}),[k,R]=a.useState({}),[X,P]=a.useState(!1),[V,Z]=a.useState({ready:!0,saving:!1,error:"",authRequired:!1,authConfigured:!0,authMode:"smart"}),[t,y]=a.useState({provider:"",ready:!1,baseUrl:"",manualOnly:!1}),[O,b]=a.useState(!1),[ee,T]=a.useState(0),Y=a.useRef(null);a.useEffect(()=>{E(h=>Math.max(h,i)),typeof window<"u"&&window.localStorage.setItem(Fe,String(i))},[i]),a.useEffect(()=>{let h=!0;return ce("/api/system/onboarding").then(j=>{if(!h||typeof window>"u")return;const se=window.localStorage.getItem(De)==="true";if(j?.onboardingDone){window.localStorage.setItem(De,"true"),o("/library",{replace:!0});return}se&&(window.localStorage.setItem(De,"false"),window.localStorage.removeItem(Fe),Ze.forEach(c=>window.localStorage.removeItem(c)),g(ke),E(ke))}).catch(j=>{console.error("Failed to load onboarding status in setup wizard",j)}),()=>{h=!1}},[o]),a.useEffect(()=>{let h=!0;return ce("/api/setup/state").then(j=>{if(!h||typeof window>"u")return;const se=window.localStorage.getItem(ms),c=Ze.some(Q=>{const ie=window.localStorage.getItem(Q);return ie!==null&&ie!==""}),N=!!j?.hasJackettSource||!!j?.hasProwlarrSource,B=!!j?.authRequired,_=!!j?.authConfigured,H=!N&&(se==="true"||c);window.localStorage.setItem(ms,j?.hasJackettSource?"true":"false"),Z(Q=>({...Q,authRequired:B,authConfigured:_,ready:!B||_||Q.authMode==="open"})),H&&(Ze.forEach(Q=>window.localStorage.removeItem(Q)),window.localStorage.removeItem(Fe),y({provider:"",ready:!1,baseUrl:"",manualOnly:!1}),b(!1),g(ke),E(ke),T(Date.now()))}).catch(j=>{console.error("Failed to load setup state in setup wizard",j)}),()=>{h=!1}},[]);const p=a.useCallback(async()=>{if(!S){C(!0);try{await Ae("/api/system/onboarding/complete"),typeof window<"u"&&(window.localStorage.removeItem(Fe),window.localStorage.setItem(De,"true")),o("/library",{replace:!0})}catch(h){console.error("Failed to complete onboarding from setup wizard",h),C(!1)}}},[S,o]),w=[{id:1,title:s("Langue","Language"),content:e.jsx(Ps,{onStatusChange:A})},{id:2,title:s("Intro","Intro"),content:e.jsx(Ms,{})},{id:3,title:s("Securite","Security"),content:e.jsx(Us,{required:V.authRequired&&!V.authConfigured,onStatusChange:Z,saveRef:Y})},{id:4,title:s("Metadonnees","Metadata"),content:e.jsx(_s,{validation:k,onValidationChange:R,onAllProvidersAddedChange:P})},{id:5,title:s("Fournisseurs RSS","RSS providers"),content:e.jsx(Ts,{onStatusChange:y,resetToken:ee,initialStatus:t})},{id:6,title:s("Indexeurs","Indexers"),content:e.jsx(Ls,{onHasSourcesChange:b,onBack:()=>g(5),jackettConfig:t})},{id:7,title:s("Applications","Applications"),content:e.jsx(Rs,{})},{id:8,title:s("Resume","Summary"),content:e.jsx(Ks,{onFinish:p,finishing:S})}],$=a.useMemo(()=>Object.values(k||{}).some(h=>h==="ok"),[k]),K=w[i-1],F=i===4||i===7,q=!!t?.ready,M=i===4?$:!0,te=F&&!(i===4&&X);function W(h){g(hs(h))}return e.jsxs("div",{className:"setup-container",children:[e.jsx("div",{className:"setup-stepper",children:w.map(h=>{const j=h.id===i,se=h.id<=u,c=h.id<=u;return e.jsxs("button",{type:"button",className:`setup-stepper-item${j?" is-active":""}${se?" is-done":""}`,onClick:()=>c&&W(h.id),disabled:!c,"aria-current":j?"step":void 0,children:[e.jsx("span",{className:"setup-stepper-num",children:h.id}),e.jsx("span",{className:"setup-stepper-label",children:h.title})]},h.id)})}),e.jsxs("div",{className:"setup-card setupWizardFrame",children:[e.jsx("div",{className:"setupWizardBody",children:e.jsx("div",{className:"setup-card__content",children:K?.content})}),e.jsx("div",{className:"setupWizardFooter",children:e.jsxs("div",{className:"setup-actions",children:[i>ke&&e.jsx("button",{className:"btn",type:"button",onClick:()=>W(i-1),children:s("Precedent","Previous")}),e.jsxs("div",{className:"setup-actions-right",style:{marginLeft:"auto"},children:[te&&e.jsx("button",{className:"btn",type:"button",onClick:()=>W(i+1),disabled:!M,children:s("Passer","Skip")}),i<gs&&i!==3&&e.jsx("button",{className:"btn btn-accent",type:"button",onClick:()=>W(i+1),disabled:i===1&&(!I.ready||I.saving)||i===4&&!$||i===5&&!q||i===6&&!O,children:s("Suivant","Next")}),i===3&&(V.saved?e.jsx("button",{className:"btn btn-accent",type:"button",onClick:()=>W(i+1),children:s("Suivant","Next")}):e.jsx("button",{className:"btn btn-accent",type:"button",onClick:()=>Y.current?.(),disabled:V.saving,children:V.saving?s("Enregistrement...","Saving..."):s("Enregistrer","Save")}))]})]})})]})]})}export{aa as default};
