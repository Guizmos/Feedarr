name: Docker Hub Overview

"on":
  workflow_dispatch:
  push:
    branches: ["main", "master"]
    paths:
      - "README.dockerhub.md"
      - ".github/workflows/dockerhub-overview.yml"

jobs:
  update-overview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Preflight Docker Hub permissions
        shell: bash
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB2_TOKEN || secrets.DOCKERHUB_TOKEN }}
          DOCKERHUB_REPOSITORY: ${{ secrets.DOCKERHUB_USERNAME }}/feedarr
          DOCKERHUB_TOKEN_SOURCE: ${{ secrets.DOCKERHUB2_TOKEN != '' && 'DOCKERHUB2_TOKEN' || 'DOCKERHUB_TOKEN' }}
        run: |
          set -euo pipefail

          if [[ -z "${DOCKERHUB_USERNAME:-}" ]]; then
            echo "::error::Secret DOCKERHUB_USERNAME manquant."
            exit 1
          fi
          if [[ -z "${DOCKERHUB_PASSWORD:-}" ]]; then
            echo "::error::Token Docker Hub manquant (DOCKERHUB2_TOKEN/DOCKERHUB_TOKEN)."
            exit 1
          fi

          echo "Token utilisé: ${DOCKERHUB_TOKEN_SOURCE}"

          namespace="${DOCKERHUB_REPOSITORY%%/*}"
          repository="${DOCKERHUB_REPOSITORY#*/}"

          login_body="$(mktemp)"
          login_code="$(curl -sS -o "$login_body" -w "%{http_code}" \
            -X POST "https://hub.docker.com/v2/users/login/" \
            -H "Content-Type: application/json" \
            -d "{\"username\":\"${DOCKERHUB_USERNAME}\",\"password\":\"${DOCKERHUB_PASSWORD}\"}")"

          if [[ "$login_code" != "200" ]]; then
            echo "::error::Authentification Docker Hub échouée (HTTP $login_code). Vérifie username/token."
            echo "Réponse API:"
            cat "$login_body"
            exit 1
          fi

          jwt_token="$(jq -r '.token // ""' "$login_body")"

          if [[ -z "${jwt_token:-}" ]]; then
            echo "::error::Token JWT Docker Hub absent dans la réponse de login."
            echo "Réponse API:"
            cat "$login_body"
            exit 1
          fi

          user_body="$(mktemp)"
          user_code="$(curl -sS -o "$user_body" -w "%{http_code}" \
            -H "Authorization: JWT ${jwt_token}" \
            "https://hub.docker.com/v2/user/")"
          auth_username=""
          if [[ "$user_code" == "200" ]]; then
            auth_username="$(jq -r '.username // ""' "$user_body")"
          fi

          repo_body="$(mktemp)"
          repo_code="$(curl -sS -o "$repo_body" -w "%{http_code}" \
            -H "Authorization: JWT ${jwt_token}" \
            "https://hub.docker.com/v2/repositories/${namespace}/${repository}/")"

          if [[ "$repo_code" == "404" ]]; then
            echo "::error::Repo Docker Hub introuvable: ${namespace}/${repository}"
            exit 1
          fi
          if [[ "$repo_code" != "200" ]]; then
            echo "::error::Lecture du repo Docker Hub impossible (HTTP $repo_code)."
            echo "Réponse API:"
            cat "$repo_body"
            exit 1
          fi

          current_short_description="$(jq -r '.short_description // ""' "$repo_body")"

          patch_payload="$(jq -cn --arg short_description "$current_short_description" '{short_description:$short_description}')"

          patch_body="$(mktemp)"
          patch_code="$(curl -sS -o "$patch_body" -w "%{http_code}" \
            -X PATCH "https://hub.docker.com/v2/repositories/${namespace}/${repository}/" \
            -H "Authorization: JWT ${jwt_token}" \
            -H "Content-Type: application/json" \
            -d "${patch_payload}")"

          if [[ "$patch_code" == "403" ]]; then
            echo "::error::Accès refusé (HTTP 403) sur PATCH Docker Hub pour ${namespace}/${repository}."
            echo "::error::Causes probables: token sans scope Delete (requis par l'action), token lié à un autre compte, ou droits insuffisants sur le repo."
            if [[ -n "${auth_username:-}" ]]; then
              echo "Utilisateur Docker authentifié: ${auth_username}"
            fi
            echo "Attendu: PAT Docker Hub avec scopes read/write/delete."
            echo "Réponse API:"
            cat "$patch_body"
            exit 1
          fi
          if [[ "$patch_code" != "200" ]]; then
            echo "::error::Test de mise à jour Docker Hub échoué (HTTP $patch_code)."
            echo "Réponse API:"
            cat "$patch_body"
            exit 1
          fi

          echo "Preflight Docker Hub OK: auth + lecture repo + droits d'écriture validés."

      - name: Update Docker Hub repository description
        uses: peter-evans/dockerhub-description@v5
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB2_TOKEN || secrets.DOCKERHUB_TOKEN }}
          repository: ${{ secrets.DOCKERHUB_USERNAME }}/feedarr
          short-description: Smart release dashboard for Torznab, Jackett and Prowlarr.
          readme-filepath: ./README.dockerhub.md
